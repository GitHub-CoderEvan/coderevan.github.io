<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>colly</title>
    <link href="/2024/04/30/Go%E7%88%AC%E8%99%AB%20-%20colly/"/>
    <url>/2024/04/30/Go%E7%88%AC%E8%99%AB%20-%20colly/</url>
    
    <content type="html"><![CDATA[<p>Colly 是 Go 语言中一个功能强大的爬虫库，它被设计用于简化 Web 页面的抓取和数据提取过程。下面是关于 Colly 的一些主要特点和用法：</p><ol><li><strong>简单易用</strong>：Colly 提供了一个简洁的 API，使得编写爬虫变得非常容易。你可以很容易地定义需要爬取的网站的规则，并提取感兴趣的数据。</li><li><strong>灵活的规则定义</strong>：你可以定义多个规则来匹配不同类型的网页，并在每个规则中指定需要采取的操作，例如提取数据或者跟踪链接。</li><li><strong>并发支持</strong>：Colly 内置了对并发的支持，可以同时爬取多个页面，从而提高爬取效率。</li><li><strong>中间件</strong>：Colly 提供了中间件机制，允许你在请求发送、响应接收等各个阶段添加自定义逻辑，从而灵活地扩展爬虫的功能。</li><li><strong>内置的数据提取工具</strong>：Colly 提供了一些方便的工具函数，用于从 HTML 页面中提取数据，例如使用 CSS 选择器或者 XPath。</li><li><strong>可扩展性</strong>：Colly 的设计非常灵活，你可以根据自己的需求轻松地扩展和定制功能。</li></ol><p>以下是一个爬取微博热搜的示例代码：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"log"</span><span class="token string">"strings"</span><span class="token string">"github.com/gocolly/colly/v2"</span><span class="token string">"github.com/gocolly/colly/v2/extensions"</span><span class="token punctuation">)</span><span class="token comment">// 获取微博热搜榜colly</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c <span class="token operator">:=</span> colly<span class="token punctuation">.</span><span class="token function">NewCollector</span><span class="token punctuation">(</span><span class="token punctuation">)</span>extensions<span class="token punctuation">.</span><span class="token function">RandomUserAgent</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">OnRequest</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>r <span class="token operator">*</span>colly<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 向请求头添加 cookie 防止进入访客模式</span>r<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"cookie"</span><span class="token punctuation">,</span> <span class="token string">"SUB=_2AkMRY4uTf8NxqwFRmfsdxWLna410ygHEieKnP3pIJRMxHRl-yT9kqkAvtRB6OuOlexrgRHkeY_A2VqgX2CcV_p0455qS; SUBP=0033WrSXqPxfM72-Ws9jqgMF55529P9D9WhOnHVoAxngUau7LDxX9KO_; _s_tentry=passport.weibo.com; Apache=6010347679488.02.1715406001552; SINAGLOBAL=6010347679488.02.1715406001552; ULV=17154060015601116010347679488.02.1715406001552"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>    <span class="token comment">// 解析热搜页面HTML结构，获取相应热搜内容</span>c<span class="token punctuation">.</span><span class="token function">OnHTML</span><span class="token punctuation">(</span><span class="token string">".data table tbody"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>e <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span><span class="token string">"tr"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> tr <span class="token operator">*</span>colly<span class="token punctuation">.</span>HTMLElement<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> i <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 去除第一个官方宣传内容</span>str <span class="token operator">:=</span> tr<span class="token punctuation">.</span>Textstr1 <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>str2 <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">ReplaceAll</span><span class="token punctuation">(</span>str1<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>str2<span class="token punctuation">,</span> <span class="token string">"•"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 根据•标记去除相应的广告</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%+v\n"</span><span class="token punctuation">,</span> str2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>         timeConsum <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span> <span class="token comment">// 计算时间耗时</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"总耗时:"</span><span class="token punctuation">,</span> timeConsum<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token string">"https://s.weibo.com/top/summary/"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go爬虫</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go爬虫</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go语言历史版本演进和新特性[持续更新]</title>
    <link href="/2024/04/10/Go%E8%AF%AD%E8%A8%80%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC%E6%BC%94%E8%BF%9B%E5%92%8C%E6%96%B0%E7%89%B9%E6%80%A7%5B%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%5D/"/>
    <url>/2024/04/10/Go%E8%AF%AD%E8%A8%80%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC%E6%BC%94%E8%BF%9B%E5%92%8C%E6%96%B0%E7%89%B9%E6%80%A7%5B%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%5D/</url>
    
    <content type="html"><![CDATA[<p>发布总览：<a href="https://go.dev/doc/devel/release">Release History - The Go Programming Language</a></p><h2 id="GO-1-22-新特性">GO 1.22 新特性</h2><p>发布时间：2024-02-06</p><p>官方说明：<a href="https://go.dev/doc/go1.22">Go 1.22 Release Notes - The Go Programming Language</a></p><ul><li><p>循环变量改进：Go 1.22解决了for循环中循环变量在迭代之间意外共享的问题。在新的版本中，for循环中的循环变量（如for range语句中的变量）将不再在整个循环中共享，而是在每次迭代中都有自己的变量。这意味着在goroutine中使用循环变量时，每个goroutine将捕获其迭代的变量，而不是共享同一个变量。这一变化可能会对现有代码的行为产生影响，因此Go团队提供了一个工具来检测代码中可能因此特性变化而产生问题的地方。</p></li><li><p>range支持整型表达式：在Go 1.22中，for range循环的range表达式除了支持传统的数组、切片、map、channel等类型外，还支持整型表达式。这意味着你可以在for range循环中使用整型值，循环将基于该整型值进行迭代。</p></li><li><p>性能提升：Go 1.22在运行时进行了内存优化，提高了CPU性能（约1-3%），并减少了大多数Go程序的内存开销（约1%）。此外，Go 1.21引入的profile-guided optimization（PGO）功能在1.22版本中得到了进一步改进，包括改进的devirtualization，允许更多的接口方法调用进行静态调度，从而提高了程序性能。</p></li><li><p>标准库新增内容：</p><ul><li>引入了一个新的<code>math/rand/v2</code>包，提供更清晰、更一致的API，并使用更高质量、更快的伪随机生成算法。</li><li><code>net/http.ServeMux</code>的 patterns 现在接受方法和通配符，例如可以匹配仅限GET请求的<code>GET /task/&#123;id&#125;/</code>模式。</li><li><code>database/sql</code>包中新增了一个<code>Null[T]</code>类型，用于扫描可为空的列。</li><li>在<code>slices</code>包中添加了一个<code>Concat</code>函数，用于连接任意类型的多个切片。</li></ul></li><li><p>工具链：</p><p>在Go工具链改善方面，首当其冲的要数go module相关工具了。</p><p>在Go 1.22中，go work增加了一个与go mod一致的特性：支持vendor。通过go work vendor，可以将workspace中的依赖放到vendor目录下，同时在构建时，如果module root下有vendor目录，那么默认的构建是go build -mod=vendor，即基于vendor的构建。</p><p>go mod init在Go 1.22中将不再考虑GOPATH时代的包依赖工具的配置文件了，比如Gopkg.lock。在Go 1.22版本之前，如果go module之前使用的是类似<a href="https://tonybai.com/2017/06/08/first-glimpse-of-dep/">dep这样的工具来管理包依赖</a>，go mod init会尝试读取dep配置文件来生成go.mod。</p><p>go vet工具取消了对loop变量引用的警告，增加了对空append的行为的警告(比如：slice = append(slice))、增加了deferring time.Since的警告以及在log/slog包的方法调用时key-value pair不匹配的警告。</p></li></ul><h2 id="GO-1-21-新特性">GO 1.21 新特性</h2><p>发布时间：2023.08.08</p><p>官方说明：<a href="https://go.dev/doc/go1.21">Go 1.21 Release Notes - The Go Programming Language</a></p><p>特性：</p><p>go1.21.1（发布于 2023 年 9 月 6 日）包括对<code>cmd/go</code>、<code>crypto/tls</code>和<code>html/template</code>包的四个安全修复，以及对编译器、<code>go</code>命令、链接器、运行时和<code>context</code>、<code>crypto/tls</code>、<code>encoding/gob</code>、<code>encoding/xml</code>、<code>go/types</code>、<code>net/http</code>、<code>os</code>和 的错误修复<code>path/filepath</code>包。</p><p>go1.21.2（2023 年 10 月 5 日发布）包括对包的一项安全修复<code>cmd/go</code>，以及对编译器、<code>go</code>命令、链接器、运行时和包的错误修复<code>runtime/metrics</code>。</p><p>go1.21.3（2023 年 10 月 10 日发布）包含对该<code>net/http</code>软件包的安全修复。</p><h2 id="GO-1-20-新特性">GO 1.20 新特性</h2><p>发布时间：2023.02.01</p><p>官方说明：<a href="https://go.dev/doc/go1.20">Go 1.20 Release Notes - The Go Programming Language</a></p><p>特性：</p><ul><li>支持将slice直接转为数组</li><li>Comparable类型可比较</li><li>unsafe包添加<code>Slice</code>，<code>SliceData</code>，<code>String</code>，<code>StringData 4个函数</code></li><li>可移植性：Go 1.20将会成为支持macOS 10.13 High Sierra和10.14 Mojave的最后一个版本。</li><li>Go 1.20增加了对于RISC-V架构在FreeBSD操作系统的实验性支持</li><li>PGO引入</li><li>标准库加强<ul><li>新增了几个 时间转换格式常量</li><li>新包 crypto/ecdh 支持通过 NIST 曲线和 Curve25519 椭圆曲线 Diffie-Hellman 密钥交换</li><li>新类型 http.ResponseController 访问 http.ResponseWriter 接口未处理的扩展请求</li><li>httputil.ReverseProxy 包含一个新的 Rewrite 钩子函数，取代了之前的 Director 钩子</li><li>新方法 context.WithCancelCause 提供了一种方法来取消具有给定错误的上下文</li><li>os/exec.Cmd 结构体中的新字段 Cancel 和 WaitDelay, 指定 Cmd 在其关联的 Context 被取消或其进程退出时的回调</li></ul></li><li>工具链<ul><li>cover 工具可以收集整个程序的覆盖率，不仅仅是单元测试</li><li>go build、go install 和其他与构建相关的命令可以接收一个 -pgo 标志，启用配置文件引导优化，以及一个 -cover 标志，用于整个程序覆盖率分析</li><li>go test -json 的实现已得到改进，可以处理复杂多样的 Stdout 输出</li><li>vet 在并行运行的测试中可能会发生更多循环变量引用错误</li><li>在没有 C 工具链 的系统上默认禁用 CGO</li></ul></li><li>性能提升<ul><li><a href="https://so.csdn.net/so/search?q=%E7%BC%96%E8%AF%91%E5%99%A8&amp;spm=1001.2101.3001.7020">编译器</a>和 GC 的优化减少了内存开销，并将 CPU 性能整体提高了 2%</li><li>针对编译时间进行了优化，提升了 10%。使得构建速度与 Go 1.17 保持一致 (恢复到了泛型之前的速度)</li><li>Go 发行版瘦身，新版本起，Go 的 $GOROOT/pkg 目录将不再存储标准库的预编译包存档，Go 发行版的将迎来一轮瘦身</li></ul></li></ul><h2 id="GO-1-19-新特性">GO 1.19 新特性</h2><p>时间：2022.05</p><p>官方说明：<a href="https://go.dev/doc/go1.19">Go 1.19 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>泛型问题fix</li><li>修订Go memory model:对Go memory model做了更正式的整体描述，增加了对multiword竞态、runtime.SetFinalizer、更多sync类型、atomic操作以及编译器优化方面的描述。</li><li>修订go doc comment格式：增加了对超链、列表、标题、标准库API引用等格式支持</li><li>新增runtime.SetMemoryLimit和GOMEMLIMIT环境变量：避免Go程序因分配heap过多，超出系统内存资源限制而被kill，默认memory limit是math.MaxInt64，limit限制的是go runtime掌控的内存总量，对于开发者自行从os申请的内存(比如通过mmap)则不予考虑。</li><li>启动时将默认提高打开文件的限值：对于导入os包的go程序，Go将在1.19中默认提高这些限制值到hard limit。</li><li>race detector将升级到v3版thread sanitizer：race detector性能相对于上一版将提升1.5倍-2倍，内存开销减半，并且没有对goroutine的数量的上限限制</li><li>增加&quot;unix&quot; build tag：//go:build unix</li><li>标准库net包使用EDNS</li><li>标准库flag包增加TextVar函数</li><li>正式支持64位龙芯cpu架构 (GOOS=linux, GOARCH=loong64)</li><li>当Go程序空闲时，Go GC进入到周期性的GC循环的情况下(2分钟一次)，Go运行时现在会在idle的操作系统线程上安排更少的GC worker goroutine，减少空闲时Go应用对os资源的占用。</li><li>Go行时将根据goroutine的历史平均栈使用率来分配初始goroutine栈，避免了一些goroutine的最多2倍的goroutine栈空间浪费。</li><li>sync/atomic包增加了新的高级原子类型Bool, Int32, Int64, Uint32, Uint64, Uintptr和Pointer，提升了使用体验。</li><li>Go编译器使用jump table重新实现了针对大整型数和string类型的switch语句，平均性能提升20%左右。</li><li>等</li></ul><h2 id="Go-1-18-新特性">Go 1.18 新特性</h2><p>时间：2022.03</p><p>官方说明：<a href="https://go.dev/doc/go1.18">Go 1.18 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>泛型支持</li><li>Workspaces 工作区</li><li>Go编译器与Go module变化：修正的语法bug，在AMD64平台上引入architectural level，为ARM64架构带来高达 20% 的 CPU 性能改进：但由于编译器中与支持泛型有关的变化，Go 1.18 的编译速度可能比Go 1.17的编译速度大约慢15%。编译后的代码的执行时间不受影响。打算在Go 1.19中提高编译器的速度。Go 1.18明确了能修改go.mod、go.sum的命令只有三个：go get、go mod tidy和go mod download。</li><li>go fuzzing test：将fuzz testing纳入了go test工具链，与单元测试、性能基准测试等一起成为了Go原生测试工具链中的重要成员，单元测试函数名样式：FuzzXxx</li><li>go get 不再执行编译和安装工作</li><li>gofmt支持并发</li><li>内置函数Append对切片的扩容算法发生变化：和Go 1.17以1024作为大小分界不同，Go 1.18使用256作为threshold</li><li>新增net/netip包</li><li>tls client默认将使用TLS 1.2版本</li><li>crypto/x509包默认将拒绝使用SHA-1哈希函数签名的证书（自签发的除外）</li><li>strings包和bytes包新增Cut函数</li><li>runtime/pprof精确性提升</li><li>sync包新增Mutex.TryLock、RWMutex.TryLock和RWMutex.TryRLock</li><li>等</li></ul><h2 id="Go-1-17-新特性">Go 1.17 新特性</h2><p>时间：2021.08</p><p>官方说明：<a href="https://go.dev/doc/go1.17">Go 1.17 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>从切片到数组指针的转换： []T 类型的表达式 s 现在可以转换为数组指针类型 *[N]T</li><li>go modules 支持“修剪模块图”（Pruned module graphs）：go mod tidy -go=1.17</li><li>编译器带来了额外的改进：即一种传递函数参数和结果的新方法，程序性能提高了约 5%，amd64 平台的二进制大小减少了约 2%。</li><li>unsafe包新增了<code>unsafe.Add</code>和<code>unsafe.Slice</code></li><li><code>go.mod 中添加 // Deprecated: 注释来弃用模块</code></li><li>net包：</li></ul><ol><li>url参数解析增加对“;”的支持变化（原先 example?a=1;b=2&amp;c=3 会解析成 <code>map[a:[1] b:[2] c:[3]]</code>, 现在解析成<code>map[c:[3]]</code>）</li><li>增加 IP.IsPrivate 判断私有 IP</li><li>a.b.c.d 格式的 ip v4 地址不允许每段有前缀 0（因为某些系统会认为前缀 0 表示 8进制）</li><li>等</li></ol><h2 id="Go-1-16-新特性">Go 1.16 新特性</h2><p>时间：2021.02</p><p>官方说明：<a href="https://go.dev/doc/go1.17">Go 1.16 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>GO111MODULE 默认为 on</li><li>支持编译阶段将静态资源文件打包进编译好的程序中，并提供访问这些文件的能力：//go:embed</li></ul><h2 id="Go-1-15-新特性">Go 1.15 新特性</h2><p>时间：2020.08</p><p>官方说明：<a href="https://go.dev/doc/go1.16">Go 1.15 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>改进了对高核心数的小对象的分配</li><li>编译器/汇编器/链接器的优化:二进制大小减少了约 5%，减少了链接器资源的使用（时间和内存）并提高了代码的稳健性/可维护性。</li><li>内置了time/tzdata包：允许将时区数据库嵌入到程序中</li><li>等</li></ul><h2 id="Go-1-14-新特性">Go 1.14 新特性</h2><p>时间：2020.02</p><p>官方说明：<a href="https://go.dev/doc/go1.15">Go 1.14 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>Go Module已可用于生产使用</li><li>嵌入具有重叠方法集的接口</li><li>改进了defer的性能</li><li>goroutines 异步可抢占</li><li>页面分配器更高效</li><li>内部定时器更高效</li><li>等</li></ul><h2 id="Go-1-13-新特性">Go 1.13 新特性</h2><p>时间：2019.09</p><p>官方说明：<a href="https://go.dev/doc/go1.14">Go 1.13 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>优化sync.Pool</li></ul><p>sync 包的 Pool 组件得到改进，得其中的资源不会在垃圾回收时被清除(通过新机制里引入的缓存，两次垃圾回收之间没有被使用过的实例才会被清除)</p><ul><li>重了逃逸分析逻辑，使得 Go 程序减少了堆上的分配次数</li><li>go 命令默认使用 Go module mirror and Go checksum database下载和验证模块</li><li>对数字文字的改进</li><li>错误换行</li><li>默认开启 TLS 1.3</li><li>等</li></ul><h2 id="Go-1-12-新特性">Go 1.12 新特性</h2><p>时间：2019.02</p><p>官方说明：<a href="https://go.dev/doc/go1.13">Go 1.12 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>改进了Go modules</li><li>在<a href="https://link.juejin.cn/?target=https%3A%2F%2Fpkg.go.dev%2Fgolang.org%2Fx%2Ftools%2Fgo%2Fanalysis">analysis包</a>基础上重写了 go vet 命令</li><li>等</li></ul><h2 id="Go-1-11-新特性">Go 1.11 新特性</h2><p>时间：2018.08</p><p>官方说明：<a href="https://go.dev/doc/go1.12">Go 1.11 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>Go modules</li></ul><h2 id="Go-1-10-新特性">Go 1.10 新特性</h2><p>时间：2018.02</p><p>官方说明：<a href="https://go.dev/doc/go1.12">Go 1.10 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>go test with cache：go test命令可以缓存测试结果</li><li>go build 命令会缓存最近构建过的包，从而加快了构建过程</li><li>明确预声明类型(predeclared type)是defined type还是alias type</li><li>移除spec中对method expression: T.m中T的类型的限制</li><li>默认的GOROOT</li><li>增加GOTMPDIR变量</li><li>通过cache实现增量构建，提高go tools性能</li><li>go tool pprof做了一个较大的改变：增加了Web UI</li><li>标准库新增strings.Builder</li><li>标准库bytes包的几个方法Fields, FieldsFunc, Split和SplitAfter在底层实现上有变化，使得外部展现的行为有所变化</li><li>等</li></ul><h2 id="Go-1-9-新特性">Go 1.9 新特性</h2><p>时间：2017.08</p><p>官方说明：<a href="https://go.dev/doc/go1.10">Go 1.9 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>提升了垃圾收集器和编译器</li><li>增加了类型别名</li><li>新增了sync.Map</li><li>time包更加安全</li><li>testing包新增helper方法</li><li>支持渐进式代码重构</li><li>引入了类型别名并提升了运行时和工具支持</li></ul><h2 id="Go-1-8-新特性">Go 1.8 新特性</h2><p>时间：2017.02</p><p>官方说明：<a href="https://go.dev/doc/go1.9">Go 1.8 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>优化编译</li></ul><p>CPU 时间在 32 位 ARM 系统上减少了 20-30%, 还针对 64 位 x86 系统进行了一些适度的性能改进。编译器和<a href="https://so.csdn.net/so/search?q=%E9%93%BE%E6%8E%A5%E5%99%A8&amp;spm=1001.2101.3001.7020">链接器</a>变得更快。</p><p>编译时间应该比 Go 1.7 改进了大约 15%</p><p>Go 1.7中进入标准库的context，提供了取消和超时机制。</p><p>Go 1.8 让标准库中更多package使用(支持)context，包括 database/sql，net 包， net/http 包中的 Server.Shutdown等</p><ul><li>对垃圾回收器改进，使两次垃圾回收的暂停时间减小到了毫秒级</li><li>同时识别了剩余仍未解决的暂停模式，并在下一个版本中得到修复。修复后，通常情况下暂停时间能控制在 100 微秒左右,甚至能低至 10 微秒。</li><li>改进了 defer 函数</li><li>部分标准库使用context包来改造</li><li>sort 包中新添加的 Slice 函数，对切片进行排序变得比之前简单得多</li></ul><h2 id="Go-1-7-新特性">Go 1.7 新特性</h2><p>时间：2016.08</p><p>官方说明：<a href="https://go.dev/doc/go1.8">Go 1.7 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>context包转正</li><li>编译时间显着加快：二进制文件大小减少了 20-30%, CPU 时间减少了 5-35%</li><li>垃圾收集器的加速和标准库的优化</li><li>go tool trace改进</li></ul><h2 id="Go-1-6-新特性">Go 1.6 新特性</h2><p>时间：2016.02</p><p>官方说明：<a href="https://go.dev/doc/go1.7">Go 1.6 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>增加对于 HTTP/2 协议的默认支持</li><li>再一次降低了垃圾回收器的延迟</li><li>runtime改变了打印程序结束恐慌的方式。现在只打印发生panic的 goroutine 的堆栈，而不是所有现有的 goroutine</li><li>默认启用vendor目录</li><li>sort.Sort 内部的算法进行了改进，运行速度提高了约 10%</li></ul><h2 id="Go-1-5-新特性">Go 1.5 新特性</h2><p>时间：2015.08</p><p>官方说明：<a href="https://go.dev/doc/go1.6">Go 1.5 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgo.dev%2Fdoc%2Fgo1.5%23gc">垃圾回收器</a>被完全重新设计实现： 基于并发的回收期，GC延迟显著降低，来自Twitter生产案例从300ms下降到30ms</li><li>调度程序的相关改进允许将默认的 GOMAXPROCS 值（并发执行的 goroutine 的数量）从 1 更改为逻辑 CPU 的数量。在以前的版本中，默认值为 1</li><li>go tool trace：可以在运行时可视化跟踪程序，追踪信息可在测试或运行期间生成，展示在浏览器窗口中</li><li>map语法的更改：由于疏忽，允许从slice literals中省略元素类型的规则未应用于map。在1.5版本得到了修正，以下两种定义map的方式从1.5及之后都可以（即可以省略Point的类型）</li></ul><h2 id="Go-1-4-新特性">Go 1.4 新特性</h2><p>时间：2014.02</p><p>官方说明：<a href="https://go.dev/doc/go1.5">Go 1.4 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li><p>For-range loops支持新语法</p><p>1234567891011121314151617</p><p>package mainimport “fmt”func main() { sli := []string{“shandong”, “zhejiang”, “guangdong”, “jiangsu”} for k, v := range sli { fmt.Println(“k-v:”, k, v) //go 1.3及之前的For-range loops } for range sli { fmt.Println(“从1.4开始这种写法是可以通过编译的”) }}</p></li><li><p>Android 的官方支持包<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fmobile">golang.org/x/mobile</a>随该版本一同发布，使开发者可以仅用 Go 代码编写简单的 Android 应用。</p></li><li><p>之前用 C 和汇编语言编写的大多数运行时已转换为用 Go 语言实现 &amp;&amp; 使用了更精准的垃圾收集器，堆栈大小减少了 10~30%</p></li><li><p>发布 go generate 命令，此命令会扫描//go:generate 指令提供的信息生成代码，简化了代码生成的方式。 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgo.dev%2Fblog%2Fgenerate">Generating code</a></p></li><li><p>引入了Internal包</p></li></ul><p>Go 的项目代码管理工具从 Mercurial 切换为 Git，与此同时，项目也从 Google Code 迁移到了 Github 上</p><h2 id="Go-1-3-新特性">Go 1.3 新特性</h2><p>时间：2014.06</p><p>官方说明：<a href="https://go.dev/doc/go1.4">Go 1.3 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>堆栈管理得到了重要改善</li><li>发布了 sync 包的 Pool 组件</li><li>改进了<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1yIAYmbvL3JxOKOjuCyon7JhW4cSv1wy5hC0ApeGMV9s%2Fpub">channel的实现</a>，提升了性能</li></ul><h2 id="Go-1-2-新特性">Go 1.2 新特性</h2><p>时间：2013.12</p><p>官方说明：<a href="https://go.dev/doc/go1.3">Go 1.2 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgo.dev%2Fdoc%2Fgo1.2%23three_index">Three-index slices</a></li><li>go test 命令支持代码覆盖率报告，并提供新的 <code>go tool cover</code> 命令输出代码测试覆盖率的统计信息. <a href="https://link.juejin.cn/?target=https%3A%2F%2Fgo.dev%2Fblog%2Fcover">The cover story</a></li></ul><h2 id="Go-1-1-新特性">Go 1.1 新特性</h2><p>时间：2013.05</p><p>官方说明：<a href="https://go.dev/doc/go1.2">Go 1.1 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>增强语言特性（编译器、垃圾回收机制、映射、goroutine 调度器）与性能。</li></ul><h2 id="Go-1-0-新特性">Go 1.0 新特性</h2><p>时间：2012.03</p><p>官方说明：<a href="https://go.dev/doc/go1">Go 1 Release Notes - The Go Programming Language</a></p><p>主要特性：</p><ul><li>承诺兼容性，确保向后兼容 <a href="https://go.dev/doc/go1compat">Go 1 and the Future of Go Programs - The Go Programming Language</a></li></ul><p>本文转自 <a href="https://blog.csdn.net/mdpets/article/details/127663206%EF%BC%8C%E5%A6%82%E6%9C%89%E4%BE%B5%E6%9D%83%EF%BC%8C%E8%AF%B7%E8%81%94%E7%B3%BB%E5%88%A0%E9%99%A4%E3%80%82">https://blog.csdn.net/mdpets/article/details/127663206，如有侵权，请联系删除。</a></p>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>并发</title>
    <link href="/2023/10/20/Go%E8%BF%9B%E9%98%B6%20-%20%E5%B9%B6%E5%8F%91/"/>
    <url>/2023/10/20/Go%E8%BF%9B%E9%98%B6%20-%20%E5%B9%B6%E5%8F%91/</url>
    
    <content type="html"><![CDATA[<h1 id="1-并发">1.  并发</h1><h2 id="1-1-并发和并行的区别">1.1  并发和并行的区别</h2><p>并发和并行是两个不同的概念：</p><ul><li>并行意味着程序在<strong>任意时刻</strong>都是同时运行的；</li><li>并发意味着程序在<strong>单位时间内</strong>是同时运行的</li></ul><h3 id="1-1-1-并行">1.1.1  并行</h3><p><strong>并行</strong>就是在任一粒度时间内都具备同时执行的能力：简单来说并行就是多机或多台机器并行处理； SMP（SMP 是对称多处理器（Symmetric MultiProcessing）的简称。在这样的系统中包含多个处理器，同时，处理器间共享了内存和 I/O 总线。&quot;对称&quot;是指所有的处理器在功能和位置上地位相同，不存在主处理器或者被处理器较多的 “主机”） 表面上看是并行的，但由于是共享内存，以及线程间的同步等，不可能完全做到并行。</p><h3 id="1-1-2-并发">1.1.2   并发</h3><p><strong>并发</strong>是在规定的时间内多个请求都得到执行和处理，强调的是给外界的感觉，实际上内部可能是分时操作的。并发重在避免阻塞，使程序不会因为一个阻塞而停止处理。并发典型的应用场景：分时操作系统就是一种并发设计（忽略多核 CPU）。</p><h2 id="1-2-goroutine">1.2  goroutine</h2><p><code>goroutine</code>是 Go 语言中处理并发执行的一个主要工具，是 Go 运行时层面的轻量级线程，与 OS 线程相比，它的开销更小。操作系统可以进行线程和进程的调度，本身具备并发处理能力，但进程切换代价还是过高，当操作系统在系统进程之间切换时，它需要保存当前正在运行进程的状态，以便在再次切换回该进程时恢复执行。这通常涉及保存进程的 “上下文”，即使该进程能够从中断点继续执行的所有信息（<strong>处理器的寄存器</strong>、<strong>内存管理信息</strong>、<strong>进程状态</strong>、<strong>输入和输出状态</strong>、<strong>资源使用情况</strong>等）。如果应用可以在用户态进行调度，应该可以更大限度地提升程序运行效率，goroutine就是基于这个思想实现的。</p><ul><li>goroutine 示例，代码如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup <span class="token comment">// 第一步：定义一个计数器</span><span class="token keyword">func</span> <span class="token function">routine1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"routine1 你好golang-"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token comment">// routine1 你好golang-0, ...9</span>      time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span>   wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//协程计数器-1    // 第三步：协程执行完毕，计数器-1</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">routine2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"routine2 你好golang-"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token comment">// routine2 你好golang-0, routine2 你好golang-1</span>      time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span>   wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//协程计数器-1</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//协程计数器+1       第二步：开启一个协程计数器+1</span>   <span class="token keyword">go</span> <span class="token function">routine1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//表示开启一个协程</span>   wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//协程计数器+1</span>   <span class="token keyword">go</span> <span class="token function">routine2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//表示开启一个协程</span>   wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//等待协程执行完毕...   第四步：计数器为0时推出</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"主线程退出..."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>goroutine 有如下特性：</p><ul><li>go 的执行是非阻塞的，不会等待；</li><li>go 后面函数的返回值会被忽略；</li><li>调度器不能保证多个 goroutine 的执行次序；</li><li>没有父子 goroutine 的概念，所有 goroutine 是平等地被调度和执行的；</li><li>go 程序运行时会在 main 函数先创建一个 goroutine，其他 go 关键字创建的 goroutine 会另外创建；</li><li>go 没有暴露 goroutine id 给用户，所以不能在一个 goroutine 里面显式地操作另一个 goroutine ，不过 runtime 包提供了一些函数访问和设置 goroutine 的相关信息；</li></ul><h3 id="1-2-1-GOMAXPROCS">1.2.1  GOMAXPROCS</h3><p>GOMAXPROCS( n int ) 用来设置或查询可以并发执行的 goroutine 数目，n 大于 1 表示设置 GOMAXPROCS 值，否则表示查询当前 GOMAXPROCS 的值。</p><h3 id="1-2-2-Goexit">1.2.2   Goexit</h3><p>Goexit() 是结束当前 goroutine 的运行， Goexit 在结束当前 goroutine 运行之前会调用当前 goroutine 已经注册的 defer 。 Goexit 并不会产生 panic ，所以该 goroutine defer 里面的 recover 调用都返回 nil 。</p><h3 id="1-2-3-Gosched">1.2.3   Gosched</h3><p>Gosched() 是放弃当前调度执行机会，将当前 goroutine 放到队列中等待下次被调度。只有 goroutine 还是不够的，多个 goroutine 之间还需要通信、同步、协同等。</p><h2 id="1-3-Chan">1.3  Chan</h2><p>chan 是 Go 语言里面的一个关键宇，是 channel 的简写，翻译为中文就是通道。  goroutine 是 Go 语言里面的并发执行体，通道是 goroutine 之间通信和同步的重要组件。 Go 的哲学是“不要通过共享内存来通信，而是通过通信来共享内存”（CSP（Communicating Sequential Processes）是一种用于设计并发系统的模型，它强调通过在独立的并发实体或“进程”之间传递消息来进行通信），通道是 Go 通过通信来共享内存的载体。例如：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">／／创建一个无缓冲的通道，通道存放元素的类型为 datatype <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> datatype <span class="token punctuation">)</span> ／／创建一个有 <span class="token number">10</span> 个缓冲的远远，遥远存放元素的类型为 datatype <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> datatype<span class="token punctuation">,</span>  <span class="token number">10</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>通道分为无缓冲的通道和有缓冲的通道， Go 提供内置函数 len 和 cap ，<strong>无缓冲的通道的 len</strong> <strong>和 cap 都是 0</strong>，<strong>有缓冲的通道的 len 代表没有被读取的元素数， cap 代表整个通道的容量</strong>。无缓冲的通道既可以用于通信，也可以用于两个 goroutine 的同步，有缓冲的通道主要用于通信。有缓冲通道示例：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> m sync<span class="token punctuation">.</span>Mutex<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 互斥锁</span>c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">defer</span> m<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解锁</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">&#123;</span>c <span class="token operator">&lt;-</span> i <span class="token comment">// 向 c 通道传递数据</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>m<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等到互斥锁解锁，然后再次锁定用来阻塞主程序。</span><span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> c <span class="token punctuation">&#123;</span> <span class="token comment">// 向已关闭的通道遍历读取数据</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>写到缓冲通道中的数据不会消失，它还可以缓冲和适配两个 goroutine 处理速率不一致的情况，缓冲通道和消息队列类似，有削峰和增大吞吐量的功能。</p><p>操作不同状态的 chan 会引发三种行为：</p><ol><li>panic<ul><li>向已经关闭的通道写数据会导致 panic ；最佳实践是由写入者关闭通道，能最大程度地避免向已经关闭的通道写数据而导致的 panic；</li><li>重复关闭的通道会导致 panic；</li></ul></li><li>阻塞<ul><li>向未初始化的通道写数据或读数据都会导致当前 goroutine 的永久阻塞；</li><li>向缓冲区己满的通道写入数据会导致 goroutine 阻塞；</li><li>通道中没有数据，读取该通道会导致 goroutine 阻塞；</li></ul></li><li>非阻塞<ul><li>读取己经关闭的通道不会引发阻塞，而是立即返回通道元素类型的零值，可以使用 comrna , ok 语法判断通道是否己经关闭；</li><li>向有缓冲且没有满的通道读／写不会引发阻塞；</li></ul></li></ol><h2 id="1-4-WaitGroup">1.4  WaitGroup</h2><p>goroutine 和 chan 一个用于并发，另一个用于通信。没有缓冲的通道具有同步的功能，除此之外， sync 包也提供了多个 goroutine 同步的机制，主要是通过 WaitGroup 实现的。</p><p>主要数据结构和操作如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> WaitGroup <span class="token keyword">struct</span>  <span class="token punctuation">&#123;</span>  <span class="token comment">// contains filtered or unexported fields</span><span class="token punctuation">&#125;</span><span class="token comment">// 添加等待信号</span><span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>delta <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// 释放等待信号</span><span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 等待</span><span class="token keyword">func</span> <span class="token punctuation">(</span>wg <span class="token operator">*</span>WaitGroup<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>WaitGroup 用来等待多个 goroutine 完成， main goroutine 调用 Add 设置需要等待 goroutine 的数目，每一个 goroutine 结束时调用 Done(), Wait() 被 main 用来等待所有的 goroutine 完成。</p><h2 id="1-5-select">1.5  select</h2><p>select 是类 UNIX 系统提供的一个多路复用系统 API, Go 语言借用多路复用的概念，提供了 select 关键字，用于多路监昕多个通道。当监听的通道没有状态是可读或可写的， select 是阻塞的；只要监听的通道中有一个状态是可读或可写的，则 select 就不会阻塞，而是进入处理就绪通道的分支流程。如果监听的通道有多个可读或可写的状态， 则 select 随机选取一个处理。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span>  <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span> ch  <span class="token punctuation">:</span> <span class="token operator">=</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">go</span>  <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token keyword">chan</span>  <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span> <span class="token keyword">for</span>  <span class="token punctuation">&#123;</span>     <span class="token keyword">select</span>  <span class="token punctuation">&#123;</span>         <span class="token comment">//0 或 1 的写入是随机的</span>        <span class="token keyword">case</span>  ch  <span class="token operator">&lt;</span> <span class="token operator">-</span> <span class="token number">0</span> <span class="token punctuation">:</span>         <span class="token keyword">case</span>  ch  <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token punctuation">:</span>         <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token keyword">for</span>  i <span class="token punctuation">:</span> <span class="token operator">=</span>  <span class="token number">0</span><span class="token punctuation">;</span>  i   <span class="token operator">&lt;</span>  <span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>     <span class="token function">println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 运行结果</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">1</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="1-6-扇入（-Fan-in-）和扇出（-Fan-out">1.6  扇入（ Fan in ）和扇出（ Fan out )</h2><p>编程中经常遇到 “扇入和扇出” 两个概念，所谓的扇入是指将多路通道聚合到一条通道中处理，Go 语言最简单的扇入就是使用 sel ect 聚合多条通道服务；所谓的扇出是指将一条通道发散到多条通道中处理，在 Go 语言里面具体实现就是使用 go 关键字启动多个 goroutine 并发处理。</p><p>中国有句经典的哲学名句叫 “分久必合，合久必分” 软件的设计和开发也遵循同样的哲学思想，扇入就是合，扇出就是分。当生产者的速度很慢时，需要使用扇入技术聚合多个生产者满足消费者， 比如很耗时的加密／解密服务；当消费者的速度很慢时，需要使用扇出技术，比如Web 服务器并发请求处理。扇入和扇出是 Go 并发编程中常用的技术。</p><h3 id="1-6-1-扇入（Fan-In）：">1.6.1   扇入（Fan-In）：</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">fanIn</span><span class="token punctuation">(</span>input1<span class="token punctuation">,</span> input2 <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">select</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">case</span> s <span class="token operator">:=</span> <span class="token operator">&lt;-</span>input1<span class="token punctuation">:</span>                c <span class="token operator">&lt;-</span> s            <span class="token keyword">case</span> s <span class="token operator">:=</span> <span class="token operator">&lt;-</span>input2<span class="token punctuation">:</span>                c <span class="token operator">&lt;-</span> s            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> c<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>扇入指的是将多个输入 channel 合并到一个 channel 中，扇出是将一个输入 channel 分散给多个 worker 进行处理。</p><h3 id="1-6-2-扇出（Fan-Out）：">1.6.2  扇出（Fan-Out）：</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">fanOut</span><span class="token punctuation">(</span>input <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> workerCount <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> outputs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workerCount<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>        outputs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token function">createWorker</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> outputs<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">createWorker</span><span class="token punctuation">(</span>input <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>    c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> input <span class="token punctuation">&#123;</span>            c <span class="token operator">&lt;-</span> <span class="token function">doWork</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>        <span class="token function">close</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> c<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">doWork</span><span class="token punctuation">(</span>n <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//...执行一些操作...</span>    <span class="token keyword">return</span> n<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>在以上扇出的例子中，<code>input</code>是输入channel，在<code>fanOut</code>函数中，我们根据<code>workerCount</code>创建相同数量的Worker来处理输入信息。每个Worker处理的任务是从输入channel读取信息，然后进行一些工作（在<code>doWork</code>函数中定义），然后将信息写入自己的输出channel中。Workers的输出channel会被添加到<code>outputs</code>切片中，并从<code>fanOut</code>函数返回。</p><h3 id="1-6-3-扇入扇出分别对应的应用场景">1.6.3  扇入扇出分别对应的应用场景</h3><p>扇入和扇出的概念常用在处理并发和流处理系统中，它们各自有一些常见的应用场景：</p><p><strong>（1）扇入（Fan-In）</strong><br>扇入是将来自多个源的数据聚合到一个通道中，这种方式常用于多个并行或异步任务完成时集中处理结果，如：</p><ol><li>对来自多个源的日志或状态更新聚合到一个处理者，以实现统一的日志记录、分析或监控。</li><li>在分布式计算的上下文中，多个节点可能正在并行处理任务，并在完成时将结果发送回中央节点以进行聚合和处理。</li></ol><p><strong>（2）扇出（Fan-Out）</strong><br>扇出是将数据从一个源分发到多个接收者的过程，每个接收者都会得到完整的数据拷贝，扇出可以提高处理或任务的吞吐量。具体应用可能包括：</p><ol><li>在负载均衡的上下文中，扇出通常用作一种将任务分发到多个工作节点的手段以提高整体处理速度，每个节点处理部分工作负载。</li><li>在自然语言处理或图像处理等领域，可以使用扇出来并行训练或运行多个模型，然后比较各自的输出以确定最优解。</li><li>扇出模式还可以用于数据备份和冗余存储的场景。比如，我们可以将一个流量的数据同时发送到多个存储节点，以此达到数据的备份和冗余保障。</li></ol><h2 id="1-7-通知退出机制">1.7  通知退出机制</h2><p>读取己经关闭的通道不会引起阻塞，也不会导致 panic ，而是立即返回该通道存储类型的零值。关闭 select 监听的某个通道能使 select 立即感知这种通知，然后进行相应的处理，这就是所谓的退出通知机制（close channel to broadcast ）。下面通过一个随机数生成器的示例演示退出通知机制，下游的消费者不需要随机数时，显式地通知生产者停止生产。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// GenerateintA 是一个随机数生成器</span><span class="token keyword">func</span> <span class="token function">GenerateintA</span><span class="token punctuation">(</span>done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>Label<span class="token punctuation">:</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>done<span class="token punctuation">:</span><span class="token keyword">break</span> Label<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>ch <span class="token operator">:=</span> <span class="token function">GenerateintA</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span><span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"NumGoroutine="</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">NumGoroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 输出结果</span><span class="token number">146870834388028874</span><span class="token number">7216694335601338127</span><span class="token number">0</span><span class="token number">0</span>NumGoroutine<span class="token operator">=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="1-8-并发范式">1.8  并发范式</h2><p>通过具体的程序示例来演示 Go 语言强大的并发处理能力，每个示例代表一个并发处理范式，这些范式具有典型的特征，在真实的程序中稍加改造就能使用。</p><h3 id="1-8-1-生成器">1.8.1   生成器</h3><p>在应用系统编程中，常见的应用场景就是调用一个统一的全局的生成器服务， 用于生成全局事务号、订单号、序列号和随机数等。 Go 对这种场景的支持非常简单，下面以一个随机数生成器为例来说明。</p><ol><li>最简单的带缓冲的生成器。  例如：</li></ol><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// RandomNumber 是一个随机数生成器</span><span class="token keyword">func</span> <span class="token function">RandomNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// 启动一个 go routine 用于生成随机数，函数返回一个通道用于获取随机数</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">&lt;-</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">RandomNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 输出结果</span><span class="token number">8442295699646266936</span><span class="token number">6343099628820528177</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ol start="2"><li>多个 goroutine 增强型生成器。  例如：</li></ol><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// RandomNumber1 是一个随机数生成器</span><span class="token keyword">func</span> <span class="token function">RandomNumber1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token comment">// 启动一个 go routine 用于生成随机数，函数返回一个通道用于获取随机数</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">&lt;-</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token punctuation">&#125;</span><span class="token comment">// RandomNumber2 是一个随机数生成器</span><span class="token keyword">func</span> <span class="token function">RandomNumber2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token comment">// 启动一个 go routine 用于生成随机数，函数返回一个通道用于获取随机数</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">&lt;-</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">GenerateInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token operator">&lt;-</span><span class="token function">RandomNumber1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> <span class="token operator">&lt;-</span><span class="token function">RandomNumber2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> ch<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ch <span class="token operator">:=</span> <span class="token function">GenerateInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 输出结果</span><span class="token number">4732711589376798349</span><span class="token number">5980361011433472918</span><span class="token number">8507484322095864034</span><span class="token operator">...</span><span class="token operator">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-8-2-管道">1.8.2   管道</h3><p>通道可以分为两个方向，一个是读，另一个是写，假如一个函数的输入参数和输出参数都是相同的 chan 类型， 则该函数可以调用自己，最终形成一个调用链。当然多个具有相同参数类型的函数也能组成一个调用链，这很像 UNIX 系统的管道，是一个有类型的管道。</p><p>下面通过具体的示例演示 Go 程序这种链式处理能力：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span>  main <span class="token keyword">import</span> <span class="token punctuation">(</span> <span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token comment">// chain 函数的输入参数和输出参数类型相同，都是 chan int 类型</span><span class="token comment">// chain 函数的功能是将 chan 内的数据统一加1</span><span class="token keyword">func</span> <span class="token function">chain</span><span class="token punctuation">(</span>in <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>     out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> in<span class="token punctuation">&#123;</span>            out <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token operator">+</span> v        <span class="token punctuation">&#125;</span>        <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> out<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    in <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>         in <span class="token operator">&lt;-</span> i        <span class="token punctuation">&#125;</span>         <span class="token function">close</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 连续调用 3 次 chan，相当于把 in 中的每个元素都加 3</span>    out <span class="token operator">:=</span> <span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token function">chain</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> out <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-8-3-每个请求一个-goroutine">1.8.3   每个请求一个  goroutine</h3><p>下面以计算 100 个自然数的和来举例，将计算任务拆分为多个 task，每个 task 启动一个 goroutine 进行处理，程序示例代码如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token punctuation">)</span><span class="token comment">// 工作任务</span><span class="token keyword">type</span> task <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>begin  <span class="token builtin">int</span>end    <span class="token builtin">int</span>result <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">// 任务执行:计算 begin 到 end 的和</span><span class="token comment">// 执行结果写入到结果 chan result 中</span><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>task<span class="token punctuation">)</span> <span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token operator">:=</span> t<span class="token punctuation">.</span>begin<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> t<span class="token punctuation">.</span>end<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> i<span class="token punctuation">&#125;</span>t<span class="token punctuation">.</span>result <span class="token operator">&lt;-</span> sum<span class="token punctuation">&#125;</span><span class="token comment">// 构建 task 并写入到 task 通道</span><span class="token keyword">func</span> <span class="token function">InitTask</span><span class="token punctuation">(</span>taskchan <span class="token keyword">chan</span><span class="token operator">&lt;-</span> task<span class="token punctuation">,</span> r <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> p <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>qu <span class="token operator">:=</span> p <span class="token operator">/</span> <span class="token number">10</span>mod <span class="token operator">:=</span> p <span class="token operator">%</span> <span class="token number">10</span>high <span class="token operator">:=</span> qu <span class="token operator">*</span> <span class="token number">10</span><span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> qu<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>b <span class="token operator">:=</span> <span class="token number">10</span><span class="token operator">*</span>j <span class="token operator">+</span> <span class="token number">1</span>e <span class="token operator">:=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>tsk <span class="token operator">:=</span> task<span class="token punctuation">&#123;</span>begin<span class="token punctuation">:</span>  b<span class="token punctuation">,</span>end<span class="token punctuation">:</span>    e<span class="token punctuation">,</span>result<span class="token punctuation">:</span> r<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>taskchan <span class="token operator">&lt;-</span> tsk<span class="token punctuation">&#125;</span><span class="token keyword">if</span> mod <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>tsk <span class="token operator">:=</span> task<span class="token punctuation">&#123;</span>begin<span class="token punctuation">:</span>  high <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>end<span class="token punctuation">:</span>    p<span class="token punctuation">,</span>result<span class="token punctuation">:</span> r<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>taskchan <span class="token operator">&lt;-</span> tsk<span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 读取 task chan ,每个 task 一个 worker goroutine 处理</span><span class="token comment">// 并等待每个 task 运行完，关闭结果通道</span><span class="token keyword">func</span> <span class="token function">DistributeTask</span><span class="token punctuation">(</span>taskchan <span class="token operator">&lt;-</span><span class="token keyword">chan</span> task<span class="token punctuation">,</span> wait <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">,</span> result <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> taskchan <span class="token punctuation">&#123;</span>wait<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">ProcessTask</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>wait<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">close</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 工作 goroutine 处理具体工作，并将处理结构发送到结果通道</span><span class="token keyword">func</span> <span class="token function">ProcessTask</span><span class="token punctuation">(</span>t task<span class="token punctuation">,</span> wait <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>t<span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>wait<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 读取结果通道，汇总结果</span><span class="token keyword">func</span> <span class="token function">ProcessResult</span><span class="token punctuation">(</span>resultchan <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> resultchan <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> r<span class="token punctuation">&#125;</span><span class="token keyword">return</span> sum<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 创建任务通道</span>taskchan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> task<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// 创建结果通道</span>resultchan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// wait 用于同步等待任务的执行</span>wait <span class="token operator">:=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// 初始化 task 的 goroutine,计算 100 个自然数之和</span><span class="token keyword">go</span> <span class="token function">InitTask</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">,</span> resultchan<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token comment">//每个 task 启动一个 goroutine 处理，</span><span class="token keyword">go</span> <span class="token function">DistributeTask</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> resultchan<span class="token punctuation">)</span><span class="token comment">// 通过结果通道获取结果并汇总</span>sum <span class="token operator">:=</span> <span class="token function">ProcessResult</span><span class="token punctuation">(</span>resultchan<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"sum="</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 结果</span>sum<span class="token operator">=</span>  <span class="token number">5050</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>程序的逻辑分析：<br>（1）InitTask 函数构建 task 并发送到 task 通道中；<br>（2）分发任务函数 DistributeTask 为每个 task 启动一个 goroutine 处理任务，   等待其处理完成， 然后关闭结果通道；<br>（3）ProcessResult 函数读取并统计所有的结果。这几个函数分别在不同的 goroutine 中运行，  它们通过通道和sync.WaitGroup 进行通信和同步；</p><h3 id="1-8-4-固定-worker-工作池">1.8.4   固定 worker 工作池</h3><p>服务器编程中使用最多的就是通过线程池来提升服务的井发处理能力。在 Go 语言编程中，<br>一样可以轻松地构建固定数目的 goroutines 作为工作线程池。下面还是以计算多个整数的和为例来说明这种并发范式。程序中除了主要的 main goroutine ，还开启了如下几类 goroutine:<br>（1）初始化任务的 goroutme；<br>（2）分发任务的 goroutine；<br>（3）等待所有 worker 结束通知，然后关闭结果通道的 goroutine；<br>main 函数负责拉起上述 goroutine ，并从结果通道获取最终的结果；<br>程序采用三个通道，分别是：<br>（1）传递 task 任务的通道；<br>（2）传递 task 结果的通道；<br>（3）接收 worker 处理完任务后所发送通知的通道；<br>相关的代码如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token comment">// 工作池的 goroutine 数目</span><span class="token keyword">const</span> <span class="token punctuation">(</span>NUMBER <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// 工作任务</span><span class="token keyword">type</span> task <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>begin  <span class="token builtin">int</span>end    <span class="token builtin">int</span>result <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">// 任务处理:计算 begin 到 end 的和</span><span class="token comment">// 执行结果写入到结果 chan result 中</span><span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>task<span class="token punctuation">)</span> <span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token operator">:=</span> t<span class="token punctuation">.</span>begin<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> t<span class="token punctuation">.</span>end<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> i<span class="token punctuation">&#125;</span>t<span class="token punctuation">.</span>result <span class="token operator">&lt;-</span> sum<span class="token punctuation">&#125;</span><span class="token comment">// 初始化待处理 task chan</span><span class="token keyword">func</span> <span class="token function">InitTask</span><span class="token punctuation">(</span>taskchan <span class="token keyword">chan</span><span class="token operator">&lt;-</span> task<span class="token punctuation">,</span> r <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> p <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>qu <span class="token operator">:=</span> p <span class="token operator">/</span> <span class="token number">10</span>mod <span class="token operator">:=</span> p <span class="token operator">%</span> <span class="token number">10</span>high <span class="token operator">:=</span> qu <span class="token operator">*</span> <span class="token number">10</span><span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> qu<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>b <span class="token operator">:=</span> <span class="token number">10</span><span class="token operator">*</span>j <span class="token operator">+</span> <span class="token number">1</span>e <span class="token operator">:=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>tsk <span class="token operator">:=</span> task<span class="token punctuation">&#123;</span>begin<span class="token punctuation">:</span>  b<span class="token punctuation">,</span>end<span class="token punctuation">:</span>    e<span class="token punctuation">,</span>result<span class="token punctuation">:</span> r<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>taskchan <span class="token operator">&lt;-</span> tsk<span class="token punctuation">&#125;</span><span class="token keyword">if</span> mod <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>tsk <span class="token operator">:=</span> task<span class="token punctuation">&#123;</span>begin<span class="token punctuation">:</span>  high <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>end<span class="token punctuation">:</span>    p<span class="token punctuation">,</span>result<span class="token punctuation">:</span> r<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>taskchan <span class="token operator">&lt;-</span> tsk<span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 读取 task chan 分发到 worker goroutine 处理，workers 的总的数量是 workers</span><span class="token keyword">func</span> <span class="token function">DistributeTask</span><span class="token punctuation">(</span>taskchan <span class="token operator">&lt;-</span><span class="token keyword">chan</span> task<span class="token punctuation">,</span> workers <span class="token builtin">int</span><span class="token punctuation">,</span> done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">go</span> <span class="token function">ProcessTask</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 工作 goroutine 处理具体工作，并将处理结构发送到结果 chan</span><span class="token keyword">func</span> <span class="token function">ProcessTask</span><span class="token punctuation">(</span>taskchan <span class="token operator">&lt;-</span><span class="token keyword">chan</span> task<span class="token punctuation">,</span> done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> t <span class="token operator">:=</span> <span class="token keyword">range</span> taskchan <span class="token punctuation">&#123;</span>t<span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>done <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 通过 done channel 来同步等待所有工作 goroutine 的结束，然后关闭结果 chan</span><span class="token keyword">func</span> <span class="token function">CloseResult</span><span class="token punctuation">(</span>done <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> resultchan <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> workers <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> workers<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token operator">&lt;-</span>done<span class="token punctuation">&#125;</span><span class="token function">close</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token function">close</span><span class="token punctuation">(</span>resultchan<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 读取结果通道，汇总结果</span><span class="token keyword">func</span> <span class="token function">ProcessResult</span><span class="token punctuation">(</span>resultchan <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> resultchan <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> r<span class="token punctuation">&#125;</span><span class="token keyword">return</span> sum<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>workers <span class="token operator">:=</span> NUMBER<span class="token comment">// 工作通道</span>taskchan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> task<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// 结果通道</span>resultchan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// worker 信号通道</span>done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">// 初始化 task 的 goroutine,计算 1000 个自然数之和</span><span class="token keyword">go</span> <span class="token function">InitTask</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">,</span> resultchan<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token comment">// 分发任务在 NUMBER 个 goroutine 池</span><span class="token function">DistributeTask</span><span class="token punctuation">(</span>taskchan<span class="token punctuation">,</span> workers<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token comment">// 获取各个 goroutine 处理完任务的通知，并关闭结果通道</span><span class="token keyword">go</span> <span class="token function">CloseResult</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> resultchan<span class="token punctuation">,</span> workers<span class="token punctuation">)</span><span class="token comment">// 通过结果通道处理结果</span>sum <span class="token operator">:=</span> <span class="token function">ProcessResult</span><span class="token punctuation">(</span>resultchan<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"sum="</span><span class="token punctuation">,</span> sum<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 结果</span>sum<span class="token operator">=</span>  <span class="token number">5050</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>程序的逻辑分析：<br>（1）构建 task 并发送到 task 通道中；<br>（2）分别启动 n 个工作线程，不停地从 task 通道中获取任务，然后将结果写入结果通道。如果任务通道被关闭，则负责向收敛结果的 goroutine 发送通知，告诉其当前 worker 已经完成工作；<br>（3）收敛结果的 goroutine 接收到所有 task 己经处理完毕的信号后，主动关闭结果通道；<br>（4）main 中的函数 ProcessResult 读取并统计所有的结果；</p><h3 id="1-8-5-future-模式">1.8.5  future 模式</h3><p>编程中经常遇到在一个流程中需要调用多个子调用的情况，这些子调用相互之间没有依赖，如果串行地调用，则耗时会很长，此时可以使用 Go 并发编程中的 future 模式。<br>future 模式的基本工作原理：<br>（1）使用 chan 作为函数参数；<br>（2）启动 goroutine 调用函数；<br>（3）通过 chan 传入参数；<br>（4）做其他可以并行处理的事情；<br>（5）通过 chan 异步获取结果；<br>下面通过一段抽象的代码来学习该模式：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// 一个查询结构体</span><span class="token comment">// 这里的 sql 和 result 是一个简单的抽象，具体的应用，可能是更复杂的数据类型</span><span class="token keyword">type</span> query <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token comment">// 参数 Channel</span>sql <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token comment">// 结果 Channel</span>result <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token comment">// 执行 Query</span><span class="token keyword">func</span> <span class="token function">execQuery</span><span class="token punctuation">(</span>q query<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 启动协程</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 获取输入</span>sql <span class="token operator">:=</span> <span class="token operator">&lt;-</span>q<span class="token punctuation">.</span>sql<span class="token comment">// 访问数据库</span><span class="token comment">// 输出结果通道</span>q<span class="token punctuation">.</span>result <span class="token operator">&lt;-</span> <span class="token string">"result from "</span> <span class="token operator">+</span> sql<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 初始化 Query</span>q <span class="token operator">:=</span> query<span class="token punctuation">&#123;</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 执行 Query，注意执行的时候无需准备参数</span><span class="token keyword">go</span> <span class="token function">execQuery</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token comment">//准备参数</span>q<span class="token punctuation">.</span>sql <span class="token operator">&lt;-</span> <span class="token string">"select * from table;"</span><span class="token comment">// do otherthings</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token comment">//获取结果</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>q<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>future 最大的好处是将函数的同步调用转换为异步调用，   适用于一个交易需要多个子调用且这些子调用没有依赖的场景。 实际情况可能比上面示例复杂得多，要考虑错误和异常的处理。</p>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>regexp2</title>
    <link href="/2022/06/23/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20regexp2/"/>
    <url>/2022/06/23/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20regexp2/</url>
    
    <content type="html"><![CDATA[<h1 id="21-regexp2">21.regexp2</h1><h2 id="01-regexp2">01.regexp2</h2><ul><li>Regexp2：<a href="https://blog.csdn.net/dianxin113/article/details/118769094">https://blog.csdn.net/dianxin113/article/details/118769094</a></li><li>GitHub：<a href="https://github.com/dlclark/regexp2">https://github.com/dlclark/regexp2</a></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/dlclark/regexp2"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">Regexp2GroupMatch</span><span class="token punctuation">(</span>m <span class="token operator">*</span>regexp2<span class="token punctuation">.</span>Match<span class="token punctuation">,</span> re <span class="token operator">*</span>regexp2<span class="token punctuation">.</span>Regexp<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> matches <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token keyword">for</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> ret <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>gps <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">Groups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> g <span class="token operator">:=</span> <span class="token keyword">range</span> gps <span class="token punctuation">&#123;</span><span class="token keyword">if</span> index <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">&#125;</span>ret <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ret<span class="token punctuation">,</span> g<span class="token punctuation">.</span>Captures<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>matches <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> ret<span class="token punctuation">)</span>m<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token function">FindNextMatch</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> matches<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">CompileRegexp</span><span class="token punctuation">(</span>regex <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>regexp2<span class="token punctuation">.</span>Regexp<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>msgRegexp<span class="token punctuation">,</span> e <span class="token operator">:=</span> regexp2<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">if</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> msgRegexp<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">:=</span> <span class="token string">"2022-8-12 2023-8-11"</span>expr <span class="token operator">:=</span> <span class="token string">"(\\d&#123;4&#125;)-(\\d&#123;1,2&#125;)-(\\d&#123;1,2&#125;)"</span> <span class="token comment">// [[2022 8 12]]</span>reg<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">CompileRegexp</span><span class="token punctuation">(</span>expr<span class="token punctuation">)</span>m<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> reg<span class="token punctuation">.</span><span class="token function">FindStringMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>ret <span class="token operator">:=</span> <span class="token function">Regexp2GroupMatch</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> reg<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token comment">// [[2022 8 12] [2023 8 11]]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>machinery</title>
    <link href="/2022/06/22/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20machinery/"/>
    <url>/2022/06/22/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20machinery/</url>
    
    <content type="html"><![CDATA[<h1 id="20-machinery">20.machinery</h1><h2 id="01-异步框架machinery">01.异步框架machinery</h2><ul><li><a href="https://github.com/RichardKnop/machinery">github地址(opens new window)</a></li></ul><h3 id="1-1-machinery介绍">1.1 machinery介绍</h3><ul><li>go machinery框架类似python中常用celery框架，主要用于 异步任务和定时任务，有一下特性<ul><li>任务重试机制</li><li>延迟任务支持</li><li>任务回调机制</li><li>任务结果记录</li><li>支持Workflow模式：Chain，Group，Chord</li><li>多Brokers支持：Redis, AMQP, <a href="https://link.segmentfault.com/?enc=DHe3inPV2HBq6uxnZ2CEOg%3D%3D.XhC%2BOAXOeJgqueAZ3HrM4nnCWizYNVCgbJcSKS7%2BsPE%3D">AWS SQS(opens new window)</a></li><li>多Backends支持：Redis, Memcache, AMQP, <a href="https://link.segmentfault.com/?enc=s1hIwqlq%2BqzLK6uutFwrfg%3D%3D.LOQSm2d600WNtAuHuxnSX%2B%2B%2F1hm1iNUspqC1IcqZPCrXnAQ23jRJTDMUunMDFawu2mQXughrPBtdSeR7f1l45w%3D%3D">MongoDB(opens new window)</a></li></ul></li></ul><h3 id="1-2-架构">1.2 架构</h3><ul><li>任务队列，简而言之就是一个放大的生产者消费者模型</li><li>用户请求会生成任务，队列的处理器程序充当消费者不断的消费任务。</li><li>基于这种框架设计思想，我们来看下machinery的简单设计结构图例<ul><li>Sender：业务推送模块，生成具体任务，可根据业务逻辑中，按交互进行拆分；</li><li>Broker：存储具体序列化后的任务，machinery中目前支持到Redis, AMQP,和SQS；</li><li>Worker：工作进程，负责消费者功能，处理具体的任务；</li><li>Backend：后端存储，用于存储任务执行状态的数据；</li></ul></li></ul><p><img src="/img/image-20220206111846252.6cdeba77.png" alt=""></p><h2 id="02-machinery使用">02.machinery使用</h2><h3 id="2-1-异步和定时任务">2.1 异步和定时任务</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span>redisbackend <span class="token string">"github.com/RichardKnop/machinery/v2/backends/redis"</span>redisbroker <span class="token string">"github.com/RichardKnop/machinery/v2/brokers/redis"</span>eagerlock <span class="token string">"github.com/RichardKnop/machinery/v2/locks/eager"</span><span class="token string">"github.com/RichardKnop/machinery/v2"</span><span class="token string">"github.com/RichardKnop/machinery/v2/config"</span><span class="token string">"github.com/RichardKnop/machinery/v2/tasks"</span><span class="token string">"os"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"worker"</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 启动worker</span><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token function">TestPeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 触发一个定时任务（定时任务由客户端控制，客户端退出定时就会结束）</span><span class="token function">TestAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           <span class="token comment">// 触发一个异步任务</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/* 触发执行Add异步任务 */</span><span class="token keyword">func</span> <span class="token function">TestAdd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>server<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 调用异步任务 Add 函数，执行 1+4=5这个逻辑</span>signature <span class="token operator">:=</span> <span class="token operator">&amp;</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"add"</span><span class="token punctuation">,</span>Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tasks<span class="token punctuation">.</span>Arg<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>Type<span class="token punctuation">:</span>  <span class="token string">"int64"</span><span class="token punctuation">,</span>Value<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>Type<span class="token punctuation">:</span>  <span class="token string">"int64"</span><span class="token punctuation">,</span>Value<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>asyncResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">SendTask</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span>        <span class="token comment">// 任务可以通过将Signature的实例传递给Server实例来调用</span>results<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> asyncResult<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment">// 您还可以执行同步阻塞调用来等待任务结果</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> result <span class="token operator">:=</span> <span class="token keyword">range</span> results <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/* 触发执行periodicTask异步任务 */</span><span class="token keyword">func</span> <span class="token function">TestPeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>server<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>signature <span class="token operator">:=</span> <span class="token operator">&amp;</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"periodicTask"</span><span class="token punctuation">,</span>Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tasks<span class="token punctuation">.</span>Arg<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 每分钟执行一次periodicTask函数，验证发现不支持秒级别定时任务</span>err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">RegisterPeriodicTask</span><span class="token punctuation">(</span><span class="token string">"*/1 * * * ?"</span><span class="token punctuation">,</span> <span class="token string">"periodic-task"</span><span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>asyncResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">SendTask</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>asyncResult<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第一：配置Server并注册任务</span><span class="token keyword">func</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>machinery<span class="token punctuation">.</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cnf <span class="token operator">:=</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>DefaultQueue<span class="token punctuation">:</span>    <span class="token string">"machinery_tasks"</span><span class="token punctuation">,</span>ResultsExpireIn<span class="token punctuation">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>Redis<span class="token punctuation">:</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>RedisConfig<span class="token punctuation">&#123;</span>MaxIdle<span class="token punctuation">:</span>                <span class="token number">3</span><span class="token punctuation">,</span>IdleTimeout<span class="token punctuation">:</span>            <span class="token number">240</span><span class="token punctuation">,</span>ReadTimeout<span class="token punctuation">:</span>            <span class="token number">15</span><span class="token punctuation">,</span>WriteTimeout<span class="token punctuation">:</span>           <span class="token number">15</span><span class="token punctuation">,</span>ConnectTimeout<span class="token punctuation">:</span>         <span class="token number">15</span><span class="token punctuation">,</span>NormalTasksPollPeriod<span class="token punctuation">:</span>  <span class="token number">1000</span><span class="token punctuation">,</span>DelayedTasksPollPeriod<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 创建服务器实例</span>broker <span class="token operator">:=</span> redisbroker<span class="token punctuation">.</span><span class="token function">NewGR</span><span class="token punctuation">(</span>cnf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"localhost:6379"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>backend <span class="token operator">:=</span> redisbackend<span class="token punctuation">.</span><span class="token function">NewGR</span><span class="token punctuation">(</span>cnf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"localhost:6379"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>lock <span class="token operator">:=</span> eagerlock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>server <span class="token operator">:=</span> machinery<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>cnf<span class="token punctuation">,</span> broker<span class="token punctuation">,</span> backend<span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token comment">// 注册异步任务</span>tasksMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token string">"add"</span><span class="token punctuation">:</span>               Add<span class="token punctuation">,</span><span class="token string">"periodicTask"</span><span class="token punctuation">:</span>      PeriodicTask<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> server<span class="token punctuation">,</span> server<span class="token punctuation">.</span><span class="token function">RegisterTasks</span><span class="token punctuation">(</span>tasksMap<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二步：启动Worker</span><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span><span class="token comment">//消费者的标记</span>consumerTag <span class="token operator">:=</span> <span class="token string">"machinery_worker"</span>server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span><span class="token comment">//第二个参数并发数, 0表示不限制</span>worker <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">NewWorker</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//钩子函数</span>errorhandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>pretaskhandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>signature <span class="token operator">*</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>posttaskhandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>signature <span class="token operator">*</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>worker<span class="token punctuation">.</span><span class="token function">SetPostTaskHandler</span><span class="token punctuation">(</span>posttaskhandler<span class="token punctuation">)</span>worker<span class="token punctuation">.</span><span class="token function">SetErrorHandler</span><span class="token punctuation">(</span>errorhandler<span class="token punctuation">)</span>worker<span class="token punctuation">.</span><span class="token function">SetPreTaskHandler</span><span class="token punctuation">(</span>pretaskhandler<span class="token punctuation">)</span><span class="token keyword">return</span> worker<span class="token punctuation">.</span><span class="token function">Launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第三步：添加异步执行函数</span><span class="token keyword">func</span> <span class="token function">Add</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"############# 执行Add方法 #############"</span><span class="token punctuation">)</span>sum <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> arg<span class="token punctuation">&#125;</span><span class="token keyword">return</span> sum<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token comment">// 第四步：添加一个周期性任务</span><span class="token keyword">func</span> <span class="token function">PeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"################ 执行周期任务PeriodicTask #################"</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-启动服务并发送任务">2.2 启动服务并发送任务</h3><blockquote><ul><li>go run main.go worker // 启动worker服务</li><li>go run main.go // 发送任务到worker</li></ul></blockquote><p><img src="/img/image-20220206111935400.8a7a4509.png" alt=""></p><h2 id="03-gin-machinery">03.gin+machinery</h2><h3 id="3-0-项目结构">3.0 项目结构</h3><blockquote><p>go run main.go // 直接执行即可测试</p></blockquote><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">xiaonaiqiang1@ZBMac<span class="token operator">-</span>C02CW08SM work <span class="token operator">%</span> tree ginWorker ginWorker├── main<span class="token punctuation">.</span><span class="token keyword">go</span>   <span class="token comment">// 项目入库</span>└── pkg    └── task        ├── server<span class="token punctuation">.</span><span class="token keyword">go</span>     <span class="token comment">// machinery服务初始化</span>        ├── start<span class="token punctuation">.</span><span class="token keyword">go</span>      <span class="token comment">// 启动异步任务入口</span>        ├── cronJobs<span class="token punctuation">.</span><span class="token keyword">go</span>   <span class="token comment">// 触发周期性任务</span>        ├── sendJobs<span class="token punctuation">.</span><span class="token keyword">go</span>   <span class="token comment">// 触发异任务</span>        └── workers            └── tasks<span class="token punctuation">.</span><span class="token keyword">go</span>   <span class="token comment">// 定义执行任务函数</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-1-main-go">3.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"ginWorker/pkg/task"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token keyword">go</span> task<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 启动异步任务worker</span><span class="token keyword">go</span> task<span class="token punctuation">.</span><span class="token function">StartCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 启动定时任务</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/add"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>task<span class="token punctuation">.</span><span class="token function">TaskAdd</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>   <span class="token comment">// 测试执行异步任务</span>c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"hello word"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"http://127.0.0.1:8000"</span><span class="token punctuation">)</span><span class="token comment">//监听端口默认为8080</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8000"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-pkg-task-server-go">3.2 pkg/task/server.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> task<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"ginWorker/pkg/task/workers"</span><span class="token string">"github.com/RichardKnop/machinery/v2"</span>redisbackend <span class="token string">"github.com/RichardKnop/machinery/v2/backends/redis"</span>redisbroker <span class="token string">"github.com/RichardKnop/machinery/v2/brokers/redis"</span><span class="token string">"github.com/RichardKnop/machinery/v2/config"</span>eagerlock <span class="token string">"github.com/RichardKnop/machinery/v2/locks/eager"</span><span class="token string">"github.com/RichardKnop/machinery/v2/tasks"</span><span class="token punctuation">)</span><span class="token keyword">var</span> AsyncTaskCenter <span class="token operator">*</span>machinery<span class="token punctuation">.</span>Server<span class="token comment">// 第一：配置Server并注册任务</span><span class="token keyword">func</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>machinery<span class="token punctuation">.</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cnf <span class="token operator">:=</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>DefaultQueue<span class="token punctuation">:</span>    <span class="token string">"machinery_tasks"</span><span class="token punctuation">,</span>ResultsExpireIn<span class="token punctuation">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>Redis<span class="token punctuation">:</span> <span class="token operator">&amp;</span>config<span class="token punctuation">.</span>RedisConfig<span class="token punctuation">&#123;</span>MaxIdle<span class="token punctuation">:</span>                <span class="token number">3</span><span class="token punctuation">,</span>IdleTimeout<span class="token punctuation">:</span>            <span class="token number">240</span><span class="token punctuation">,</span>ReadTimeout<span class="token punctuation">:</span>            <span class="token number">15</span><span class="token punctuation">,</span>WriteTimeout<span class="token punctuation">:</span>           <span class="token number">15</span><span class="token punctuation">,</span>ConnectTimeout<span class="token punctuation">:</span>         <span class="token number">15</span><span class="token punctuation">,</span>NormalTasksPollPeriod<span class="token punctuation">:</span>  <span class="token number">1000</span><span class="token punctuation">,</span>DelayedTasksPollPeriod<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 创建服务器实例</span>broker <span class="token operator">:=</span> redisbroker<span class="token punctuation">.</span><span class="token function">NewGR</span><span class="token punctuation">(</span>cnf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"localhost:6379"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>backend <span class="token operator">:=</span> redisbackend<span class="token punctuation">.</span><span class="token function">NewGR</span><span class="token punctuation">(</span>cnf<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"localhost:6379"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>lock <span class="token operator">:=</span> eagerlock<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>server <span class="token operator">:=</span> machinery<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span>cnf<span class="token punctuation">,</span> broker<span class="token punctuation">,</span> backend<span class="token punctuation">,</span> lock<span class="token punctuation">)</span>tasksMap <span class="token operator">:=</span> <span class="token function">initAsyncTaskMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>AsyncTaskCenter <span class="token operator">=</span> server<span class="token keyword">return</span> server<span class="token punctuation">,</span> server<span class="token punctuation">.</span><span class="token function">RegisterTasks</span><span class="token punctuation">(</span>tasksMap<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二步：启动Worker</span><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>consumerTag <span class="token operator">:=</span> <span class="token string">"machinery_worker"</span><span class="token comment">//消费者的标记</span>server<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> err<span class="token punctuation">&#125;</span>worker <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">NewWorker</span><span class="token punctuation">(</span>consumerTag<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//第二个参数并发数, 0表示不限制</span><span class="token comment">//钩子函数</span>errorhandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>pretaskhandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>signature <span class="token operator">*</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>posttaskhandler <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>signature <span class="token operator">*</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>worker<span class="token punctuation">.</span><span class="token function">SetPostTaskHandler</span><span class="token punctuation">(</span>posttaskhandler<span class="token punctuation">)</span>worker<span class="token punctuation">.</span><span class="token function">SetErrorHandler</span><span class="token punctuation">(</span>errorhandler<span class="token punctuation">)</span>worker<span class="token punctuation">.</span><span class="token function">SetPreTaskHandler</span><span class="token punctuation">(</span>pretaskhandler<span class="token punctuation">)</span><span class="token keyword">return</span> worker<span class="token punctuation">.</span><span class="token function">Launch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第三步：注册函数</span><span class="token keyword">func</span> <span class="token function">initAsyncTaskMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>tasksMap <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token string">"add"</span><span class="token punctuation">:</span>               workers<span class="token punctuation">.</span>Add<span class="token punctuation">,</span><span class="token string">"periodicTask"</span><span class="token punctuation">:</span>      workers<span class="token punctuation">.</span>PeriodicTask<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> tasksMap<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3-pkg-task-start-go">3.3 pkg/task/start.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> task<span class="token keyword">func</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 启动worker</span><span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 启动周期性任务</span><span class="token keyword">func</span> <span class="token function">StartCron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token function">TestPeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-4-pkg-task-cronJobs-go">3.4 pkg/task/cronJobs.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> task<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/RichardKnop/machinery/v2/tasks"</span><span class="token punctuation">)</span><span class="token comment">/* 触发执行periodicTask异步任务 */</span><span class="token keyword">func</span> <span class="token function">TestPeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>server<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>signature <span class="token operator">:=</span> <span class="token operator">&amp;</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"periodicTask"</span><span class="token punctuation">,</span>Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tasks<span class="token punctuation">.</span>Arg<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 每分钟执行一次periodicTask函数，验证发现不支持秒级别定时任务</span>err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">RegisterPeriodicTask</span><span class="token punctuation">(</span><span class="token string">"*/1 * * * ?"</span><span class="token punctuation">,</span> <span class="token string">"periodic-task"</span><span class="token punctuation">,</span> signature<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>asyncResult<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">SendTask</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>asyncResult<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-5-pkg-task-sendJobs-go">3.5 pkg/task/sendJobs.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> task<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/RichardKnop/machinery/v2/tasks"</span><span class="token punctuation">)</span><span class="token comment">/* 触发执行Add异步任务 */</span><span class="token keyword">func</span> <span class="token function">TaskAdd</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b <span class="token builtin">int64</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>signature <span class="token operator">:=</span> <span class="token operator">&amp;</span>tasks<span class="token punctuation">.</span>Signature<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"add"</span><span class="token punctuation">,</span>Args<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>tasks<span class="token punctuation">.</span>Arg<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>Type<span class="token punctuation">:</span>  <span class="token string">"int64"</span><span class="token punctuation">,</span>Value<span class="token punctuation">:</span> a<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span>Type<span class="token punctuation">:</span>  <span class="token string">"int64"</span><span class="token punctuation">,</span>Value<span class="token punctuation">:</span> b<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> AsyncTaskCenter<span class="token punctuation">.</span><span class="token function">SendTask</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span> <span class="token comment">// 任务可以通过将Signature的实例传递给Server实例来调用</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-6-pkg-task-workers-tasks-go">3.6 pkg/task/workers/tasks.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> workers<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// 添加异步执行函数</span><span class="token keyword">func</span> <span class="token function">Add</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"############# 执行Add方法 #############"</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>  <span class="token comment">// 模拟执行耗时任务</span>sum <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">&#123;</span>sum <span class="token operator">+=</span> arg<span class="token punctuation">&#125;</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"############# Add方法Done #############"</span><span class="token punctuation">)</span><span class="token keyword">return</span> sum<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token comment">// 添加一个周期性任务</span><span class="token keyword">func</span> <span class="token function">PeriodicTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"################ 执行周期任务PeriodicTask #################"</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-7-运行结果">3.7 运行结果</h3><ul><li><code>执行周期任务：每秒执行一次</code></li></ul><p><img src="/img/image-20220206112020324.6a282832.png" alt=""></p><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">通过接口触发异步任务</code></pre></div></figure><ul><li><a href="http://127.0.0.1:8000/add">http://127.0.0.1:8000/add</a></li></ul></li></ul><p><img src="/img/image-20220206112110293.6b3d47fc.png" alt=""></p>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>cron</title>
    <link href="/2022/06/21/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20cron/"/>
    <url>/2022/06/21/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20cron/</url>
    
    <content type="html"><![CDATA[<h1 id="19-cron定时">19.cron定时</h1><h2 id="01-cron基本使用">01.cron基本使用</h2><h3 id="1-1-使用举例">1.1 使用举例</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/robfig/cron"</span><span class="token punctuation">)</span><span class="token comment">//主函数</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cron2 <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//创建一个cron实例</span><span class="token comment">//执行定时任务（每5秒执行一次）</span>err<span class="token operator">:=</span> cron2<span class="token punctuation">.</span><span class="token function">AddFunc</span><span class="token punctuation">(</span><span class="token string">"*/5 * * * * *"</span><span class="token punctuation">,</span> print5<span class="token punctuation">)</span><span class="token keyword">if</span> err<span class="token operator">!=</span><span class="token boolean">nil</span><span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//启动/关闭</span>cron2<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> cron2<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//查询语句，保持程序运行，在这里等同于for&#123;&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//执行函数</span><span class="token keyword">func</span> <span class="token function">print5</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>     fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"每5s执行一次cron"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-配置">1.2 配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">┌─────────────second 范围 <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">60</span><span class="token punctuation">)</span>│ ┌───────────── min <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">59</span><span class="token punctuation">)</span>│ │ ┌────────────── hour <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">23</span><span class="token punctuation">)</span>│ │ │ ┌─────────────── day of month <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">31</span><span class="token punctuation">)</span>│ │ │ │ ┌──────────────── month <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">12</span><span class="token punctuation">)</span>│ │ │ │ │ ┌───────────────── day of week <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">6</span><span class="token punctuation">)</span>│ │ │ │ │ ││ │ │ │ │ │<span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-多个crontab任务">1.3 多个crontab任务</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/robfig/cron"</span><span class="token punctuation">)</span><span class="token keyword">type</span> TestJob <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>this TestJob<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"testJob1..."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Test2Job <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>this Test2Job<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"testJob2..."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//启动多个任务</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c <span class="token operator">:=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>spec <span class="token operator">:=</span> <span class="token string">"*/5 * * * * ?"</span><span class="token comment">//AddJob方法</span>c<span class="token punctuation">.</span><span class="token function">AddJob</span><span class="token punctuation">(</span>spec<span class="token punctuation">,</span> TestJob<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">AddJob</span><span class="token punctuation">(</span>spec<span class="token punctuation">,</span> Test2Job<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">//启动计划任务</span>c<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//关闭着计划任务, 但是不能关闭已经在执行中的任务.</span><span class="token keyword">defer</span> c<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*testJob1...testJob2...testJob1...testJob2...*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-gin框架cron应用">02.gin框架cron应用</h2><ul><li>目录结构</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token punctuation">.</span>├── main<span class="token punctuation">.</span><span class="token keyword">go</span>└── pkg    └── jobs        ├── job_cron<span class="token punctuation">.</span><span class="token keyword">go</span>    <span class="token comment">// 分布式任务配置</span>        └── test_task<span class="token punctuation">.</span><span class="token keyword">go</span>   <span class="token comment">// 具体任务实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-1-main-go">2.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"go_cron_demo/pkg/jobs"</span><span class="token string">"net/http"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>jobs<span class="token punctuation">.</span><span class="token function">InitJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8000"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-pkg-jobs-job-cron-go">2.2 pkg/jobs/job_cron.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> jobs<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/robfig/cron"</span><span class="token punctuation">)</span><span class="token keyword">var</span> mainCron <span class="token operator">*</span>cron<span class="token punctuation">.</span>Cron<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>mainCron <span class="token operator">=</span> cron<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>mainCron<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">InitJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 每5s钟调度一次，并传参</span>mainCron<span class="token punctuation">.</span><span class="token function">AddJob</span><span class="token punctuation">(</span><span class="token string">"*/5 * * * * ?"</span><span class="token punctuation">,</span>TestJob<span class="token punctuation">&#123;</span>Id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> Name<span class="token punctuation">:</span> <span class="token string">"zhangsan"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*  运行结果1 zhangsantestJob1...1 zhangsantestJob1...*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-pkg-jobs-test-task-go">2.3 pkg/jobs/test_task.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> jobs<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> TestJob <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Id   <span class="token builtin">int</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>this TestJob<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>this<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> this<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"testJob1..."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>logrus</title>
    <link href="/2022/06/20/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20logrus/"/>
    <url>/2022/06/20/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20logrus/</url>
    
    <content type="html"><![CDATA[<h1 id="18-logrus">18.logrus</h1><h2 id="01-logrus基础">01.logrus基础</h2><ul><li><a href="https://github.com/sirupsen/logrus">参考GitHub(opens new window)</a></li><li><a href="https://blog.51cto.com/u_15183360/2737283">参考博客1(opens new window)</a></li><li><a href="https://www.liwenzhou.com/posts/Go/go_logrus/">参考博客2(opens new window)</a></li><li>安装</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get github.com/sirupsen/logrus<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="1-1-简介">1.1 简介</h3><blockquote><p>Logrus是Go（golang）的结构化logger，与标准库logger完全API兼容，它有以下特点</p></blockquote><ul><li>完全兼容标准日志库，拥有七种日志级别：<code>Trace</code>, <code>Debug</code>, <code>Info</code>, <code>Warning</code>, <code>Error</code>, <code>Fatal</code>and <code>Panic</code>。</li><li>可扩展的Hook机制，允许使用者通过Hook的方式将日志分发到任意地方<ul><li>如本地文件系统，logstash，elasticsearch或者mq等，或者通过Hook定义日志内容和格式等</li></ul></li><li>可选的日志输出格式，内置了两种日志格式JSONFormater和TextFormatter，还可以自定义日志格式</li><li>Field机制，通过Filed机制进行结构化的日志记录</li><li>线程安全</li></ul><h3 id="1-2-简单导报使用">1.2 简单导报使用</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>log <span class="token string">"github.com/sirupsen/logrus"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"animal"</span><span class="token punctuation">:</span> <span class="token string">"dog"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"测试info日志"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// INFO[0000] 测试info日志      animal=dog</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-日志级别">1.3 日志级别</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/sirupsen/logrus"</span><span class="token punctuation">)</span><span class="token comment">// 创建一个新的logger实例。可以创建任意多个。</span><span class="token keyword">var</span> log <span class="token operator">=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Trace</span><span class="token punctuation">(</span><span class="token string">"Something very low level."</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"Useful debugging information."</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Something noteworthy happened!"</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"You should probably take a look at this."</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Something failed but I'm not quitting."</span><span class="token punctuation">)</span><span class="token comment">// 记完日志后会调用os.Exit(1)</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Bye."</span><span class="token punctuation">)</span><span class="token comment">// 记完日志后会调用 panic()</span>log<span class="token punctuation">.</span><span class="token function">Panic</span><span class="token punctuation">(</span><span class="token string">"I'm bailing."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*INFO[0000] Something noteworthy happened!WARN[0000] You should probably take a look at this.ERRO[0000] Something failed but I'm not quitting.FATA[0000] Bye.*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-4-设置日志级别">1.4 设置日志级别</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 会记录info及以上级别 (warn, error, fatal, panic)</span>log<span class="token punctuation">.</span><span class="token function">SetLevel</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>InfoLevel<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h3 id="1-5-字段">1.5 字段</h3><ul><li>Logrus鼓励通过日志字段进行谨慎的结构化日志记录，而不是冗长的、不可解析的错误消息。</li><li>例如，区别于使用<code>log.Fatalf(&quot;Failed to send event %s to topic %s with key %d&quot;)</code></li><li>你应该使用如下方式记录更容易发现的内容</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>log <span class="token string">"github.com/sirupsen/logrus"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"event"</span><span class="token punctuation">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span><span class="token string">"topic"</span><span class="token punctuation">:</span> <span class="token string">"topic"</span><span class="token punctuation">,</span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"key"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Failed to send event"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// FATA[0000] Failed to send event   event=event key=key topic=topic</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-6-默认字段">1.6 默认字段</h3><ul><li>通常，将一些字段始终附加到应用程序的全部或部分的日志语句中会很有帮助。</li><li>例如，你可能希望始终在请求的上下文中记录<code>request_id</code>和<code>user_ip</code>。</li><li>区别于在每一行日志中写上<code>log.WithFields(log.Fields&#123;&quot;request_id&quot;: request_id, &quot;user_ip&quot;: user_ip&#125;)</code></li><li>你可以向下面的示例代码一样创建一个<code>logrus.Entry</code>去传递这些字段。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> log <span class="token string">"github.com/sirupsen/logrus"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>requestLogger <span class="token operator">:=</span> log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"request_id"</span><span class="token punctuation">:</span> <span class="token string">"request_id"</span><span class="token punctuation">,</span> <span class="token string">"user_ip"</span><span class="token punctuation">:</span> <span class="token string">"user_ip"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>requestLogger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"something happened on that request"</span><span class="token punctuation">)</span> <span class="token comment">// will log request_id and user_ip</span>requestLogger<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"something not great happened"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*INFO[0000] something happened on that request            request_id=request_id user_ip=user_ipWARN[0000] something not great happened                  request_id=request_id user_ip=user_ip */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-7-Hooks">1.7 Hooks</h3><ul><li>你可以添加日志级别的钩子（Hook）。</li><li>例如，向异常跟踪服务发送<code>Error</code>、<code>Fatal</code>和<code>Panic</code>、信息到StatsD或同时将日志发送到多个位置，例如syslog。</li><li>Logrus配有内置钩子，在<code>init</code>中添加这些内置钩子或你自定义的钩子</li><li><a href="https://github.com/sirupsen/logrus/blob/master/hooks/syslog/README.md">GitHub参考(opens new window)</a></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>log <span class="token string">"github.com/sirupsen/logrus"</span><span class="token string">"gopkg.in/gemnasium/logrus-airbrake-hook.v2"</span> <span class="token comment">// the package is named "airbrake"</span>logrus_syslog <span class="token string">"github.com/sirupsen/logrus/hooks/syslog"</span><span class="token string">"log/syslog"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Use the Airbrake hook to report errors that have Error severity or above to</span><span class="token comment">// an exception tracker. You can create custom hooks, see the Hooks section.</span>log<span class="token punctuation">.</span><span class="token function">AddHook</span><span class="token punctuation">(</span>airbrake<span class="token punctuation">.</span><span class="token function">NewHook</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token string">"xyz"</span><span class="token punctuation">,</span> <span class="token string">"production"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>hook<span class="token punctuation">,</span> err <span class="token operator">:=</span> logrus_syslog<span class="token punctuation">.</span><span class="token function">NewSyslogHook</span><span class="token punctuation">(</span><span class="token string">"udp"</span><span class="token punctuation">,</span> <span class="token string">"localhost:514"</span><span class="token punctuation">,</span> syslog<span class="token punctuation">.</span>LOG_INFO<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Unable to connect to local syslog daemon"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">AddHook</span><span class="token punctuation">(</span>hook<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-8-格式化">1.8 格式化</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/sirupsen/logrus"</span><span class="token punctuation">)</span><span class="token keyword">var</span> log <span class="token operator">=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span>Formatter <span class="token operator">=</span> <span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>  <span class="token comment">//log.SetReportCaller(true)  // 可以开启记录函数名，但是会消耗性能</span>log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"event"</span><span class="token punctuation">:</span> <span class="token string">"event"</span><span class="token punctuation">,</span><span class="token string">"topic"</span><span class="token punctuation">:</span> <span class="token string">"topic"</span><span class="token punctuation">,</span><span class="token string">"key"</span><span class="token punctuation">:</span> <span class="token string">"key"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Failed to send event"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*&#123;    "event":"event",    "key":"key",    "level":"info",    "msg":"Failed to send event",    "time":"2021-12-23T12:21:55+08:00",    "topic":"topic"&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-9-gin中使用logrus">1.9 gin中使用logrus</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/sirupsen/logrus"</span><span class="token string">"os"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token punctuation">)</span><span class="token keyword">var</span> log <span class="token operator">=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Log as JSON instead of the default ASCII formatter.</span>log<span class="token punctuation">.</span>Formatter <span class="token operator">=</span> <span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// Output to stdout instead of the default stderr</span><span class="token comment">// Can be any io.Writer, see below for File example</span>f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">"./gin.log"</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>Out <span class="token operator">=</span> fgin<span class="token punctuation">.</span><span class="token function">SetMode</span><span class="token punctuation">(</span>gin<span class="token punctuation">.</span>ReleaseMode<span class="token punctuation">)</span>gin<span class="token punctuation">.</span>DefaultWriter <span class="token operator">=</span> log<span class="token punctuation">.</span>Out<span class="token comment">// Only log the warning severity or above.</span>log<span class="token punctuation">.</span>Level <span class="token operator">=</span> logrus<span class="token punctuation">.</span>InfoLevel<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 创建一个默认的路由引擎</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// GET：请求方式；/hello：请求的路径</span><span class="token comment">// 当客户端以GET方法请求/hello路径时，会执行后面的匿名函数</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"animal"</span><span class="token punctuation">:</span> <span class="token string">"walrus"</span><span class="token punctuation">,</span><span class="token string">"size"</span><span class="token punctuation">:</span>   <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">"A group of walrus emerges from the ocean"</span><span class="token punctuation">)</span><span class="token comment">// c.JSON：返回JSON格式的数据</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// 启动HTTP服务，默认在0.0.0.0:8080启动服务</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">`http://127.0.0.1:8080/hello`</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>记录日志</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">&#123;"animal":"walrus","level":"warning","msg":"A group of walrus emerges from the ocean","size":10,"time":"2021-12-23T12:37:21+08:00"&#125;[GIN] 2021/12/23 - 12:37:21 | 200 |     705.823µs |       127.0.0.1 | GET      "/hello"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h2 id="02-在gin中封装使用">02.在gin中封装使用</h2><h3 id="2-0-目录结构">2.0 目录结构</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">logrus<span class="token operator">-</span>demo├── main<span class="token punctuation">.</span><span class="token keyword">go</span>└── middleware    └── logger<span class="token punctuation">.</span><span class="token keyword">go</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-1-main-go">2.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"cobra-demo/middleware"</span><span class="token string">"fmt"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"github.com/sirupsen/logrus"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">helloWorld</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 测试写入日志</span>middleware<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"data"</span>  <span class="token punctuation">:</span> <span class="token string">"访问/hello"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"测试写入info"</span><span class="token punctuation">)</span><span class="token comment">// c.JSON：返回JSON格式的数据</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"Hello world!"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span><span class="token function">LoggerMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/hello"</span><span class="token punctuation">,</span> helloWorld<span class="token punctuation">)</span><span class="token comment">// 启动HTTP服务，默认在0.0.0.0:8080启动服务</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">`http://127.0.0.1:8080/hello`</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-middleware-logger-ge">2.2 middleware/logger.ge</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> middleware<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/gin-gonic/gin"</span>rotatelogs <span class="token string">"github.com/lestrrat-go/file-rotatelogs"</span><span class="token string">"github.com/rifflock/lfshook"</span><span class="token string">"github.com/sirupsen/logrus"</span><span class="token string">"os"</span><span class="token string">"path"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">var</span> <span class="token punctuation">(</span>logFilePath <span class="token operator">=</span> <span class="token string">"./"</span>logFileName <span class="token operator">=</span> <span class="token string">"system.log"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">LoggerMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> gin<span class="token punctuation">.</span>HandlerFunc <span class="token punctuation">&#123;</span><span class="token comment">// 日志文件</span>fileName <span class="token operator">:=</span> path<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">,</span> logFileName<span class="token punctuation">)</span><span class="token comment">// 写入文件</span>src<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModeAppend<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"err"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 实例化</span>logger <span class="token operator">:=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//设置日志级别</span>logger<span class="token punctuation">.</span><span class="token function">SetLevel</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">)</span><span class="token comment">//设置输出</span>logger<span class="token punctuation">.</span>Out <span class="token operator">=</span> src<span class="token comment">// 设置 rotatelogs</span>logWriter<span class="token punctuation">,</span> err <span class="token operator">:=</span> rotatelogs<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token comment">// 分割后的文件名称</span>fileName<span class="token operator">+</span><span class="token string">".%Y%m%d.log"</span><span class="token punctuation">,</span><span class="token comment">// 生成软链，指向最新日志文件</span>rotatelogs<span class="token punctuation">.</span><span class="token function">WithLinkName</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 设置最大保存时间(7天)</span>rotatelogs<span class="token punctuation">.</span><span class="token function">WithMaxAge</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 设置日志切割时间间隔(1天)</span>rotatelogs<span class="token punctuation">.</span><span class="token function">WithRotationTime</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span>writeMap <span class="token operator">:=</span> lfshook<span class="token punctuation">.</span>WriterMap<span class="token punctuation">&#123;</span>logrus<span class="token punctuation">.</span>InfoLevel<span class="token punctuation">:</span>  logWriter<span class="token punctuation">,</span>logrus<span class="token punctuation">.</span>FatalLevel<span class="token punctuation">:</span> logWriter<span class="token punctuation">,</span>logrus<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">:</span> logWriter<span class="token punctuation">,</span>logrus<span class="token punctuation">.</span>WarnLevel<span class="token punctuation">:</span>  logWriter<span class="token punctuation">,</span>logrus<span class="token punctuation">.</span>ErrorLevel<span class="token punctuation">:</span> logWriter<span class="token punctuation">,</span>logrus<span class="token punctuation">.</span>PanicLevel<span class="token punctuation">:</span> logWriter<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>logger<span class="token punctuation">.</span><span class="token function">AddHook</span><span class="token punctuation">(</span>lfshook<span class="token punctuation">.</span><span class="token function">NewHook</span><span class="token punctuation">(</span>writeMap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">&#123;</span>TimestampFormat<span class="token punctuation">:</span> <span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//开始时间</span>startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//处理请求</span>c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//结束时间</span>endTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 执行时间</span>latencyTime <span class="token operator">:=</span> endTime<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token comment">//请求方式</span>reqMethod <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method<span class="token comment">//请求路由</span>reqUrl <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>RequestURI<span class="token comment">//状态码</span>statusCode <span class="token operator">:=</span> c<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//请求ip</span>clientIP <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ClientIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 日志格式</span>logger<span class="token punctuation">.</span><span class="token function">WithFields</span><span class="token punctuation">(</span>logrus<span class="token punctuation">.</span>Fields<span class="token punctuation">&#123;</span><span class="token string">"status_code"</span><span class="token punctuation">:</span>  statusCode<span class="token punctuation">,</span><span class="token string">"latency_time"</span><span class="token punctuation">:</span> latencyTime<span class="token punctuation">,</span><span class="token string">"client_ip"</span><span class="token punctuation">:</span>    clientIP<span class="token punctuation">,</span><span class="token string">"req_method"</span><span class="token punctuation">:</span>   reqMethod<span class="token punctuation">,</span><span class="token string">"req_uri"</span><span class="token punctuation">:</span>      reqUrl<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-logging-logger-go">2.3 logging/logger.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> logging<span class="token keyword">import</span> <span class="token punctuation">(</span>setting <span class="token string">"bamboo.com/pipeline/Go-assault-squad/config"</span><span class="token string">"fmt"</span><span class="token string">"github.com/sirupsen/logrus"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">var</span> WebLog <span class="token operator">*</span>logrus<span class="token punctuation">.</span>Logger<span class="token keyword">func</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">initWebLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">initWebLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>WebLog <span class="token operator">=</span> <span class="token function">initLog</span><span class="token punctuation">(</span>setting<span class="token punctuation">.</span>Conf<span class="token punctuation">.</span>LogConfig<span class="token punctuation">.</span>WebLogName<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 初始化日志句柄</span><span class="token keyword">func</span> <span class="token function">initLog</span><span class="token punctuation">(</span>logFileName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>logrus<span class="token punctuation">.</span>Logger<span class="token punctuation">&#123;</span>log <span class="token operator">:=</span> logrus<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span>Formatter <span class="token operator">=</span> <span class="token operator">&amp;</span>logrus<span class="token punctuation">.</span>JSONFormatter<span class="token punctuation">&#123;</span>TimestampFormat<span class="token punctuation">:</span> <span class="token string">"2006-01-02 15:04:05"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>logFilePath <span class="token operator">:=</span> setting<span class="token punctuation">.</span>Conf<span class="token punctuation">.</span>LogFilePathlogName <span class="token operator">:=</span> logFilePath <span class="token operator">+</span> logFileName<span class="token keyword">var</span> f <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token keyword">var</span> err <span class="token builtin">error</span><span class="token comment">//判断日志文件夹是否存在，不存在则创建</span><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>os<span class="token punctuation">.</span><span class="token function">MkdirAll</span><span class="token punctuation">(</span>logFilePath<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModePerm<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//判断日志文件是否存在，不存在则创建，否则就直接打开</span><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Stat</span><span class="token punctuation">(</span>logName<span class="token punctuation">)</span><span class="token punctuation">;</span> os<span class="token punctuation">.</span><span class="token function">IsNotExist</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>f<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>logName<span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>f<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>logName<span class="token punctuation">,</span>os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> os<span class="token punctuation">.</span>ModeAppend<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"open log file failed"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>log<span class="token punctuation">.</span>Out <span class="token operator">=</span> flog<span class="token punctuation">.</span>Level <span class="token operator">=</span> logrus<span class="token punctuation">.</span>InfoLevel<span class="token keyword">return</span> log<span class="token punctuation">&#125;</span><span class="token comment">/*---- 日志写入测试 ----WebLog.WithFields(logrus.Fields&#123;"data"  : "访问/hello",&#125;).Info("测试写入info")---- 写入结构如下 ----&#123;"data":"访问/hello","level":"info","msg":"测试写入info","time":"2021-12-29 18:15:54"&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-访问测试">2.4 访问测试</h3><blockquote><p>go run main.go</p></blockquote><ul><li><a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a></li><li>写入日志格式</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span><span class="token property">"data"</span><span class="token operator">:</span><span class="token string">"访问/hello"</span><span class="token punctuation">,</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">"测试写入info"</span><span class="token punctuation">,</span><span class="token property">"time"</span><span class="token operator">:</span><span class="token string">"2021-12-23 15:27:37"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token property">"client_ip"</span><span class="token operator">:</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span><span class="token property">"latency_time"</span><span class="token operator">:</span><span class="token number">418116</span><span class="token punctuation">,</span><span class="token property">"level"</span><span class="token operator">:</span><span class="token string">"info"</span><span class="token punctuation">,</span><span class="token property">"msg"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"req_method"</span><span class="token operator">:</span><span class="token string">"GET"</span><span class="token punctuation">,</span><span class="token property">"req_uri"</span><span class="token operator">:</span><span class="token string">"/hello"</span><span class="token punctuation">,</span><span class="token property">"status_code"</span><span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token property">"time"</span><span class="token operator">:</span><span class="token string">"2021-12-23 15:27:37"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Cobor</title>
    <link href="/2022/06/19/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20cobor/"/>
    <url>/2022/06/19/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20cobor/</url>
    
    <content type="html"><![CDATA[<h1 id="17-cobor">17.cobor</h1><h2 id="01-cobra使用">01.cobra使用</h2><ul><li>GitHub地址： <a href="https://github.com/spf13/cobra/blob/master/user_guide.md">https://github.com/spf13/cobra/blob/master/user_guide.md</a></li><li>参考博客：<a href="https://www.qikqiak.com/post/create-cli-app-with-cobra/">https://www.qikqiak.com/post/create-cli-app-with-cobra/</a></li><li>安装</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get <span class="token parameter variable">-u</span> github.com/spf13/cobra <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="1-1-基本使用">1.1 基本使用</h3><ul><li>初始项目</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$  <span class="token function">mkdir</span> cobra-demo <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> cobra-demo$  go mod init cobra-demo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><ul><li>2）下载cobra</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 强烈推荐配置该环境变量</span>$  <span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPROXY</span><span class="token operator">=</span>https://goproxy.cn$  go get <span class="token parameter variable">-u</span> github.com/spf13/cobra/cobra<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>3）<code>cobra init</code> 命令来初始化 CLI 应用的脚手架</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ cobra init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="1-2-初始化结构说明">1.2 初始化结构说明</h3><ul><li>目录结构</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">├── cmd│   └── root.go└── main.go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>main.go</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"cobra-demo/cmd"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>cmd/root.go</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> cmd<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"os"</span><span class="token string">"github.com/spf13/cobra"</span><span class="token punctuation">)</span><span class="token keyword">var</span> rootCmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">&#123;</span>Use<span class="token punctuation">:</span>   <span class="token string">"cobra-demo"</span><span class="token punctuation">,</span>Short<span class="token punctuation">:</span> <span class="token string">"A brief description of your application"</span><span class="token punctuation">,</span>Long<span class="token punctuation">:</span>   Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello Cobra CLI"</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 然后再执行 execute 方法</span><span class="token keyword">func</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>err <span class="token operator">:=</span> rootCmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 每当执行或者调用命令的时候，它都会先执行 init 函数中的所有函数</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>rootCmd<span class="token punctuation">.</span><span class="token function">Flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">BoolP</span><span class="token punctuation">(</span><span class="token string">"toggle"</span><span class="token punctuation">,</span> <span class="token string">"t"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"Help message for toggle"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>rootCmd</code> 根命令就会首先运行 <code>initConfig</code> 函数，当所有的初始化函数执行完成后，才会执行 <code>rootCmd</code> 的 <code>RUN: func</code> 执行函数</li><li>我们可以在 <code>initConfig</code> 函数里面添加一些 Debug 信息</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">initConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"I'm inside initConfig function in cmd/root.go"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-cobra项目使用">02.cobra项目使用</h2><h3 id="2-0-目录结构">2.0 目录结构</h3><ul><li>目录结构</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">cobra-demo├── cmd│   ├── root.go│   └── serve.go└── main.go<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-1-main-go">2.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"cobra-demo/cmd"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>cmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-cmd-root-go">2.2 cmd/root.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> cmd<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"errors"</span><span class="token string">"github.com/spf13/cobra"</span><span class="token string">"log"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">var</span> rootCmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">&#123;</span>Use<span class="token punctuation">:</span>               <span class="token string">"demo"</span><span class="token punctuation">,</span>  <span class="token comment">// 命令行时关键字</span>Short<span class="token punctuation">:</span>             <span class="token string">"cobra demo example"</span><span class="token punctuation">,</span>  <span class="token comment">// 命令简单描述</span>Long<span class="token punctuation">:</span>              <span class="token string">`cobra demo example ....`</span><span class="token punctuation">,</span>  <span class="token comment">// 命令详细描述</span>Args<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"requires at least one arg"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>PersistentPreRunE<span class="token punctuation">:</span>      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token boolean">nil</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>Run<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 钩子函数</span>usageStr <span class="token operator">:=</span> <span class="token string">`可以使用 -h 查看命令`</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> usageStr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二步：然后再执行 execute 方法</span><span class="token keyword">func</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>err <span class="token operator">:=</span> rootCmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 第一步：每当执行或者调用命令的时候，它都会先执行 init 函数中的所有函数</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>rootCmd<span class="token punctuation">.</span><span class="token function">AddCommand</span><span class="token punctuation">(</span>StartCmd<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-cmd-serve-go">2.3 cmd/serve.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> cmd<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/spf13/cobra"</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token keyword">var</span> <span class="token punctuation">(</span>config   <span class="token builtin">string</span>  <span class="token comment">// 启动配置文件位置</span>port     <span class="token builtin">string</span>  <span class="token comment">// 启动端口号</span>mode     <span class="token builtin">string</span>  <span class="token comment">// 启动模式</span>StartCmd <span class="token operator">=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">&#123;</span><span class="token comment">// go run main.go server -c=config/settings.dev.yml</span>Use<span class="token punctuation">:</span>     <span class="token string">"server"</span><span class="token punctuation">,</span>  <span class="token comment">// 启动时要添加 server关键字</span>Short<span class="token punctuation">:</span>   <span class="token string">"Start API server"</span><span class="token punctuation">,</span>  <span class="token comment">// 对命令简单描述</span>Example<span class="token punctuation">:</span> <span class="token string">"ferry server config/settings.yml"</span><span class="token punctuation">,</span>  <span class="token comment">// 运行命令例子</span>PreRun<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 钩子函数，在RunE前执行</span><span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span>RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 钩子函数</span><span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 为 Command 添加选项(flags)</span>StartCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>config<span class="token punctuation">,</span> <span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"config/settings.yml"</span><span class="token punctuation">,</span> <span class="token string">"Start server with provided configuration file"</span><span class="token punctuation">)</span>StartCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>port<span class="token punctuation">,</span> <span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token string">"p"</span><span class="token punctuation">,</span> <span class="token string">"8002"</span><span class="token punctuation">,</span> <span class="token string">"Tcp port server listening on"</span><span class="token punctuation">)</span>StartCmd<span class="token punctuation">.</span><span class="token function">PersistentFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">StringVarP</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mode<span class="token punctuation">,</span> <span class="token string">"mode"</span><span class="token punctuation">,</span> <span class="token string">"m"</span><span class="token punctuation">,</span> <span class="token string">"dev"</span><span class="token punctuation">,</span> <span class="token string">"server mode ; eg:dev,test,prod"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 记录日志</span><span class="token keyword">func</span> <span class="token function">usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>usageStr <span class="token operator">:=</span> <span class="token string">`starting api server`</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> usageStr<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 初始化项目</span><span class="token keyword">func</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 1. 读取配置</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"启动命令配置文件："</span><span class="token punctuation">,</span>config<span class="token punctuation">)</span><span class="token comment">// 2. 初始化数据库链接</span><span class="token comment">// 3. 启动异步任务队列</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span><span class="token comment">// 1.获取当前启动模式</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"启动命令当前模式："</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token comment">// 2.获取当前启动端口</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"启动命令当前端口"</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-运行测试">2.4 运行测试</h3><ul><li>我们可以根据当前命令行传入的 <code>配置文件位置、端口号、启动模式</code> 来启动项目</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xiaonaiqiang1@ZBMac-C02CW08SM cobra-demo %  go run main.go server <span class="token parameter variable">-c</span><span class="token operator">=</span>config/settings.dev.yml <span class="token parameter variable">-p</span><span class="token operator">=</span><span class="token number">8888</span> <span class="token parameter variable">-m</span><span class="token operator">=</span>release<span class="token number">2021</span>/12/23 <span class="token number">11</span>:09:12 starting api server启动命令配置文件： config/settings.dev.yml启动命令当前模式： release启动命令当前端口 <span class="token number">8888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Makefile</title>
    <link href="/2022/06/17/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Makefile/"/>
    <url>/2022/06/17/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Makefile/</url>
    
    <content type="html"><![CDATA[<h1 id="16-Makefile">16.Makefile</h1><h2 id="01-介绍">01.介绍</h2><h3 id="1-1-make介绍">1.1 make介绍</h3><ul><li><code>make</code>是一个构建自动化工具，会在当前目录下寻找<code>Makefile</code>或<code>makefile</code>文件</li><li>如果存在相应的文件，它就会依据其中定义好的规则完成构建任务。</li></ul><h3 id="1-2-Makefile介绍">1.2 Makefile介绍</h3><ul><li>借助<code>Makefile</code>我们在编译过程中不再需要每次手动输入编译的命令和编译的参数，可以极大简化项目编译过程。</li><li>我们可以把<code>Makefile</code>简单理解为它定义了一个项目文件的编译规则。</li><li>借助<code>Makefile</code>我们在编译过程中不再需要每次手动输入编译的命令和编译的参数，可以极大简化项目编译过程。</li><li>同时使用<code>Makefile</code>也可以在项目中确定具体的编译规则和流程，很多开源项目中都会定义<code>Makefile</code>文件。</li></ul><h3 id="1-3-win10安装make">1.3 win10安装make</h3><ul><li>MinGW下载网页：<a href="http://sourceforge.net/projects/mingw/files/latest/download?source=files">http://sourceforge.net/projects/mingw/files/latest/download?source=files</a></li><li>右击计算机-&gt;属性-&gt;高级系统设置-&gt;环境变量，在系统变量中找到PATH</li><li>将MinGW安装目录里的bin文件夹的地址添加到PATH里面。</li><li>打开MinGW的安装目录，打开bin文件夹，将mingw32-make.exe重命名为make.exe。</li><li>经过以上步骤后，控制台可以输入make。</li></ul><h3 id="1-4-规则介绍">1.4 规则介绍</h3><ul><li><code>Makefile</code>由多条规则组成，每条规则主要由两个部分组成，分别是依赖的关系和执行的命令。</li><li>其结构如下所示：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token target symbol">[target] ...</span> <span class="token punctuation">:</span> [prerequisites] ...&lt;tab>[command]    ...    ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>其中：<ul><li>targets：规则的目标</li><li>prerequisites：可选的要生成 targets 需要的文件或者是目标。</li><li>command：make 需要执行的命令（任意的 shell 命令）。可以有多条命令，每一条命令占一行。</li></ul></li><li>举个例子：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token target symbol">build</span><span class="token punctuation">:</span>CGO_ENABLED<span class="token operator">=</span>0 GOOS<span class="token operator">=</span>linux GOARCH<span class="token operator">=</span>amd64 go build -o xx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h2 id="02-makefile基本使用">02.makefile基本使用</h2><h3 id="2-1-main-go">2.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> hello<span class="token punctuation">)</span>server <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">&#123;</span>Addr<span class="token punctuation">:</span> <span class="token string">":8888"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"server startup..."</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">:=</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"server startup failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">hello</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"hello v5blog.cn!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-示例">2.2 示例</h3><ul><li><code>BINARY=&quot;xxx&quot;</code>是定义变量</li><li><code>.PHONY</code>用来定义伪目标，不创建目标文件，而是去执行这个目标下面的命令</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> all build run gotool clean help<span class="token comment"># 编译后的项目名</span>BINARY<span class="token operator">=</span><span class="token string">"xxx"</span><span class="token comment"># 如果make后面不加任何参数，默认执行all</span><span class="token target symbol">all</span><span class="token punctuation">:</span> gotool build<span class="token target symbol">build</span><span class="token punctuation">:</span>CGO_ENABLED<span class="token operator">=</span>0 GOOS<span class="token operator">=</span>linux GOARCH<span class="token operator">=</span>amd64 go build -o <span class="token variable">$</span><span class="token punctuation">&#123;</span>BINARY<span class="token punctuation">&#125;</span><span class="token target symbol">run</span><span class="token punctuation">:</span><span class="token operator">@</span>go run ./main.go<span class="token comment">#@go run ./main.go conf/config.yaml</span><span class="token target symbol">gotool</span><span class="token punctuation">:</span>go fmt ./go vet ./<span class="token target symbol">clean</span><span class="token punctuation">:</span><span class="token operator">@</span>if [ -f <span class="token variable">$</span><span class="token punctuation">&#123;</span>BINARY<span class="token punctuation">&#125;</span> ] <span class="token punctuation">;</span> then rm <span class="token variable">$</span><span class="token punctuation">&#123;</span>BINARY<span class="token punctuation">&#125;</span> <span class="token punctuation">;</span> fi<span class="token target symbol">help</span><span class="token punctuation">:</span><span class="token operator">@</span>echo <span class="token string">"make - 格式化 Go 代码, 并编译生成二进制文件"</span><span class="token operator">@</span>echo <span class="token string">"make build - 编译 Go 代码, 生成二进制文件"</span><span class="token operator">@</span>echo <span class="token string">"make run - 直接运行 Go 代码"</span><span class="token operator">@</span>echo <span class="token string">"make clean - 移除二进制文件和 vim swap files"</span><span class="token operator">@</span>echo <span class="token string">"make gotool - 运行 Go 工具 'fmt' and 'vet'"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-使用">2.3 使用</h3><p><img src="/img/image-20210615203624174.c01717f8.png" alt=""></p><h2 id="03-完整">03.完整</h2><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token punctuation">.</span>PHONY<span class="token punctuation">:</span> all build run gotool clean helpBINARY<span class="token operator">=</span><span class="token string">"bluebell"</span>all<span class="token punctuation">:</span> gotool buildbuild<span class="token punctuation">:</span>CGO_ENABLED<span class="token operator">=</span><span class="token number">0</span> GOOS<span class="token operator">=</span>linux GOARCH<span class="token operator">=</span>amd64 <span class="token keyword">go</span> build <span class="token operator">-</span>ldflags <span class="token string">"-s -w"</span> <span class="token operator">-</span>o <span class="token punctuation">.</span><span class="token operator">/</span>bin<span class="token operator">/</span>$<span class="token punctuation">&#123;</span>BINARY<span class="token punctuation">&#125;</span>run<span class="token punctuation">:</span>@<span class="token keyword">go</span> run <span class="token punctuation">.</span><span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span> conf<span class="token operator">/</span>config<span class="token punctuation">.</span>yamlgotool<span class="token punctuation">:</span><span class="token keyword">go</span> fmt <span class="token punctuation">.</span><span class="token operator">/</span><span class="token keyword">go</span> vet <span class="token punctuation">.</span><span class="token operator">/</span>clean<span class="token punctuation">:</span>@<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">-</span>f $<span class="token punctuation">&#123;</span>BINARY<span class="token punctuation">&#125;</span> <span class="token punctuation">]</span> <span class="token punctuation">;</span> then rm $<span class="token punctuation">&#123;</span>BINARY<span class="token punctuation">&#125;</span> <span class="token punctuation">;</span> fihelp<span class="token punctuation">:</span>@echo <span class="token string">"make - 格式化 Go 代码, 并编译生成二进制文件"</span>@echo <span class="token string">"make build - 编译 Go 代码, 生成二进制文件"</span>@echo <span class="token string">"make run - 直接运行 Go 代码"</span>@echo <span class="token string">"make clean - 移除二进制文件和 vim swap files"</span>@echo <span class="token string">"make gotool - 运行 Go 工具 'fmt' and 'vet'"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go-wrk</title>
    <link href="/2022/06/15/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20go-wrk/"/>
    <url>/2022/06/15/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20go-wrk/</url>
    
    <content type="html"><![CDATA[<h1 id="15-go-wrk压测">15.go-wrk压测</h1><h2 id="01-压测介绍">01.压测介绍</h2><h3 id="1-1-压测作用">1.1 压测作用</h3><ul><li>在项目正式上线之前，我们通常需要通过压测来评估当前系统能够支撑的请求量、排查可能存在的隐藏bug</li><li>同时了解了程序的实际处理能力能够帮我们更好的匹配项目的实际需求，节约资源成本。</li></ul><h3 id="1-2-压测相关术语">1.2 压测相关术语</h3><ul><li>响应时间(RT) ：指系统对请求作出响应的时间.</li><li>吞吐量(Throughput) ：指系统在单位时间内处理请求的数量</li><li>QPS每秒查询率(Query Per Second) ：“每秒查询率”，是一台服务器每秒能够响应的查询次数<ul><li>是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。</li></ul></li><li>TPS(TransactionPerSecond)：每秒钟系统能够处理的交易或事务的数量</li><li>并发连接数：某个时刻服务器所接受的请求总数</li></ul><h2 id="02-压力测试工具">02.压力测试工具</h2><h3 id="2-1-ab">2.1 ab</h3><ul><li>ab全称Apache Bench，是Apache自带的性能测试工具。</li><li>使用这个工具，只须指定同时连接数、请求数以及URL，即可测试网站或网站程序的性能。</li><li>通过ab发送请求模拟多个访问者同时对某一URL地址进行访问,可以得到每秒传送字节数、每秒处理请求数、每请求处理时间等统计数据。</li><li>命令格式：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ab <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>http://<span class="token punctuation">]</span>hostname<span class="token punctuation">[</span>:port<span class="token punctuation">]</span>/path<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>常用参数如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-n</span> requests 总请求数<span class="token parameter variable">-c</span> concurrency 一次产生的请求数，可以理解为并发数<span class="token parameter variable">-t</span> timelimit 测试所进行的最大秒数, 可以当做请求的超时时间<span class="token parameter variable">-p</span> postfile 包含了需要POST的数据的文件<span class="token parameter variable">-T</span> content-type POST数据所使用的Content-type头信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>更多参数请查看<a href="http://httpd.apache.org/docs/2.2/programs/ab.html">官方文档 (opens new window)</a>。</li><li>例如测试某个GET请求接口：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ab <span class="token parameter variable">-n</span> <span class="token number">10000</span> <span class="token parameter variable">-c</span> <span class="token number">100</span> <span class="token parameter variable">-t</span> <span class="token number">10</span> <span class="token string">"http://127.0.0.1:8080/api/v1/posts?size=10"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>测试POST请求接口：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ab <span class="token parameter variable">-n</span> <span class="token number">10000</span> <span class="token parameter variable">-c</span> <span class="token number">100</span> <span class="token parameter variable">-t</span> <span class="token number">10</span> <span class="token parameter variable">-p</span> post.json <span class="token parameter variable">-T</span> <span class="token string">"application/json"</span> <span class="token string">"http://127.0.0.1:8080/api/v1/post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="2-2-wrk">2.2 wrk</h3><ul><li>是一款开源的HTTP性能测试工具，它和上面提到的<code>ab</code>同属于HTTP性能测试工具</li><li>它比<code>ab</code>功能更加强大，可以通过编写lua脚本来支持更加复杂的测试场景。</li><li>Mac下安装</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">brew <span class="token function">install</span> wrk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>常用命令参数：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-c</span> --conections：保持的连接数<span class="token parameter variable">-d</span> --duration：压测持续时间<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token parameter variable">-t</span> --threads：使用的线程总数<span class="token parameter variable">-s</span> --script：加载lua脚本<span class="token parameter variable">-H</span> --header：在请求头部添加一些参数<span class="token parameter variable">--latency</span> 打印详细的延迟统计信息<span class="token parameter variable">--timeout</span> 请求的最大超时时间<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>使用示例：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wrk <span class="token parameter variable">-t8</span> <span class="token parameter variable">-c100</span> <span class="token parameter variable">-d30s</span> <span class="token parameter variable">--latency</span> http://127.0.0.1:8080/api/v1/posts?size<span class="token operator">=</span><span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>输出结果：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Running 30s <span class="token builtin class-name">test</span> @ http://127.0.0.1:8080/api/v1/posts?size<span class="token operator">=</span><span class="token number">10</span>  <span class="token number">8</span> threads and <span class="token number">100</span> connections  Thread Stats   Avg      Stdev     Max   +/- Stdev    Latency    <span class="token number">14</span>.55ms    <span class="token number">2</span>.02ms  <span class="token number">31</span>.59ms   <span class="token number">76.70</span>%    Req/Sec   <span class="token number">828.16</span>     <span class="token number">85.69</span>     <span class="token number">0</span>.97k    <span class="token number">60.46</span>%  Latency Distribution     <span class="token number">50</span>%   <span class="token number">14</span>.44ms     <span class="token number">75</span>%   <span class="token number">15</span>.76ms     <span class="token number">90</span>%   <span class="token number">16</span>.63ms     <span class="token number">99</span>%   <span class="token number">21</span>.07ms  <span class="token number">198091</span> requests <span class="token keyword">in</span> <span class="token number">30</span>.05s, <span class="token number">29</span>.66MB <span class="token builtin class-name">read</span>Requests/sec:   <span class="token number">6592.29</span>Transfer/sec:      <span class="token number">0</span>.99MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-go-wrk">2.3 go-wrk</h3><ul><li>是Go语言版本的<code>wrk</code></li><li>Windows同学可以使用它来测试，使用如下命令来安装<code>go-wrk</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get github.com/adeven/go-wrk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>使用方法同<code>wrk</code>类似，基本格式如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go-wrk <span class="token punctuation">[</span>flags<span class="token punctuation">]</span> url<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>常用的参数：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token parameter variable">-H</span><span class="token operator">=</span><span class="token string">"User-Agent: go-wrk 0.1 bechmark<span class="token entity" title="\n">\n</span>Content-Type: text/html;"</span><span class="token builtin class-name">:</span> 由<span class="token string">'\n'</span>分隔的请求头<span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token number">100</span>: 使用的最大连接数<span class="token parameter variable">-k</span><span class="token operator">=</span>true: 是否禁用keep-alives<span class="token parameter variable">-i</span><span class="token operator">=</span>false: <span class="token keyword">if</span> TLS security checks are disabled<span class="token parameter variable">-m</span><span class="token operator">=</span><span class="token string">"GET"</span><span class="token builtin class-name">:</span> HTTP请求方法<span class="token parameter variable">-n</span><span class="token operator">=</span><span class="token number">1000</span>: 请求总数<span class="token parameter variable">-t</span><span class="token operator">=</span><span class="token number">1</span>: 使用的线程数<span class="token parameter variable">-b</span><span class="token operator">=</span><span class="token string">""</span> HTTP请求体<span class="token parameter variable">-s</span><span class="token operator">=</span><span class="token string">""</span> 如果指定，它将计算响应中包含搜索到的字符串s的频率<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>执行测试：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go-wrk <span class="token parameter variable">-t</span><span class="token operator">=</span><span class="token number">8</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token number">100</span> <span class="token parameter variable">-n</span><span class="token operator">=</span><span class="token number">10000</span> <span class="token string">"http://127.0.0.1:8080/api/v1/posts?size=10"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>输出结果：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>BENCHMARK<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>URL:                            http://127.0.0.1:8080/api/v1/posts?size<span class="token operator">=</span><span class="token number">10</span>Used Connections:               <span class="token number">100</span>Used Threads:                   <span class="token number">8</span>Total number of calls:          <span class="token number">10000</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>TIMINGS<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>Total <span class="token function">time</span> passed:              <span class="token number">2</span>.74sAvg <span class="token function">time</span> per request:           <span class="token number">27</span>.11msRequests per second:            <span class="token number">3644.53</span>Median <span class="token function">time</span> per request:        <span class="token number">26</span>.88ms99th percentile time:           <span class="token number">39</span>.16msSlowest <span class="token function">time</span> <span class="token keyword">for</span> request:       <span class="token number">45</span>.00ms<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>DATA<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>Total response body sizes:              <span class="token number">340000</span>Avg response body per request:          <span class="token number">34.00</span> ByteTransfer rate per second:               <span class="token number">123914.11</span> Byte/s <span class="token punctuation">(</span><span class="token number">0.12</span> MByte/s<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>RESPONSES<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>20X Responses:          <span class="token number">10000</span>   <span class="token punctuation">(</span><span class="token number">100.00</span>%<span class="token punctuation">)</span>30X Responses:          <span class="token number">0</span>       <span class="token punctuation">(</span><span class="token number">0.00</span>%<span class="token punctuation">)</span>40X Responses:          <span class="token number">0</span>       <span class="token punctuation">(</span><span class="token number">0.00</span>%<span class="token punctuation">)</span>50X Responses:          <span class="token number">0</span>       <span class="token punctuation">(</span><span class="token number">0.00</span>%<span class="token punctuation">)</span>Errors:                 <span class="token number">0</span>       <span class="token punctuation">(</span><span class="token number">0.00</span>%<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jwt-go</title>
    <link href="/2022/06/13/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20jwt-go/"/>
    <url>/2022/06/13/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20jwt-go/</url>
    
    <content type="html"><![CDATA[<h1 id="14-jwt-go">14.jwt-go</h1><h2 id="01-JWT介绍">01.JWT介绍</h2><h3 id="1-1-什么是JWT？">1.1 什么是JWT？</h3><ul><li>JWT全称JSON Web Token是一种跨域认证解决方案，属于一个开放的标准，它规定了一种Token实现方式</li><li>目前多用于前后端分离项目和OAuth2.0业务场景下。</li></ul><h3 id="1-2-jwt三部分">1.2 jwt三部分</h3><ul><li>基于JWT技术及RSA非对称加密实现真正无状态的单点登录</li></ul><p><img src="/img/image-20210614161501680.e267e765.png" alt=""></p><h2 id="02-JWT基本用法">02.JWT基本用法</h2><h3 id="2-1-定义需求">2.1 定义需求</h3><ul><li>我们需要定制自己的需求来决定JWT中保存哪些数据</li><li>比如我们规定在JWT中要存储<code>username</code>信息</li><li>那么我们就定义一个<code>MyClaims</code>结构体如下</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// MyClaims 自定义声明结构体并内嵌jwt.StandardClaims</span><span class="token comment">// jwt包自带的jwt.StandardClaims只包含了官方字段</span><span class="token comment">// 我们这里需要额外记录一个username字段，所以要自定义结构体</span><span class="token comment">// 如果想要保存更多信息，都可以添加到这个结构体中</span><span class="token keyword">type</span> MyClaims <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Username <span class="token builtin">string</span> <span class="token string">`json:"username"`</span>jwt<span class="token punctuation">.</span>StandardClaims<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>然后我们定义JWT的过期时间，这里以2小时为例：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> TokenExpireDuration <span class="token operator">=</span> time<span class="token punctuation">.</span>Hour <span class="token operator">*</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>接下来还需要定义Secret：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">var</span> MySecret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"夏天夏天悄悄过去"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="2-2-生成JWT">2.2 生成JWT</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// GenToken 生成JWT</span><span class="token keyword">func</span> <span class="token function">GenToken</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 创建一个我们自己的声明</span>c <span class="token operator">:=</span> MyClaims<span class="token punctuation">&#123;</span>username<span class="token punctuation">,</span> <span class="token comment">// 自定义字段</span>jwt<span class="token punctuation">.</span>StandardClaims<span class="token punctuation">&#123;</span>ExpiresAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>TokenExpireDuration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 过期时间</span>Issuer<span class="token punctuation">:</span>    <span class="token string">"my-project"</span><span class="token punctuation">,</span>                               <span class="token comment">// 签发人</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 使用指定的签名方法创建签名对象</span>token <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token comment">// 使用指定的secret签名并获得完整的编码后的字符串token</span><span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span>MySecret<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-解析JWT">2.3 解析JWT</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ParseToken 解析JWT</span><span class="token keyword">func</span> <span class="token function">ParseToken</span><span class="token punctuation">(</span>tokenString <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MyClaims<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 解析token</span>token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>tokenString<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MyClaims<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> MySecret<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">&#125;</span><span class="token keyword">if</span> claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>MyClaims<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>Valid <span class="token punctuation">&#123;</span> <span class="token comment">// 校验token</span><span class="token keyword">return</span> claims<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"invalid token"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-gin使用JWT">03.gin使用JWT</h2><h3 id="3-0-demo结构">3.0 demo结构</h3><p><img src="/img/image-20210614170143996.08fc999d.png" alt=""></p><h3 id="3-1-main-go">3.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"jwt-test/controllers"</span><span class="token string">"jwt-test/middlewares"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"/auth"</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>AuthHandler<span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/home"</span><span class="token punctuation">,</span> middlewares<span class="token punctuation">.</span><span class="token function">JWTAuthMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controllers<span class="token punctuation">.</span>HomeHandler<span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">":8000"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-controllers-user-go">3.2 controllers/user.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> controllers<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"jwt-test/pkg/jwt"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token comment">// ParamSignUp 注册请求参数</span><span class="token keyword">type</span> UserInfo <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Username   <span class="token builtin">string</span> <span class="token string">`json:"username" binding:"required"`</span>Password   <span class="token builtin">string</span> <span class="token string">`json:"password" binding:"required"`</span>RePassword <span class="token builtin">string</span> <span class="token string">`json:"confirm_password" binding:"required,eqfield=Password"`</span><span class="token comment">//RePassword string `json:"re_password" binding:"required,eqfield=Password"`</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">AuthHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 用户发送用户名和密码过来</span><span class="token keyword">var</span> user UserInfoerr <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2001</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"无效的参数"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token comment">// 校验用户名和密码是否正确</span><span class="token keyword">if</span> user<span class="token punctuation">.</span>Username <span class="token operator">==</span> <span class="token string">"zhangsan"</span> <span class="token operator">&amp;&amp;</span> user<span class="token punctuation">.</span>Password <span class="token operator">==</span> <span class="token string">"123456"</span> <span class="token punctuation">&#123;</span><span class="token comment">// 生成Token</span>tokenString<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">GenToken</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"success"</span><span class="token punctuation">,</span><span class="token string">"data"</span><span class="token punctuation">:</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"token"</span><span class="token punctuation">:</span> tokenString<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2002</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"鉴权失败"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">HomeHandler</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>username <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">MustGet</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"success"</span><span class="token punctuation">,</span><span class="token string">"data"</span><span class="token punctuation">:</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3-pkg-jwt-jwt-go">3.3 pkg/jwt/jwt.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> jwt<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"errors"</span><span class="token string">"github.com/dgrijalva/jwt-go"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// MyClaims 自定义声明结构体并内嵌jwt.StandardClaims</span><span class="token comment">// jwt包自带的jwt.StandardClaims只包含了官方字段</span><span class="token comment">// 我们这里需要额外记录一个username字段，所以要自定义结构体</span><span class="token comment">// 如果想要保存更多信息，都可以添加到这个结构体中</span><span class="token keyword">type</span> MyClaims <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Username <span class="token builtin">string</span> <span class="token string">`json:"username"`</span>jwt<span class="token punctuation">.</span>StandardClaims<span class="token punctuation">&#125;</span><span class="token keyword">const</span> TokenExpireDuration <span class="token operator">=</span> time<span class="token punctuation">.</span>Hour <span class="token operator">*</span> <span class="token number">2</span><span class="token keyword">var</span> MySecret <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"夏天夏天悄悄过去"</span><span class="token punctuation">)</span><span class="token comment">// GenToken 生成JWT</span><span class="token keyword">func</span> <span class="token function">GenToken</span><span class="token punctuation">(</span>username <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 创建一个我们自己的声明</span>c <span class="token operator">:=</span> MyClaims<span class="token punctuation">&#123;</span>username<span class="token punctuation">,</span> <span class="token comment">// 自定义字段</span>jwt<span class="token punctuation">.</span>StandardClaims<span class="token punctuation">&#123;</span>ExpiresAt<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>TokenExpireDuration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 过期时间</span>Issuer<span class="token punctuation">:</span>    <span class="token string">"my-project"</span><span class="token punctuation">,</span>                               <span class="token comment">// 签发人</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 使用指定的签名方法创建签名对象</span>token <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">NewWithClaims</span><span class="token punctuation">(</span>jwt<span class="token punctuation">.</span>SigningMethodHS256<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token comment">// 使用指定的secret签名并获得完整的编码后的字符串token</span><span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">SignedString</span><span class="token punctuation">(</span>MySecret<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// ParseToken 解析JWT</span><span class="token keyword">func</span> <span class="token function">ParseToken</span><span class="token punctuation">(</span>tokenString <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MyClaims<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 解析token</span>token<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseWithClaims</span><span class="token punctuation">(</span>tokenString<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MyClaims<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>token <span class="token operator">*</span>jwt<span class="token punctuation">.</span>Token<span class="token punctuation">)</span> <span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> MySecret<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">&#125;</span><span class="token keyword">if</span> claims<span class="token punctuation">,</span> ok <span class="token operator">:=</span> token<span class="token punctuation">.</span>Claims<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>MyClaims<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> token<span class="token punctuation">.</span>Valid <span class="token punctuation">&#123;</span> <span class="token comment">// 校验token</span><span class="token keyword">return</span> claims<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"invalid token"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-4-middlewares-auth-go">3.4 middlewares/auth.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> middlewares<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"jwt-test/pkg/jwt"</span><span class="token string">"net/http"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token comment">// JWTAuthMiddleware 基于JWT的认证中间件</span><span class="token keyword">func</span> <span class="token function">JWTAuthMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 客户端携带Token有三种方式 1.放在请求头 2.放在请求体 3.放在URI</span><span class="token comment">// 这里假设Token放在Header的Authorization中，并使用Bearer开头</span><span class="token comment">// 这里的具体实现方式要依据你的实际业务情况决定</span>authHeader <span class="token operator">:=</span> c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token keyword">if</span> authHeader <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2003</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"请求头中auth为空"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token comment">// 按空格分割</span>parts <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>authHeader<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"Bearer"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2004</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"请求头中auth格式有误"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token comment">// parts[1]是获取到的tokenString，我们使用之前定义好的解析JWT的函数来解析它</span>mc<span class="token punctuation">,</span> err <span class="token operator">:=</span> jwt<span class="token punctuation">.</span><span class="token function">ParseToken</span><span class="token punctuation">(</span>parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> gin<span class="token punctuation">.</span>H<span class="token punctuation">&#123;</span><span class="token string">"code"</span><span class="token punctuation">:</span> <span class="token number">2005</span><span class="token punctuation">,</span><span class="token string">"msg"</span><span class="token punctuation">:</span>  <span class="token string">"无效的Token"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">Abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token comment">// 将当前请求的username信息保存到请求的上下文c上</span>c<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> mc<span class="token punctuation">.</span>Username<span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 后续的处理函数可以用过c.Get("username")来获取当前请求的用户信息</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-测试">04.测试</h2><h3 id="4-1-登录获取token">4.1 登录获取token</h3><ul><li><a href="http://127.0.0.1:8000/auth">http://127.0.0.1:8000/auth</a></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"username"</span><span class="token operator">:</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span>    <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>    <span class="token property">"confirm_password"</span><span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210614165132336.0766e8a7.png" alt=""></p><h3 id="4-2-携带token访问">4.2 携带token访问</h3><ul><li><a href="http://127.0.0.1:8000/home">http://127.0.0.1:8000/home</a></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">AuthorizationBearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9<span class="token punctuation">.</span>eyJ1c2VybmFtZSI6InpoYW5nc2FuIiwiZXhwIjoxNjIzNjY3NzUzLCJpc3MiOiJteS1wcm9qZWN0In0<span class="token punctuation">.</span>j9SFygMnMq1<span class="token operator">-</span>ymsDcTLN59svQb4<span class="token operator">-</span>BTgO3DLaBeUAAVY<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><p><img src="http://v5blog.cn/assets/img/image-20210614165555199.4798dd56.png" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>gRPC</title>
    <link href="/2022/06/11/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20gRPC/"/>
    <url>/2022/06/11/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20gRPC/</url>
    
    <content type="html"><![CDATA[<h1 id="13-gRPC">13.gRPC</h1><h2 id="01-gRPC基础">01.gRPC基础</h2><h3 id="1-1-RPC是什么">1.1 RPC是什么</h3><ul><li>在分布式计算，远程过程调用（英语：Remote Procedure Call，缩写为 RPC）是一个计算机通信协议。</li><li>该协议允许运行于一台计算机的程序调用另一个地址空间（通常为一个开放网络的一台计算机）的子程序</li><li>而程序员就像调用本地程序一样，无需额外地为这个交互作用编程（无需关注细节）。</li><li>RPC是一种服务器-客户端（Client/Server）模式，经典实现是一个通过<code>发送请求-接受回应</code>进行信息交互的系统。</li></ul><h3 id="1-2-gRPC是什么">1.2 gRPC是什么</h3><ul><li><code>gRPC</code>是一种现代化开源的高性能RPC框架，能够运行于任意环境之中。</li><li>最初由谷歌进行开发，它使用HTTP/2作为传输协议。</li><li>在gRPC里，客户端可以像调用本地方法一样直接调用其他机器上的服务端应用程序的方法，帮助你更容易创建分布式应用程序和服务。</li><li>与许多RPC系统一样，gRPC是基于定义一个服务，指定一个可以远程调用的带有参数和返回类型的的方法。</li><li>在服务端程序中实现这个接口并且运行gRPC服务处理客户端调用。</li><li>在客户端，有一个stub提供和服务端相同的方</li></ul><h3 id="1-3-为什么要用gRPC">1.3 为什么要用gRPC</h3><ul><li>使用gRPC， 我们可以一次性的在一个<code>.proto</code>文件中定义服务并使用任何支持它的语言去实现客户端和服务端</li><li>反过来，它们可以应用在各种场景中，从Google的服务器到你自己的平板电脑—— gRPC帮你解决了不同语言及环境间通信的复杂性。</li><li>使用<code>protocol buffers</code>还能获得其他好处，包括高效的序列号，简单的IDL以及容易进行接口更新。</li><li>总之一句话，使用gRPC能让我们更容易编写跨语言的分布式代码。</li></ul><h2 id="02-安装gRPC">02.安装gRPC</h2><h3 id="2-1-安装gRPC">2.1 安装gRPC</h3><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get <span class="token parameter variable">-u</span> google.golang.org/grpc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="2-2-安装Protocol-Buffers-v3">2.2 安装Protocol Buffers v3</h3><ul><li>安装用于生成gRPC服务代码的协议编译器，最简单的方法是从下面的链接</li><li><a href="https://github.com/google/protobuf/releases">https://github.com/google/protobuf/releases</a></li><li>下载适合你平台的预编译好的二进制文件（<code>protoc-&lt;version&gt;-&lt;platform&gt;.zip</code>）。</li><li>下载完之后，执行下面的步骤：<ul><li>1、解压下载好的文件</li><li>2、把<code>protoc</code>二进制文件的路径加到环境变量中</li></ul></li><li>接下来执行下面的命令安装protoc的Go插件</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get <span class="token parameter variable">-u</span> github.com/golang/protobuf/protoc-gen-go<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>编译插件<code>protoc-gen-go</code>将会安装到<code>$GOBIN</code>，默认是<code>$GOPATH/bin</code>，它必须在你的<code>$PATH</code>中以便协议编译器<code>protoc</code>能够找到它。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>viper配置管理</title>
    <link href="/2022/06/09/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20viper/"/>
    <url>/2022/06/09/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20viper/</url>
    
    <content type="html"><![CDATA[<h1 id="12-viper配置管理">12.viper配置管理</h1><h2 id="01-viper介绍">01.viper介绍</h2><ul><li><a href="https://www.liwenzhou.com/posts/Go/viper_tutorial/">参考博客(opens new window)</a></li></ul><h3 id="1-1-viper是什么？">1.1 viper是什么？</h3><ul><li><a href="https://github.com/spf13/viper">Viper (opens new window)</a>是适用于Go应用程序的完整配置解决方案。</li><li>它被设计用于在应用程序中工作，并且可以处理所有类型的配置需求和格式</li><li>viper功能<ul><li>设置默认值</li><li>从<code>JSON</code>、<code>TOML</code>、<code>YAML</code>、<code>HCL</code>、<code>envfile</code>和<code>Java properties</code>格式的配置文件读取配置信息</li><li>实时监控和重新读取配置文件（可选）</li><li>从环境变量中读取</li><li>从远程配置系统（etcd或Consul）读取并监控配置变化</li><li>从命令行参数读取配置</li><li>从buffer读取配置</li><li>显式配置值</li></ul></li></ul><h3 id="1-2-为什么选择Viper">1.2 为什么选择Viper?</h3><ul><li>在构建现代应用程序时，你无需担心配置文件格式；</li><li>Viper能够为你执行下列操作：<ul><li>查找、加载和反序列化JSON、TOML、YAML、HCL、INI、envfile和Java properties格式的配置文件。</li><li>提供一种机制为你的不同配置选项设置默认值。</li><li>提供一种机制来通过命令行参数覆盖指定选项的值。</li><li>提供别名系统，以便在不破坏现有代码的情况下轻松重命名参数。</li><li>当用户提供了与默认值相同的命令行或配置文件时，可以很容易地分辨出它们之间的区别。</li></ul></li><li><code>Viper会按照下面的优先，每个项目的优先级都高于它下面的项目</code><ul><li>显示调用<code>Set</code>设置值</li><li>命令行参数（flag）</li><li>环境变量</li><li>配置文件</li><li>key/value存储</li><li>默认值</li></ul></li><li><strong>重要：</strong> 目前Viper配置的键（Key）是<code>大小写不敏感的</code></li></ul><h3 id="1-3-viper安装">1.3 viper安装</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>spf13<span class="token operator">/</span>viper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h2 id="02-viper设置配置">02.viper设置配置</h2><h3 id="2-1-建立默认值">2.1 建立默认值</h3><ul><li>一个好的配置系统应该支持默认值。</li><li>键不需要默认值，但如果没有通过配置文件、环境变量、远程配置或命令行标志（flag）设置键，则默认值非常有用。</li><li>例如：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"ContentDir"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"LayoutDir"</span><span class="token punctuation">,</span> <span class="token string">"layouts"</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">SetDefault</span><span class="token punctuation">(</span><span class="token string">"Taxonomies"</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"tag"</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token string">"category"</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-读取配置文件">2.2 读取配置文件</h3><ul><li>Viper需要最少知道在哪里查找配置文件的配置。</li><li>Viper支持<code>JSON</code>、<code>TOML</code>、<code>YAML</code>、<code>HCL</code>、<code>envfile</code>和<code>Java properties</code>格式的配置文件。</li><li>Viper可以搜索多个路径，但目前单个Viper实例只支持单个配置文件。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./config.yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 指定配置文件路径</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span> <span class="token comment">// 配置文件名称(无扩展名)</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 如果配置文件的名称中没有扩展名，则需要配置此项</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"/etc/appname/"</span><span class="token punctuation">)</span>   <span class="token comment">// 查找配置文件所在的路径</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"$HOME/.appname"</span><span class="token punctuation">)</span>  <span class="token comment">// 多次调用以添加多个搜索路径</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>               <span class="token comment">// 还可以在工作目录中查找配置</span>err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查找并读取配置文件</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 处理读取配置文件的错误</span><span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-写入配置文件">2.3 写入配置文件</h3><ul><li>从配置文件中读取配置文件是有用的，但是有时你想要存储在运行时所做的所有修改。</li><li>为此，可以使用下面一组命令，每个命令都有自己的用途</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">viper<span class="token punctuation">.</span><span class="token function">WriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 将当前配置写入“viper.AddConfigPath()”和“viper.SetConfigName”设置的预定义路径</span>viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">WriteConfigAs</span><span class="token punctuation">(</span><span class="token string">"/path/to/my/.config"</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfigAs</span><span class="token punctuation">(</span><span class="token string">"/path/to/my/.config"</span><span class="token punctuation">)</span> <span class="token comment">// 因为该配置文件写入过，所以会报错</span>viper<span class="token punctuation">.</span><span class="token function">SafeWriteConfigAs</span><span class="token punctuation">(</span><span class="token string">"/path/to/my/.other_config"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-监控并重新读取配置文件">2.4 监控并重新读取配置文件</h3><ul><li>确保在调用<code>WatchConfig()</code>之前添加了所有的配置路径。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 配置文件发生变更之后会调用的回调函数</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Config file changed:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-覆盖设置">2.4 覆盖设置</h3><ul><li>这些可能来自命令行标志，也可能来自你自己的应用程序逻辑。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"Verbose"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"LogFile"</span><span class="token punctuation">,</span> LogFile<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h2 id="03-viper读取配置">03.viper读取配置</h2><h3 id="3-1-几种访问值的方法">3.1 几种访问值的方法</h3><ul><li>在Viper中，有几种方法可以根据值的类型获取值</li><li><code>Get(key string) : interface&#123;&#125;</code></li><li><code>GetBool(key string) : bool</code></li><li><code>GetFloat64(key string) : float64</code></li><li><code>GetInt(key string) : int</code></li><li><code>GetIntSlice(key string) : []int</code></li><li><code>GetString(key string) : string</code></li><li><code>GetStringMap(key string) : map[string]interface&#123;&#125;</code></li><li><code>GetStringMapString(key string) : map[string]string</code></li><li><code>GetStringSlice(key string) : []string</code></li><li><code>GetTime(key string) : time.Time</code></li><li><code>GetDuration(key string) : time.Duration</code></li><li><code>IsSet(key string) : bool</code></li><li><code>AllSettings() : map[string]interface&#123;&#125;</code></li></ul><p>例如：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"logfile"</span><span class="token punctuation">)</span> <span class="token comment">// 不区分大小写的设置和获取</span><span class="token keyword">if</span> viper<span class="token punctuation">.</span><span class="token function">GetBool</span><span class="token punctuation">(</span><span class="token string">"verbose"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"verbose enabled"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-访问嵌套的键">3.2 访问嵌套的键</h3><ul><li>问器方法也接受深度嵌套键的格式化路径</li><li>例如，如果加载下面的JSON文件</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>    <span class="token property">"host"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"address"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>        <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">5799</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"metric"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>            <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">3099</span>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>        <span class="token property">"warehouse"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>            <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"198.0.0.1"</span><span class="token punctuation">,</span>            <span class="token property">"port"</span><span class="token operator">:</span> <span class="token number">2112</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>Viper可以通过传入<code>.</code>分隔的路径来访问嵌套字段：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"datastore.metric.host"</span><span class="token punctuation">)</span> <span class="token comment">// (返回 "127.0.0.1")</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="3-3-提取子树">3.3 提取子树</h3><ul><li>例如，<code>viper</code>实例现在代表了以下配置：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">app</span><span class="token punctuation">:</span>  <span class="token key atrule">cache1</span><span class="token punctuation">:</span>    <span class="token key atrule">max-items</span><span class="token punctuation">:</span> <span class="token number">100</span>    <span class="token key atrule">item-size</span><span class="token punctuation">:</span> <span class="token number">64</span>  <span class="token key atrule">cache2</span><span class="token punctuation">:</span>    <span class="token key atrule">max-items</span><span class="token punctuation">:</span> <span class="token number">200</span>    <span class="token key atrule">item-size</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>执行后：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">subv <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"app.cache1"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li><code>subv</code>现在就代表：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">max-items</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token key atrule">item-size</span><span class="token punctuation">:</span> <span class="token number">64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><ul><li>假设我们现在有这么一个函数：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg <span class="token operator">*</span>Viper<span class="token punctuation">)</span> <span class="token operator">*</span>Cache <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>它基于<code>subv</code>格式的配置信息创建缓存。现在，可以轻松地分别创建这两个缓存，如下所示：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">cfg1 <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"app.cache1"</span><span class="token punctuation">)</span>cache1 <span class="token operator">:=</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg1<span class="token punctuation">)</span>cfg2 <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token string">"app.cache2"</span><span class="token punctuation">)</span>cache2 <span class="token operator">:=</span> <span class="token function">NewCache</span><span class="token punctuation">(</span>cfg2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-4-反序列化">3.4 反序列化</h3><p>你还可以选择将所有或特定的值解析到结构体、map等。</p><p>有两种方法可以做到这一点：</p><ul><li><code>Unmarshal(rawVal interface&#123;&#125;) : error</code></li><li><code>UnmarshalKey(key string, rawVal interface&#123;&#125;) : error</code></li></ul><p><img src="/img/image-20210609094655146.46d6e697.png" alt=""></p><ul><li><code>main.go</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/spf13/viper"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Port        <span class="token builtin">int</span>    <span class="token string">`mapstructure:"port"`</span>Version     <span class="token builtin">string</span> <span class="token string">`mapstructure:"version"`</span>MySQLConfig <span class="token string">`mapstructure:"mysql"`</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> MySQLConfig <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Host   <span class="token builtin">string</span> <span class="token string">`mapstructure:"host"`</span>DbName <span class="token builtin">string</span> <span class="token string">`mapstructure:"dbname"`</span>Port   <span class="token builtin">int</span>    <span class="token string">`mapstructure:"port"`</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 读取配置文件</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigFile</span><span class="token punctuation">(</span><span class="token string">"./config.yaml"</span><span class="token punctuation">)</span> <span class="token comment">// 指定配置文件路径</span>err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查找并读取配置文件</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>             <span class="token comment">// 处理读取配置文件的错误</span><span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> c Config<span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"viper.Unmarshal failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"c:%#v\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>config.yaml</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"v0.0.2"</span><span class="token key atrule">mysql</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"127.0.0.1"</span>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">13306</span>  <span class="token key atrule">dbname</span><span class="token punctuation">:</span> <span class="token string">"sql_demo"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-使用Viper示例">04.使用Viper示例</h2><ul><li>目录结构</li></ul><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATIAAAClCAYAAADf0nGKAAAgAElEQVR4nO2de1Bc95XnP7cRCMSzuyX0tCMQMIptybIaeQxrxxkTawxRElkR+JHE8sxmmsxW7dbCOrVTW1bKFWd3djYOpGpSKdMzdqzYlcSgTOREBgcFPyJHnVhCfuDEuBtoWbb14v0SCETf/aMf3G4aaOhuuhvOp6qr4N7f4/SF/vY55/e79ygtLS2qTqcjOTmZm2++mYGRCQRBEGKd/u5PAZicnEQXZVsEQRBCRoRMEIS4R4RMEIS4R4RMEIS4R4RMEOIAT2JbCIwImSAIcY8ImSAIcc+qaBsgxD9Op5PRkSGujg4zNXUdgISEVaxJTSc1LQOdLrzfl39ue5f3295ZVN9bduzi5h23htWeeGRs7CoAKSlromxJeAhJyLp7+xmfuBaSAclJq1ln1Ic0hhAdVFVloK+bvp4rOJ1TM84PDfSh0yVgWJtNlmEdiqKEZd7BwQE+Pv/RovrecOPWsNigZXx8jLdbT6OqasDziqJwm2kPyckpYZ97MdT/4nnOn3MAcOPWHCoe/EaULQqdkITscm8vQyMjIRmQkZYmQhaHOJ1TXPj4HGNXR1AUHRlZBhITk+jtvgSAcd0GJicnGB4coOfKRUZHhtl0w1Z0uoSQ587MzOKGGz+z6L7hJjk5hfSMDH7b+JsZYqYoCn9b9qWYETGAkeHhgD/HMys+tFTVLp75yu18l+/xxkuV5ITJa1jOqKrqFbGk1cls2pJDYlISV0env9SSU1IxrF2PwbieC584GLs6woWPz7H5xtyQPbObd9wac+HhLTt2AfiImUfEPOeiwdWrVxkZHiJ7/QaczinefecsQ4MD3vNDgwO8ffY0t+7ajU6XwJXLl0hLz2DNmvgKOWNeyByWUu5+4rTvwUIRnWgy0NftFbEbtubPmQNLTErihq35fHzOztjVEQb6utEbsyNil9Pp5PWWZgA+X7I37Lm5+dCKGRB1EVNVlVdefomuTjs3bs1h/OpVrly57NPm+vXrtDQ30fbOWZLXrOH8OQe52/K5/+CDYUsFLAUhC1m20UC20bCovld6+xi/FsRN6hrh8nhQd3+FsIiZouTyzV/38M2QRpmJqrbwT5sfgBe6+Zd74ucfYj6cU1P09VxBUXRs2pITlFjodK62H3V9SF/PFTKzjOgSQg8xtUxMTHD817+kq8MOwMBgP/u+/FWSkpLCOs98aIUrmiIG4OjqoKvTdT08ObHZ0ApcV6cdR1cHudvyI2pfOAlZyFYnJaFLXkPHaOBE52zkpSqsThoJTsg0KEou//mH3+PlOx/n6dcq+Zd7FtRdCJHR0SGczikyMg0k+olEUlIShrXrvT9rSUxKIj0ji6HBPkZHh0jPCF9edGRkmP+o/5nvh7HDzi9e+AkHKh4mLS09bHMFQ7QFzMOlixcCHt+x8zZ23HobAG3vvk3be28H7LuihAxgeArODk0uqM/65BC+KXPyKdD8+vq31/LIh9/jp/te4pEnTvt6cF1Pc+DOx2nVtH/Iz0vy9Nd6eDP6BQhnPV7Xz/3a8G9l0+Hw19fxc8D0xFv8ypwb1Nu7fOkinR22oNpuyytg/YaNQbUNB2NXRwFm5MSSkpJYlZiEcd0G77HrkxNMTEx/UXmEb+zqaNiE7Nr4OL9/7XesTk4OuADw+9d+R8m9paxOTg7LfB6GBgcYHBxcVN/MzEwyIrDo4E/xnXeTkZnJiVdeZmrKtaq8Y+dt/G3Zl7xtNm3eAuAVs4SEBO6974thEeOlvEYxnyMLiMOOjT18UbuSfuZxHvmrFzl/ocR7SH21ms98/ac89EI3v7pHK1DruH8OYXH1+4DvvNnNr3IDh7OesU1PvMV59zhq19M88xp809zER/+w+NByXfZ6/nDyNbo6O+Zsl7stjzuK71rQ2KFyfdL1heVZnfRgWLveR8QABgf66OvxzcloxwgHq5OTKfvS/WEbL1jeb3uXU2++sai+xXfeTfGdd4fZosDcsmMXr554ZVrIdt02o82OXbf5CFm4PMqlvEZxt7NfVVv4pzsfp/Vrj/HNXK1APMJP/989vu3cQqMVEiX3W9Q8sYfWJ37E6wH2/ahqF8/88Kc89EKjd3xPOGs68xItjuk2fO1FHzFUcr/FN8OQD9PpdHxpfzkbN22etc3GTZv50v7yJU9oC0IsEh8e2ZnHuXvz495ftV6Ql8ICfAILhx0bUJCXM2O4rXmfBT6gwwGf93fKHM28fAZa3SGhPwXnAFxtHvrvkUvQJSYmcqD8IX7+/E/o6+v1OWcwGDlQ/hCJiYkRm382VrnnNK7bQHJKqvd4oKR6ZpaBlDVp3t/Hx0bp7b7kHSMcXBsfp+VEE8PDQwHPp6dnRCS0vGXHrYveXJuZmRlWW+bi/bZ3vN4YQNs7b7Np0xafNm3vTOfIpqameL/tnbB4ZUt5jeJDyKKw3cI/j6ZF7VoaG1JS1nDwga/xs+d/wsiIa+NiWlo6Bx/4WtRuLUlZk8pgfy+TExPexL6H65MTDA70AS4RW5Xoypt5GB7s944RLlYnJ/O5v/nCjGQ/QHb2er745QNhFzGAjMysJclzhcKpN9+YEdp5QsjZkv1TU1O88vKvGRocDDn8XcprtHzjEveCgK1j5rLzuY4PgM8SwFmbs9+C2oSJjMwsDlQ8zOrkZFYnJ3Og4uGofoBSUzPQ6RIYHhpgcsJ3xXliYoK+nsv09Vz2SfIDTE5MMDw0gE6XQGpqRlhtSktL58Gv/x25edOrbLl5+Tz49b9b8hVLcHlBi70XNJxs2Lgp4PG2997mZ88/y8+efzbgiuVcfWOVZStkilLCt57YQ+sTt/M/X53OhamvVnP3E6d56IUf8PkAHt6s/bqe5v5vt8w7tvZ3CI/YZWevZ/+BB9h/4AGys9fP3yGC6BJc906qqpMLnzhwOp3z9nE6XW1V1YlhbXbY95CBK7Tdf+ABdptuZ7fpdvYfeGDJ95CBS8R+2/gbftv4m6iLWU5unncLxY1bc+b838nOXs+NW13f7Lnb8snJzVsSG8NFfISWiyTH3MRHedV8xifftYfvvNntt1Aws98blHK3tl/h93jjpXt82swY+2svcv77ngWCEv7vC4/wma/fzo1PLGz7RSAWe29hJMgyrGN0ZJixqyN8fM7uvUUpEJMTE1z4xMHEtXFS1qSRZVgXMbt0Oh333HtfxMafD4+IeW5R8uzwj9a+MkVRuO+LX5lxi9Ibr57g+nXXU0pWrVrF3ffcO+MWpXja1Q+ghFIO7n1bB5npaaxfv4Heyfm/mbUYE3VcvnyJweERbimIrvq//u21PMKLnP9+yfyNBWDmTePpmVmz3jSuqk5S1qSF7abxWHyMj7+IeQjX/Zb93Z+iXzf7KvZCePbffkxfbw8ABuNa/v4f/ktYxl1qtOXgQvbIBodHgEvztvPnsrdvdFHVLjo+BNO+QAkzYTZ0ugQ235jrfYzPkDvJ78EjaDpdAsZ1G5f9Y3yGh4Yo+k+fC3h+eGiI8fGxmHkCRlp6ulfI0tKXPocYCUISsrQ1KYxcHQtJkNLWRPmP+9qP+O6ZPXznhyJkC0VRFPTGbDL1a5f0wYqx+Bif2UQsFql48BvyYEUtW7eEx9WNBtqnajz0wtw5M2FudDod6RlZpGcszWpqLD7GJ95YLgLmYVkn++cix9zEeXO0rRAEIRws2+0XgiCsHETIBCEOCNeK5XJFhEwQhLhHhEwQhLhHhEwQhLhnxqqlZ7esIAhCvOAjZOnp6ezcuTNatgiCIATNe++95/1ZQktBEOIeETJBEOIeETJBEOIeETJBEOKemLrX8vyFy4yOjfkcS1q1ivXrjNF/SoYgCDFLTHlkH316ifbOj3xe733YScsfTmM/93FkJ7fXUqwoKEoxtfbIThUSTZUoioKiVNIUbVuEGTha6qg72kp/tA2Zk35aj9ZR1xL5mhNLRUx5ZLPhVFXet3XhdDr5q9zYeeSzsBgctNQ106l5yOK2e82UzHgcnKsdeysDnIu8fYubt5++2FawZUtcCJmHv3Sc4y8d5+Zss1afxV17FvGsqvwqTqlVi7RMCIb+1qM0tPaxbW8lZo1IOFqO0pp1EJNe2zqH3Dxobm1ld44Jvf9gESOUefWYDlZiipBlwuwsOLS8ePEiTz/9NP39s3/12Gw2nnnmGcb88l3CCsbRQv0ZMJXP9L5ySvxFzH18dyHGXgddS+zlRGteYfEs2CMbGRmhp6eH5557jkcffRS93vc/0GazUV9fT2pqKuPj46SkRD9J31SpUGYBMNOo1lEKgJ3a4gKqrYC5EfWxdooLqrFSRI3tFFX5TVQqZViAohobRzhEQbXVPaJ2HO8kKK5JXBTVYDtVhasY1/RY5sZGKCvD4p1nbtvttcW+8zbO+iaDmn/GezE3otaV+vUP4v25xzo13xsAoJ/W1g6MhRUBBcun3dF6zlBIxUETen0uOcYzOLr6Mc3o6Grb2ucKUVV1G3srS8gJx/lZ5nW01NHc77ZNY4n2+IBfG++5EmipP0OfO6RWt91Lpb+i97dyVNvGYPKZyzPW3hwHJ1r7ZpyfFUcLlhOd3l/VbSYKA7ULZn72UpHVSkNrn08b3N524Gs9c2yYLaWwOBYsZPn5+VRUVFBfXz9DzLQiFkjkokXpYzUUWaqxYuFYUx2lpYD9OA1WgCJqHisF2mftb60uoMDniIWy4u1eofAVG28nCorRiIm7Z1lZ0HZPC7Bm3gDdFzI/DYcosGraWsoobivCqj0WzPvDdV2UdrcQzkV/F45e0M+tYgHQYzLlcab5LA6T7wejv/UslFRi1oNHlJqPZnk/eKGdDzxvTm4eNDvo6jdNC3J/K60dkLfXNe5AgHeh9LVS32KiorLSJQr9rRytb6aOvdNi5mihrrmfwopKDmpsqj+Kj5gofa006++l0hykArhFTCsajpY6TvQp+KlxcPN3nqDFVI7ZrPeKU4Ol1SXM5hw8Ocbmllyf92Y50cm2vZUc9Jjd38rR+jqOFlZwcMH/FzNZ1KplQUEBFRUVjI6O8txzz9Hf3x+zIgZA/j7Ki1w/trW7liTtxxtw6Vg5++ZzKopqsKkqqqpiq3EPZG3guB2giafcH3Jzo6uNqtqoKQKs1Tzlv7ToHWseb8xey5NeB6nRd1wfFja/lXL3/I14nvRttUKNzdW30XuwnQ63HYe03pv/dbA8GeQqr5GseR/p78oxVWq9jJxc8uigy2+BTW8q0Xh3LuGhd8ArJKGeDzhvzm4Kjb04NDFnf5eDXvLInUNXVHUbe7XvSW+ipNAIHV24hnd5rHl7D/raVDIzxFXVbewN2o1x0NLcgcFU7uP55JRUYDJoy9YtYH6DiRJPI70JU56/Ta4cI/197pXbwDZ4rkHvmbOEY+100cl+j5jV19fz7LPPMjY2FpsiBkA++8qLqLZasTYcx15VRUe768NZVL6P+XTMfHjaq8mvOoy5ugwLVto7gI5jePTGUqZg8evb1m5HG6Npx5qTjnbcFro9Rtf7qDpsplrrpjUtbP7p91vKfjNYLPiIean34Fx2+F6HhuN2qoIKMReDO/ne5aAkx/cD7Gip40SntmjMtjCeDzSvntwcI2ccXfSbTOjpp8vRi7HQL4zyx5iFv4brDXo8q5w5uDzWvhMWOv37KqAfYNp7CjDWrLjFxDXXXO0WML/eMDOU9bMpK8uId//JHDb4XIMQJSOkVUutmMWuiLnI31dOUbUVq7WB4/bttFsAiiif1x3zw95OWyQMjGN2bJ/nGuoN6Jkt1zU/ObsLMda30ro7x+0xuMKXDvKmczGOFuqaPT1CPT/bvKDPzcF45gxnHSZKsrpw9BrJKQnP/3w4c0bxOH8ohLwhtqCggAcffDCmRQzQhJdWGg496fJczIfnTbYDWJ6sxRM9NT1V7fVQtucBedvxRHvTod30K7hkeAC847o8Hhd2ap+0zNIuzPMHsKNaE6faa93X0HMd5sTl3Sw6jNDnkqMN6RxddGCksGLaE+rXbuAK9fxs84I3nOrocrjCyjzTPAsY+IasXhM6wJhDrh6vlxPQhlCYddwBBnqDaRdJGzzH9MznMAZDWHb25+XlxbaIAZ7wEvAmts3750lSe7BWU6AoKIom+e4RwfwqDrvzSpYyxb3r3v0qnhbAhZs7ndezVhe4x3Svsvq0i9D8AcbHUuYde3rVM7gvg5ySCgqNHTTXHaXV53+6n9ajnmPuHeczdsa7QrpeR5f3uKL0MeBRh/5WWs70+vQI9fxs84I76d/RSoujl7y5kmPeuTpp1u6id7RwolMhz+TJm+Wwu9BIX2sDPpvt+1s5GtLue88XSIvPNXe0+G5Ijtz8c4ztaKGhtY+8vfOE5UESVxtiQ2U6rwNgJlgdK6pppLyhbFpEzL4rdaV1KrbtAVb2dmwPLh8W2FqqTtmguMBnXtv2J2fME5n5fcdX98/cfmFuVJlvwXIaVyI/t/UoDQ0WWt1HVdVAYUXgfWQ+vU0m8s40u0K6nBLKTf00uHM6qsFExd486j2hYajnZ53X0z+XPJrpoDCoUEw1mNib1YrFcsJ7zD+M05sOUs5Rr02efhUHQ/uY55RUspc6Tmiu+bZ7KzD113NG0y5S83vGNhtasGjHVg0UVpjn92aDRGlpaVF1Oh3Jycnccccd4Rl1kZw8/S49/YEWsINn0Tv7Z+C79yrkEE0IGc8+phn7r2J43tn2ngmh43lC7OTkZGx5ZDu35zF5fTKkMRJXJYbJGiHWCJR8X87zCsETU0KWmZ4abROEWEZv4mBlFO5kjNa8QtDElJCtLKZD1xn43F4kCLMx80kiHoK+fWmZEFM5MkEQhGDR5shi6sGKgiAIi2HZhJZ9N0ggJiwew8ex/FhgYT7EIxMEIe4RIRMEIe5ZNqGlFgkThGCQdMTyQTwyQRDiHhEyQRDinmUZWvojhX8FYXmzIoTso08vBbwZXWfr4qb8HPK33hAFq0LAXusulCI3tAsCrBAhm434LPzbRGVBNdTYUEXABAFY4ULmIaKFf8ONvZ22xTyiWxCWMTGT7JfCv0HiLQYiCIKHmBEybeHfQGLmKTc3NDTE+Ph4FCycjyYq53rMtL2WYsX3UdSVPqXa7NQWKyiVTdhrizXtKvE0a6pU3E9ptVJdoKAoxUGWYhOE5U3MCJmn8K+2VqaHmK6ZCa4q3EoZbTW26cIfR+B4k+Z8QTU7tMVBbDW0lSkU+yuRpYxDHHG3a8SMhTK34pXWqaiNZqDIXYdy/krlgrASiBkhgzgs/At4KxuZG31XD/OrqCoFaKKyzEJRjc33+fb5VRypKcJa/RQ+jllRDUe845TyWE0RWI7hX+dXEIRpYkrIwFfMnn322RgXMcB+nAbrHBWZ3HUwA9V+zN++A2ijXeuUhalgiCCsJGJOyGBazGK7erkgCLFCzG6/8BT+NRqNsS1i+dvZAbS126E0gC81x3l7exuwg/kKdQuCMDcx6ZF5iI/Cv648lrW6wHcVsqnS/fvs5wuqrZgb6wi6NKQgCAGJWY8snsivOoW6vRKlTJkuJmJuRK2b47x75VFWHQUhdJZN8RHts6X8n0cWW4V/hVhhrv8ZIfaJ2QK9kUIK/wrC8mZFCJkU/hWE5U1MJ/sFQRCCQYRMEIS4R4RMEIS4R4RMEIS4R4RMEIS4R4RMEIS4R4RMEIS4R4RMEIS4Z9WePXvQ6XR0dnZG25Zlx+WePtavNXDy9LsBz+/cniebdQUhDKyInf3R4IPOc/T0DbJ+rWHW+zxDvW1KEAQXElpGgA86z9He+VG0zVg4mgIpxbV2V7ET/yIqcUS82y8EjwhZmIlbEdMW/lVVTlVBe1u0bRKE4JDQMozEr4gRoPBvPlWnVKqiapQgBIcIWZhwOp2sM2SxzpDlPRZXj/5xF/4tj7YdgrAIJLQME2PXJujuG/B5XbjSzQed50IcOXqFfwPmmJoqfeYqrm3yjh/Q+lnyVL7H3TYGsM3b1t9+d9/Z3pOwshAhCxNj4+O0d34U8LVoYqzwr722GKXMglkz3+H2Mqqts7+F0v1msDZw3FcNOWYB8+Eq8gF77VNwxDOmjZoiC2X+4qe131ZDkbWaAkWhoP1wwPckrCxEyGKWWCv828RT1dYZ85XW2agpmqNb6WPUFFlp0CpZ0zEsmPGUAs2vqtMIZz5Vh81gbadjNvvzqzhsBjDT6DWmlP1moK1dVilXIJIjCxNr9Vncv/fu8A3oKfx7OLTCv94KdKEW/p1jvrnJZ195EdUNx7FXVZHvFuiiGptP9aimSoUyi7af2XeYQPYXbSdP82ve9iKQldYViQhZiDjbbKgDw2EZK+EuU1jGiTXy95VTVN3AcXsVVRynwVpE+RGPLDVRqZRhwUyj6i6N11SJUhZFg4W4Q4QsRN47+zajV7r567ztAEw5nZx47yzpa1KZmLzG39y8y9v2rc4PmZpyUlTwWY6f/RNFBTdhTEsPPHCsFf6ddb4O2q3Ajrn67qO8qJqG43b20YC1qJxpHTuGhSJqbNP1PT32C0KwSI4sRDYY1/KLP7xO15VLAPyu7Sytjg56hwept57kRNvbALRf+JjnXm/mj/YPAHj57Fv0jgzNMXKsFf515aCs1YfQriM0VZbhExF6Vll9jHLlvawNT/FUg9Wb5J/GSrsnIWav5dBcqweCEAARshBZl5nFlwvv4Ke//x0f93bzyjtneORzJegUhTVJq3np9ClaHXaefe23pCSuXtDY+VWnUBvNWMo0WxOO7fcm2wOeL2ujxqb6LgCEidI6lUazZ4uG63Vsv3+yP4/tgZL/pfsxWy1YrNNJfveg2GqKpt/DITjSaA4wgCDMjjI0NKR6nn6xc+fOaNuzaKJVbHXqZCvOnj5+cPyXfNLTwxd23sa+3X/N8bN/wn7xU3LXb+SVd85QsHEzues30nX5IlVfPMA//vu/UrXvAAUbNnvHWnX/F5bM7vBhp7a4gOodjahzqmew7ZYOKdAb32gL9IpHFgYUFMp27eHa9Unu21Xoc+7LhXdwzy27MH+hjATdMrzcntXV/fOIk92V5K95LDZETFheSLI/TKxa5bqUq3QJPscVFMrvuCtgnz/aPsB24RMAbv1MLjmRNTFk7LXFHOKIZl+b60Zza1ENR+bRp6anqrGaGzkVzgUIQXAjQhYmUhKTKNg4HSYa0zIYM074tNEeK9i4md7hIXqHXQn/3OwNS2fsIsmvOsXhSgVF0Rw0zx0q2muLKai2QlENtlPijQmRQXJkITJ1shW1pz8sY8Vnjix+kRxZfKPNkYlHFiLLdROrIMQTyzD7LAjCSkOETBCEuEeETBCEuEeETBCEuGdZJvu1q1GCICx/xCMTBCHuESETBCHuicnQ8uLFi4yMjJCfH3yIuNANjZ7SbWv1Wdy151Z+1fxGwHZ37bmVtfqsgOeWN7F3k7cgzEbMeWSqqvLSSy/x4osvYrPZIjJHXNefFARhBjEnZIqi8MADD5Camkp9fX3YxUxETBCWHzEZWur1eh599FGee+456uvrqaiooKCgIORx476IriAIAYk5j8yDR8zC6ZlFroguwReunbegbqChQyhQG+x8fvYrlccXfy0EYYmJWSGDaTFLSUmhvr6ejo6O+TvNgbaI7qk/nea1k3/wvi5e+MT76uu5sqBxgy5cu5CCuv4spkBtsPM1Vc6wv5HqOQvvCkIsEdNCBtDd3c3Y2BipqakYjcawjfvWyTd45T8aAr7eOhl4BTMwwRauXWBBXX8WXKA22PkCt5u38K4gxBAxmSPzYLPZqK+vJzU1lUcffRS9Xh+2se+7vzw8AwVbuHahBXX9WWiB2mDnY7GFdwUhdohZIYukiAG89eYb9HUHDiEN67K5/c4wVg0XBCGixGRoGWkRAzCsXcf6LTcEfBnWrgt+IG3hWh/chWvnbbcEBXXnmi9Y+wUhhok5IVNVlZMnT0ZUxAAMa9eyYfMWn9ctO2/jtj13kLf9pgWMFGzh2mAL6gYqcLsYgp0vWPsFIXaJudBSURQefvhhrl27RlZW5G4NeuvkG1z89BOfY/cdKGfjpi0LHqu0TqURhbIChWr3MXOjjZq2Au/v4C6ou70SpUzRiEQRNTYVb2Gi2QrcLoLg5gvefkGIVZZN8ZFg6Okf4OTpdxfUZ/H3Wsq9ioIQSaRA71IQbOFaQRBCRoQsDNhri/02tE4XrpXC2oIQeWIuRxZJElclLjhMDOZezMUUrhUEIXysqByZIAjLh2VXoFee0R8/SEVvIRJIjkwQhLhHhEwQhLhnWYSWWiR0iT0k9BcijXhkgiDEPSJkgiDEPcsutFwI5wau0XZljO7RSQCyUxO5JTuFrVmro2yZIAgLYcUJ2dVJJzqg4YM+/nxlzOecrXecN88Pc3N2CuWfNeAE1iSK0yoIsc6KErKB8Sl+cOoiqYkJDFy7Pmu7P18Z49PBy4xOTvE/ijeSlZywhFZO01SpUNZWg+1U1cynwwqC4GVFCZlOAQUYuHadGzKTuDc3k+7RSX5jGyAxQWHPplQATl8YZeDadZJ0Cjpl7jEjh532tvlbCYKwwpL9GasT+OpNBpJ0Ov6xcD2nX/klyidtPLzDSPlNBtb1tTN0+mXKbzIA8NWbDGSsjo43BvlUnVJRxRsThHlZUUIGkJqkIzttFToFDh8+zNNPP83m9CS2ZCRRV1fH448/zpaMJEDyY4IQL6y4T2pqYgKfDE0wfG2KkydP8uMf/5hf/fHP/Pqtdv71Rz/i5JtvYv14BIC0pOC8scUX0LW7ivjOcr6pcnocb1v/eQIV5Z1pYMSKBwtCLLDihGz1KlfS659PXuD3fcnUne3F9ovv8+HPvk/d2V5+/lECJ88PAwv0yBZRQNde+xQc8RTFtVFTZKHMK1xBzBOoKK8fS1I8WBCizIoSMtXpZMjxFxScOIF3L1+le0LHff/tf/OF//pdeiZ09I25VjMVnAw4/ozqdAY3+IIL6EJ+VZ3m2fn5VB02g7WdOeupa5rfYNYAAAISSURBVOdxFxjBcmwWr2yJigcLQpRZUUI2NjzAh68dI3ly1Od48yUdJy75XorkyVHaXz3G2PBAcIMHW0DXj6ZKTShXFkTdokDzzEaYiwcLQqyyooRsTaaBwkceYywxfd62Y4npmL7xGGsyDRGyxlX2rcxiptETyjWaIzSXICxvVpSQAVxbwNa58Uhus2s6hoUiamye+pKewrlhJFaLBwtCmFlxQjY8EWTOCxiZmIqgJQBW2j0JMXsth2Zk4BeKf3HfcBcPFoTYZMUJ2ZRTDbrtApounNI6bDVFWMrc+bFDcCTk0HJmcd/SOpVGs5Xqgulc3LH9/sl+dzHfRvO0PYqCUtZGjU1FaqgIsc6yKD6ifXDffA9WHJmY4v+cvDCvSOkU+F93bQp6L1l8sbTFgxfy9xGEYFnRBXrTkhL4/NaMedt9fmvGMhUxpHiwsOxYcUIGkPLH5ylZc5lVAe4IX6VTKFlzmZQ/Ph8Fy8KPFA8WVgIr6ukXHnJ334lhy1aKV2fQ3jtG/5grqa9PSWC7MQXdtTT69Mvj0kjxYGElsDw+rQtk82d3eX82bUyd2SApy6dNvFNap6LWRdsKQYgcKzK0FARhebHsPDIpPSYIKw/xyARBiHtEyARBiHuWRWgpmywFYWUjHpkgCHFP3Hhkg8OjvOe+w3rn9jwy0wNsmxAEYUUSN0I2eX2Snv4B78+CIAge/j8UQ8AdT/eHsAAAAABJRU5ErkJggg==" alt="img"></p><h3 id="4-1-conf-config-yaml">4.1 ./conf/config.yaml</h3><figure><div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8123</span><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"v1.2.3"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-gin中使用viper案例">4.2 gin中使用viper案例</h3><ul><li>这里用一个demo演示如何在gin框架搭建的web项目中使用<code>viper</code>，使用viper加载配置文件中的信息</li><li>并在代码中直接使用<code>viper.GetXXX()</code>方法获取对应的配置值。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/fsnotify/fsnotify"</span><span class="token string">"github.com/gin-gonic/gin"</span><span class="token string">"github.com/spf13/viper"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 第一：viper配置</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>       <span class="token comment">// 还可以在工作目录中查找配置</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span>  <span class="token comment">// 配置文件名称(无扩展名)</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span>    <span class="token comment">// 如果配置文件的名称中没有扩展名，则需要配置此项</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"./conf/"</span><span class="token punctuation">)</span> <span class="token comment">// 指定查找配置文件的路径</span>err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 读取配置信息</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>             <span class="token comment">// 读取配置信息失败</span><span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二：实时监控配置文件的变化</span>viper<span class="token punctuation">.</span><span class="token function">WatchConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>viper<span class="token punctuation">.</span><span class="token function">OnConfigChange</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>e fsnotify<span class="token punctuation">.</span>Event<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 配置文件发生变更之后会调用的回调函数</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Config file changed:"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// 第三：读取配置</span>r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/version"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> viper<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span><span class="token string">"version"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>r<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-3-结构体变量保存配置">4.3 结构体变量保存配置</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"github.com/spf13/viper"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Config <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Port    <span class="token builtin">int</span>    <span class="token string">`mapstructure:"port"`</span>Version <span class="token builtin">string</span> <span class="token string">`mapstructure:"version"`</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> Conf <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 第一：viper配置</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span>       <span class="token comment">// 还可以在工作目录中查找配置</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigName</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">)</span>  <span class="token comment">// 配置文件名称(无扩展名)</span>viper<span class="token punctuation">.</span><span class="token function">SetConfigType</span><span class="token punctuation">(</span><span class="token string">"yaml"</span><span class="token punctuation">)</span>    <span class="token comment">// 如果配置文件的名称中没有扩展名，则需要配置此项</span>viper<span class="token punctuation">.</span><span class="token function">AddConfigPath</span><span class="token punctuation">(</span><span class="token string">"./conf/"</span><span class="token punctuation">)</span> <span class="token comment">// 指定查找配置文件的路径</span>err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">ReadInConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 读取配置信息</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>             <span class="token comment">// 读取配置信息失败</span><span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Fatal error config file: %s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二：将读取的配置信息保存至全局变量Conf</span><span class="token keyword">if</span> err <span class="token operator">:=</span> viper<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>Conf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unmarshal conf failed, err:%s \n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Conf:%#v\n"</span><span class="token punctuation">,</span> Conf<span class="token punctuation">)</span> <span class="token comment">// 打印</span><span class="token punctuation">&#125;</span><span class="token comment">/*Conf:&amp;main.Config&#123;Port:8123, Version:"v1.2.3"&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>zap</title>
    <link href="/2022/06/07/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20zap/"/>
    <url>/2022/06/07/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20zap/</url>
    
    <content type="html"><![CDATA[<h1 id="11-zap日志包">11.zap日志包</h1><h2 id="01-日志模块介绍">01.日志模块介绍</h2><ul><li><a href="https://www.liwenzhou.com/posts/Go/zap/">参考博客(opens new window)</a></li></ul><h3 id="1-1-介绍">1.1 介绍</h3><p>在许多Go语言项目中，我们需要一个好的日志记录器能够提供下面这些功能</p><ul><li>能够将事件记录到文件中，而不是应用程序控制台。</li><li>日志切割-能够根据文件大小、时间或间隔等来切割日志文件。</li><li>支持不同的日志级别。例如INFO，DEBUG，ERROR等。</li><li>能够打印基本信息，如调用文件/函数名和行号，日志时间等。</li></ul><h3 id="1-2-默认的Go-Logger">1.2 默认的Go Logger</h3><ul><li>实现一个Go语言中的日志记录器非常简单——创建一个新的日志文件，然后设置它为日志的输出位置。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"log"</span><span class="token string">"net/http"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token comment">// 第一：设置Logger</span><span class="token keyword">func</span> <span class="token function">SetupLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logFileLocation<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"./test.log"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_RDWR<span class="token punctuation">,</span> <span class="token number">0744</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>logFileLocation<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二：使用Logger</span><span class="token keyword">func</span> <span class="token function">simpleHttpGet</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Error fetching url %s : %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Status Code for %s : %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">)</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token function">SetupLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"www.baidu.com"</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-Go-Logger的优势和劣势">1.3 Go Logger的优势和劣势</h3><ul><li>优势<ul><li>它最大的优点是使用非常简单。</li><li>我们可以设置任何<code>io.Writer</code>作为日志记录输出并向其发送要写入的日志。</li></ul></li><li>劣势<ul><li>仅限基本的日志级别</li><li>只有一个<code>Print</code>选项。不支持<code>INFO</code>/<code>DEBUG</code>等多个级别。</li><li>缺乏日志格式化的能力——例如记录调用者的函数名和行号，格式化日期和时间格式。等等。</li><li>不提供日志切割的能力。</li></ul></li></ul><h2 id="02-zap基本使用">02.zap基本使用</h2><h3 id="2-1-zap介绍">2.1 zap介绍</h3><ul><li>Uber-go zap优势<ul><li>它同时提供了结构化日志记录和printf风格的日志记录</li><li>它非常的快</li></ul></li><li>安装</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go get <span class="token parameter variable">-u</span> go.uber.org/zap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>1</p><h3 id="2-2-Sugared-Logger和Logger">2.2 Sugared Logger和Logger</h3><ul><li>Zap提供了两种类型的日志记录器—<code>Sugared Logger</code>和<code>Logger</code>。</li><li>在性能很好但不是很关键的上下文中，使用<code>SugaredLogger</code>。</li><li>它比其他结构化日志记录包快4-10倍，并且支持结构化和printf风格的日志记录。</li><li>在每一微秒和每一次内存分配都很重要的上下文中，使用<code>Logger</code>。</li><li>它甚至比<code>SugaredLogger</code>更快，内存分配次数也更少，但它只支持强类型的结构化日志记录。</li></ul><h3 id="2-3-zap日志记录器Logger">2.3 zap日志记录器Logger</h3><ul><li>通过调用<code>zap.NewProduction()</code>/<code>zap.NewDevelopment()</code>或者<code>zap.Example()</code>创建一个Logger。</li><li>唯一的区别在于它将记录的信息不同<ul><li>例如production logger默认记录调用函数信息、日期和时间等。</li></ul></li><li>通过Logger调用Info/Error等。</li><li>默认情况下日志都会打印到应用程序的console界面。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"go.uber.org/zap"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token comment">// 第一步：创建一个Logger</span><span class="token keyword">var</span> logger <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger<span class="token keyword">func</span> <span class="token function">InitLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> zap<span class="token punctuation">.</span><span class="token function">NewProduction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二步：通过Logger调用Info/Error等输出日志</span><span class="token keyword">func</span> <span class="token function">simpleHttpGet</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"Error fetching url.."</span><span class="token punctuation">,</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span>zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Success.."</span><span class="token punctuation">,</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"statusCode"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">)</span><span class="token punctuation">,</span>zap<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">InitLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> logger<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"www.google.com"</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"http://www.google.com"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*在控制台会输出一下日志信息：&#123;"level":"error","ts":1623143450.9749353,"caller":"gin_demo/main.go:23","msg":"Error fetching url..","url":"www.google.com","error":"Get \"www.google.com\": unsupported protocol scheme \"\"","stacktrace":"main.simpleHttpGet\n\tC:/aaa/gin_demo/main.go:23\nmain.main\n\tC:/aaa/gin_demo/main.go:12\nruntime.main\n\tC:/Go/src/runtime/proc.go:225"&#125;&#123;"level":"error","ts":1623143472.030105,"caller":"gin_demo/main.go:23","msg":"Error fetching url..","url":"http://www.google.com","error":"Get \"http://www.google.com\": dial tcp 69.171.247.32:80: connectex: A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.","stacktrace":"main.simpleHttpGet\n\tC:/aaa/gin_demo/main.go:23\nmain.main\n\tC:/aaa/gin_demo/main.go:13\nruntime.main\n\tC:/Go/src/runtime/proc.go:225"&#125;*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-zap日志记录器Sugared-Logger">2.4 zap日志记录器Sugared Logger</h3><p>现在让我们使用Sugared Logger来实现相同的功能。</p><ul><li>大部分的实现基本都相同。</li><li>惟一的区别是，我们通过调用主logger的<code>. Sugar()</code>方法来获取一个<code>SugaredLogger</code>。</li><li>然后使用<code>SugaredLogger</code>以<code>printf</code>格式记录语句</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"go.uber.org/zap"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token comment">// 第一步：创建一个Sugared Logger</span><span class="token keyword">var</span> sugarLogger <span class="token operator">*</span>zap<span class="token punctuation">.</span>SugaredLogger<span class="token keyword">func</span> <span class="token function">InitLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logger<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">NewProduction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>sugarLogger <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">Sugar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二步：通过Logger调用Info/Error等输出日志</span><span class="token keyword">func</span> <span class="token function">simpleHttpGet</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sugarLogger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"Trying to hit GET request for %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>sugarLogger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Error fetching URL %s : Error = %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>sugarLogger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Success! statusCode = %s for URL %s"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> url<span class="token punctuation">)</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">InitLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> sugarLogger<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"www.google.com"</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"http://www.google.com"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*在控制台会输出一下日志信息：&#123;"level":"error","ts":1623143450.9749353,......&#123;"level":"error","ts":1623143450.9749353,......*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-定制logger">03.定制logger</h2><h3 id="3-1-测试定制logger">3.1 测试定制logger</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"github.com/natefinch/lumberjack"</span>   <span class="token comment">// Lumberjack进行日志切割归档</span><span class="token string">"go.uber.org/zap"</span><span class="token string">"go.uber.org/zap/zapcore"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token comment">// 第一步：创建一个Sugared Logger</span><span class="token keyword">var</span> sugarLogger <span class="token operator">*</span>zap<span class="token punctuation">.</span>SugaredLogger<span class="token comment">// 第二步：将编码器从JSON Encoder更改为普通Encoder</span><span class="token keyword">func</span> <span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> zapcore<span class="token punctuation">.</span>Encoder <span class="token punctuation">&#123;</span>encoderConfig <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">NewProductionEncoderConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>encoderConfig<span class="token punctuation">.</span>EncodeTime <span class="token operator">=</span> zapcore<span class="token punctuation">.</span>ISO8601TimeEncoderencoderConfig<span class="token punctuation">.</span>EncodeLevel <span class="token operator">=</span> zapcore<span class="token punctuation">.</span>CapitalLevelEncoder<span class="token comment">// 为此，我们需要将NewJSONEncoder()更改为NewConsoleEncoder()</span><span class="token keyword">return</span> zapcore<span class="token punctuation">.</span><span class="token function">NewConsoleEncoder</span><span class="token punctuation">(</span>encoderConfig<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第三步：使用Lumberjack进行日志切割归档</span><span class="token keyword">func</span> <span class="token function">getLogWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> zapcore<span class="token punctuation">.</span>WriteSyncer <span class="token punctuation">&#123;</span>lumberJackLogger <span class="token operator">:=</span> <span class="token operator">&amp;</span>lumberjack<span class="token punctuation">.</span>Logger<span class="token punctuation">&#123;</span>Filename<span class="token punctuation">:</span>   <span class="token string">"./test.log"</span><span class="token punctuation">,</span>  <span class="token comment">// 指定日志将写到哪里去</span>MaxSize<span class="token punctuation">:</span>    <span class="token number">1</span><span class="token punctuation">,</span>             <span class="token comment">// 每次满1M进行切割</span>MaxBackups<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>             <span class="token comment">// 最多报错5个文件</span>MaxAge<span class="token punctuation">:</span>     <span class="token number">30</span><span class="token punctuation">,</span>            <span class="token comment">// 文件最多保存30天</span>Compress<span class="token punctuation">:</span>   <span class="token boolean">false</span><span class="token punctuation">,</span>         <span class="token comment">// 是否压缩/归档旧文件</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> zapcore<span class="token punctuation">.</span><span class="token function">AddSync</span><span class="token punctuation">(</span>lumberJackLogger<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第四步：重写InitLogger()方法</span><span class="token keyword">func</span> <span class="token function">InitLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>writeSyncer <span class="token operator">:=</span> <span class="token function">getLogWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>encoder <span class="token operator">:=</span> <span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// zapcore.Core需要三个配置——Encoder，WriteSyncer，LogLevel</span>core <span class="token operator">:=</span> zapcore<span class="token punctuation">.</span><span class="token function">NewCore</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> writeSyncer<span class="token punctuation">,</span> zapcore<span class="token punctuation">.</span>DebugLevel<span class="token punctuation">)</span><span class="token comment">/*Encoder:编码器(如何写入日志),我们将使用开箱即用的NewJSONEncoder()，并使用预先设置的WriterSyncer ：指定日志将写到哪里去。我们使用zapcore.AddSync()函数并且将打开的文件句柄传进去Log Level：哪种级别的日志将被写入。*/</span><span class="token comment">// 我们将使用zap.New(…)方法来手动传递所有配置，而不是使用像zap.NewProduction()这样的预置方法来创建logger。</span>logger <span class="token operator">:=</span> zap<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>core<span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">AddCaller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>sugarLogger <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">Sugar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 实例化全局变量sugarLogger</span><span class="token punctuation">&#125;</span><span class="token comment">// 第五步：函数调用全局sugarLogger写入log日志</span><span class="token keyword">func</span> <span class="token function">simpleHttpGet</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sugarLogger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">"Trying to hit GET request for %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>sugarLogger<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Error fetching URL %s : Error = %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>sugarLogger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Success! statusCode = %s for URL %s"</span><span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">,</span> url<span class="token punctuation">)</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">InitLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">defer</span> sugarLogger<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"www.sogo.com"</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"http://www.sogo.com"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>reflect</title>
    <link href="/2022/06/05/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20reflect/"/>
    <url>/2022/06/05/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20reflect/</url>
    
    <content type="html"><![CDATA[<h1 id="10-reflect">10.reflect</h1><h2 id="01-反射">01.反射</h2><ul><li><code>反射是指在程序运行期对程序本身进行访问和修改的能力</code></li></ul><h3 id="1-1-变量的内在机制">1.1 变量的内在机制</h3><ul><li>变量包含类型信息和值信息 var arr [10]int arr[0] = 10</li><li>类型信息：是静态的元信息，是预先定义好的</li><li>值信息：是程序运行过程中动态改变的</li></ul><h3 id="1-2-反射的使用">1.2 反射的使用</h3><ul><li>反射是指<code>在程序运行期对程序本身进行访问和修改的能力</code>。</li><li>程序在编译时，变量被转换为内存地址，变量名不会被编译器写入到可执行部分。</li><li>在运行程序时，程序无法获取自身的信息。</li><li>支持反射的语言可以在程序编译期将变量的反射信息，如字段名称、类型信息、结构体信息等整合到可执行文件中</li><li>并给程序提供接口访问反射信息，这样就可以在程序运行期获取类型的反射信息，并且有能力修改它们。</li><li>Go程序在运行期使用reflect包访问程序的反射信息。</li></ul><h2 id="02-反射方法">02.反射方法</h2><ul><li><code>反射可以在运行时动态获取程序的各种详细信息</code></li></ul><h3 id="2-1-TypeOf">2.1 TypeOf</h3><ul><li><code>reflect.TypeOf()</code>获取<code>类型信息</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">reflectType</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type:%v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token builtin">float32</span> <span class="token operator">=</span> <span class="token number">3.14</span><span class="token function">reflectType</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// type:float32</span><span class="token keyword">var</span> b <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token function">reflectType</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// type:int64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-ValueOf">2.2 ValueOf</h3><ul><li><code>reflect.Value</code>获取值</li><li><code>reflect.Value</code>类型提供的获取原始值的方法如下</li></ul><table><thead><tr><th style="text-align:center">方法</th><th style="text-align:center">说明</th></tr></thead><tbody><tr><td style="text-align:center">Interface() interface {}</td><td style="text-align:center">将值以 interface{} 类型返回，可以通过类型断言转换为指定类型</td></tr><tr><td style="text-align:center">Int() int64</td><td style="text-align:center">将值以 int 类型返回，所有有符号整型均可以此方式返回</td></tr><tr><td style="text-align:center">Uint() uint64</td><td style="text-align:center">将值以 uint 类型返回，所有无符号整型均可以此方式返回</td></tr><tr><td style="text-align:center">Float() float64</td><td style="text-align:center">将值以双精度（float64）类型返回，所有浮点数（float32、float64）均可以此方式返回</td></tr><tr><td style="text-align:center">Bool() bool</td><td style="text-align:center">将值以 bool 类型返回</td></tr><tr><td style="text-align:center">Bytes() []bytes</td><td style="text-align:center">将值以字节数组 []bytes 类型返回</td></tr><tr><td style="text-align:center">String() string</td><td style="text-align:center">将值以字符串类型返回</td></tr></tbody></table><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">reflectValue</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>k <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">switch</span> k <span class="token punctuation">&#123;</span><span class="token keyword">case</span> reflect<span class="token punctuation">.</span>Int64<span class="token punctuation">:</span><span class="token comment">// v.Int()从反射中获取整型的原始值，然后通过int64()强制类型转换</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type is int64, value is %d\n"</span><span class="token punctuation">,</span> <span class="token function">int64</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">case</span> reflect<span class="token punctuation">.</span>Float32<span class="token punctuation">:</span><span class="token comment">// v.Float()从反射中获取浮点型的原始值，然后通过float32()强制类型转换</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type is float32, value is %f\n"</span><span class="token punctuation">,</span> <span class="token function">float32</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">case</span> reflect<span class="token punctuation">.</span>Float64<span class="token punctuation">:</span><span class="token comment">// v.Float()从反射中获取浮点型的原始值，然后通过float64()强制类型转换</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type is float64, value is %f\n"</span><span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token builtin">float32</span> <span class="token operator">=</span> <span class="token number">3.14</span><span class="token keyword">var</span> b <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token function">reflectValue</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// type is float32, value is 3.140000</span><span class="token function">reflectValue</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// type is int64, value is 100</span><span class="token comment">// 将int类型的原始值转换为reflect.Value类型</span>c <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type c :%T\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token comment">// type c :reflect.Value</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-修改值">2.3 修改值</h3><ul><li>想要在函数中通过反射修改变量的值，需要注意函数参数传递的是值拷贝，必须传递变量地址才能修改变量值。</li><li>而反射中使用专有的<code>Elem()</code>方法来获取指针对应的值。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">reflectSetValue1</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token keyword">if</span> v<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Int64 <span class="token punctuation">&#123;</span>v<span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token comment">//修改的是副本，reflect包会引发panic</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">reflectSetValue2</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token comment">// 反射中使用 Elem()方法获取指针对应的值</span><span class="token keyword">if</span> v<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Int64 <span class="token punctuation">&#123;</span>v<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token comment">// reflectSetValue1(a) //panic: reflect: reflect.Value.SetInt using unaddressable value</span><span class="token function">reflectSetValue2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-isNil-和isValid">2.4 isNil()和isValid()</h3><ul><li><p>isNil()</p><ul><li><code>IsNil()</code>报告v持有的值是否为nil。</li><li>v持有的值的分类必须是通道、函数、接口、映射、指针、切片之一；</li><li>否则IsNil函数会导致panic。</li></ul></li><li><p>isValid()</p><ul><li><code>IsValid()</code>返回v是否持有一个值。</li><li>如果v是Value零值会返回假，此时v除了IsValid、String、Kind之外的方法都会导致panic。</li></ul></li><li><p><code>IsNil()</code>常被用于判断指针是否为空；<code>IsValid()</code>常被用于判定返回值是否有效。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// *int类型空指针</span><span class="token keyword">var</span> a <span class="token operator">*</span><span class="token builtin">int</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"var a *int IsNil:"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsNil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// nil值</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"nil IsValid:"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 实例化一个匿名结构体</span>b <span class="token operator">:=</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// 尝试从结构体中查找"abc"字段</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"不存在的结构体成员:"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 尝试从结构体中查找"abc"方法</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"不存在的结构体方法:"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MethodByName</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// map</span>c <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">// 尝试从map中查找一个不存在的键</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"map中不存在的键："</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">MapIndex</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token string">"娜扎"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></li></ul><h2 id="03-结构体与反射">03.结构体与反射</h2><h3 id="3-1-查看类型、字段和方法">3.1 查看类型、字段和方法</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token comment">// 定义结构体</span><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    Id   <span class="token builtin">int</span>    Name <span class="token builtin">string</span>    Age  <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">// 绑方法</span><span class="token keyword">func</span> <span class="token punctuation">(</span>u User<span class="token punctuation">)</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 传入interface&#123;&#125;</span><span class="token keyword">func</span> <span class="token function">Poni</span><span class="token punctuation">(</span>o <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    t <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"类型："</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"字符串类型："</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 获取值</span>    v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>    <span class="token comment">// 可以获取所有属性</span>    <span class="token comment">// 获取结构体字段个数：t.NumField()</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> t<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>        <span class="token comment">// 取每个字段</span>        f <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s : %v"</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> f<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>        <span class="token comment">// 获取字段的值信息</span>        <span class="token comment">// Interface()：获取字段对应的值</span>        val <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"val :"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"=================方法===================="</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> t<span class="token punctuation">.</span><span class="token function">NumMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>        m <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u <span class="token operator">:=</span> User<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"zs"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span>    <span class="token function">Poni</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-查看匿名字段">3.2 查看匿名字段</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token comment">// 定义结构体</span><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    Id   <span class="token builtin">int</span>    Name <span class="token builtin">string</span>    Age  <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">// 匿名字段</span><span class="token keyword">type</span> Boy <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    User    Addr <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    m <span class="token operator">:=</span> Boy<span class="token punctuation">&#123;</span>User<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"zs"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"bj"</span><span class="token punctuation">&#125;</span>    t <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>    <span class="token comment">// Anonymous：匿名</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 值信息</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v\n"</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3-修改结构体的值">3.3 修改结构体的值</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token comment">// 定义结构体</span><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    Id   <span class="token builtin">int</span>    Name <span class="token builtin">string</span>    Age  <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">// 修改结构体值</span><span class="token keyword">func</span> <span class="token function">SetValue</span><span class="token punctuation">(</span>o <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>    <span class="token comment">// 获取指针指向的元素</span>    v <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 取字段</span>    f <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">FieldByName</span><span class="token punctuation">(</span><span class="token string">"Name"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> f<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>String <span class="token punctuation">&#123;</span>        f<span class="token punctuation">.</span><span class="token function">SetString</span><span class="token punctuation">(</span><span class="token string">"kuteng"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u <span class="token operator">:=</span> User<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"5lmh.com"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span>    <span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>u<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-4-调用方法">3.4 调用方法</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token comment">// 定义结构体</span><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    Id   <span class="token builtin">int</span>    Name <span class="token builtin">string</span>    Age  <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>u User<span class="token punctuation">)</span> <span class="token function">Hello</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello："</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    u <span class="token operator">:=</span> User<span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"5lmh.com"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">&#125;</span>    v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>    <span class="token comment">// 获取方法</span>    m <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">MethodByName</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span>    <span class="token comment">// 构建一些参数</span>    args <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>reflect<span class="token punctuation">.</span>Value<span class="token punctuation">&#123;</span>reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token string">"6666"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>    <span class="token comment">// 没参数的情况下：var args2 []reflect.Value</span>    <span class="token comment">// 调用方法，需要传入方法的参数</span>    m<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-5-获取字段的tag">3.5 获取字段的tag</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    Name <span class="token builtin">string</span> <span class="token string">`json:"name1" db:"name2"`</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> s Student    v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>    <span class="token comment">// 类型</span>    t <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 获取字段</span>    f <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Tag<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>Tag<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"db"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-反射练习">04.反射练习</h2><ul><li>任务：解析如下配置文件<ul><li>序列化：将结构体序列化为配置文件数据并保存到硬盘</li><li>反序列化：将配置文件内容反序列化到程序的结构体</li></ul></li><li>配置文件有server和mysql相关配置</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">#this is comment;this a comment;[]表示一个section[server]ip = 10.238.2.2port = 8080[mysql]username = rootpasswd = admindatabase = testhost = 192.168.10.10port = 8000timeout = 1.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Context</title>
    <link href="/2022/06/03/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Context/"/>
    <url>/2022/06/03/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Context/</url>
    
    <content type="html"><![CDATA[<h1 id="09-Context">09.Context</h1><h2 id="01-context介绍">01.context介绍</h2><h3 id="1-1-context由来">1.1 context由来</h3><ul><li>context在Go1.7之后就进入标准库中了，是在于<code>控制goroutine的生命周期</code>。</li><li>由于在Golang severs中，每个request都是在单个goroutine中完成</li><li>并且在单个goroutine（不妨称之为A）中也会有请求其他服务（启动另一个goroutine（称之为B）去完成）的场景</li><li>这就会涉及多个Goroutine之间的调用</li><li>如果某一时刻请求其他服务被取消或者超时，则作为深陷其中的当前goroutine B需要立即退出，然后系统才可回收B所占用的资源。</li><li>即一个request中通常包含多个goroutine，这些goroutine之间通常会有交互。</li></ul><p><img src="/img/image-20210616213116924.6104cd92.png" alt=""></p><ul><li>那么，如何有效管理这些goroutine成为一个问题（主要是退出通知和元数据传递问题）</li><li>Google的解决方法是Context机制，相互调用的goroutine之间通过传递context变量保持关联</li><li>这样在不用暴露各goroutine内部实现细节的前提下，有效地控制各goroutine的运行。</li></ul><p><img src="/img/image-20210616213314610.60383589.png" alt=""></p><ul><li>如此一来，通过传递Context就可以追踪goroutine调用树，并在这些调用树之间传递通知和元数据。</li><li>虽然goroutine之间是平行的，没有继承关系，但是Context设计成是包含父子关系的，这样可以更好的描述goroutine调用之间的树型关系。</li></ul><h3 id="1-2-context常用方法">1.2 context常用方法</h3><ul><li><code>context.Context</code>是一个接口，该接口定义了四个需要实现的方法</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Context <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>    <span class="token function">Deadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>deadline time<span class="token punctuation">.</span>Time<span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span>    <span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    <span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>    <span class="token function">Value</span><span class="token punctuation">(</span>key <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><strong>Done</strong> 方法<ul><li>在Context被取消或超时时返回一个close的channel,close的channel可以作为广播通知</li><li>告诉给context相关的函数要停止当前工作然后返回。</li><li>当一个父operation启动一个goroutine用于子operation，这些子operation不能够取消父operation。</li><li>下面描述的WithCancel函数提供一种方式可以取消新创建的Context.</li><li>开发者可以把一个Context传递给任意多个goroutine然后cancel这个context的时候就能够通知到所有的goroutine。</li></ul></li><li><strong>Err</strong>方法<ul><li>返回context为什么被取消</li></ul></li><li><strong>Deadline</strong><ul><li>返回context何时会超时。</li></ul></li><li><strong>Value</strong><ul><li>返回context相关的数据。</li></ul></li></ul><h2 id="02-为什么需要context">02.为什么需要context</h2><ul><li>在 Go http包的Server中，每一个请求在都有一个对应的 goroutine 去处理。</li><li>请求处理函数通常会启动额外的 goroutine 用来访问后端服务，比如数据库和RPC服务。</li><li>用来处理一个请求的 goroutine 通常需要访问一些与请求特定的数据，比如终端用户的身份认证信息、验证相关的token、请求的截止时间。</li><li>当一个请求被取消或超时时，所有用来处理该请求的 goroutine 都应该迅速退出，然后系统才能释放这些 goroutine 占用的资源。</li></ul><h3 id="2-1-全局变量解决">2.1 全局变量解决</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 全局变量方式存在的问题：</span><span class="token comment">// 1. 使用全局变量在跨包调用时不容易统一</span><span class="token comment">// 2. 如果worker中再启动goroutine，就不太好控制了。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup<span class="token keyword">var</span> exit <span class="token builtin">bool</span><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token keyword">if</span> exit <span class="token punctuation">&#123;</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment">// sleep3秒以免程序过快退出</span>exit <span class="token operator">=</span> <span class="token boolean">true</span>                 <span class="token comment">// 修改全局变量实现子goroutine的退出</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-通道方式">2.2 通道方式</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup<span class="token comment">// 管道方式存在的问题：</span><span class="token comment">// 1. 使用全局变量在跨包调用时不容易实现规范和统一，需要维护一个共用的channel</span><span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>exitChan <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>LOOP<span class="token punctuation">:</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>exitChan<span class="token punctuation">:</span> <span class="token comment">// 等待接收上级通知</span><span class="token keyword">break</span> LOOP<span class="token keyword">default</span><span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> exitChan <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>exitChan<span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>   <span class="token comment">// sleep3秒以免程序过快退出</span>    exitChan <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token comment">// 给子goroutine发送退出信号</span><span class="token function">close</span><span class="token punctuation">(</span>exitChan<span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-官方版的方案">2.3 官方版的方案</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>LOOP<span class="token punctuation">:</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// 等待上级通知</span><span class="token keyword">break</span> LOOP<span class="token keyword">default</span><span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通知子goroutine结束</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-With系列函数">03.With系列函数</h2><p>此外，<code>context</code>包中还定义了四个With系列函数。</p><h3 id="3-1-WithCancel">3.1 WithCancel</h3><ul><li><code>WithCancel</code>返回带有新Done通道的父节点的副本。</li><li>当调用返回的cancel函数或当关闭父上下文的Done通道时，将关闭返回上下文的Done通道，无论先发生什么情况。</li><li>取消此上下文将释放与其关联的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel。</li><li>示例<ul><li>上面的示例代码中，<code>gen</code>函数在单独的goroutine中生成整数并将它们发送到返回的通道。</li><li>gen的调用者在使用生成的整数之后需要取消上下文，以免<code>gen</code>启动的内部goroutine发生泄漏。</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">gen</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>dst <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>n <span class="token operator">:=</span> <span class="token number">1</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">return</span> <span class="token comment">// return结束该goroutine，防止泄露</span><span class="token keyword">case</span> dst <span class="token operator">&lt;-</span> n<span class="token punctuation">:</span>n<span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> dst<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 当我们取完需要的整数后调用cancel</span><span class="token keyword">for</span> n <span class="token operator">:=</span> <span class="token keyword">range</span> <span class="token function">gen</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*12345 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-WithDeadline">3.2 WithDeadline</h3><ul><li>下面的代码中，定义了一个50毫秒之后过期的deadline</li><li>然后我们调用<code>context.WithDeadline(context.Background(), d)</code>得到一个上下文（ctx）和一个取消函数（cancel）</li><li>然后使用一个select让主程序陷入等待：等待1秒后打印<code>overslept</code>退出或者等待ctx过期后退出。</li><li>因为ctx50秒后就过期，所以<code>ctx.Done()</code>会先接收到值，上面的代码会打印ctx.Err()取消原因。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond<span class="token punctuation">)</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithDeadline</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token comment">// 尽管ctx会过期，但在任何情况下调用它的cancel函数都是很好的实践。</span><span class="token comment">// 如果不这样做，可能会使上下文及其父类存活的时间超过必要的时间。</span><span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"overslept"</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3WithTimeout">3.3WithTimeout</h3><ul><li>取消此上下文将释放与其相关的资源，因此代码应该在此上下文中运行的操作完成后立即调用cancel</li><li>通常用于数据库或者网络连接的超时控制</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// context.WithTimeout</span><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>LOOP<span class="token punctuation">:</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"db connecting ..."</span><span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 假设正常连接数据库耗时10毫秒</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// 50毫秒后自动调用</span><span class="token keyword">break</span> LOOP<span class="token keyword">default</span><span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker done!"</span><span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 设置一个50毫秒的超时</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通知子goroutine结束</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-4-WithValue">3.4 WithValue</h3><ul><li><code>WithValue</code>函数能够将请求作用域的数据与 Context 对象建立关系</li><li><code>WithValue</code>返回父节点的副本，其中与key关联的值为val。</li><li>仅对API和进程间传递请求域的数据使用上下文值，而不是使用它来传递可选参数给函数。</li><li>所提供的键必须是可比较的，并且不应该是<code>string</code>类型或任何其他内置类型，以避免使用上下文在包之间发生冲突。</li><li><code>WithValue</code>的用户应该为键定义自己的类型。为了避免在分配给interface{}时进行分配，上下文键通常具有具体类型<code>struct&#123;&#125;</code>。</li><li>或者，导出的上下文关键变量的静态类型应该是指针或接口。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// context.WithValue</span><span class="token keyword">type</span> TraceCode <span class="token builtin">string</span><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup<span class="token keyword">func</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>key <span class="token operator">:=</span> <span class="token function">TraceCode</span><span class="token punctuation">(</span><span class="token string">"TRACE_CODE"</span><span class="token punctuation">)</span>traceCode<span class="token punctuation">,</span> ok <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">Value</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// 在子goroutine中获取trace code</span><span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"invalid trace code"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>LOOP<span class="token punctuation">:</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"worker, trace code:%s\n"</span><span class="token punctuation">,</span> traceCode<span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 假设正常连接数据库耗时10毫秒</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// 50毫秒后自动调用</span><span class="token keyword">break</span> LOOP<span class="token keyword">default</span><span class="token punctuation">:</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"worker done!"</span><span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 设置一个50毫秒的超时</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token comment">// 在系统的入口中设置trace code传递给后续启动的goroutine实现日志数据聚合</span>ctx <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">TraceCode</span><span class="token punctuation">(</span><span class="token string">"TRACE_CODE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"12512312234"</span><span class="token punctuation">)</span>wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">worker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 通知子goroutine结束</span>wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"over"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-客户端超时取消示例">04.客户端超时取消示例</h2><p>调用服务端API时如何在客户端实现超时控制？</p><h3 id="4-1-server端">4.1 server端</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// context_timeout/server/main.go</span><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"math/rand"</span><span class="token string">"net/http"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// server端，随机出现慢响应</span><span class="token keyword">func</span> <span class="token function">indexHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>number <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">if</span> number <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// 耗时10秒的慢响应</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"slow response"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"quick response"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> indexHandler<span class="token punctuation">)</span>err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8000"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-client端">4.2 client端</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// context_timeout/client/main.go</span><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"context"</span><span class="token string">"fmt"</span><span class="token string">"io/ioutil"</span><span class="token string">"net/http"</span><span class="token string">"sync"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token comment">// 客户端</span><span class="token keyword">type</span> respData <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>resp <span class="token operator">*</span>http<span class="token punctuation">.</span>Responseerr  <span class="token builtin">error</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">doCall</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>transport <span class="token operator">:=</span> http<span class="token punctuation">.</span>Transport<span class="token punctuation">&#123;</span>   <span class="token comment">// 请求频繁可定义全局的client对象并启用长链接</span>   <span class="token comment">// 请求不频繁使用短链接</span>   DisableKeepAlives<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span>client <span class="token operator">:=</span> http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span>Transport<span class="token punctuation">:</span> <span class="token operator">&amp;</span>transport<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>respChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token operator">*</span>respData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"http://127.0.0.1:8000/"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"new requestg failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">WithContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token comment">// 使用带超时的ctx创建一个新的client request</span><span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroupwg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"client.do resp:%v, err:%v\n"</span><span class="token punctuation">,</span> resp<span class="token punctuation">,</span> err<span class="token punctuation">)</span>rd <span class="token operator">:=</span> <span class="token operator">&amp;</span>respData<span class="token punctuation">&#123;</span>resp<span class="token punctuation">:</span> resp<span class="token punctuation">,</span>err<span class="token punctuation">:</span>  err<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>respChan <span class="token operator">&lt;-</span> rdwg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">//transport.CancelRequest(req)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"call api timeout"</span><span class="token punctuation">)</span><span class="token keyword">case</span> result <span class="token operator">:=</span> <span class="token operator">&lt;-</span>respChan<span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"call server api success"</span><span class="token punctuation">)</span><span class="token keyword">if</span> result<span class="token punctuation">.</span>err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"call server api failed, err:%v\n"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> result<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>data<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"resp:%v\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 定义一个100毫秒的超时</span>ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>Millisecond<span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 调用cancel释放子goroutine资源</span><span class="token function">doCall</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>net/http</title>
    <link href="/2022/06/01/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20net%20http/"/>
    <url>/2022/06/01/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20net%20http/</url>
    
    <content type="html"><![CDATA[<h1 id="08-net-http"><a href="http://08.net/http">08.net/http</a></h1><h2 id="01-net-http（GET）"><a href="http://01.net/http%EF%BC%88GET%EF%BC%89">01.net/http（GET）</a></h2><ul><li>Go语言内置的net/http包十分的优秀，提供了HTTP客户端和服务端的实现。</li></ul><h3 id="1-1-无参GET">1.1 无参GET</h3><ul><li>使用net/http包编写一个简单的发送HTTP请求的Client端</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"io/ioutil"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"https://www.baidu.com/"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"get failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>body<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read from resp.Body failed,err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-带参GET">1.2 带参GET</h3><ul><li>关于GET请求的参数需要使用Go语言内置的net/url这个标准库来处理。</li></ul><p>关于GET请求的参数需要使用Go语言内置的net/url这个标准库来处理。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    apiUrl <span class="token operator">:=</span> <span class="token string">"http://127.0.0.1:9090/get"</span>    <span class="token comment">// URL param</span>    data <span class="token operator">:=</span> url<span class="token punctuation">.</span>Values<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>    data<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"枯藤"</span><span class="token punctuation">)</span>    data<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"18"</span><span class="token punctuation">)</span>    u<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">ParseRequestURI</span><span class="token punctuation">(</span>apiUrl<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"parse url requestUrl failed,err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span>    u<span class="token punctuation">.</span>RawQuery <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// URL encode</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"post failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"get resp failed,err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>对应的Server端HandlerFunc如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">getHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">defer</span> r<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    data <span class="token operator">:=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    answer <span class="token operator">:=</span> <span class="token string">`&#123;"status": "ok"&#125;`</span>    w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-自定义Client">1.3 自定义Client</h3><ul><li>要管理HTTP客户端的头域、重定向策略和其他设置，创建一个Client：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span>    CheckRedirect<span class="token punctuation">:</span> redirectPolicyFunc<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"http://5lmh.com"</span><span class="token punctuation">)</span><span class="token comment">// ...</span>req<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">NewRequest</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">,</span> <span class="token string">"http://5lmh.com"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token comment">// ...</span>req<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"If-None-Match"</span><span class="token punctuation">,</span> <span class="token string">`W/"wyzzy"`</span><span class="token punctuation">)</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token comment">// ...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-4-自定义Transport">1.4 自定义Transport</h3><ul><li>要管理代理、TLS配置、keep-alive、压缩和其他设置，创建一个Transport</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">tr <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">&#123;</span>    TLSClientConfig<span class="token punctuation">:</span>    <span class="token operator">&amp;</span>tls<span class="token punctuation">.</span>Config<span class="token punctuation">&#123;</span>RootCAs<span class="token punctuation">:</span> pool<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    DisableCompression<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">&#123;</span>Transport<span class="token punctuation">:</span> tr<span class="token punctuation">&#125;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"https://5lmh.com"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>Client和Transport类型都可以安全的被多个go程同时使用，出于效率考虑，应该一次建立、尽量重用。</li></ul><h2 id="02-net-http（POST）"><a href="http://02.net/http%EF%BC%88POST%EF%BC%89">02.net/http（POST）</a></h2><h3 id="2-1-Post请求示例">2.1 Post请求示例</h3><ul><li>上面演示了使用net/http包发送GET请求的示例，发送POST请求的示例代码如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"io/ioutil"</span>    <span class="token string">"net/http"</span>    <span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token comment">// net/http post demo</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    url <span class="token operator">:=</span> <span class="token string">"http://127.0.0.1:9090/post"</span>    <span class="token comment">// 表单数据</span>    <span class="token comment">//contentType := "application/x-www-form-urlencoded"</span>    <span class="token comment">//data := "name=枯藤&amp;age=18"</span>    <span class="token comment">// json</span>    contentType <span class="token operator">:=</span> <span class="token string">"application/json"</span>    data <span class="token operator">:=</span> <span class="token string">`&#123;"name":"枯藤","age":18&#125;`</span>    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> contentType<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"post failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"get resp failed,err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-Server端">2.2 Server端</h3><ul><li>对应的Server端HandlerFunc如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">postHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">defer</span> r<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 1. 请求类型是application/x-www-form-urlencoded时解析form数据</span>    r<span class="token punctuation">.</span><span class="token function">ParseForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>PostForm<span class="token punctuation">)</span> <span class="token comment">// 打印form数据</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>PostForm<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>PostForm<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 2. 请求类型是application/json时从r.Body读取数据</span>    b<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Body<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read request.Body failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>    answer <span class="token operator">:=</span> <span class="token string">`&#123;"status": "ok"&#125;`</span>    w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-服务端">03.服务端</h2><h3 id="3-1-默认的Server">3.1 默认的Server</h3><ul><li>ListenAndServe使用指定的监听地址和处理器启动一个HTTP服务端。</li><li>处理器参数通常是nil，这表示采用包变量DefaultServeMux作为处理器。</li><li>Handle和HandleFunc函数可以向DefaultServeMux添加处理器。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">http<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span><span class="token string">"/foo"</span><span class="token punctuation">,</span> fooHandler<span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/bar"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Hello, %q"</span><span class="token punctuation">,</span> html<span class="token punctuation">.</span><span class="token function">EscapeString</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":8080"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>示例</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"net/http"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">sayHello</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">"Hello World！"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> sayHello<span class="token punctuation">)</span>err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">":9090"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"http server failed, err:%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-自定义Server">3.2 自定义Server</h3><ul><li>要管理服务端的行为，可以创建一个自定义的Server：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">s <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">&#123;</span>    Addr<span class="token punctuation">:</span>           <span class="token string">":8080"</span><span class="token punctuation">,</span>    Handler<span class="token punctuation">:</span>         myHandler<span class="token punctuation">,</span>    ReadTimeout<span class="token punctuation">:</span>      <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>    WriteTimeout<span class="token punctuation">:</span>      <span class="token number">10</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>    MaxHeaderBytes<span class="token punctuation">:</span>    <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Strconv</title>
    <link href="/2022/05/31/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Strconv/"/>
    <url>/2022/05/31/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Strconv/</url>
    
    <content type="html"><![CDATA[<h1 id="07-Strconv">07.Strconv</h1><h2 id="01-string与int类型转换">01.string与int类型转换</h2><h3 id="1-0-strconv包介绍">1.0 strconv包介绍</h3><ul><li>strconv包实现了基本数据类型与其字符串表示的转换</li><li>主要有以下常用函数： Atoi()、Itia()、parse系列、format系列、append系列。</li><li>更多函数请查看<a href="https://golang.org/pkg/strconv/">官方文档 (opens new window)</a>。</li></ul><h3 id="1-1-Atoi-转int">1.1 Atoi()转int</h3><ul><li><code>Atoi()</code>函数用于将字符串类型的整数转换为int类型，函数签名如下。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    s1 <span class="token operator">:=</span> <span class="token string">"100"</span>    i1<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"can't convert to int"</span><span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type:%T value:%#v\n"</span><span class="token punctuation">,</span> i1<span class="token punctuation">,</span> i1<span class="token punctuation">)</span> <span class="token comment">//type:int value:100</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-Itoa-转str">1.2 Itoa()转str</h3><ul><li><code>Itoa()</code>函数用于将int类型数据转换为对应的字符串表示</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>i2 <span class="token operator">:=</span> <span class="token number">200</span>s2 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>i2<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type:%T value:%#v\n"</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span> s2<span class="token punctuation">)</span> <span class="token comment">//type:string value:"200"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-string转字符">1.3 string转字符</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token string">"hello 张三"</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">&#123;</span> <span class="token comment">//rune</span><span class="token comment">// 104(h) 101(e) 108(l) 108(l) 111(o) 32( ) 24352(张) 19977(三) </span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v(%c) "</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-Parse系列函数">02.Parse系列函数</h2><h3 id="1-1-ParseInt">1.1 ParseInt()</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">"1234"</span>i64<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T"</span><span class="token punctuation">,</span> i64<span class="token punctuation">,</span> i64<span class="token punctuation">)</span>  <span class="token comment">// 值：1234 类型：int64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-ParseFloat">1.2 ParseFloat()</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">:=</span> <span class="token string">"3.1415926535"</span>v1<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>v2<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T\n"</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span>  <span class="token comment">// 值：3.1415927410125732 类型：float64</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T"</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v2<span class="token punctuation">)</span>  <span class="token comment">// 值：3.1415926535 类型：float64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-ParseBool">1.3 ParseBool()</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseBool</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">)</span>   <span class="token comment">// string 转 bool</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T"</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment">// 值：true 类型：bool</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-Format系列函数">03.Format系列函数</h2><ul><li>Format系列函数实现了将给定类型数据格式化为string类型数据的功能</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s1 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatBool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>s2 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatFloat</span><span class="token punctuation">(</span><span class="token number">3.1415</span><span class="token punctuation">,</span> <span class="token char">'E'</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>s3 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>s4 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatUint</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v --%T \n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s1<span class="token punctuation">)</span>  <span class="token comment">// true --string </span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v --%T \n"</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span> s2<span class="token punctuation">)</span>  <span class="token comment">// 3.1415E+00 --string </span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v --%T \n"</span><span class="token punctuation">,</span> s3<span class="token punctuation">,</span> s3<span class="token punctuation">)</span>  <span class="token comment">// -2 --string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v --%T \n"</span><span class="token punctuation">,</span> s4<span class="token punctuation">,</span> s4<span class="token punctuation">)</span>  <span class="token comment">// 2 --string </span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IO</title>
    <link href="/2022/05/29/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20IO%E6%93%8D%E4%BD%9C/"/>
    <url>/2022/05/29/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20IO%E6%93%8D%E4%BD%9C/</url>
    
    <content type="html"><![CDATA[<h1 id="06-IO操作">06.IO操作</h1><h2 id="01-打开和关闭文件">01.打开和关闭文件</h2><ul><li>os.Open()函数能够打开一个文件，返回一个*File和一个err。</li><li>对得到的文件实例调用close()方法能够关闭文件。</li><li>为了防止文件忘记关闭，我们通常使用defer注册文件关闭语句。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 只读方式打开当前目录下的main.go文件</span>    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"./main.go"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"open file failed!, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">// 关闭文件</span>    file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-读取文件">02.读取文件</h2><h3 id="2-1-file-Read-指定读取size">2.1 file.Read()指定读取size</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"io"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 只读方式打开当前目录下的main.go文件</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"./main.go"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"open file failed!, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 使用Read方法读取数据，每次只读取128个字节</span><span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>n<span class="token punctuation">,</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"文件读完了"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"读取了%d字节数据\n"</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-循环读取">2.2 循环读取</h3><ul><li>使用for循环读取文件中的所有数据。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"io"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 只读方式打开当前目录下的main.go文件</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"./main.go"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"open file failed!, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 循环读取文件</span><span class="token keyword">var</span> content <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>n<span class="token punctuation">,</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"文件读完了"</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>content <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> tmp<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-bufio按行读取">2.3 bufio按行读取</h3><ul><li>bufio是在file的基础上封装了一层API，支持更多的功能。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"bufio"</span><span class="token string">"fmt"</span><span class="token string">"io"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token comment">// bufio按行读取示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">"./main.go"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"open file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>reader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>line<span class="token punctuation">,</span> err <span class="token operator">:=</span> reader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token comment">//注意是字符</span><span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"文件读完了"</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-ioutil读取整个文件">2.4 ioutil读取整个文件</h3><ul><li><code>io/ioutil</code>包的<code>ReadFile</code>方法能够读取完整的文件，只需要将文件名作为参数传入。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"io/ioutil"</span><span class="token punctuation">)</span><span class="token comment">// ioutil.ReadFile读取整个文件</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>content<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span><span class="token string">"./main.go"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"read file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-写入文件">03.写入文件</h2><h3 id="3-0-参数说明">3.0 参数说明</h3><ul><li><code>os.OpenFile()</code>函数能够以指定模式打开文件，从而实现文件写入相关功能。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">OpenFile</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> flag <span class="token builtin">int</span><span class="token punctuation">,</span> perm FileMode<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>File<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>其中：<ul><li><code>name</code>：要打开的文件名</li><li><code>flag</code>：打开文件的模式，模式有以下几种</li></ul></li></ul><table><thead><tr><th style="text-align:center">模式</th><th style="text-align:center">含义</th></tr></thead><tbody><tr><td style="text-align:center"><code>os.O_WRONLY</code></td><td style="text-align:center">只写</td></tr><tr><td style="text-align:center"><code>os.O_CREATE</code></td><td style="text-align:center">创建文件</td></tr><tr><td style="text-align:center"><code>os.O_RDONLY</code></td><td style="text-align:center">只读</td></tr><tr><td style="text-align:center"><code>os.O_RDWR</code></td><td style="text-align:center">读写</td></tr><tr><td style="text-align:center"><code>os.O_TRUNC</code></td><td style="text-align:center">清空</td></tr><tr><td style="text-align:center"><code>os.O_APPEND</code></td><td style="text-align:center">追加</td></tr></tbody></table><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">perm<pre class="line-numbers language-none"><code class="language-none">  ：文件权限，一个八进制数  - r（读）04，w（写）02，x（执行）01。### 3.1 Write和WriteString&#96;&#96;&#96;gopackage mainimport (&quot;fmt&quot;&quot;os&quot;)func main() &#123;file, err :&#x3D; os.OpenFile(&quot;xx.txt&quot;, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, 0666)if err !&#x3D; nil &#123;fmt.Println(&quot;open file failed, err:&quot;, err)return&#125;defer file.Close()str :&#x3D; &quot;hello 沙河&quot;file.Write([]byte(str))       &#x2F;&#x2F;写入字节切片数据file.WriteString(&quot;hello 小王子&quot;) &#x2F;&#x2F;直接写入字符串数据&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></code></pre></li></ul><h3 id="3-2-bufio-NewWriter">3.2 bufio.NewWriter</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"bufio"</span><span class="token string">"fmt"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"xx.txt"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_TRUNC<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"open file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>writer <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>writer<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">"hello沙河\n"</span><span class="token punctuation">)</span> <span class="token comment">//将数据先写入缓存</span><span class="token punctuation">&#125;</span>writer<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//将缓存中的内容写入文件</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3-ioutil-WriteFile">3.3 ioutil.WriteFile</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"io/ioutil"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">:=</span> <span class="token string">"hello 沙河"</span>err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">"./xx.txt"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"write file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-练习">04.练习</h2><h3 id="4-1-copyFile">4.1 copyFile</h3><ul><li>借助<code>io.Copy()</code>实现一个拷贝文件函数。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// CopyFile 拷贝文件函数</span><span class="token keyword">func</span> <span class="token function">CopyFile</span><span class="token punctuation">(</span>dstName<span class="token punctuation">,</span> srcName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>written <span class="token builtin">int64</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 以读方式打开源文件</span>src<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>srcName<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"open %s failed, err:%v.\n"</span><span class="token punctuation">,</span> srcName<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> src<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 以写|创建的方式打开目标文件</span>dst<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>dstName<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"open %s failed, err:%v.\n"</span><span class="token punctuation">,</span> dstName<span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">defer</span> dst<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">return</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">)</span> <span class="token comment">//调用io.Copy()拷贝内容</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">CopyFile</span><span class="token punctuation">(</span><span class="token string">"dst.txt"</span><span class="token punctuation">,</span> <span class="token string">"src.txt"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"copy file failed, err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"copy done!"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-实现一个cat命令">4.2 实现一个cat命令</h3><ul><li>使用文件操作相关知识，模拟实现linux平台<code>cat</code>命令的功能。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"bufio"</span><span class="token string">"flag"</span><span class="token string">"fmt"</span><span class="token string">"io"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token comment">// cat命令实现</span><span class="token keyword">func</span> <span class="token function">cat</span><span class="token punctuation">(</span>r <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span>buf<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token comment">//注意是字符</span><span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">&#123;</span><span class="token comment">// 退出之前将已读到的内容输出</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">"%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 解析命令行参数</span><span class="token keyword">if</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token comment">// 如果没有参数默认从标准输入读取内容</span><span class="token function">cat</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 依次读取每个指定文件的内容并打印到终端</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">"reading from %s failed, err:%v\n"</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">continue</span><span class="token punctuation">&#125;</span><span class="token function">cat</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Log</title>
    <link href="/2022/05/27/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Log/"/>
    <url>/2022/05/27/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Log/</url>
    
    <content type="html"><![CDATA[<h1 id="05-Log">05.Log</h1><h2 id="01-日志模块介绍">01.日志模块介绍</h2><ul><li><a href="https://www.liwenzhou.com/posts/Go/zap/">参考博客(opens new window)</a></li></ul><h3 id="1-1-介绍">1.1 介绍</h3><p>在许多Go语言项目中，我们需要一个好的日志记录器能够提供下面这些功能</p><ul><li>能够将事件记录到文件中，而不是应用程序控制台。</li><li>日志切割-能够根据文件大小、时间或间隔等来切割日志文件。</li><li>支持不同的日志级别。例如INFO，DEBUG，ERROR等。</li><li>能够打印基本信息，如调用文件/函数名和行号，日志时间等。</li></ul><h3 id="1-2-默认的Go-Logger">1.2 默认的Go Logger</h3><ul><li>实现一个Go语言中的日志记录器非常简单——创建一个新的日志文件，然后设置它为日志的输出位置。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"log"</span><span class="token string">"net/http"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token comment">// 第一：设置Logger</span><span class="token keyword">func</span> <span class="token function">SetupLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>logFileLocation<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"./test.log"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token operator">|</span>os<span class="token punctuation">.</span>O_RDWR<span class="token punctuation">,</span> <span class="token number">0744</span><span class="token punctuation">)</span>log<span class="token punctuation">.</span><span class="token function">SetOutput</span><span class="token punctuation">(</span>logFileLocation<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第二：使用Logger</span><span class="token keyword">func</span> <span class="token function">simpleHttpGet</span><span class="token punctuation">(</span>url <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Error fetching url %s : %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"Status Code for %s : %s"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> resp<span class="token punctuation">.</span>Status<span class="token punctuation">)</span>resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token function">SetupLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"www.baidu.com"</span><span class="token punctuation">)</span><span class="token function">simpleHttpGet</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-Go-Logger的优势和劣势">1.3 Go Logger的优势和劣势</h3><ul><li>优势<ul><li>它最大的优点是使用非常简单。</li><li>我们可以设置任何<code>io.Writer</code>作为日志记录输出并向其发送要写入的日志。</li></ul></li><li>劣势<ul><li>仅限基本的日志级别</li><li>只有一个<code>Print</code>选项。不支持<code>INFO</code>/<code>DEBUG</code>等多个级别。</li><li>缺乏日志格式化的能力——例如记录调用者的函数名和行号，格式化日期和时间格式。等等。</li><li>不提供日志切割的能力。</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flag</title>
    <link href="/2022/05/26/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Flag/"/>
    <url>/2022/05/26/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Flag/</url>
    
    <content type="html"><![CDATA[<h1 id="04-Flag">04.Flag</h1><h2 id="01-Flag">01.Flag</h2><ul><li>Go语言内置的flag包实现了命令行参数的解析，flag包使得开发命令行工具更为简单。</li></ul><h3 id="1-1-os-Args">1.1 os.Args</h3><ul><li>如果你只是简单的想要获取命令行参数，可以像下面的代码示例一样使用os.Args来获取命令行参数</li><li>os.Args是一个存储命令行参数的字符串切片，它的第一个元素是执行文件的名称。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token comment">//os.Args demo</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//os.Args是一个[]string</span><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> os<span class="token punctuation">.</span>Args <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"args[%d]=%v\n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/* C:\aaa\gin_demo> go run main.go a b cargs[1]=aargs[2]=bargs[3]=c */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-flag-Parse">1.2 flag.Parse()</h3><p>通过以上两种方法定义好命令行flag参数后，需要通过调用flag.Parse()来对命令行参数进行解析。</p><p>支持的命令行参数格式有以下几种：</p><ul><li>-flag xxx （使用空格，一个-符号）</li><li>–flag xxx （使用空格，两个-符号）</li><li>-flag=xxx （使用等号，一个-符号）</li><li>–flag=xxx （使用等号，两个-符号）</li></ul><p>其中，布尔类型的参数必须使用等号的方式指定。</p><p>Flag解析在第一个非flag参数（单个”-“不是flag参数）之前停止，或者在终止符”–“之后停止。</p><h3 id="1-3-其他函数">1.3 其他函数</h3><ul><li>flag.Args() ////返回命令行参数后的其他参数，以[]string类型</li><li>flag.NArg() //返回命令行参数后的其他参数个数</li><li>flag.NFlag() //返回使用的命令行参数个数</li></ul><h2 id="02-完整示例">02.完整示例</h2><h3 id="2-1-main-go">2.1 main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"flag"</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//定义命令行参数方式1</span><span class="token keyword">var</span> name <span class="token builtin">string</span><span class="token keyword">var</span> age <span class="token builtin">int</span><span class="token keyword">var</span> married <span class="token builtin">bool</span><span class="token keyword">var</span> delay time<span class="token punctuation">.</span>Durationflag<span class="token punctuation">.</span><span class="token function">StringVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token string">"姓名"</span><span class="token punctuation">)</span>flag<span class="token punctuation">.</span><span class="token function">IntVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>age<span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"年龄"</span><span class="token punctuation">)</span>flag<span class="token punctuation">.</span><span class="token function">BoolVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>married<span class="token punctuation">,</span> <span class="token string">"married"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"婚否"</span><span class="token punctuation">)</span>flag<span class="token punctuation">.</span><span class="token function">DurationVar</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>delay<span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"延迟的时间间隔"</span><span class="token punctuation">)</span><span class="token comment">//解析命令行参数</span>flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> married<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token comment">//返回命令行参数后的其他参数</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">Args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//返回命令行参数后的其他参数个数</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//返回使用的命令行参数个数</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">NFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-查看帮助">2.2 查看帮助</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">C<span class="token punctuation">:</span>\aaa\gin_demo<span class="token operator">></span>  <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token operator">--</span>help  <span class="token operator">-</span>age <span class="token builtin">int</span>        年龄 <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token number">18</span><span class="token punctuation">)</span>  <span class="token operator">-</span>d duration        延迟的时间间隔  <span class="token operator">-</span>married        婚否  <span class="token operator">-</span>name <span class="token builtin">string</span>        姓名 <span class="token punctuation">(</span><span class="token keyword">default</span> <span class="token string">"张三"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-flag参数演示">2.3 flag参数演示</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">C<span class="token punctuation">:</span>\aaa\gin_demo<span class="token operator">></span>  <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token operator">-</span>name pprof <span class="token operator">--</span>age <span class="token number">28</span> <span class="token operator">-</span>married<span class="token operator">=</span><span class="token boolean">false</span> <span class="token operator">-</span>d<span class="token operator">=</span>1h30mpprof <span class="token number">28</span> <span class="token boolean">false</span> 1h30m0s<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token number">0</span><span class="token number">4</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-非flag命令行参数">2.4 非flag命令行参数</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">C<span class="token punctuation">:</span>\aaa\gin_demo<span class="token operator">></span><span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span> a b c张三 <span class="token number">18</span> <span class="token boolean">false</span> 0s<span class="token punctuation">[</span>a b c<span class="token punctuation">]</span><span class="token number">3</span><span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>encodingjson</title>
    <link href="/2022/05/24/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20encodingjson/"/>
    <url>/2022/05/24/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20encodingjson/</url>
    
    <content type="html"><![CDATA[<h1 id="03-encoding-json包">03.encoding/json包</h1><h2 id="01-struct与json">01.struct与json</h2><ul><li>比如我们 Golang 要给 App 或者小程序提供 Api 接口数据，这个时候就需要涉及到结构体和Json 之间的相互转换</li><li><strong>GolangJSON</strong> 序列化是指把结构体数据转化成 JSON 格式的字符串</li><li><strong>Golang</strong> <strong>JSON</strong> 的反序列化是指把 JSON 数据转化成 Golang 中的结构体对象</li><li>Golang 中 的 序 列 化 和 反 序 列 化 主 要 通 过 “encoding/json” 包 中 的 json.Marshal() 和json.Unmarshal()方法实现</li></ul><h3 id="1-1-struct转Json字符串">1.1 struct转Json字符串</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>ID <span class="token builtin">int</span>Gender <span class="token builtin">string</span>name <span class="token builtin">string</span>     <span class="token comment">//私有属性不能被 json 包访问</span>Sno <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s1 <span class="token operator">=</span> Student<span class="token punctuation">&#123;</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>Gender<span class="token punctuation">:</span> <span class="token string">"男"</span><span class="token punctuation">,</span>name<span class="token punctuation">:</span> <span class="token string">"李四"</span><span class="token punctuation">,</span>Sno<span class="token punctuation">:</span> <span class="token string">"s0001"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span>  <span class="token comment">// main.Student&#123;ID:1, Gender:"男", name:"李四", Sno:"s0001"&#125;</span><span class="token keyword">var</span> s<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>jsonStr <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span>   <span class="token comment">// &#123;"ID":1,"Gender":"男","Sno":"s0001"&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-Json字符串转struct">1.2 Json字符串转struct</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>ID <span class="token builtin">int</span>Gender <span class="token builtin">string</span>Name <span class="token builtin">string</span>Sno <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> jsonStr <span class="token operator">=</span> <span class="token string">`&#123;"ID":1,"Gender":"男","Name":"李四","Sno":"s0001"&#125;`</span><span class="token keyword">var</span> student Student   <span class="token comment">//定义一个 Monster 实例</span>err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>student<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"unmarshal err=%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 反序列化后 student=main.Student&#123;ID:1, Gender:"男", Name:"李四", Sno:"s0001"&#125; student.Name=李四 </span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"反序列化后 student=%#v student.Name=%v \n"</span><span class="token punctuation">,</span> student<span class="token punctuation">,</span> student<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-struct-tag">02. struct tag</h2><h3 id="2-1-Tag标签说明">2.1 Tag标签说明</h3><ul><li>Tag 是结构体的元信息，可以在运行的时候通过反射的机制读取出来。</li><li>Tag 在结构体字段的后方定义，由一对反引号包裹起来</li><li>具体的格式如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">key1<span class="token punctuation">:</span><span class="token string">"value1"</span> key2<span class="token punctuation">:</span><span class="token string">"value2"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>1</p><ul><li>结构体 tag 由一个或多个键值对组成。键与值使用冒号分隔，值用双引号括起来。</li><li>同一个结构体字段可以设置多个键值对 tag，不同的键值对之间使用空格分隔。</li><li>注意事项：<ul><li>为结构体编写 Tag 时，必须严格遵守键值对的规则。</li><li>结构体标签的解析代码的容错能力很差，一旦格式写错，编译和运行时都不会提示任何错误，通过反射也无法正确取值。</li><li>例如不要在 key 和 value 之间添加空格。</li></ul></li></ul><h3 id="2-2-Tag结构体转化Json字符串">2.2 Tag结构体转化Json字符串</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>ID <span class="token builtin">int</span> <span class="token string">`json:"id"`</span>       <span class="token comment">//通过指定 tag 实现 json 序列化该字段时的 key</span>Gender <span class="token builtin">string</span> <span class="token string">`json:"gender"`</span>Name <span class="token builtin">string</span>Sno <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s1 <span class="token operator">=</span> Student<span class="token punctuation">&#123;</span>ID<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>Gender<span class="token punctuation">:</span> <span class="token string">"男"</span><span class="token punctuation">,</span>Name<span class="token punctuation">:</span> <span class="token string">"李四"</span><span class="token punctuation">,</span>Sno<span class="token punctuation">:</span> <span class="token string">"s0001"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// main.Student&#123;ID:1, Gender:"男", Name:"李四", Sno:"s0001"&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v\n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">)</span> <span class="token keyword">var</span> s<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>jsonStr <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>jsonStr<span class="token punctuation">)</span>  <span class="token comment">// &#123;"id":1,"gender":"男","Name":"李四","Sno":"s0001"&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-Json字符串转成Tag结构体">2.3 Json字符串转成Tag结构体</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>ID <span class="token builtin">int</span> <span class="token string">`json:"id"`</span> <span class="token comment">//通过指定 tag 实现 json 序列化该字段时的 key</span>Gender <span class="token builtin">string</span> <span class="token string">`json:"gender"`</span>Name <span class="token builtin">string</span>Sno <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s2 Student<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">`&#123;"id":1,"gender":"男","Name":"李四","Sno":"s0001"&#125;`</span>err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>s2<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// main.Student&#123;ID:1, Gender:"男", Name:"李四", Sno:"s0001"&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v"</span><span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-加tag坑">2.4 加tag坑</h3><ul><li><p>如果变量<code>首字母小写</code>，则为<code>private</code>。无论如何<code>不能转</code>，因为取不到<code>反射信息</code>。</p></li><li><p>如果变量<code>首字母大写</code>，则为<code>public</code>。</p></li><li><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">不加tag<pre class="line-numbers language-none"><code class="language-none">，可以正常转为<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>json<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">里的字段，<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>json<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">内字段名跟结构体内字段<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>原名一致<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">    。    - &#96;加了tag&#96;，从&#96;struct&#96;转&#96;json&#96;的时候，&#96;json&#96;的字段名就是&#96;tag&#96;里的字段名，原字段名已经没用。&#96;&#96;&#96;gopackage mainimport (&quot;encoding&#x2F;json&quot;&quot;fmt&quot;)type J struct &#123;a string          &#x2F;&#x2F; 首字母小写，不能转换成jsonb string &#96;json:&quot;B&quot;&#96;  &#x2F;&#x2F; 首字母小写，不能转换成jsonC string          &#x2F;&#x2F; 不加&#96;tag&#96;则&#96;json&#96;内的字段跟结构体字段&#96;原名一致&#96;。D string &#96;json:&quot;dd&quot;&#96;  &#x2F;&#x2F; 而&#96;大写的&#96;加了&#96;tag&#96;可以&#96;取别名&#96;&#125;func main() &#123;j :&#x3D; J &#123;a: &quot;1&quot;,b: &quot;2&quot;,C: &quot;3&quot;,D: &quot;4&quot;,&#125;fmt.Printf(&quot;转为json前j结构体的内容 &#x3D; %+v\n&quot;, j)      &#x2F;&#x2F; 转为json前j结构体的内容 &#x3D; &#123;a:1 b:2 C:3 D:4&#125;jsonInfo, _ :&#x3D; json.Marshal(j)fmt.Printf(&quot;转为json后的内容 &#x3D; %+v\n&quot;, string(jsonInfo))  &#x2F;&#x2F; 转为json后的内容 &#x3D; &#123;&quot;C&quot;:&quot;3&quot;,&quot;dd&quot;:&quot;4&quot;&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></code></pre></li></ul></li><li><p>结构体里定义了四个字段，分别对应 <code>小写无tag</code>，<code>小写+tag</code>，<code>大写无tag</code>，<code>大写+tag</code>。</p></li><li><p>转为<code>json</code>后首字母<code>小写的</code>不管加不加tag<code>都不能</code>转为<code>json</code>里的内容，而<code>大写的</code>加了<code>tag</code>可以<code>取别名</code>，不加<code>tag</code>则<code>json</code>内的字段跟结构体字段<code>原名一致</code>。</p></li></ul><h2 id="03-嵌套struct和JSON">03.嵌套struct和JSON</h2><h3 id="3-1-结构化转Json字符串"><a href="http://v5blog.cn/pages/4c5209/#_3-1-%E7%BB%93%E6%9E%84%E5%8C%96%E8%BD%ACjson%E5%AD%97%E7%AC%A6%E4%B8%B2">#</a>3.1 结构化转Json字符串</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Student 学生</span>ID <span class="token builtin">int</span>Gender <span class="token builtin">string</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Class <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Class 班级</span>Title <span class="token builtin">string</span>Students <span class="token punctuation">[</span><span class="token punctuation">]</span>Student<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Class<span class="token punctuation">&#123;</span>Title<span class="token punctuation">:</span>    <span class="token string">"001"</span><span class="token punctuation">,</span>Students<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Student<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>stu <span class="token operator">:=</span> Student<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"stu%02d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span>Gender<span class="token punctuation">:</span> <span class="token string">"男"</span><span class="token punctuation">,</span>ID<span class="token punctuation">:</span>     i<span class="token punctuation">,</span><span class="token punctuation">&#125;</span>c<span class="token punctuation">.</span>Students <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Students<span class="token punctuation">,</span> stu<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//JSON 序列化：结构体-->JSON 格式的字符串</span>data<span class="token punctuation">,</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"json marshal failed"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"json:%s\n"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*&#123;    "Title":"001",    "Students":[        &#123;            "ID":0,            "Gender":"男",            "Name":"stu00"        &#125;,        &#123;            "ID":1,            "Gender":"男",            "Name":"stu01"        &#125;,        &#123;            "ID":2,            "Gender":"男",            "Name":"stu02"        &#125;,....    ]&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-Json字符串转结构化">3.2 Json字符串转结构化</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Student 学生</span>ID <span class="token builtin">int</span>Gender <span class="token builtin">string</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Class <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Class 班级</span>Title <span class="token builtin">string</span>Students <span class="token punctuation">[</span><span class="token punctuation">]</span>Student<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">:=</span> <span class="token string">`&#123;"Title":"001","Students":[&#123;"ID":0,"Gender":"男","Name":"stu00"&#125;,&#123;"ID":1,"Gender":"男","Name":"stu01"&#125;,&#123;"ID":2,"Gender":"男","Name":"stu02"&#125;,&#123;"ID":3,"Gender":"男","Name":"stu03"&#125;]&#125;`</span>c1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Class<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">,</span> c1<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"json unmarshal failed!"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v\n"</span><span class="token punctuation">,</span> c1<span class="token punctuation">)</span><span class="token comment">// &amp;main.Class&#123;Title:"001", Students:[]main.Student&#123;main.Student&#123;ID:0, Gender:"男", Name:"stu00"&#125;, main.Student&#123;ID:1, Gender:"男", Name:"stu01"&#125;, main.Student&#123;ID:2, Gender:"男", Name:"stu02"&#125;, main.Student&#123;ID:3, Gender:"男", Name:"stu03"&#125;&#125;&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Time</title>
    <link href="/2022/05/22/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Time/"/>
    <url>/2022/05/22/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20Time/</url>
    
    <content type="html"><![CDATA[<h1 id="02-Time">02.Time</h1><h2 id="01-时间类型">01.时间类型</h2><ul><li>我们可以通过 time.Now()函数获取当前的时间对象，然后获取时间对象的年月日时分秒等信息。</li><li>注意：<strong>%02d</strong> 中的 2 表示宽度，如果整数不够 2 列就补上 0</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//获取当前时间</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"current time:%v\n"</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span>year <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//年</span>month <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//月</span>day <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">//日</span>hour <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">//小时</span>minute <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//分钟</span>second <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Second</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//秒</span><span class="token comment">// 打印结果为：2021-05-19 09:20:06</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d-%02d-%02d %02d:%02d:%02d\n"</span><span class="token punctuation">,</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-时间戳">02.时间戳</h2><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">//获取当前时间</span>timestamp1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//时间戳</span>timestamp2 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//纳秒时间戳</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"current timestamp1:%v\n"</span><span class="token punctuation">,</span> timestamp1<span class="token punctuation">)</span>  <span class="token comment">// current timestamp1:1623560753</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"current timestamp2:%v\n"</span><span class="token punctuation">,</span> timestamp2<span class="token punctuation">)</span>  <span class="token comment">// current timestamp2:1623560753965606600</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>使用<code>time.Unix()</code>函数可以将时间戳转为时间格式</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">timestampDemo2</span><span class="token punctuation">(</span>timestamp <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>timeObj <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">//将时间戳转为时间格式</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeObj<span class="token punctuation">)</span>year <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//年</span>month <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">//月</span>day <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token comment">//日</span>hour <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">//小时</span>minute <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Minute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//分钟</span>second <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Second</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//秒</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d-%02d-%02d %02d:%02d:%02d\n"</span><span class="token punctuation">,</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">,</span> hour<span class="token punctuation">,</span> minute<span class="token punctuation">,</span> second<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-时间间隔">03.时间间隔</h2><ul><li><code>time.Duration</code>是<code>time</code>包定义的一个类型，它代表两个时间点之间经过的时间，以纳秒为单位。</li><li><code>time.Duration</code>表示一段时间间隔，可表示的最长时间段大约290年。</li><li>time包中定义的时间间隔类型的常量如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>    Nanosecond  Duration <span class="token operator">=</span> <span class="token number">1</span>    Microsecond          <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> Nanosecond    Millisecond          <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> Microsecond    Second               <span class="token operator">=</span> <span class="token number">1000</span> <span class="token operator">*</span> Millisecond    Minute               <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> Second    Hour                 <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> Minute<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-时间格式化">04.时间格式化</h2><ul><li>时间类型有一个自带的方法<code>Format</code>进行格式化</li><li>需要注意的是Go语言中格式化时间模板不是常见的<code>Y-m-d H:M:S</code></li><li>而是使用Go的诞生时间2006年1月2号15点04分（记忆口诀为2006 1 2 3 4）。</li><li>补充：如果想格式化为12小时方式，需指定<code>PM</code>。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 格式化的模板为Go的出生时间2006年1月2号15点04分 Mon Jan</span><span class="token comment">// 24小时制</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 15:04:05.000 Mon Jan"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 2021-06-13 13:10:18.143 Sun Jun</span><span class="token comment">// 12小时制</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006-01-02 03:04:05.000 PM Mon Jan"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 2021-06-13 01:10:18.143 PM Sun Jun</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006/01/02 15:04"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 2021/06/13 13:10</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"15:04 2006/01/02"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 13:10 2021/06/13</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">"2006/01/02"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// 2021/06/13</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>解析字符串格式的时间</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span>  <span class="token comment">// 2021-06-13 13:11:29.0679475 +0800 CST m=+0.001573301</span><span class="token comment">// 加载时区</span>loc<span class="token punctuation">,</span> err <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">LoadLocation</span><span class="token punctuation">(</span><span class="token string">"Asia/Shanghai"</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token comment">// 按照指定时区和指定格式解析字符串时间</span>timeObj<span class="token punctuation">,</span> err <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseInLocation</span><span class="token punctuation">(</span><span class="token string">"2006/01/02 15:04:05"</span><span class="token punctuation">,</span> <span class="token string">"2019/08/04 14:15:20"</span><span class="token punctuation">,</span> loc<span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeObj<span class="token punctuation">)</span>  <span class="token comment">// 2019-08-04 14:15:20 +0800 CST</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeObj<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// -16294h56m9.0679475s</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-时间操作函数">05.时间操作函数</h2><ul><li>Add<ul><li>我们在日常的编码过程中可能会遇到要求时间+时间间隔的需求</li><li>Go 语言的时间对象有提供Add 方法如下</li></ul></li><li>Sub<ul><li>求两个时间之间的差值</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 获取当前时间</span><span class="token comment">// 10分钟前</span>m<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"-1m"</span><span class="token punctuation">)</span>m1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span><span class="token comment">// 8个小时前</span>h<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"-1h"</span><span class="token punctuation">)</span>h1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> h<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>h1<span class="token punctuation">)</span><span class="token comment">// 一天前</span>d<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"-24h"</span><span class="token punctuation">)</span>d1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>d1<span class="token punctuation">)</span><span class="token comment">// 10分钟后</span>mm<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"1m"</span><span class="token punctuation">)</span>mm1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>mm<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>mm1<span class="token punctuation">)</span><span class="token comment">// 8小时后</span>hh<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"1h"</span><span class="token punctuation">)</span>hh1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>hh<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>hh1<span class="token punctuation">)</span><span class="token comment">// 一天后</span>dd<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseDuration</span><span class="token punctuation">(</span><span class="token string">"24h"</span><span class="token punctuation">)</span>dd1 <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>dd<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>dd1<span class="token punctuation">)</span><span class="token comment">// Sub 计算两个时间差</span>subM <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>m1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>subM<span class="token punctuation">.</span><span class="token function">Minutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"分钟"</span><span class="token punctuation">)</span>   <span class="token comment">// 1 分钟</span>sumH <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>h1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sumH<span class="token punctuation">.</span><span class="token function">Hours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"小时"</span><span class="token punctuation">)</span>    <span class="token comment">// 8 小时</span>sumD <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>d1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v 天\n"</span><span class="token punctuation">,</span> sumD<span class="token punctuation">.</span><span class="token function">Hours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span><span class="token punctuation">)</span>   <span class="token comment">// 1 天</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>Equal<ul><li>判断两个时间是否相同，会考虑时区的影响，因此不同时区标准的时间也可以正确比较。</li><li>本方法和用t==u不同，这种方法还会比较地点和时区信息。</li></ul></li><li>Before<ul><li>如果t代表的时间点在u之前，返回真；否则返回假。</li></ul></li><li>After<ul><li>如果t代表的时间点在u之后，返回真；否则返回假。</li></ul></li></ul><h2 id="06-定时器">06.定时器</h2><ul><li>使用<code>time.Tick(时间间隔)</code>来设置定时器，定时器的本质上是一个通道（channel）。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">tickDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Tick</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">//定义一个1秒间隔的定时器</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ticker <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">//每秒都会执行的任务</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>fmt</title>
    <link href="/2022/05/20/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20fmt/"/>
    <url>/2022/05/20/Go%E5%B8%B8%E7%94%A8%E5%BA%93%E4%BB%8B%E7%BB%8D%20-%20fmt/</url>
    
    <content type="html"><![CDATA[<h1 id="01-fmt">01.fmt</h1><h2 id="01-常用占位符">01.常用占位符</h2><table><thead><tr><th>动词</th><th>功能</th></tr></thead><tbody><tr><td><code>%v</code></td><td>按值的本来值输出</td></tr><tr><td>%+v</td><td>在 %v 的基础上，对结构体字段名和值进行展开</td></tr><tr><td><code>%#v</code></td><td>输出 Go 语言语法格式的值</td></tr><tr><td><code>%T</code></td><td>输出 Go 语言语法格式的类型和值</td></tr><tr><td>%%</td><td>输出 %% 本体</td></tr><tr><td>%b</td><td>整型以二进制方式显示</td></tr><tr><td>%o</td><td>整型以八进制方式显示</td></tr><tr><td><code>%d</code></td><td>整型以十进制方式显示</td></tr><tr><td>%x</td><td>整型以 十六进制显示</td></tr><tr><td>%X</td><td>整型以十六进制、字母大写方式显示</td></tr><tr><td>%U</td><td>Unicode 字符</td></tr><tr><td>%f</td><td>浮点数</td></tr><tr><td>%p</td><td>指针，十六进制方式显示</td></tr></tbody></table><h2 id="02-Print">02. Print</h2><ul><li>Println：<ul><li>一次输入多个值的时候 Println 中间有空格</li><li>Println 会自动换行，Print 不会</li></ul></li><li>Print：<ul><li>一次输入多个值的时候 Print 没有 中间有空格</li><li>Print 不会自动换行</li></ul></li><li>Printf<ul><li>Printf 是格式化输出，在很多场景下比 Println 更方便</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">)</span>   <span class="token comment">// zhangsanlisiwangwu</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token string">"wangwu"</span><span class="token punctuation">)</span> <span class="token comment">// zhangsan lisi wangwu</span>name <span class="token operator">:=</span> <span class="token string">"zhangsan"</span>age <span class="token operator">:=</span> <span class="token number">20</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s 今年 %d 岁\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span>     <span class="token comment">// zhangsan 今年 20 岁</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v --> 类型: %T"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token comment">// 值：zhangsan --> 类型: string</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-Sprint">03.Sprint</h2><ul><li>Sprint系列函数会把传入的数据生成并返回一个字符串。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s1 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span><span class="token string">"枯藤"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span> <span class="token comment">// 枯藤</span>name <span class="token operator">:=</span> <span class="token string">"枯藤"</span>age <span class="token operator">:=</span> <span class="token number">18</span>s2 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"name:%s,age:%d"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> age<span class="token punctuation">)</span> <span class="token comment">// name:枯藤,age:18</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>s3 <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintln</span><span class="token punctuation">(</span><span class="token string">"枯藤"</span><span class="token punctuation">)</span> <span class="token comment">// 枯藤 有空格</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s3<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-Fprint">04. Fprint</h2><ul><li>Fprint系列函数会将内容输出到一个io.Writer接口类型的变量w中</li><li>我们通常用这个函数往文件中写入内容。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"os"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 方法1：输出到控制台</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintln</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">"向标准输出写入内容"</span><span class="token punctuation">)</span><span class="token comment">// 方法2：将文件写入到 xx.txt 文件中</span>fileObj<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">"./xx.txt"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_APPEND<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打开文件出错，err:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span>name <span class="token operator">:=</span> <span class="token string">"枯藤"</span><span class="token comment">// 向打开的文件句柄中写入内容</span>fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>fileObj<span class="token punctuation">,</span> <span class="token string">"往文件中写如信息：%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go常用库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go常用库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go设计模式 - 抽象工厂方法模式</title>
    <link href="/2022/05/17/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/05/17/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E6%8A%BD%E8%B1%A1%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="6-抽象工厂方法模式">6. 抽象工厂方法模式</h1><h2 id="6-1-抽象工厂方法模式中的角色和职责">6.1  抽象工厂方法模式中的角色和职责</h2><p>**抽象工厂（Abstract Factory）角色：**它声明了一组用于创建一族产品的方法，每一个方法对应一种产品。</p><p>**具体工厂（Concrete Factory）角色：**它实现了在抽象工厂中声明的创建产品的方法，生成一组具体产品，这些产品构成了一个产品族，每一个产品都位于某个产品等级结构中。</p><p>**抽象产品（Abstract Product）角色：**它为每种产品声明接口，在抽象产品中声明了产品所具有的业务方法。</p><p>**具体产品（Concrete Product）角色：**它定义具体工厂生产的具体产品对象，实现抽象产品接口中声明的业务方法。</p><h2 id="6-2-抽象工厂方法模式的实现">6.2 抽象工厂方法模式的实现</h2><p>抽象工厂方法模式的实现代码如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">/*练习：设计一个电脑主板架构，电脑包括（显卡，内存，CPU）3个固定的插口，显卡具有显示功能（display，功能实现只要打印出意义即可），内存具有存储功能（storage），cpu具有计算功能（calculate）。现有Intel厂商，nvidia厂商，Kingston厂商，均会生产以上三种硬件。要求组装两台电脑，            1台（Intel的CPU，Intel的显卡，Intel的内存）            1台（Intel的CPU， nvidia的显卡，Kingston的内存）用抽象工厂模式实现。*/</span><span class="token comment">// ======= 抽象层 =========</span><span class="token keyword">type</span> AbstractCPU <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">Calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> AbstractGraphics <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> AbstractMemory <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 抽象工厂</span><span class="token keyword">type</span> AbstractFactoryFn <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">CreateCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractCPU<span class="token function">CreateGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractGraphics<span class="token function">CreateMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractMemory<span class="token punctuation">&#125;</span><span class="token comment">// ======= 实现层 =========</span><span class="token comment">/* Inter 产品族 */</span><span class="token keyword">type</span> InterCPU <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ic <span class="token operator">*</span>InterCPU<span class="token punctuation">)</span> <span class="token function">Calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Inter's CPU calculation"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> InterGraphics <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ig <span class="token operator">*</span>InterGraphics<span class="token punctuation">)</span> <span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Inter's graphics display"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> InterMemory <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>im <span class="token operator">*</span>InterMemory<span class="token punctuation">)</span> <span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Inter's memory storage"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> InterFactory <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractFactoryFn<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>InterFactory<span class="token punctuation">)</span> <span class="token function">CreateCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractCPU <span class="token punctuation">&#123;</span><span class="token keyword">var</span> cpu <span class="token operator">*</span>InterCPUcpu <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>InterCPU<span class="token punctuation">)</span><span class="token keyword">return</span> cpu<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>InterFactory<span class="token punctuation">)</span> <span class="token function">CreateGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractGraphics <span class="token punctuation">&#123;</span><span class="token keyword">var</span> graphics <span class="token operator">*</span>InterGraphicsgraphics <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>InterGraphics<span class="token punctuation">)</span><span class="token keyword">return</span> graphics<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>InterFactory<span class="token punctuation">)</span> <span class="token function">CreateMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractMemory <span class="token punctuation">&#123;</span><span class="token keyword">var</span> memory <span class="token operator">*</span>InterMemorymemory <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>InterMemory<span class="token punctuation">)</span><span class="token keyword">return</span> memory<span class="token punctuation">&#125;</span><span class="token comment">/* Nvidia 产品族 */</span><span class="token keyword">type</span> NvidiaCPU <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>nc <span class="token operator">*</span>NvidiaCPU<span class="token punctuation">)</span> <span class="token function">Calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Nvidia's CPU calculation"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> NvidiaGraphics <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ng <span class="token operator">*</span>NvidiaGraphics<span class="token punctuation">)</span> <span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Nvidia's graphics display"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> NvidiaMemory <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>nm <span class="token operator">*</span>NvidiaMemory<span class="token punctuation">)</span> <span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Nvidia's memory storage"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> NvidiaFactory <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractFactoryFn<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>NvidiaFactory<span class="token punctuation">)</span> <span class="token function">CreateCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractCPU <span class="token punctuation">&#123;</span><span class="token keyword">var</span> cpu <span class="token operator">*</span>NvidiaCPUcpu <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>NvidiaCPU<span class="token punctuation">)</span><span class="token keyword">return</span> cpu<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>NvidiaFactory<span class="token punctuation">)</span> <span class="token function">CreateGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractGraphics <span class="token punctuation">&#123;</span><span class="token keyword">var</span> graphics <span class="token operator">*</span>NvidiaGraphicsgraphics <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>NvidiaGraphics<span class="token punctuation">)</span><span class="token keyword">return</span> graphics<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>NvidiaFactory<span class="token punctuation">)</span> <span class="token function">CreateMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractMemory <span class="token punctuation">&#123;</span><span class="token keyword">var</span> memory <span class="token operator">*</span>NvidiaMemorymemory <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>NvidiaMemory<span class="token punctuation">)</span><span class="token keyword">return</span> memory<span class="token punctuation">&#125;</span><span class="token comment">/* Kingston 产品族 */</span><span class="token keyword">type</span> KingstonCPU <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ic <span class="token operator">*</span>KingstonCPU<span class="token punctuation">)</span> <span class="token function">Calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Kingston's CPU calculation"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> KingstonGraphics <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>ig <span class="token operator">*</span>KingstonGraphics<span class="token punctuation">)</span> <span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Kingston's graphics display"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> KingstonMemory <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>im <span class="token operator">*</span>KingstonMemory<span class="token punctuation">)</span> <span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Kingston's memory storage"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> KingstonFactory <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractFactoryFn<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>KingstonFactory<span class="token punctuation">)</span> <span class="token function">CreateCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractCPU <span class="token punctuation">&#123;</span><span class="token keyword">var</span> cpu <span class="token operator">*</span>KingstonCPUcpu <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>KingstonCPU<span class="token punctuation">)</span><span class="token keyword">return</span> cpu<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>KingstonFactory<span class="token punctuation">)</span> <span class="token function">CreateGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractGraphics <span class="token punctuation">&#123;</span><span class="token keyword">var</span> graphics <span class="token operator">*</span>KingstonGraphicsgraphics <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>KingstonGraphics<span class="token punctuation">)</span><span class="token keyword">return</span> graphics<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>KingstonFactory<span class="token punctuation">)</span> <span class="token function">CreateMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractMemory <span class="token punctuation">&#123;</span><span class="token keyword">var</span> memory <span class="token operator">*</span>KingstonMemorymemory <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>KingstonMemory<span class="token punctuation">)</span><span class="token keyword">return</span> memory<span class="token punctuation">&#125;</span><span class="token comment">// ======= 业务逻辑层 =========</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 要求组装两台电脑，</span><span class="token comment">// 1台（Intel的CPU，Intel的显卡，Intel的内存）</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第1台：（Intel的CPU，Intel的显卡，Intel的内存）"</span><span class="token punctuation">)</span>iFac <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>InterFactory<span class="token punctuation">)</span>iCpu <span class="token operator">:=</span> iFac<span class="token punctuation">.</span><span class="token function">CreateCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span>iCpu<span class="token punctuation">.</span><span class="token function">Calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>iGraphics <span class="token operator">:=</span> iFac<span class="token punctuation">.</span><span class="token function">CreateGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>iGraphics<span class="token punctuation">.</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>iMemory <span class="token operator">:=</span> iFac<span class="token punctuation">.</span><span class="token function">CreateMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>iMemory<span class="token punctuation">.</span><span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 1台（Intel的CPU， nvidia的显卡，Kingston的内存）</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"第2台：（Intel的CPU，nvidia的显卡，Kingston的内存）"</span><span class="token punctuation">)</span>inFac <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>InterFactory<span class="token punctuation">)</span>inCpu <span class="token operator">:=</span> inFac<span class="token punctuation">.</span><span class="token function">CreateCPU</span><span class="token punctuation">(</span><span class="token punctuation">)</span>inCpu<span class="token punctuation">.</span><span class="token function">Calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>nGraphics <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>NvidiaFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateGraphics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>nGraphics<span class="token punctuation">.</span><span class="token function">Display</span><span class="token punctuation">(</span><span class="token punctuation">)</span>kMemory <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>KingstonFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>kMemory<span class="token punctuation">.</span><span class="token function">Storage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>以上是一个使用抽象工厂模式实现的电脑主板架构代码。这个系统可以组装不同厂商生产的CPU、显卡和内存来创建电脑。 该代码中定义了抽象层的接口，包括<code>AbstractCPU</code>、<code>AbstractGraphics</code>和<code>AbstractMemory</code>，以及抽象工厂接口<code>AbstractFactory</code>。然后通过实现这些接口来创建具体产品族的硬件和工厂。 在实现层中，有三个产品族的具体实现：<code>Inter</code>、<code>Nvidia</code>和<code>Kingston</code>。每个产品族都有对应的CPU、显卡和内存，并实现了抽象层的接口。 在业务逻辑层的<code>main</code>函数中，创建了两台电脑并进行组装。第一台电脑使用Intel的CPU、显卡和内存，第二台电脑使用Intel的CPU、Nvidia的显卡和Kingston的内存。组装过程通过抽象工厂来创建对应的硬件，并调用其相应的功能。 运行该代码将输出每个硬件的功能实现结果，例如CPU的计算、显卡的显示和内存的存储。 请注意，这只是一个示例代码，具体的电脑主板架构根据实际需求可能会有所不同。</p><h2 id="6-3-抽象工厂方法模式的优缺点">6.3 抽象工厂方法模式的优缺点</h2><p>优点：</p><ol><li>拥有工厂方法模式的优点</li><li>当一个产品族中的多个对象被设计成一起工作时，它能够保证客户端始终只使用同一个产品族中的对象。</li><li>增加新的产品族很方便，无须修改已有系统，符合“开闭原则”。</li><li>对于新产品的创建，符合开闭原则。</li></ol><p>缺点：</p><ol><li>增加新的产品等级结构麻烦，需要对原有系统进行较大的修改，甚至需要修改抽象层代码，这显然会带来较大的不便，违背了“开闭原则”。</li></ol><p>适用场景：</p><ol><li>系统中有多于一个的产品族。而每次只使用其中某一产品族。可以通过配置文件等方式来使得用户可以动态改变产品族，也可以很方便地增加新的产品族。</li><li>产品等级结构稳定。设计完成之后，不会向系统中增加新的产品等级结构或者删除已有的产品等级结构。</li></ol>]]></content>
    
    
    <categories>
      
      <category>Go设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go设计模式 - 工厂方法模式</title>
    <link href="/2022/05/15/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/05/15/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%B7%A5%E5%8E%82%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="5-工厂方法模式">5. 工厂方法模式</h1><h2 id="5-1-工厂方法模式中的角色和职责">5.1  工厂方法模式中的角色和职责</h2><p><strong>抽象工厂（Abstract Factory）角色</strong>：工厂方法模式的核心，任何工厂类都必须实现这个接口。</p><p><strong>工厂（Concrete Factory）角色</strong>：具体工厂类是抽象工厂的一个实现，负责实例化产品对象。</p><p><strong>抽象产品（Abstract Product）角色</strong>：工厂方法模式所创建的所有对象的父类，它负责描述所有实例所共有的公共接口。</p><p><strong>具体产品（Concrete Product）角色</strong>：工厂方法模式所创建的具体实例对象。</p><h2 id="5-2-工厂方法模式的实现">5.2 工厂方法模式的实现</h2><p>工厂方法模式的实现代码如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">// TODO 工厂模式</span><span class="token comment">// ----抽象层----</span><span class="token comment">// 文具类</span><span class="token keyword">type</span> AbstractStationery <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 工厂类</span><span class="token keyword">type</span> AbstractFactory <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractStationery <span class="token comment">// 生产文具的（抽象）类方法</span><span class="token punctuation">&#125;</span><span class="token comment">// ----实现层----</span><span class="token keyword">type</span> ActualPencil <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractStationery <span class="token comment">// 实际的铅笔继承抽象的文具</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>stationery <span class="token operator">*</span>ActualPencil<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"生产铅笔"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> ActualPen <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractStationery <span class="token comment">// 实际的钢笔继承抽象的文具</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>stationery <span class="token operator">*</span>ActualPen<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"生产钢笔"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// ----工厂模块----</span><span class="token comment">// 铅笔工厂</span><span class="token keyword">type</span> PencilFactory <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractFactory <span class="token comment">// 实际的铅笔工厂继承抽象的工厂</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>pencil <span class="token operator">*</span>PencilFactory<span class="token punctuation">)</span> <span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractStationery <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>ActualPencil<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 返回实际的铅笔</span><span class="token punctuation">&#125;</span><span class="token comment">// 钢笔工厂</span><span class="token keyword">type</span> PenFactory <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>AbstractFactory <span class="token comment">// 实际的钢笔工厂继承抽象的工厂</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>pen <span class="token operator">*</span>PenFactory<span class="token punctuation">)</span> <span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> AbstractStationery <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>ActualPen<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token comment">// 返回实际的钢笔</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 生产铅笔</span>pencilFactory <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>PencilFactory<span class="token punctuation">)</span>pencil <span class="token operator">:=</span> pencilFactory<span class="token punctuation">.</span><span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>pencil<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// 生产钢笔</span>penFactory <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>PenFactory<span class="token punctuation">)</span>pen <span class="token operator">:=</span> penFactory<span class="token punctuation">.</span><span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>pen<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>上述代码是通过面向抽象层开发，业务逻辑层的main()函数逻辑，依然是只与工厂耦合，且只与抽象的工厂和抽象的水果类耦合，这样就遵循了面向抽象层接口编程的原则。</p><h2 id="5-3-工厂方法模式的优缺点">5.3 工厂方法模式的优缺点</h2><p>优点：</p><ol><li>不需要记住具体类名，甚至连具体参数都不用记忆。</li><li>实现了对象创建和使用的分离。</li><li>系统的可扩展性也就变得非常好，无需修改接口和原类。</li><li>对于新产品的创建，符合开闭原则。</li></ol><p>缺点：</p><ol><li>增加系统中类的个数，复杂度和理解度增加。</li><li>增加了系统的抽象性和理解难度。</li></ol><p>适用场景：</p><ol><li>客户端不知道它所需要的对象的类。</li><li>抽象工厂类通过其子类来指定创建哪个对象。</li></ol>]]></content>
    
    
    <categories>
      
      <category>Go设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go设计模式 - 简单工厂模式</title>
    <link href="/2022/05/10/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/05/10/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E7%AE%80%E5%8D%95%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="4-简单工厂模式">4. 简单工厂模式</h1><h2 id="4-1-简单工厂模式角色和职责">4.1 简单工厂模式角色和职责</h2><p>简单工厂模式并不属于GoF的23种设计模式。他是开发者自发认为的一种非常简易的设计模式，其角色和职责如下：</p><p>工厂（Factory）角色：简单工厂模式的核心，它负责实现创建所有实例的内部逻辑。工厂类可以被外界直接调用，创建所需的产品对象。</p><p>抽象产品（AbstractProduct）角色：简单工厂模式所创建的所有对象的父类，它负责描述所有实例所共有的公共接口。</p><p>具体产品（Concrete Product）角色：简单工厂模式所创建的具体实例对象。</p><h2 id="4-2-简单工厂模式实现">4.2 简单工厂模式实现</h2><p>简单工厂方法模式的实现代码如下：</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">// TODO 简单工厂模式</span><span class="token comment">// ----抽象层----</span><span class="token keyword">type</span> Stationery <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>   <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// ----实现层----</span><span class="token keyword">type</span> Pencil <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   Stationery<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>stationery <span class="token operator">*</span>Pencil<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"生产铅笔"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Pen <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   Stationery<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>stationery <span class="token operator">*</span>Pen<span class="token punctuation">)</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"生产钢笔"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// ----工厂模块----</span><span class="token keyword">type</span> Factory <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>fac <span class="token operator">*</span>Factory<span class="token punctuation">)</span> <span class="token function">CreateStationery</span><span class="token punctuation">(</span>kind <span class="token builtin">string</span><span class="token punctuation">)</span> Stationery <span class="token punctuation">&#123;</span>   <span class="token keyword">var</span> sationery Stationery   <span class="token keyword">if</span> kind <span class="token operator">==</span> <span class="token string">"pencil"</span> <span class="token punctuation">&#123;</span>      sationery <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Pencil<span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> kind <span class="token operator">==</span> <span class="token string">"pen"</span> <span class="token punctuation">&#123;</span>      sationery <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Pen<span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span>   <span class="token keyword">return</span> sationery<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   factory <span class="token operator">:=</span> Factory<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>   <span class="token comment">// 生产铅笔</span>   pencil <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token string">"pencil"</span><span class="token punctuation">)</span>   pencil<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// 生产钢笔</span>   pen <span class="token operator">:=</span> factory<span class="token punctuation">.</span><span class="token function">CreateStationery</span><span class="token punctuation">(</span><span class="token string">"pen"</span><span class="token punctuation">)</span>   pen<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>上述代码可以看出，业务逻辑层只会和工厂模块进行依赖，这样业务逻辑层将不再关心Stationery类是具体怎么创建基础对象的。</p><h2 id="4-3-简单工厂方法模式的优缺点">4.3 简单工厂方法模式的优缺点</h2><p>优点：</p><ol><li>实现了对象创建和使用的分离。 2. 不需要记住具体类名，记住参数即可，减少使用者记忆量。</li></ol><p>缺点：</p><ol><li>对工厂类职责过重，一旦不能工作，系统受到影响。 2. 增加系统中类的个数，复杂度和理解度增加。 3. 违反“开闭原则”，添加新产品需要修改工厂逻辑，工厂越来越复杂。</li></ol><p>适用场景：</p><ol><li>工厂类负责创建的对象比较少，由于创建的对象较少，不会造成工厂方法中的业务逻辑太过复杂。 2. 客户端只知道传入工厂类的参数，对于如何创建对象并不关心。</li></ol>]]></content>
    
    
    <categories>
      
      <category>Go设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go设计模式 - 创建型模式</title>
    <link href="/2022/05/05/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/05/05/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E5%88%9B%E5%BB%BA%E5%9E%8B%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="3-创建型模式">3. 创建型模式</h1><table><thead><tr><th><strong>模式名称</strong></th><th><strong>模式名称</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong>创建型模式  Creational Pattern（<strong>6</strong>）</strong></td><td>单例模式★★★★☆</td><td>是保证一个类仅有一个实例，并提供一个访问它的全局访问点。</td></tr><tr><td></td><td>简单工厂模式★★★☆☆</td><td>通过专门定义一个类来负责创建其他类的实例，被创建的实例通常都具有共同的父类。</td></tr><tr><td></td><td>工厂方法模式★★★★★</td><td>定义一个创建产品对象的工厂接口，将实际创建工作推迟到子类中。</td></tr><tr><td></td><td>抽象工厂模式★★★★★</td><td>提供一个创建一系列相关或者相互依赖的接口，而无需指定它们具体的类。</td></tr><tr><td></td><td>原型模式★★★☆☆</td><td>用原型实例指定创建对象的种类，并且通过拷贝这些原型创建新的对象。</td></tr><tr><td></td><td>建造者模式★★☆☆☆</td><td>将一个复杂的构建与其表示相分离，使得同样的构建过程可以创建不同的表示。</td></tr></tbody></table><p>目前标准的创建型设计模式共有6种（注：设计模式种类并非仅仅局限于此，设计模式实则是一种编程思想，开发者可以根据自身经验来总结出很多种设计模式思想，这6中创建型设计模式为早期官方认可的标准模式）</p><p>本章节主要介绍常用的“单例模式”、“简单工程模式”、“工厂方法模式”、“抽象工厂模式”等。“原型模式”、“建造者模式”思想类似，作为读者选修篇幅，本章暂时先不介绍。</p>]]></content>
    
    
    <categories>
      
      <category>Go设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go设计模式 - 面向对象设计原则</title>
    <link href="/2022/05/03/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/"/>
    <url>/2022/05/03/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/</url>
    
    <content type="html"><![CDATA[<h1 id="2-面向对象设计原则">2. 面向对象设计原则</h1><p>对于面向对象软件系统的设计而言，在支持可维护性的同时，提高系统的可复用性是一个至关重要的问题，**如何同时提高一个软件系统的可维护性和可复用性是面向对象设计需要解决的核心问题之一。**在面向对象设计中，可维护性的复用是以设计原则为基础的。每一个原则都蕴含一些面向对象设计的思想，可以从不同的角度提升一个软件结构的设计水平。</p><p>**面向对象设计原则为支持可维护性复用而诞生，这些原则蕴含在很多设计模式中，它们是从许多设计方案中总结出的指导性原则。**面向对象设计原则也是我们用于评价一个设计模式的使用效果的重要指标之一。</p><p>原则的目的： 高内聚，低耦合</p><h2 id="2-1-面向对象设计原则表">2.1 面向对象设计原则表</h2><table><thead><tr><th style="text-align:left"><strong>名称</strong></th><th style="text-align:left"><strong>定义</strong></th></tr></thead><tbody><tr><td style="text-align:left"><strong>单一职责原则<br />(Single Responsibility Principle, SRP)</strong><br /><strong>★★★★☆</strong></td><td style="text-align:left">类的职责单一，对外只提供一种功能，而引起类变化的原因都应该只有一个。</td></tr><tr><td style="text-align:left"><strong>开闭原则<br />(Open-Closed Principle, OCP)<br />★★★★★</strong></td><td style="text-align:left">类的改动是通过增加代码进行的，而不是修改源代码。</td></tr><tr><td style="text-align:left"><strong>里氏代换原则</strong><br /><strong>(Liskov Substitution Principle, LSP)</strong><br /><strong>★★★★★</strong></td><td style="text-align:left">任何抽象类（interface接口）出现的地方都可以用他的实现类进行替换，实际就是虚拟机制，语言级别实现面向对象功能。</td></tr><tr><td style="text-align:left"><strong>依赖倒转原则</strong><br /><strong>(Dependence  Inversion Principle, DIP)</strong><br /><strong>★★★★★</strong></td><td style="text-align:left">依赖于抽象(接口)，不要依赖具体的实现(类)，也就是针对接口编程。</td></tr><tr><td style="text-align:left"><strong>接口隔离原则</strong><br /><strong>(Interface Segregation Principle, ISP)</strong><br /><strong>★★☆☆☆</strong></td><td style="text-align:left">不应该强迫用户的程序依赖他们不需要的接口方法。一个接口应该只提供一种对外功能，不应该把所有操作都封装到一个接口中去。</td></tr><tr><td style="text-align:left"><strong>合成复用原则<br />(Composite Reuse Principle,CRP)<br />★★★★☆</strong></td><td style="text-align:left">如果使用继承，会导致父类的任何变换都可能影响到子类的行为。如果使用对象组合，就降低了这种依赖关系。对于继承和组合，优先使用组合。</td></tr><tr><td style="text-align:left"><strong>迪米特法则<br />(Law of Demeter,LoD)</strong><br /><strong>★★★☆☆</strong></td><td style="text-align:left">一个对象应当对其他对象尽可能少的了解，从而降低各个对象之间的耦合，提高系统的可维护性。例如在一个程序中，各个模块之间相互调用时，通常会提供一个统一的接口来实现。这样其他模块不需要了解另外一个模块的内部实现细节，这样当一个模块内部的实现发生改变时，不会影响其他模块的使用。（黑盒原理）</td></tr></tbody></table><h2 id="2-2-单一职责原则">2.2 单一职责原则</h2><p>类的职责单一，对外只提供一种功能，而引起类变化的原因都应该只有一个。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> ClothesShop <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>cs <span class="token operator">*</span>ClothesShop<span class="token punctuation">)</span> <span class="token function">OnShop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"休闲的装扮"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> ClothesWork <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>cw <span class="token operator">*</span>ClothesWork<span class="token punctuation">)</span> <span class="token function">OnWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"工作的装扮"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//工作的时候</span>cw <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>ClothesWork<span class="token punctuation">)</span>cw<span class="token punctuation">.</span><span class="token function">OnWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//shopping的时候</span>cs <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>ClothesShop<span class="token punctuation">)</span>cs<span class="token punctuation">.</span><span class="token function">OnShop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>在面向对象编程的过程中，设计一个类，建议对外提供的功能单一，接口单一，影响一个类的范围就只限定在这一个接口上，一个类的一个接口具备这个类的功能含义，职责单一不复杂。</p><h2 id="2-3-开闭原则">2.3 开闭原则</h2><p>类的改动是通过增加代码实现的，而不是修改源码。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">// TODO 开闭原则</span><span class="token comment">// 类的改动是通过增加代码实现的，而不是修改源码</span><span class="token comment">// AbstractBanker 创建一个抽象业务员接口</span><span class="token keyword">type</span> AbstractBanker <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>   <span class="token function">DoBusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// SaveBanker 通过存款业务实例化业务员接口</span><span class="token keyword">type</span> SaveBanker <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   AbstractBanker<span class="token punctuation">&#125;</span><span class="token comment">// DoBusi 方法实例化了抽象接口</span><span class="token keyword">func</span> <span class="token punctuation">(</span>sb <span class="token operator">*</span>SaveBanker<span class="token punctuation">)</span> <span class="token function">DoBusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"进行存款业务"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> TranferBanker <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   AbstractBanker<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>tb <span class="token operator">*</span>TranferBanker<span class="token punctuation">)</span> <span class="token function">DoBusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"进行了转账业务"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> SharesBanker <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   AbstractBanker<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>sb <span class="token operator">*</span>SharesBanker<span class="token punctuation">)</span> <span class="token function">DoBusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"进行了股票业务"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// BankBusiness 实现一个架构层（基于抽象层进行业务封装-针对interface接口进行封装）</span><span class="token keyword">func</span> <span class="token function">BankBusiness</span><span class="token punctuation">(</span>banker AbstractBanker<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// 通过接口向下调用（多态现象）</span>   banker<span class="token punctuation">.</span><span class="token function">DoBusi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token function">BankBusiness</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SaveBanker<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>   <span class="token function">BankBusiness</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TranferBanker<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>   <span class="token function">BankBusiness</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SharesBanker<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p>开闭原则:一个软件实体如类、模块和函数应该对扩展开放，对修改关闭。<br>简单的说就是在修改需求的时候，应该尽量通过扩展来实现变化，而不是通过修改已有代码来实现变化。</p><h2 id="2-4-依赖倒转原则">2.4 依赖倒转原则</h2><p>面向抽象层依赖倒转</p><p><img src="/img/1651037225156-1b9ba94a-9498-4b72-a42b-c32e6261bbed.png" alt="依赖倒转设计.png"></p><p>如上图所示，如果我们在设计一个系统的时候，将模块分为3个层次，抽象层、实现层、业务逻辑层。那么，我们首先将抽象层的模块和接口定义出来，这里就需要了<code>interface</code>接口的设计，然后我们依照抽象层，依次实现每个实现层的模块，在我们写实现层代码的时候，实际上我们只需要参考对应的抽象层实现就好了，实现每个模块，也和其他的实现的模块没有关系，这样也符合了上面介绍的开闭原则。这样实现起来每个模块只依赖对象的接口，而和其他模块没关系，依赖关系单一。系统容易扩展和维护。</p><p>我们在指定业务逻辑也是一样，只需要参考抽象层的接口来业务就好了，抽象层暴露出来的接口就是我们业务层可以使用的方法，然后可以通过多态的线下，接口指针指向哪个实现模块，调用了就是具体的实现方法，这样我们业务逻辑层也是依赖抽象成编程。</p><p>我们就将这种的设计原则叫做<code>依赖倒转原则</code>。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">// TODO 依赖倒转原则</span><span class="token comment">// 依赖于抽象（接口），不要依赖具体的实现（类），针对接口编程</span><span class="token comment">// &lt;---- 抽象层 ----></span><span class="token keyword">type</span> Car <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>   <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Drive <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>   <span class="token function">Drive</span><span class="token punctuation">(</span>car Car<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// &lt;---- 实现层 ----></span><span class="token keyword">type</span> Banz <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Banz<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Banz is running"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> BMW <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>BMW<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"BMW is running"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Zhangsan <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>Zs <span class="token operator">*</span>Zhangsan<span class="token punctuation">)</span> <span class="token function">Drive</span><span class="token punctuation">(</span>car Car<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"zhangsan drive car"</span><span class="token punctuation">)</span>   car<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Lisi <span class="token keyword">struct</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>Ls <span class="token operator">*</span>Lisi<span class="token punctuation">)</span> <span class="token function">Drive</span><span class="token punctuation">(</span>car Car<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"lisi drive car"</span><span class="token punctuation">)</span>   car<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// &lt;---- 业务逻辑层 ----></span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">var</span> banz Car   banz <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Banz<span class="token punctuation">)</span>   <span class="token keyword">var</span> bm Car   bm <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>BMW<span class="token punctuation">)</span>   <span class="token comment">// 张三开奔驰</span>   <span class="token keyword">var</span> zs Drive   zs <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Zhangsan<span class="token punctuation">)</span>   zs<span class="token punctuation">.</span><span class="token function">Drive</span><span class="token punctuation">(</span>banz<span class="token punctuation">)</span>   <span class="token comment">//李四开宝马</span>   <span class="token keyword">var</span> ls Drive   ls <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Lisi<span class="token punctuation">)</span>   ls<span class="token punctuation">.</span><span class="token function">Drive</span><span class="token punctuation">(</span>bm<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="2-5-合成复用原则">2.5 合成复用原则</h2><p>如果使用继承，会导致父类的任何变换都可能影响到子类的行为。如果使用对象组合，就降低了这种依赖关系。对于继承和组合，优先使用组合。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Cat <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Cat<span class="token punctuation">)</span> <span class="token function">Eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"小猫吃饭"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//给小猫添加一个 可以睡觉的方法 （使用继承来实现）</span><span class="token keyword">type</span> CatB <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Cat<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>CatB<span class="token punctuation">)</span> <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"小猫睡觉"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//给小猫添加一个 可以睡觉的方法 （使用组合的方式）</span><span class="token keyword">type</span> CatC <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>C <span class="token operator">*</span>Cat<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>cc <span class="token operator">*</span>CatC<span class="token punctuation">)</span> <span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"小猫睡觉"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//通过继承增加的功能，可以正常使用</span>cb <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>CatB<span class="token punctuation">)</span>cb<span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>cb<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//通过组合增加的功能，可以正常使用</span>    cc <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>CatC<span class="token punctuation">)</span>    cc<span class="token punctuation">.</span>C <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Cat<span class="token punctuation">)</span>    cc<span class="token punctuation">.</span>C<span class="token punctuation">.</span><span class="token function">Eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cc<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Go设计模式 - 概述</title>
    <link href="/2022/05/01/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E6%A6%82%E8%BF%B0/"/>
    <url>/2022/05/01/Go%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%20-%20%E6%A6%82%E8%BF%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Go设计模式概述">1. Go设计模式概述</h1><p>如果把修习软件开发当做武功修炼的话，那么可以分为招式和内功。</p><p>招式：</p><p><img src="/img/1656050966875-2464cb07-3795-48aa-a7d9-20571786df18.png" alt="招式"></p><p>●Java、C#、C++、Golang、Rust等编程语言；</p><p>● Eclipse、Visual Studio、Goland、Vim等开发工具；</p><p>● Struts、Hibernate、JBPM、Gin、Istio、gRPC等框架技术；</p><p>内功： <img src="/img/1656050900953-d06ef59b-9a5b-4a91-b498-6356baf650a9.png" alt="内功"></p><p>●数据结构</p><p>●算法</p><p>●设计模式</p><p>●架构设计</p><p>●软件工程</p><p>注意：招式可以很快学会，但是内功的修炼需要更长的时间</p><h2 id="1-1-设计模式从何而来">1.1 设计模式从何而来</h2><p><img src="/img/1656051498608-c780e559-81fc-424c-9e73-60b9788d6dc6.png" alt="模式之父"></p><p>上图是“模式之父”，Christopher Alexander（克里斯托弗.亚历山大）———哈佛大学建筑学博士、美国加州大学伯克利分校建筑学教授、加州大学伯克利分校环境结构研究所所长、美国艺术和科学院院士。</p><p>克里斯托弗.亚历山大在作品《建筑的永恒之道》中对“模式”的描述是：</p><p>“每个模式都描述了一个在我们的环境中不断出现的问题，然后描述了该问题的解决方案的核心，通过这种方式，我们可以无数次地重用那些已有的成功的解决方案，无须再重复相同的工作。”</p><p>他给出了设计模式的定义。</p><p>我们也可以用下面这句话来理解“设计模式”的定义：</p><p>“设计模式是在特定环境下人们解决某类重复出现问题的一套成功或有效的解决方案。”</p><h2 id="1-2-软件设计模式又从何而来">1.2 软件设计模式又从何而来</h2><p><img src="/img/1656052978285-a32786ac-4b4d-4bdf-80c4-575d934f5d0b.png" alt="四人组（Gang of Four），简称GoF"></p><p>​</p><p>左到右依次是：Ralph Johnson，Richard Helm，Erich Gamma，John Vlissides。</p><p>GoF将模式的概念引入软件工程领域，这标志着软件模式的诞生。软件模式(Software Patterns)是将模式的一般概念应用于软件开发领域，即软件开发的总体指导思路或参照样板。软件模式并非仅限于设计模式，还包括架构模式、分析模式和过程模式等，实际上，在软件开发生命周期的每一个阶段都存在着一些被认同的模式。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">软件模式与具体的应用领域无关，也就是说无论你从事的是移动应用开发、桌面应用开发、Web应用开发还是嵌入式软件的开发，都可以使用软件模式。无论你是使用Java、C#、Objective-C、VB.net、Smalltalk等纯面向对象编程语言，还是使用C++、PHP、Delphi、JavaScript等可支持面向对象编程的语言，你都需要了解软件设计模式！ GoF给软件设计模式提供了定义，如下：</code></pre></div></figure><p>“软件设计模式(Design Pattern)是一套被反复使用、多数人知晓的、经过分类编目的、代码设计经验的总结，使用设计模式是为了可重用代码、让代码更容易被他人理解并且保证代码可靠性。”</p><p>一句大白话可以总结：“在一定环境下，用固定套路解决问题。”</p><h2 id="1-3-软件设计模式的种类">1.3 软件设计模式的种类</h2><p>GoF提出的设计模式有23个，包括：</p><p>（1）创建型(Creational)模式：如何创建对象；</p><p>（2）结构型(Structural )模式：如何实现类或对象的组合；</p><p>（3）行为型(Behavioral)模式：类或对象怎样交互以及怎样分配职责。</p><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">有一个“简单工厂模式”不属于GoF 23种设计模式，但大部分的设计模式书籍都会对它进行专门的介绍。</code></pre></div></figure><p>设计模式目前种类： GoF的23种   + “简单工厂模式” = 24种。</p><h2 id="1-4-软件设计模式的作用">1.4 软件设计模式的作用</h2><p>那么对于初学者来说，学习设计模式将有助于更加深入地理解面向对象思想, 让你知道：</p><ol><li><p>如何将代码分散在几个不同的类中？</p></li><li><p>为什么要有“接口”？</p></li><li><p>何谓针对抽象编程？</p></li><li><p>何时不应该使用继承？</p></li><li><p>如果不修改源代码增加新功能？</p></li><li><p>更好地阅读和理解现有类库与其他系统中的源代码。</p><p>学习设计模式会让你早点脱离面向对象编程的“菜鸟期”。</p></li></ol><h2 id="1-5-如何学好设计模式">1.5 如何学好设计模式</h2><p>设计模式的基础是：多态。</p><p>初学者：积累案例，不要盲目的背类图。</p><p>初级开发人员：多思考，多梳理，归纳总结，尊重事物的认知规律，注意临界点的突破，不要浮躁。</p><p>中级开发人员：合适的开发环境，寻找合适的设计模式来解决问题。</p><p>多应用，对经典则组合设计模式的大量，自由的运用。要不断的追求。</p><h2 id="1-6-设计模式总览表">1.6 设计模式总览表</h2><table><thead><tr><th><strong>模式名称</strong></th><th><strong>模式名称</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong>创建型模式</strong>  <strong>Creational Pattern（6）</strong></td><td>单例模式★★★★☆</td><td>是保证一个类仅有一个实例，并提供一个访问它的全局访问点。</td></tr><tr><td></td><td>简单工厂模式★★★☆☆</td><td>通过专门定义一个类来负责创建其他类的实例，被创建的实例通常都具有共同的父类。</td></tr><tr><td></td><td>工厂方法模式★★★★★</td><td>定义一个创建产品对象的工厂接口，将实际创建工作推迟到子类中。</td></tr><tr><td></td><td>抽象工厂模式★★★★★</td><td>提供一个创建一系列相关或者相互依赖的接口，而无需指定它们具体的类。</td></tr><tr><td></td><td>原型模式★★★☆☆</td><td>用原型实例指定创建对象的种类，并且通过拷贝这些原型创建新的对象。</td></tr><tr><td></td><td>建造者模式★★☆☆☆</td><td>将一个复杂的构建与其表示相分离，使得同样的构建过程可以创建不同的表示。</td></tr><tr><td><strong>结构型模式</strong> <strong>Structural Pattern（7）</strong></td><td>适配器模式★★★★☆</td><td>将一个类的接口转换成客户希望的另外一个接口。使得原本由于接口不兼容而不能一起工作的那些类可以一起工作。</td></tr><tr><td></td><td>桥接模式★★★☆☆</td><td>将抽象部分与实际部分分离，使它们都可以独立的变化。</td></tr><tr><td></td><td>组合模式★★☆☆☆</td><td>将对象组合成树形结构以表示“部分–整体”的层次结构。使得用户对单个对象和组合对象的使用具有一致性。</td></tr><tr><td></td><td>装饰模式★★★☆☆</td><td>动态的给一个对象添加一些额外的职责。就增加功能来说，此模式比生成子类更为灵活。</td></tr><tr><td></td><td>外观模式★★★★★</td><td>为子系统中的一组接口提供一个一致的界面，此模式定义了一个高层接口，这个接口使得这一子系统更加容易使用。</td></tr><tr><td></td><td>享元模式★☆☆☆☆</td><td>以共享的方式高效的支持大量的细粒度的对象。</td></tr><tr><td></td><td>代理模式★★★★☆</td><td>为其他对象提供一种代理以控制对这个对象的访问。</td></tr><tr><td><strong>行为型模式</strong> <strong>Behavioral Pattern（11）</strong></td><td>职责链模式★★☆☆☆</td><td>在该模式里，很多对象由每一个对象对其下家的引用而连接起来形成一条链。请求在这个链上传递，直到链上的某一个对象决定处理此请求，这使得系统可以在不影响客户端的情况下动态地重新组织链和分配责任。</td></tr><tr><td></td><td>命令模式★★★★☆</td><td>将一个请求封装为一个对象，从而使你可用不同的请求对客户端进行参数化；对请求排队或记录请求日志，以及支持可撤销的操作。</td></tr><tr><td></td><td>解释器模式★☆☆☆☆</td><td>如何为简单的语言定义一个语法，如何在该语言中表示一个句子，以及如何解释这些句子。</td></tr><tr><td></td><td>迭代器模式★☆☆☆☆</td><td>提供了一种方法顺序来访问一个聚合对象中的各个元素，而又不需要暴露该对象的内部表示。</td></tr><tr><td></td><td>中介者模式★★☆☆☆</td><td>定义一个中介对象来封装系列对象之间的交互。终结者使各个对象不需要显示的相互调用 ，从而使其耦合性松散，而且可以独立的改变他们之间的交互。</td></tr><tr><td></td><td>备忘录模式★★☆☆☆</td><td>是在不破坏封装的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态。</td></tr><tr><td></td><td>观察者模式★★★★★</td><td>定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</td></tr><tr><td></td><td>状态模式★★☆☆☆</td><td>对象的行为，依赖于它所处的状态。</td></tr><tr><td></td><td>策略模式★★★★☆</td><td>准备一组算法，并将每一个算法封装起来，使得它们可以互换。</td></tr><tr><td></td><td>模板方法模式★★★☆☆</td><td>得子类可以不改变一个算法的结构即可重定义该算法的某些特定步骤。</td></tr><tr><td></td><td>访问者模式★☆☆☆☆</td><td>表示一个作用于某对象结构中的各元素的操作，它使你可以在不改变各元素的类的前提下定义作用于这些元素的新操作。</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>Go设计模式</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>常见坑1~10</title>
    <link href="/2022/04/21/Go%E8%BF%9B%E9%98%B6%20-%20%E5%B8%B8%E8%A7%81%E5%9D%911~10/"/>
    <url>/2022/04/21/Go%E8%BF%9B%E9%98%B6%20-%20%E5%B8%B8%E8%A7%81%E5%9D%911~10/</url>
    
    <content type="html"><![CDATA[<h1 id="1-常见坑1-10">1.常见坑1~10</h1><h2 id="01-nil-slice-empty-slice">01.nil slice &amp; empty slice</h2><h3 id="1-1-nil切片与空切片底层">1.1 nil切片与空切片底层</h3><ul><li>nil切片：<code>var nilSlice []string</code><ul><li>nil slice 的<code>长度len和容量cap都是0</code></li><li><code>nil slice == nil</code></li><li>nil slice的pointer 是nil,</li></ul></li><li>空切片：<code>emptySlice0 := make([]int, 0)</code><ul><li>empty slice的长度是0, 容量是由指向底层数组决定</li><li><code>empty slice != nil</code></li><li>empty slice的pointer是底层数组的地址</li></ul></li><li>nil切片和空切片最大的区别在于<strong>指向的数组引用地址是不一样的</strong>。</li><li><code>nil空切片引用数组指针地址为0（无指向任何实际地址）</code></li></ul><p><img src="/img/image-20210622165057355.96fc918a.png" alt="img"></p><ul><li><code>空切片的引用数组指针地址是有的，且固定为一个值</code>,所有的空切片指向的数组引用地址都是一样的</li></ul><p><img src="/img/image-20210622165353680.61846d3c.png" alt="img"></p><h3 id="1-2-创建nil-slice和empty-slice">1.2 创建nil slice和empty slice</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> nilSlice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>  <span class="token comment">// 创建一个 nil 切片</span>emptySlice0 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">// 方法1：创建一个空切片（零切片）</span><span class="token keyword">var</span> emptySlice1 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>   <span class="token comment">// 方法2：创建一个空切片</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"\nnilSlice---> Nil:%v Len:%d Capacity:%d"</span><span class="token punctuation">,</span> nilSlice <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>nilSlice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>nilSlice<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"\nemptySlice0---> nil:%v Len:%d Capacity:%d"</span><span class="token punctuation">,</span> emptySlice0 <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>emptySlice0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>emptySlice0<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"\nemptySlice1---> nil:%v Len:%d Capacity:%d"</span><span class="token punctuation">,</span> emptySlice1 <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>emptySlice1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>emptySlice1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// nil切片和空切片都可以正常 append数据</span>nilSlice <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>nilSlice<span class="token punctuation">,</span> <span class="token string">"sss"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*Nil:true Len:0 Capacity:0nil:false Len:0 Capacity:0nil:false Len:0 Capacity:0[sss] */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-类型强转产生内存拷贝">02.类型强转产生内存拷贝</h2><h3 id="1-1-字符串转数组发送内存拷贝">1.1 字符串转数组发送内存拷贝</h3><ul><li>字符串转成byte数组，会发生内存拷贝吗？</li><li>字符串转成切片，会产生拷贝。</li><li>严格来说，只要是发生类型强转都会发生内存拷贝。</li><li>那么问题来了，频繁的内存拷贝操作听起来对性能不大友好。</li><li><strong>有没有什么办法可以在字符串转成切片的时候不用发生拷贝呢？</strong></li></ul><h3 id="1-2-字符串转数组不内存拷贝方法">1.2 字符串转数组不内存拷贝方法</h3><ul><li><p>那么如果想要在底层转换二者，只需要把 <code>StringHeader</code> 的地址强转成 <code>SliceHeader</code> 就行。那么go有个很强的包叫 <code>unsafe</code> 。</p></li><li><ul><li><ol><li></li></ol><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">unsafe.Pointer(&amp;a)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>方法可以得到变量</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>的地址。</p><ul><li>2.<code>(*reflect.StringHeader)(unsafe.Pointer(&amp;a))</code> 可以把字符串a转成底层结构的形式。</li><li>3.<code>(*[]byte)(unsafe.Pointer(&amp;ssh))</code> 可以把ssh底层结构体转成byte的切片的指针。</li><li>4.再通过 <code>*</code>转为指针指向的实际内容。</li></ul></li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>   <span class="token string">"fmt"</span>   <span class="token string">"reflect"</span>   <span class="token string">"unsafe"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   a <span class="token operator">:=</span><span class="token string">"aaa"</span>   ssh <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>   b <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ssh<span class="token punctuation">)</span><span class="token punctuation">)</span>   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T"</span><span class="token punctuation">,</span>b<span class="token punctuation">,</span>b<span class="token punctuation">)</span>  <span class="token comment">// [97 97 97]---[]uint8</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-解释">1.3 解释</h3><ul><li><code>StringHeader</code> 是<code>字符串</code>在go的底层结构。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> StringHeader <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Data <span class="token builtin">uintptr</span>Len  <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>SliceHeader</code> 是<code>切片</code>在go的底层结构。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> SliceHeader <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Data <span class="token builtin">uintptr</span>Len  <span class="token builtin">int</span>Cap  <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><p>那么如果想要在底层转换二者，只需要把 <code>StringHeader</code> 的地址强转成 <code>SliceHeader</code> 就行。</p></li><li><p>那么go有个很强的包叫 <code>unsafe</code> 。</p></li><li><ul><li><ol><li></li></ol><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">unsafe.Pointer(&amp;a)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>方法可以得到变量</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">a<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>的地址。</p><ul><li>2.<code>(*reflect.StringHeader)(unsafe.Pointer(&amp;a))</code> 可以把字符串a转成底层结构的形式。</li><li>3.<code>(*[]byte)(unsafe.Pointer(&amp;ssh))</code> 可以把ssh底层结构体转成byte的切片的指针。</li><li>4.再通过 <code>*</code>转为指针指向的实际内容。</li></ul></li></ul></li></ul><h2 id="03-拷贝大切片一定代价大吗">03.拷贝大切片一定代价大吗</h2><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">拷贝大切片一定比小切片代价大吗？<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">SliceHeader<pre class="line-numbers language-none"><code class="language-none"> 是<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure>切片<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">  在go的底层结构。  - 第一个字是指向切片&#96;底层数组的指针&#96;，这是切片的存储空间  - 第二个字段是&#96;切片的长度&#96;  - 第三个字段是&#96;容量&#96;&#96;&#96;&#96;gotype SliceHeader struct &#123;Data uintptrLen  intCap  int&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></code></pre></li><li><p>大切片跟小切片的区别无非就是 <code>Len</code> 和 <code>Cap</code>的值比小切片的这两个值大一些，如果发生拷贝，本质上就是拷贝上面的三个字段。</p></li><li><p>所以 <strong>拷贝大切片跟小切片的代价应该是一样的</strong>。</p></li></ul><h2 id="04-map不初始化使用会怎么样">04.map不初始化使用会怎么样</h2><ul><li>空map和nil map结果是一样的，都为map[]。</li><li>所以，这个时候别断定map是空还是nil，而应该通过map == nil来判断。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> m1 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>    <span class="token comment">// 创建一个 nil map</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"m1为nil: "</span><span class="token punctuation">,</span> m1<span class="token operator">==</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token comment">// 报错 => panic: assignment to entry in nil map</span><span class="token comment">//m1["name"] = "tom"</span><span class="token keyword">var</span> m2 <span class="token operator">=</span>  <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>  <span class="token comment">// 创建一个空map</span>m2<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"jack"</span>                <span class="token comment">// 空map可以正常</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"m2为nil: "</span><span class="token punctuation">,</span> m2<span class="token operator">==</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-map遍历删除安全吗">05.map遍历删除安全吗</h2><ul><li>map 并不是一个线程安全的数据结构。</li><li>同时读写一个 map 是未定义的行为，如果被检测到，会直接 panic。</li><li>上面说的是发生在多个协程同时读写同一个 map 的情况下。</li><li>如果在同一个协程内边遍历边删除，并不会检测到同时读写，理论上是可以这样做的。</li><li>sync.Map可以解决多线程读写map问题<ul><li>一般而言，这可以通过读写锁来解决：<code>sync.RWMutex</code>。</li><li>读之前调用 <code>RLock()</code> 函数，读完之后调用 <code>RUnlock()</code> 函数解锁；</li><li>写之前调用 <code>Lock()</code> 函数，写完之后，调用 <code>Unlock()</code> 解锁。</li><li>另外，<code>sync.Map</code> 是线程安全的 map，也可以使用。</li></ul></li></ul><h2 id="06-for循环append坑">06.for循环append坑</h2><h3 id="6-1-坑1：添加元素变覆盖">6.1 坑1：添加元素变覆盖</h3><ul><li><strong>不会死循环</strong>，<code>for range</code>其实是<code>golang</code>的<code>语法糖</code>，在循环开始前会获取切片的长度 <code>len(切片)</code>，然后再执行<code>len(切片)</code>次数的循环。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v<span class="token operator">:=</span><span class="token keyword">range</span> s <span class="token punctuation">&#123;</span>s <span class="token operator">=</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> v<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"len(s)=%v\n"</span><span class="token punctuation">,</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*len(s)=6len(s)=7len(s)=8len(s)=9len(s)=10 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="6-2-坑2：值全部一样">6.2 坑2：值全部一样</h3><ul><li>每次循转中num的值是正常的，但是由append构造的res中，全是nums的最后一个值。</li><li>最终总结出原因是在for range语句中，创建了变量num且只被创建了一次。</li><li>即num有自己的空间内存且地址在for循环过程中不变</li><li>循环过程中每次将nums中对应的值和num进行值传递。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> res <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> num <span class="token operator">:=</span> <span class="token keyword">range</span> nums <span class="token punctuation">&#123;</span>res <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num<span class="token punctuation">)</span><span class="token comment">//fmt.Println("num:", num)</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> res <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"res:"</span><span class="token punctuation">,</span> <span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*res: 5res: 5res: 5res: 5res: 5 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="6-3-解决方法">6.3 解决方法</h3><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">方法1<pre class="line-numbers language-none"><code class="language-none">  - 不使用for range的形式，直接用索引来对nums取值&#96;&#96;&#96;gopackage mainimport &quot;fmt&quot;func main() &#123;var nums &#x3D; []int&#123;1, 2, 3, 4, 5&#125;var res []*intfor i :&#x3D; 0; i &lt; len(nums); i++ &#123;res &#x3D; append(res, &amp;nums[i])&#125;fmt.Println(&quot;res:&quot;, res)for _, r :&#x3D; range res &#123;fmt.Println(&quot;res:&quot;, *r)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></code></pre></li><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">方法2<pre class="line-numbers language-none"><code class="language-none">  - 在for循环中每次再定义一个新的变量num_temp，将num的值传给num_temp，之后append该变量即可。&#96;&#96;&#96;textpackage mainimport &quot;fmt&quot;func main() &#123;var nums &#x3D; []int&#123;1, 2, 3, 4, 5&#125;var res []*intfor _, num :&#x3D; range nums &#123;numTemp :&#x3D; num &#x2F;&#x2F; 创建一个新的临时变量res &#x3D; append(res, &amp;numTemp)&#125;for _, r :&#x3D; range res &#123;fmt.Println(&quot;res:&quot;, *r)&#125;&#125;&#x2F;*res: 1res: 2res: 3res: 4res: 5 *&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></code></pre></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Golang常犯错误</title>
    <link href="/2022/04/20/Go%E8%BF%9B%E9%98%B6%20-%20Golang%E5%B8%B8%E7%8A%AF%E9%94%99%E8%AF%AF/"/>
    <url>/2022/04/20/Go%E8%BF%9B%E9%98%B6%20-%20Golang%E5%B8%B8%E7%8A%AF%E9%94%99%E8%AF%AF/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Golang常犯错误">1.Golang常犯错误</h1><h2 id="01-01-10">01.01~10</h2><h3 id="01-nil的slice和map">01.nil的slice和map</h3><ul><li>允许对值为 nil 的 slice 添加元素，但对值为 nil 的 map 添加元素，则会造成运行时 panic。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// map 错误示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">var</span> m <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>    m<span class="token punctuation">[</span><span class="token string">"one"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">// error: panic: assignment to entry in nil map</span>    <span class="token comment">// m := make(map[string]int)// map 的正确声明，分配了实际的内存</span><span class="token punctuation">&#125;</span>    <span class="token comment">// slice 正确示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">var</span> s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>     s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="02-判断map中key是否存在">02.判断map中key是否存在</h3><ul><li>当访问 map 中不存在的 key 时，Go 则会返回元素对应数据类型的零值，比如 nil、’’ 、false 和 0</li><li>取值操作总有值返回，故不能通过取出来的值，来判断 key 是不是在 map 中。</li><li>检查 key 是否存在可以用 map 直接访问，检查返回的第二个参数即可。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 错误的 key 检测方式</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"one"</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> v <span class="token operator">:=</span> x<span class="token punctuation">[</span><span class="token string">"two"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> v <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key two is no entry"</span><span class="token punctuation">)</span> <span class="token comment">// 键 two 存不存在都会返回的空字符串</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// 正确示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"one"</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"two"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"three"</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> x<span class="token punctuation">[</span><span class="token string">"two"</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"key two is no entry"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="03-string值修改">03.string值修改</h3><ul><li>不能，尝试使用索引遍历字符串，来更新字符串中的个别字符，是不允许的。</li><li>string 类型的值是只读的二进制 byte slice，如果真要修改字符串中的字符</li><li><code>将 string 转为 []byte 修改后，再转为 string 即可</code>。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 修改字符串的错误示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x <span class="token operator">:=</span> <span class="token string">"text"</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"T"</span>  <span class="token comment">// error: cannot assign to x[0]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 修改示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x <span class="token operator">:=</span> <span class="token string">"text"</span>xBytes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>xBytes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'T'</span> <span class="token comment">// 注意此时的 T 是 rune 类型</span>x <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>xBytes<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// Text</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="04-解析JSON数字转成float64">04.解析JSON数字转成float64</h3><ul><li>在 encode/decode JSON 数据时，Go 默认会将数值当做 float64 处理。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"encoding/json"</span><span class="token string">"fmt"</span><span class="token string">"log"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">`&#123;"status": 200&#125;`</span><span class="token punctuation">)</span>     <span class="token keyword">var</span> result <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>     <span class="token keyword">if</span> err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>     log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>     <span class="token punctuation">&#125;</span>     fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v--%T"</span><span class="token punctuation">,</span>result<span class="token punctuation">[</span><span class="token string">"status"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>result<span class="token punctuation">[</span><span class="token string">"status"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment">// 200--float64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>解析出来的 200 是 float 类型。</li></ul><h3 id="05-如何从-panic-中恢复">05.如何从 panic 中恢复</h3><ul><li>在一个 defer 延迟执行的函数中调用 recover ，它便能捕捉/中断 panic。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 错误的 recover 调用示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 什么都不会捕捉</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"not good"</span><span class="token punctuation">)</span> <span class="token comment">// 发生 panic，主程序退出</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 不会被执行</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 正确的 recover 调用示例</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"recovered: "</span><span class="token punctuation">,</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"not good"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="06-避免Goroutine泄露">06.避免Goroutine泄露</h3><ul><li>可以通过 context 包来避免内存泄漏。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    ch <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>        ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">select</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">case</span> <span class="token operator">&lt;-</span> ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    <span class="token keyword">return</span>                <span class="token keyword">case</span> ch <span class="token operator">&lt;-</span> i<span class="token punctuation">:</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> ch    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>    <span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>        <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">&#123;</span>            <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">break</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>下面的 for 循环停止取数据时，就用 cancel 函数，让另一个协程停止写数据。</li><li>如果下面 for 已停止读取数据，上面 for 循环还在写入，就会造成内存泄漏。</li></ul><h3 id="07-跳出for-select-循环">07.跳出for select 循环</h3><ul><li>通常在for循环中，使用break可以跳出循环</li><li>但是注意在go语言中，for select配合时，break 并不能跳出循环。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">testSelectFor2</span><span class="token punctuation">(</span>chExit <span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> EXIT<span class="token punctuation">:</span>    <span class="token keyword">for</span>  <span class="token punctuation">&#123;</span>        <span class="token keyword">select</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>chExit<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">&#123;</span>                fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"close channel 2"</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>                <span class="token keyword">break</span> EXIT<span class="token comment">//goto EXIT2</span>            <span class="token punctuation">&#125;</span>            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ch2 val ="</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">//EXIT2:</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"exit testSelectFor2"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="08-嵌套结构初始化">08.嵌套结构初始化</h3><ul><li>go 的哲学是组合优于继承，使用 struct 嵌套即可完成组合，内嵌的结构体属性就像外层结构的属性即可，可以直接调用。</li><li>注意初始化外层结构体时，必须指定内嵌结构体名称的结构体初始化，如下看到 s1方式报错，s2 方式正确。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> stPeople <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    Gender <span class="token builtin">bool</span>    Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> stStudent <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    stPeople    Class <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">//尝试4 嵌套结构的初始化表达式</span><span class="token comment">//var s1 = stStudent&#123;false, "JimWen", 3&#125;</span><span class="token keyword">var</span> s2 <span class="token operator">=</span> stStudent<span class="token punctuation">&#123;</span>stPeople<span class="token punctuation">&#123;</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"JimWen"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s2<span class="token punctuation">.</span>Gender<span class="token punctuation">,</span> s2<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> s2<span class="token punctuation">.</span>Class<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="09-defer触发顺序">09.defer触发顺序</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token function">defer_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">defer_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印前"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印中"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印后"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"触发异常"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>看下答案，输出：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">打印后打印中打印前panic: 触发异常<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>参考解析：defer 的执行顺序是后进先出。当出现 panic 语句的时候，会先按照 defer 的后进先出的顺序执行，最后才会执行panic</li></ul><h3 id="10-for循环-val取值错误">10.for循环&amp;val取值错误</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     slice <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span>     m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span>     <span class="token keyword">for</span> key<span class="token punctuation">,</span>val <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">&#123;</span>         m<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>val     <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token string">"->"</span><span class="token punctuation">,</span><span class="token operator">*</span>v<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>直接给答案：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">0 -> 31 -> 32 -> 33 -> 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>参考解析：<ul><li>这是新手常会犯的错误写法，for range 循环的时候会创建每个元素的副本，而不是元素的引用</li><li>所以 m[key] = &amp;val 取的都是变量 val 的地址，所以最后 map 中的所有元素的值都是变量 val 的地址</li><li>因为最后 val 被赋值为3，所有输出都是3</li></ul></li><li>正确的写法:</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     slice <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span>     m <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span>         <span class="token keyword">for</span> key<span class="token punctuation">,</span>val <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">&#123;</span>         value <span class="token operator">:=</span> val         m<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>value     <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">&#123;</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token string">"===>"</span><span class="token punctuation">,</span><span class="token operator">*</span>v<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="11-切片append错误">11.切片append错误</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 1.</span> <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     s <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>     s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>     fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token comment">// 2.</span> <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    s <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>    s <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>两段代码分别输出：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">[0 0 0 0 0 1 2 3][1 2 3 4]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><ul><li>参考解析：这道题考的是使用 append 向 slice 添加元素，第一段代码常见的错误是 [1 2 3]，需要注意。</li></ul><h2 id="02-11-20">02.11~20</h2><h3 id="12-new-返回指针">12.new()返回指针</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    list <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>    list <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>参考答案及解析：<ul><li>不能通过编译，new([]int) 之后的 list 是一个 <code>*[]int</code> 类型的指针，不能对指针执行 append 操作。</li><li>可以使用 make() 初始化之后再用。</li><li>同样的，map 和 channel 建议使用 make() 或字面量的方式初始化，不要用 new() 。</li></ul></li></ul><h3 id="13-赋值只能在函数内部使用">13. :=赋值只能在函数内部使用</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token comment">// myvar := 1   // error</span><span class="token keyword">var</span> myvar <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment">// ok</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>:=赋值不会影响外层函数值</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x <span class="token operator">:=</span> <span class="token number">1</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>       <span class="token comment">//prints 1</span><span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>   <span class="token comment">//prints 1</span>x <span class="token operator">:=</span> <span class="token number">2</span>           <span class="token comment">// 不会影响到外部x变量的值</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>   <span class="token comment">//prints 2</span><span class="token comment">//x = 5         // 要想修改x的值，必须使用这种语法赋值</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>      <span class="token comment">//prints 1</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="14-数组用于函数传参时是值复制">14.数组用于函数传参时是值复制</h3><ul><li>注意：方法或函数调用时，传入参数都是值复制（跟赋值一致）</li><li>除非是<code>map、slice、channel、指针类型</code> 这些特殊类型是引用传递</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>x <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span><span class="token function">test01</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>     <span class="token comment">// [1 2 3]</span><span class="token punctuation">&#125;</span><span class="token comment">// 数组在函数中传参是值复制</span><span class="token keyword">func</span> <span class="token function">test01</span><span class="token punctuation">(</span>arr <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>    <span class="token comment">//prints [7 2 3]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="15-defer打印顺序">15.defer打印顺序</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main <span class="token keyword">import</span> <span class="token punctuation">(</span>     <span class="token string">"fmt"</span> <span class="token punctuation">)</span> <span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     <span class="token function">defer_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">defer_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印前"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印中"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"打印后"</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"触发异常"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*    打印后    打印中    打印前    panic: 触发异常*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>当出现 panic 语句的时候，会先按照 defer 的后进先出的顺序执行，最后才会执行panic</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mutex锁原理</title>
    <link href="/2021/02/23/Go%E8%BF%9B%E9%98%B6%20-%20mutex%E9%94%81%E5%8E%9F%E7%90%86/"/>
    <url>/2021/02/23/Go%E8%BF%9B%E9%98%B6%20-%20mutex%E9%94%81%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="1-mutex锁原理">1.mutex锁原理</h1><h2 id="01-Mutex">01.Mutex</h2><h3 id="1-1-mutex结构体">1.1 mutex结构体</h3><ul><li>源码包src/sync/mutex.go:Mutex定义了互斥锁的数据结构</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>state <span class="token builtin">int32</span>     <span class="token comment">// 表示互斥锁的状态，比如是否被锁定等</span>sema  <span class="token builtin">uint32</span>   <span class="token comment">// 表示信号量，协程阻塞等待该信号量，解锁的协程释放信号量从而唤醒等待信号量的协程</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>我们看到Mutex.state是32位的整型变量，内部实现时把该变量分成四份，用于记录Mutex的四种状态。</li><li>下图展示Mutex的内存布局<ul><li><code>Locked</code>: 表示该Mutex是否已被锁定，0：没有锁定 1：已被锁定。</li><li><code>Woken</code>: 表示是否有协程已被唤醒，0：没有协程唤醒 1：已有协程唤醒，正在加锁过程中。</li><li><code>Starving</code>：表示该Mutex是否处理饥饿状态， 0：没有饥饿 1：饥饿状态，说明有协程阻塞了超过1ms。</li><li><code>Waiter</code>: 表示阻塞等待锁的协程个数，协程解锁时根据此值来判断是否需要释放信号量。</li></ul></li></ul><p><img src="/img/image-20220331104729411.c9e2f615.png" alt="img"></p><h3 id="1-2-简单加锁">1.2 简单加锁</h3><ul><li>假定当前只有一个协程在加锁，没有其他协程干扰，那么过程如下图所示</li><li>加锁过程会去判断Locked标志位是否为0，如果是0则把Locked位置1，代表加锁成功</li><li>从上图可见，加锁成功后，只是Locked位置1，其他状态位没发生变化</li></ul><p><img src="/img/image-20220331105015975.edc3fb06.png" alt="img"></p><h3 id="1-3-加锁被阻塞">1.3 加锁被阻塞</h3><ul><li>假定加锁时，锁已被其他协程占用了，此时加锁过程如下图所示<ul><li>当协程B对一个已被占用的锁再次加锁时，Waiter计数器增加了1</li><li>此时协程B将被阻塞，直到Locked值变为0后才会被唤醒。</li></ul></li></ul><p><img src="/img/image-20220331105145401.9da3a632.png" alt="img"></p><h3 id="1-4-解锁并唤醒协程">1.4 解锁并唤醒协程</h3><ul><li>假定解锁时，有1个或多个协程阻塞，此时解锁过程如下图所示：</li><li>协程A解锁过程分为两个步骤，一是把Locked位置0，二是查看到Waiter&gt;0</li><li>所以释放一个信号量，唤醒一个阻塞的协程，被唤醒的协程B把Locked位置1，于是协程B获得锁。</li></ul><p><img src="/img/image-20220331105401407.d6c8e796.png" alt="img"></p><h3 id="1-5-自旋过程">1.5 自旋过程</h3><ul><li>加锁时，如果当前Locked位为1，说明该锁当前由其他协程持有，尝试加锁的协程并不是马上转入阻塞</li><li>而是会持续的探测Locked位是否变为0，这个过程即为自旋过程。</li><li>自旋时间很短，但如果在自旋过程中发现锁已被释放，那么协程可以立即获取锁。此时即便有协程被唤醒也无法获取锁，只能再次阻塞。</li><li>自旋的好处是，当加锁失败时不必立即转入阻塞，有一定机会获取到锁，这样可以避免协程的切换。</li><li>自旋条件<ul><li>自旋次数要足够小，通常为4，即自旋最多4次</li><li>CPU核数要大于1，否则自旋没有意义，因为此时不可能有其他协程释放锁</li><li>协程调度机制中的Process数量要大于1，比如使用GOMAXPROCS()将处理器设置为1就不能启用自旋</li><li>协程调度机制中的可运行队列必须为空，否则会延迟协程调度</li></ul></li></ul><h2 id="02-原子操作与锁">02.原子操作与锁</h2><h3 id="2-1-什么是原子操作">2.1 什么是原子操作</h3><ul><li>一个或者多个操作在 CPU 执行的过程中不被中断的特性，称为<em>原子性（atomicity）</em> 。</li><li>这些操作对外表现成一个不可分割的整体，他们要么都执行，要么都不执行，外界不会看到他们只执行到一半的状态。</li><li><code>atomic</code>包中的原子操作则由<strong>底层硬件指令</strong>直接提供支持，这些指令在执行的过程中是不允许中断的</li><li>因此原子操作可以在<code>lock-free</code>的情况下保证并发安全，并且它的性能也能做到随<code>CPU</code>个数的增多而线性扩展。</li></ul><h3 id="2-2-互斥锁跟原子操作">2.2 互斥锁跟原子操作</h3><ul><li>使用目的：互斥锁是用来保护一段逻辑，原子操作用于对一个变量的更新保护。</li><li>底层实现：<ul><li><code>Mutex</code>由<code>操作系统的调度器</code>实现，而<code>atomic</code>包中的原子操作则由**<code>底层硬件指令</code>**直接提供支持，这些指令在执行的过程中是不允许中断的</li><li>因此原子操作可以在<code>lock-free</code>的情况下保证并发安全，并且它的性能也能做到随<code>CPU</code>个数的增多而线性扩展。</li></ul></li></ul><h3 id="2-3-Mutex实现机制">2.3 Mutex实现机制</h3><ul><li><p><code>CAS</code> (Compare And Swap) 的做法类似操作数据库时常见的乐观锁机制</p></li><li><p>该操作在进行交换前首先确保被操作数的值未被更改，满足此前提条件下才进行交换操作。</p></li><li><p>其实<code>Mutex</code>的底层实现也是依赖原子操作中的<code>CAS</code>实现的，原子操作的<code>atomic</code>包相当于是<code>sync</code>包里的那些同步原语的实现依赖。</p></li><li><p>比如互斥锁<code>Mutex</code>的结构里有一个<code>state</code>字段，其是表示锁状态的状态位。</p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    state <span class="token builtin">int32</span>    sema  <span class="token builtin">uint32</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sync.Map</title>
    <link href="/2021/02/22/Go%E8%BF%9B%E9%98%B6%20-%20sync_map/"/>
    <url>/2021/02/22/Go%E8%BF%9B%E9%98%B6%20-%20sync_map/</url>
    
    <content type="html"><![CDATA[<h1 id="1-sync-map">1.sync.map</h1><h2 id="01-sync-Map介绍">01.sync.Map介绍</h2><h3 id="1-1-sync-Map介绍">1.1 sync.Map介绍</h3><ul><li><p>简单说：空间换时间+读写分离+原子操作(快路径)</p></li><li><p>sync.Map 的主要思想就是读写分离，空间换时间</p><p>。</p><ul><li>sync.Map底层使用了两个原生<strong>map</strong>，一个叫read，仅用于读；</li><li>一个叫dirty，用于在特定情况下存储最新写入的key-value数据</li></ul></li></ul><h3 id="1-2-sync-Map特点">1.2 sync.Map特点</h3><ul><li>1、空间换时间：通过冗余的两个Map数据结构(read、dirty)，实现加锁对性能的影响。</li><li>2、使用只读数据(read)，避免读写冲突。</li><li>3、动态调整，miss次数多了之后，将dirty数据迁移到read中。</li><li>4、double-checking。</li><li>5、迟删除。 删除一个键值只是打标记，只有在迁移dirty数据的时候才清理删除的数据。</li><li>6、优先从read读取、更新、删除，因为对read的读取不需要锁。</li></ul><h3 id="1-3-sync-Map结构体">1.3 sync.Map结构体</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Map <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 当涉及到脏数据(dirty)操作时候，需要使用这个锁</span>    mu Mutex    <span class="token comment">// 后面是readOnly结构体，依靠map实现，仅仅只用来读</span>    read atomic<span class="token punctuation">.</span>Value <span class="token comment">// readOnly</span>    <span class="token comment">// 这个map主要用来写的，部分时候也承担读的能力</span>    dirty <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token operator">*</span>entry    <span class="token comment">// 记录自从上次更新了read之后，从read读取key失败的次数</span>    misses <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>readOnly</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// readOnly is an immutable struct stored atomically in the Map.read field.</span><span class="token keyword">type</span> readOnly <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// m包含所有只读数据，不会进行任何的数据增加和删除操作 </span>    <span class="token comment">// 但是可以修改entry的指针因为这个不会导致map的元素移动</span>    m       <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token operator">*</span>entry        <span class="token comment">// 标志位，如果为true则表明当前read只读map的数据不完整，dirty map中包含部分数据</span>    amended <span class="token builtin">bool</span> <span class="token comment">// true if the dirty map contains some key not in m.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-sync-Map操作">02.sync.Map操作</h2><p><img src="/img/image-20220331102352849.979847b4.png" alt="img"></p><h3 id="2-1-新增数据">2.1 新增数据</h3><ul><li>1、key原先就存在于read中，获取key所对应内存地址，原子性修改</li><li>2、key存在，但是key所对应的值被标记为 expunged，解锁，解除标记，并更新dirty中的key，与read中进行同步，然后修改key对应的值</li><li>3、read中没有key，但是dirty中存在这个key，直接修改dirty中key的值</li><li>4、read和dirty中都没有值，先判断自从read上次同步dirty的内容后有没有再修改过dirty的内容，没有的话，先同步read和dirty的值，然后添加新的key value到dirty上面</li></ul><h3 id="2-2-删除数据">2.2 删除数据</h3><ul><li>1、read中没有，且Map存在修改，则尝试删除dirty中的map中的key</li><li>2、read中没有，且Map不存在修改，那就是没有这个key，无需操作</li><li>3、read中有，尝试将key对应的值设置为nil，后面读取的时候就知道被删了，<ul><li><code>因为dirty中map的值跟read的map中的值指向的都是同一个地址空间，所以，修改了read也就是修改了dirty</code></li></ul></li></ul><h3 id="2-3-遍历（Range）">2.3 遍历（Range）</h3><ul><li>遍历的逻辑就比较简单了，Map只有两种状态，被修改过和没有修改过</li><li>修改过：将dirty的指针交给read，read就是最新的数据了，然后遍历read的map</li><li>没有修改过：遍历read的map就好了</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>sync.Pool</title>
    <link href="/2021/02/21/Go%E8%BF%9B%E9%98%B6%20-%20sync.Pool%20/"/>
    <url>/2021/02/21/Go%E8%BF%9B%E9%98%B6%20-%20sync.Pool%20/</url>
    
    <content type="html"><![CDATA[<h1 id="1-sync-Pool">1.sync.Pool</h1><h2 id="01-sync-Pool介绍">01.sync.Pool介绍</h2><h3 id="1-1-是什么">1.1 是什么</h3><ul><li><code>sync.Pool</code> 是 sync 包下的一个组件，可以作为保存临时取还对象的一个“池子”。</li><li>个人觉得它的名字有一定的误导性，因为 Pool 里装的对象可以被无通知地被回收，可能 <code>sync.Cache</code> 是一个更合适的名字。</li><li><code>Pool</code> 结构体的定义为：<ul><li><code>Pool</code> 中有两个定义的公共方法，分别是 <code>Put</code> - 向池中添加元素；</li><li><code>Get</code> 从池中获取元素，如果没有，则调用 <code>New</code> 生成元素，如果 <code>New</code> 未设置，则返回 <code>nil</code>。</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">type Pool struct &#123;   noCopy noCopy   local     unsafe.Pointer // 本地P缓存池指针   localSize uintptr        // 本地P缓存池大小   // 当池中没有可能对象时   // 会调用 New 函数构造构造一个对象   New func() interface&#123;&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-有什么用">1.2 有什么用</h3><ul><li>对于很多需要重复分配、回收内存的地方，<code>sync.Pool</code> 是一个很好的选择。</li><li>频繁地分配、回收内存会给 GC 带来一定的负担，严重的时候会引起 CPU 的毛刺</li><li>而 <code>sync.Pool</code> 可以将暂时不用的对象缓存起来，待下次需要的时候直接使用，不用再次经过内存分配</li><li>复用对象的内存，减轻 GC 的压力，提升系统的性能。</li></ul><h3 id="1-3-怎么用">1.3 怎么用</h3><ul><li>首先，<code>sync.Pool</code> 是协程安全的，这对于使用者来说是极其方便的。</li><li>使用前，设置好对象的 <code>New</code> 函数，用于在 <code>Pool</code> 里没有缓存的对象时，创建一个。</li><li>之后，在程序的任何地方、任何时候仅通过 <code>Get()</code>、<code>Put()</code> 方法就可以取、还对象了。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sync"</span><span class="token punctuation">)</span><span class="token keyword">var</span> pool <span class="token operator">*</span>sync<span class="token punctuation">.</span>Pool<span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">initPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>pool <span class="token operator">=</span> <span class="token operator">&amp;</span>sync<span class="token punctuation">.</span>Pool <span class="token punctuation">&#123;</span>New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Creating a new Person"</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">initPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>p <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Person<span class="token punctuation">)</span>   <span class="token comment">// get获取不到就会调用方法，创建一个</span>p<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"first"</span>pool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>  <span class="token comment">// 使用 Put方法将对象放回 pool池子中</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Pool 里已有一个对象：&amp;&#123;first&#125;，调用 Get: "</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Person<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Pool 没有对象了，调用 Get: "</span><span class="token punctuation">,</span> pool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Person<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 获取后再次获取就没有了,会再次创建</span><span class="token punctuation">&#125;</span><span class="token comment">/*Creating a new PersonPool 里已有一个对象：&amp;&#123;first&#125;，调用 Get:  &amp;&#123;first&#125;Creating a new PersonPool 没有对象了，调用 Get:  &amp;&#123;&#125; */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-4-Get">1.4 Get</h3><ul><li><code>Pool</code> 会为每个 <code>P</code> 维护一个本地池，<code>P</code> 的本地池分为 私有池 <code>private</code> 和共享池 <code>shared</code>。</li><li>私有池中的元素只能本地 <code>P</code> 使用，共享池中的元素可能会被其他 <code>P</code> 偷走</li><li>所以使用私有池 <code>private</code> 时不用加锁，而使用共享池 <code>shared</code> 时需加锁。</li><li><code>Get</code> 会优先查找本地 <code>private</code>，再查找本地 <code>shared</code>，最后查找其他 <code>P</code> 的 <code>shared</code></li><li>如果以上全部没有可用元素，最后会调用 <code>New</code> 函数获取新元素。</li></ul><h3 id="1-5-PUT">1.5 PUT</h3><ul><li><code>Put</code> 优先把元素放在 <code>private</code> 池中；</li><li>如果 <code>private</code> 不为空，则放在 <code>shared</code> 池中</li><li>有趣的是，在入池之前，该元素有 1/4 可能被丢掉。</li></ul><h2 id="02-gin中的Context-pool">02.gin中的Context pool</h2><ul><li>在 <code>web</code> 应用中，后台在处理用户的每条请求时都会为当前请求创建一个上下文环境 <code>Context</code>，用于存储请求信息及相应信息等。</li><li><code>Context</code> 满足长生命周期的特点，且用户请求也是属于并发环境，所以对于线程安全的 <code>Pool</code> 非常适合用来维护 <code>Context</code> 的临时对象池。</li><li><code>Gin</code> 在结构体 <code>Engine</code> 中定义了一个 <code>pool</code>:</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Engine <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">// ... 省略了其他字段</span>   pool             sync<span class="token punctuation">.</span>Pool<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>初始化 <code>engine</code> 时定义了 <code>pool</code> 的 <code>New</code> 函数：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">engine<span class="token punctuation">.</span>pool<span class="token punctuation">.</span>New <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">return</span> engine<span class="token punctuation">.</span><span class="token function">allocateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// allocateContext</span><span class="token keyword">func</span> <span class="token punctuation">(</span>engine <span class="token operator">*</span>Engine<span class="token punctuation">)</span> <span class="token function">allocateContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Context <span class="token punctuation">&#123;</span>   <span class="token comment">// 构造新的上下文对象</span>   <span class="token keyword">return</span> <span class="token operator">&amp;</span>Context<span class="token punctuation">&#123;</span>engine<span class="token punctuation">:</span> engine<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>ServeHttp</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 从 pool 中获取，并转化为 *Context</span>c <span class="token operator">:=</span> engine<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Context<span class="token punctuation">)</span>c<span class="token punctuation">.</span>writermem<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>c<span class="token punctuation">.</span>Request <span class="token operator">=</span> reqc<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// reset</span>engine<span class="token punctuation">.</span><span class="token function">handleHTTPRequest</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token comment">// 再扔回 pool 中</span>engine<span class="token punctuation">.</span>pool<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>协程调度GMP模型</title>
    <link href="/2021/02/20/Go%E8%BF%9B%E9%98%B6%20-%20%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6GMP%E6%A8%A1%E5%9E%8B/"/>
    <url>/2021/02/20/Go%E8%BF%9B%E9%98%B6%20-%20%E5%8D%8F%E7%A8%8B%E8%B0%83%E5%BA%A6GMP%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1-协程调度GMP模型">1.协程调度GMP模型</h1><h2 id="01-线程调度">01.线程调度</h2><h3 id="1-1-早期单线程操作系统">1.1 早期单线程操作系统</h3><ul><li>一切的软件都是跑在操作系统上，真正用来干活(计算)的是CPU。</li><li>早期的操作系统每个程序就是一个进程，知道一个程序运行完，才能进行下一个进程，就是“单进程时代”</li><li>一切的程序只能串行发生。</li></ul><p><img src="/img/image-20210604144028156.d6b2864c.png" alt="img"></p><h3 id="1-2-多进程-线程时代">1.2 多进程/线程时代</h3><ul><li>在多进程/多线程的操作系统中，就解决了阻塞的问题，因为一个进程阻塞cpu可以立刻切换到其他进程中去执行</li><li>而且调度cpu的算法可以保证在运行的进程都可以被分配到cpu的运行时间片</li><li>这样从宏观来看，似乎多个进程是在同时被运行。</li><li>但新的问题就又出现了，进程拥有太多的资源，进程的创建、切换、销毁，都会占用很长的时间</li><li>CPU虽然利用起来了，但如果<code>进程过多，CPU有很大的一部分都被用来进行进程调度了</code></li><li>大量的进程/线程出现了新的问题<ul><li>高内存占用</li><li>调度的高消耗CPU</li><li>进程虚拟内存会占用4GB[32位操作系统], 而线程也要大约4MB</li></ul></li></ul><p><img src="/img/image-20210604144407556.878340a6.png" alt="img"></p><h3 id="1-3-Go协程goroutine">1.3 Go协程goroutine</h3><ul><li>Go中，协程被称为goroutine，它非常轻量，一个goroutine只占几KB，并且这几KB就足够goroutine运行完</li><li>这就能在有限的内存空间内支持大量goroutine，支持了更多的并发</li><li>虽然一个goroutine的栈只占几KB，但实际是可伸缩的，如果需要更多内容，<code>runtime</code>会自动为goroutine分配。</li><li>Goroutine特点：<ul><li>占用内存更小（几kb）</li><li>调度更灵活(runtime调度)</li></ul></li></ul><h3 id="1-4-协程与线程区别">1.4 协程与线程区别</h3><ul><li>协程跟线程是有区别的，线程由CPU调度是抢占式的</li><li><strong>协程由用户态调度是协作式的</strong>，一个协程让出CPU后，才执行下一个协程</li></ul><p><img src="/img/image-20210604151113883.31ff129f.png" alt="img"></p><h2 id="02-调度器GMP模型">02.调度器GMP模型</h2><ul><li>G：goroutine（协程）</li><li>M：thread（内核线程，不是用户态线程）</li><li>P：processer（调度器）</li></ul><h3 id="2-1-GM模型">2.1 GM模型</h3><ul><li><code>G（协程）</code>，通常在代码里用 <code>go</code> 关键字执行一个方法，那么就等于起了一个<code>G</code>。</li><li><code>M（内核线程）</code>，操作系统内核其实看不见<code>G</code>和<code>P</code>，只知道自己在执行一个线程。</li><li><code>G</code>和<code>P</code>都是在<strong>用户层</strong>上的实现。</li><li>并发量小的时候还好，当并发量大了，这把大锁，就成为了<strong>性能瓶颈</strong>。</li></ul><p><img src="/img/640.adc59e89.gif" alt="img"></p><ul><li>GPM由来<ul><li>基于没有什么是加一个中间层不能解决的思路，<code>golang</code>在原有的<code>GM</code>模型的基础上加入了一个调度器<code>P</code></li><li>可以简单理解为是在<code>G</code>和<code>M</code>中间加了个中间层</li><li>于是就有了现在的<code>GMP</code>模型里的P</li></ul></li></ul><h3 id="2-2-GMP模型">2.2 GMP模型</h3><p><img src="/img/image-20210604153340855.3a3ed056.png" alt="img"></p><h2 id="03-GPM流程分析">03.GPM流程分析</h2><ul><li>我们通过 go func()来创建一个goroutine；</li></ul><h3 id="3-1-P本地队列获取G">3.1 P本地队列获取G</h3><ul><li>M<code>想要运行</code>G<code>，就得先获取</code>P<code>，然后从</code>P<code>的本地队列获取</code>G</li></ul><p><img src="/img/641.ac98dab0.gif" alt="img"></p><h3 id="3-2-本地队列中G移动到全局队列">3.2 本地队列中G移动到全局队列</h3><ul><li>新建 <code>G</code> 时，新<code>G</code>会优先加入到 <code>P</code> 的本地队列；</li><li>如果本地队列满了，则会把本地队列中一半的 <code>G</code> 移动到全局队列</li></ul><p><img src="/img/646.61ce03be.gif" alt="img"></p><h3 id="3-3-从其他P本地队列的G放到自己P队列">3.3 从其他P本地队列的G放到自己P队列</h3><ul><li>如果全局队列为空时，<code>M</code> 会从其他 <code>P</code> 的本地队列<strong>偷（stealing）一半G</strong>放到自己 <code>P</code> 的本地队列。</li></ul><p><img src="/img/888.ab33d3d0.gif" alt="img"></p><h3 id="3-4-M从P获取下一个G，不断重复">3.4 M从P获取下一个G，不断重复</h3><ul><li><code>M</code> 运行 <code>G</code>，<code>G</code> 执行之后，<code>M</code> 会从 <code>P</code> 获取下一个 <code>G</code>，不断重复下去</li></ul><p><img src="/img/999.29c4346c.gif" alt="img"></p><h2 id="04-goroutine调度器">04.goroutine调度器</h2><ul><li><a href="https://github.com/lifei6671/interview-go/blob/master/base/go-scheduler-base.md">参考(opens new window)</a></li></ul><h3 id="4-1-普通线程与goroutine">4.1 普通线程与goroutine</h3><h4 id="1、普通线程缺点">1、普通线程缺点</h4><ul><li><p>1）创建和切换太重</p><ul><li>操作系统<code>线程的创建和切换都需要进入内核</code>，而进入内核所消耗的<code>性能代价比较高，开销较大</code>；</li></ul></li><li><p>2）内存使用太重</p><ul><li><p>一方面，为了尽量避免极端情况下操作系统线程栈的溢出，</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">内核在创建操作系统线程时默认会为其分配一个较大的栈内存<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>虚拟地址空间，内核并不会一开始就分配这么多的物理内存</li><li>然而在绝大多数情况下，系统线程远远用不了这么多内存，这导致了浪费；</li></ul></li><li><p>另一方面，栈内存空间一旦创建和初始化完成之后其大小就不能再有变化，这决定了在某些特殊场景下系统线程栈还是有溢出的风险。</p></li></ul></li></ul><h4 id="2、goroutine为什么轻量">2、goroutine为什么轻量</h4><ul><li>goroutine是用户态线程，其创<code>建和切换都在用户代码中完成而无需进入操作系统内核</code>，所以其开销要远远小于系统线程的创建和切换；</li><li><code>goroutine启动时默认栈大小只有2k</code>，这在多数情况下已经够用了，即使不够用，goroutine的栈也会自动扩大<ul><li>同时，如果栈太大了过于浪费它还能自动收缩，这样既没有栈溢出的风险，也不会造成栈内存空间的大量浪费。</li></ul></li></ul><h3 id="4-2-线程模型与调度器">4.2 线程模型与调度器</h3><h4 id="1、调度器理论">1、调度器理论</h4><ul><li>goroutine建立在操作系统线程基础之上，它与操作系统线程之间实现了一个多对多(M:N)的两级线程模型</li><li>这里的 M:N 是指M个goroutine运行在N个操作系统线程之上</li><li><code>内核负责对这N个操作系统线程进行调度</code>，而这<code>N个系统线程又负责对这M个goroutine进行调度和运行</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">如何调度<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>所谓的对goroutine的调度，是指程序代码按照一定的算法在适当的时候挑选出合适的goroutine并放到CPU上去运行的过程</li><li>这些<code>负责对goroutine进行调度的程序代码我们称之为goroutine调度器</code></li></ul><h4 id="2、调度器伪代码理解">2、调度器伪代码理解</h4><ul><li>所谓的对goroutine的调度，<code>是指程序代码按照一定的算法在适当的时候挑选出合适的goroutine并放到CPU上去运行的过程</code></li><li>这些<code>负责对goroutine进行调度的程序代码我们称之为goroutine调度器</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 程序启动时的初始化代码</span><span class="token operator">...</span><span class="token operator">...</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 创建N个操作系统线程执行schedule函数</span>    <span class="token function">create_os_thread</span><span class="token punctuation">(</span>schedule<span class="token punctuation">)</span> <span class="token comment">// 创建一个操作系统线程执行schedule函数</span><span class="token punctuation">&#125;</span><span class="token comment">//schedule函数实现调度逻辑</span><span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token keyword">for</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//调度循环</span>         <span class="token comment">// 根据某种算法从M个goroutine中找出一个需要运行的goroutine</span>         g <span class="token operator">:=</span> <span class="token function">find_a_runnable_goroutine_from_M_goroutines</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token function">run_g</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token comment">// CPU运行该goroutine，直到需要调度其它goroutine才返回</span>         <span class="token function">save_status_of_g</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span> <span class="token comment">// 保存goroutine的状态，主要是寄存器的值</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>程序运行起来之后创建了N个由内核调度的操作系统线程（工作线程）去执行shedule函数</code></li><li>而schedule函数在一个调度循环中反复从M个goroutine中挑选出一个需要运行的goroutine并跳转到该goroutine去运行</li><li>直到需要调度其它goroutine时才返回到schedule函数中<ul><li>通过save_status_of_g保存刚刚正在运行的goroutine的状态然后再次去寻找下一个goroutine</li></ul></li></ul><h3 id="4-3-调度器数据结构">4.3 调度器数据结构</h3><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">操作系统线程及其调度<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>在执行操作系统代码时，<code>内核调度器按照一定的算法挑选出一个线程</code></li><li>并把<code>该线程保存在内存之中的寄存器的值放入CPU对应的寄存器从而恢复该线程的运行</code></li></ul><h4 id="1、g结构体">1、g结构体</h4><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">存放goroutine状态信息：g的结构体<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li><code>系统线程对goroutine的调度与内核对系统线程的调度原理是一样的</code></li><li><code>实质都是通过保存和修改CPU寄存器的值来达到切换线程/goroutine的目的</code></li><li>为了实现对goroutine的调度，需要引入一个数据结构来保存CPU寄存器的值以及goroutine的其它一些状态信息</li><li>在Go语言调度器源代码中，这个数据结构是一个名叫g的结构体，它保存了goroutine的所有信息</li><li>该结构体的每一个实例对象都代表了一个goroutine，调度器代码可以通过g对象来对goroutine进行调度</li><li>当goroutine被调离CPU时，<code>调度器代码负责把CPU寄存器的值保存在g对象的成员变量之中</code></li><li><code>当goroutine被调度起来运行时，调度器代码又负责把g对象的成员变量所保存的寄存器的值恢复到CPU的寄存器</code></li></ul><h4 id="2、全局队列">2、全局队列</h4><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">goroutine全局队列：schedt结构体<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>要实现对goroutine的调度，仅仅有g结构体对象是不够的，至少还需要<code>一个存放所有（可运行）goroutine的容器</code></li><li>一方面用来<code>保存调度器自身的状态信息</code>，另一方面它还拥有<code>一个用来保存goroutine的运行队列</code></li><li>在每个Go程序中schedt结构体只有一个实例对象，该实例对象在源代码中被定义成了一个共享的全局变量</li><li>这样每个工作线程都可以<code>访问它以及它所拥有的goroutine运行队列，我们称这个运行队列为全局运行队列</code></li></ul><h4 id="3、局部队列">3、局部队列</h4><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">goroutine局部队列：p结构体<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>因为全局运行队列是每个工作线程都可以读写的，因此访问它需要加锁，加锁会导致严重的性能问题。</li><li>于是，调度器又为<code>每个工作线程引入了一个私有的局部goroutine运行队列</code></li><li><code>工作线程优先使用自己的局部运行队列，只有必要时才会去访问全局运行队列</code>，这大大减少了锁冲突，提高了工作线程的并发性</li><li>在Go调度器源代码中，局部运行队列被包含在p结构体的实例对象之中</li><li>每一个运行着go代码的工作线程都会与一个p结构体的实例对象关联在一起</li></ul><h4 id="4、m结构体">4、m结构体</h4><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">属于工作线程的m结构体<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>Go调度器源代码中还有一个<code>用来代表工作线程的m结构体</code></li><li><code>每个工作线程都有唯一的一个m结构体的实例对象与之对应</code>，m结构体对象除了记录着<ul><li>1）工作线程的诸如栈的<code>起止位置</code></li><li>2）当前<code>正在执行的goroutine</code>以及是否空闲等等状态信息之外</li><li>3）还通过指针维持着与<code>p结构体的实例对象之间的绑定关系</code></li></ul></li><li>于是，<code>通过m既可以找到与之对应的工作线程正在运行的goroutine，又可以找到工作线程的局部运行队列等资源</code></li></ul><h4 id="5、全局私有变量">5、全局私有变量</h4><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">全局私有变量 工作线程与工作线程结构体对应关系<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>工作线程执行的代码是如何找到属于自己的那个m结构体实例对象的呢？</li><li>每个<code>工作线程在刚刚被创建出来</code>进入调度循环之前就利用线程本地存储机制<code>为该工作线程实现了一个指向m结构体实例对象的私有全局变量</code></li><li>这样在之后的代码中就使用该全局变量来访问自己的m结构体对象以及与m相关联的p和g对象</li></ul><h3 id="4-4-重要的结构体">4.4 重要的结构体</h3><h4 id="1、g结构体-2">1、g结构体</h4><ul><li>g结构体用于代表一个goroutine，该结构体保存了goroutine的所有信息</li><li>包括<code>栈，gobuf结构体和其它的一些状态信息</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 前文所说的g结构体，它代表了一个goroutine</span><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    stack       stack     <span class="token comment">// 记录该goroutine使用的栈</span>    m          <span class="token operator">*</span>m      <span class="token comment">// 此goroutine正在被哪个工作线程执行</span>    sched       gobuf    <span class="token comment">// 保存调度信息，主要是几个寄存器的值</span>    <span class="token comment">// schedlink字段指向全局运行队列中的下一个g,所有位于全局运行队列中的g形成一个链表</span>    schedlink      guintptr    preempt        <span class="token builtin">bool</span>   <span class="token comment">// 抢占调度标志，如果需要抢占调度，设置preempt为true</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h4 id="2、m结构体">2、m结构体</h4><ul><li>m结构体用来代表<code>工作线程</code>，它保存了m自身使用的栈信息</li><li><code>当前正在运行的goroutine以及与m绑定的p等信息</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> m <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// g0主要用来记录工作线程使用的栈信息，在执行调度代码时需要使用这个栈</span>    <span class="token comment">// 执行用户goroutine代码时，使用用户goroutine自己的栈，调度时会发生栈的切换</span>    g0      <span class="token operator">*</span>g    <span class="token comment">// 通过TLS实现m结构体对象与工作线程之间的绑定</span>    tls           <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span>   <span class="token comment">// thread-local storage (for x86 extern register)</span>    curg          <span class="token operator">*</span>g         <span class="token comment">// 指向工作线程正在运行的goroutine的g结构体对象</span>    p            puintptr     <span class="token comment">// 记录与当前工作线程绑定的p结构体对象</span>    nextp         puintptr    oldp          puintptr     <span class="token comment">// the p that was attached before executing a syscall</span>       <span class="token comment">// spinning状态：表示当前工作线程正在试图从其它工作线程的本地运行队列偷取goroutine</span>    spinning      <span class="token builtin">bool</span> <span class="token comment">// m is out of work and is actively looking for work</span>    blocked       <span class="token builtin">bool</span> <span class="token comment">// m is blocked on a note</span>       <span class="token comment">// 没有goroutine需要运行时，工作线程睡眠在这个park成员上，</span>    <span class="token comment">// 其它线程通过这个park唤醒该工作线程</span>    park          note    <span class="token comment">// 记录所有工作线程的一个链表</span>    alllink       <span class="token operator">*</span>m <span class="token comment">// on allm</span>    schedlink     muintptr    <span class="token comment">// Linux平台thread的值就是操作系统线程ID</span>    thread        <span class="token builtin">uintptr</span> <span class="token comment">// thread handle</span>    freelink      <span class="token operator">*</span>m      <span class="token comment">// on sched.freem</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h4 id="3、p结构体">3、p结构体</h4><ul><li>p结构体用于<code>保存工作线程执行go代码时所必需的资源</code>，比如goroutine的运行队列，内存分配用到的缓存等等</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    lock mutex    status       <span class="token builtin">uint32</span> <span class="token comment">// one of pidle/prunning/...</span>    link            puintptr    schedtick   <span class="token builtin">uint32</span>     <span class="token comment">// incremented on every scheduler call</span>    syscalltick  <span class="token builtin">uint32</span>     <span class="token comment">// incremented on every system call</span>    sysmontick  sysmontick <span class="token comment">// last tick observed by sysmon</span>    m                muintptr   <span class="token comment">// back-link to associated m (nil if idle)</span>    <span class="token comment">//本地goroutine运行队列</span>    runqhead <span class="token builtin">uint32</span>  <span class="token comment">// 队列头</span>    runqtail <span class="token builtin">uint32</span>     <span class="token comment">// 队列尾</span>    runq     <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span>guintptr  <span class="token comment">//使用数组实现的循环队列</span>    runnext guintptr    gFree <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>        gList        n <span class="token builtin">int32</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h4 id="4、schedt结构体">4、schedt结构体</h4><ul><li>schedt结构体用来保存调度器的状态信息和goroutine的全局运行队列：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> schedt <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// accessed atomically. keep at top to ensure alignment on 32-bit systems.</span>    goidgen  <span class="token builtin">uint64</span>    lastpoll <span class="token builtin">uint64</span>    lock mutex    <span class="token comment">// When increasing nmidle, nmidlelocked, nmsys, or nmfreed, be</span>    <span class="token comment">// sure to call checkdead().</span>    <span class="token comment">// 由空闲的工作线程组成链表</span>    midle        muintptr <span class="token comment">// idle m's waiting for work</span>    <span class="token comment">// 空闲的工作线程的数量</span>    nmidle       <span class="token builtin">int32</span>    <span class="token comment">// number of idle m's waiting for work</span>    nmidlelocked <span class="token builtin">int32</span>    <span class="token comment">// number of locked m's waiting for work</span>    mnext        <span class="token builtin">int64</span>    <span class="token comment">// number of m's that have been created and next M ID</span>    <span class="token comment">// 最多只能创建maxmcount个工作线程</span>    maxmcount    <span class="token builtin">int32</span>    <span class="token comment">// maximum number of m's allowed (or die)</span>    nmsys        <span class="token builtin">int32</span>    <span class="token comment">// number of system m's not counted for deadlock</span>    nmfreed      <span class="token builtin">int64</span>    <span class="token comment">// cumulative number of freed m's</span>    ngsys <span class="token builtin">uint32</span> <span class="token comment">// number of system goroutines; updated atomically</span>    <span class="token comment">// 由空闲的p结构体对象组成的链表</span>    pidle      puintptr <span class="token comment">// idle p's</span>    <span class="token comment">// 空闲的p结构体对象的数量</span>    npidle     <span class="token builtin">uint32</span>    nmspinning <span class="token builtin">uint32</span> <span class="token comment">// See "Worker thread parking/unparking" comment in proc.go.</span>    <span class="token comment">// Global runnable queue.</span>    <span class="token comment">// goroutine全局运行队列</span>    runq     gQueue    runqsize <span class="token builtin">int32</span>    <span class="token operator">...</span><span class="token operator">...</span>    <span class="token comment">// Global cache of dead G's.</span>    <span class="token comment">// gFree是所有已经退出的goroutine对应的g结构体对象组成的链表</span>    <span class="token comment">// 用于缓存g结构体对象，避免每次创建goroutine时都重新分配内存</span>    gFree <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>        lock          mutex        stack        gList <span class="token comment">// Gs with stacks</span>        noStack   gList <span class="token comment">// Gs without stacks</span>        n              <span class="token builtin">int32</span>    <span class="token punctuation">&#125;</span>     <span class="token operator">...</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h4 id="5、重要的全局变量">5、重要的全局变量</h4><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">allgs     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>g     <span class="token comment">// 保存所有的g</span>allm       <span class="token operator">*</span>m    <span class="token comment">// 所有的m构成的一个链表，包括下面的m0</span>allp       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>p    <span class="token comment">// 保存所有的p，len(allp) == gomaxprocs</span>ncpu             <span class="token builtin">int32</span>   <span class="token comment">// 系统中cpu核的数量，程序启动时由runtime代码初始化</span>gomaxprocs <span class="token builtin">int32</span>   <span class="token comment">// p的最大值，默认等于ncpu，但可以通过GOMAXPROCS修改</span>sched      schedt     <span class="token comment">// 调度器结构体对象，记录了调度器的工作状态</span>m0  m       <span class="token comment">// 代表进程的主线程</span>g0   g        <span class="token comment">// m0的g0，也就是m0.g0 = &amp;g0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>chan读写问题</title>
    <link href="/2021/02/15/Go%E8%BF%9B%E9%98%B6%20-%20chan%E8%AF%BB%E5%86%99%E9%97%AE%E9%A2%98/"/>
    <url>/2021/02/15/Go%E8%BF%9B%E9%98%B6%20-%20chan%E8%AF%BB%E5%86%99%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="1-chan读写问题">1.chan读写问题</h1><h2 id="01-对关闭chan读写">01.对关闭chan读写</h2><ul><li>golang面试题：对已经关闭的的chan进行读写，会怎么样？为什么？</li><li>读<strong>已经关闭</strong>的 <code>chan</code> 能一直读到东西，但是读到的内容根据通道内<code>关闭前</code>是否有元素而不同。<ul><li>1）读取有元素，且关闭的chan<ul><li>会正确读到 <code>chan</code> 内的值，且返回的第二个 bool 值（是否读成功）为 <code>true</code>。</li></ul></li><li>2）读取无元素，且关闭的chan<ul><li><code>chan</code> 内无值，接下来所有接收的值都会非阻塞直接成功</li><li>返回 <code>channel</code> 元素的<strong>零值</strong>，但是第二个 <code>bool</code> 值一直为 <code>false</code>。</li></ul></li></ul></li><li>3）写<strong>已经关闭</strong>的 <code>chan</code> 会 <code>panic</code></li></ul><h2 id="02-未初始化的的chan读写">02.未初始化的的chan读写</h2><ul><li>对未初始化的的chan进行读写，会怎么样？为什么？</li></ul><h3 id="2-1-对于写的情况">2.1 对于写的情况</h3><ul><li>未初始化的 <code>chan</code> 此时是等于 <code>nil</code>，当它不能阻塞的情况下，直接返回 <code>false</code>，表示写 <code>chan</code> 失败</li><li>当 <code>chan</code> 能阻塞的情况下，则直接阻塞 <code>gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2)</code></li><li>然后调用 <code>throw(s string)</code> 抛出错误，其中 <code>waitReasonChanSendNilChan</code> 就是刚刚提到的报错 <code>&quot;chan send (nil chan)&quot;</code></li></ul><h3 id="2-2-对于读的情况">2.2 对于读的情况</h3><ul><li>未初始化的 <code>chan</code> 此时是等于 <code>nil</code>，当它不能阻塞的情况下，直接返回 <code>false</code>，表示读 <code>chan</code> 失败</li><li>当 <code>chan</code> 能阻塞的情况下，则直接阻塞 <code>gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2)</code></li><li>然后调用 <code>throw(s string)</code> 抛出错误，其中 <code>waitReasonChanReceiveNilChan</code> 就是刚刚提到的报错 <code>&quot;chan receive (nil chan)&quot;</code></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>深浅拷贝</title>
    <link href="/2021/02/12/Go%E8%BF%9B%E9%98%B6%20-%20%E6%B7%B1%E6%B5%85%E6%8B%B7%E8%B4%9D/"/>
    <url>/2021/02/12/Go%E8%BF%9B%E9%98%B6%20-%20%E6%B7%B1%E6%B5%85%E6%8B%B7%E8%B4%9D/</url>
    
    <content type="html"><![CDATA[<h1 id="1-深浅拷贝">1.深浅拷贝</h1><h2 id="01-深浅拷贝">01.深浅拷贝</h2><h3 id="1-1-深浅拷贝定义">1.1 深浅拷贝定义</h3><ul><li>浅拷贝就是只拷贝指针的值，指针指向的内容只有一份。</li><li>而深拷贝是把指针指向的值拷贝一份。</li><li>golang里面也有浅拷贝和深拷贝。</li><li>slice的浅拷贝就是指slice变量的赋值操作。</li><li>slice的深拷贝就是指使用内置的copy函数来拷贝两个slice。</li></ul><h3 id="1-2-深浅拷贝代码举例">1.2 深浅拷贝代码举例</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">SliceShallowCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">SliceDeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">SliceShallowCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>src <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">&#125;</span>dst <span class="token operator">:=</span> srcfmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"浅拷贝原始数据"</span><span class="token punctuation">,</span>src<span class="token punctuation">)</span>   <span class="token comment">// [1 2 3 4 5 6]</span>dst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">10</span><span class="token comment">// 修改拷贝数据，原始数据会以前跟着改变</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"after modify[src]:"</span><span class="token punctuation">,</span>src<span class="token punctuation">)</span>  <span class="token comment">// [10 2 3 4 5 6]</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">SliceDeepCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>src <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> dst <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token function">copy</span><span class="token punctuation">(</span>dst<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"深拷贝前:"</span><span class="token punctuation">,</span>src<span class="token punctuation">)</span>   <span class="token comment">// [1 2 3 4 5 6]</span>dst<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">10</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"深拷贝修改拷贝数据值后:"</span><span class="token punctuation">,</span>src<span class="token punctuation">)</span>   <span class="token comment">// [1 2 3 4 5 6]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>垃圾回收</title>
    <link href="/2021/02/11/Go%E8%BF%9B%E9%98%B6%20-%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/"/>
    <url>/2021/02/11/Go%E8%BF%9B%E9%98%B6%20-%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="1-垃圾回收">1.垃圾回收</h1><h2 id="01-三种常见垃圾回收机制">01.三种常见垃圾回收机制</h2><h3 id="1-0-垃圾回收是什么">1.0 垃圾回收是什么</h3><ul><li>传统的系统级编程语言（主要指C/C++）中，程序员必须对内存小心的进行管理操作，控制内存的申请及释放。</li><li>稍有不慎，就可能产生内存泄露问题，这种问题不易发现并且难以定位</li><li>后来开发出来的几乎所有新语言（java，python，php等等）都引入了语言层面的自动内存管理</li><li>也就是语言的使用者只用关注内存的申请而不必关心内存的释放</li><li>内存释放由虚拟机（virtual machine）或运行时（runtime）来自动进行管理</li><li>而这种对不再使用的内存资源进行自动回收的行为就被称为垃圾回收。</li></ul><h3 id="1-1-引计数">1.1 引计数</h3><ul><li>原理<ul><li>当一个对象的引用被创建或者复制时，对象的引用计数加1；当一个对象的引用被销毁时，对象的引用计数减1.</li><li>当对象的引用计数减少为0时，就意味着对象已经再没有被使用了，可以将其内存释放掉。</li></ul></li><li>优点<ul><li>引用计数有一个很大的优点，即实时性，任何内存，一旦没有指向它的引用，就会被立即回收，而其他的垃圾收集技术必须在某种特殊条件下才能进行无效内存的回收。</li></ul></li><li>缺点<ul><li>引用计数机制所带来的维护引用计数的额外操作与Python运行中所进行的内存分配和释放，引用赋值的次数是成正比的，</li><li>显然比其它那些垃圾收集技术所带来的额外操作只是与待回收的内存数量有关的效率要低。</li><li>同时，因为对象之间相互引用，每个对象的引用都不会为0，所以这些对象所占用的内存始终都不会被释放掉。</li></ul></li></ul><h3 id="1-2-标记－清除">1.2 标记－清除</h3><ul><li>它分为两个阶段：第一阶段是标记阶段，GC会把所有的活动对象打上标记，第二阶段是把那些没有标记的对象非活动对象进行回收。</li><li>对象之间通过引用（指针）连在一起，构成一个有向图</li><li>从根对象（root object）出发，沿着有向边遍历对象，可达的（reachable）对象标记为活动对象，不可达的对象就是要被清除的非活动对象。</li><li>根对象就是全局变量、调用栈、寄存器。</li></ul><p><img src="/img/image-20210603162801815.fc6c7a54.png" alt="img"></p><ul><li>在上图中，可以从程序变量直接访问块1，并且可以间接访问块2和3,程序无法访问块4和5</li><li>第一步将标记块1，并记住块2和3以供稍后处理。</li><li>第二步将标记块2，第三步将标记块3，但不记得块2，因为它已被标记。</li><li>扫描阶段将忽略块1，2和3，因为它们已被标记，但会回收块4和5。</li></ul><h3 id="1-3-分代回收">1.3 分代回收</h3><ul><li>分代回收是建立在标记清除技术基础之上的，是一种以空间换时间的操作方式。</li><li>Python将内存分为了3“代”，分别为年轻代（第0代）、中年代（第1代）、老年代（第2代）</li><li>他们对应的是3个链表，它们的<strong>垃圾收集频率与对象的存活时间的增大而减小</strong>。</li><li>新创建的对象都会分配在年轻代，年轻代链表的总数达到上限时，Python垃圾收集机制就会被触发</li><li>把那些可以被回收的对象回收掉，而那些不会回收的对象就会被移到中年代去，依此类推</li><li>老年代中的对象是存活时间最久的对象，甚至是存活于整个系统的生命周期内。</li></ul><h2 id="02-Golang-三色标记法">02.Golang-三色标记法</h2><h3 id="2-1-三色标记法介绍">2.1 三色标记法介绍</h3><ul><li><p>三色标记法只是为了叙述方便而抽象出来的一种说法，实际上的对象是没有三色之分的。</p></li><li><p>这里的三色，对应了垃圾回收过程中对象的三种状态：</p></li><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">1）灰色（可能指向其他白色）<pre class="line-numbers language-none"><code class="language-none">  ：对象还在标记队列中等待  - 已被回收器访问到的对象，不会被回收  - 但回收器需要对其中的一个或多个指针进行扫描，因为他们可能还指向白色对象- &#96;&#96;&#96;  2）黑色（不指向其他白色）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>：对象已被标记，<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">gcmarkBits<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure> 对应位为 <figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure> -- 该对象不会在本次 GC 中被回收- 已被回收器访问到的对象，其中所有字段都已被扫描- 黑色对象中任何一个指针都不可能直接指向白色对象</code></pre></li><li><p><code>3）白色（要被清除的）</code>：对象未被标记，<code>gcmarkBits</code> 对应位为 <code>0</code> – 该对象将会在本次 GC 中被清理</p></li></ul><h3 id="2-2-具体流程如下图">2.2 具体流程如下图</h3><ul><li>就是标记内存中那些还在使用中（即被引用了）的部分</li><li>而内存中不再使用（即未被引用）的部分，就是要回收的垃圾，需要将其回收</li><li>上图中的 A、B、D 就是被引用正在使用的内存</li><li>而 C、F、E 曾经被使用过，但现在没有任何对象引用，就需要被回收掉。</li><li>而 Root 区域主要是程序运行到当前时刻的栈和全局数据区域，是实时正在使用到的内存，当然应该优先标记。</li><li>而考虑到内存块中存放的可能是指针，所以还需要递归的进行标记，待全部标记完后，就会对未被标记的内存进行回收。</li></ul><p><img src="/img/image-20210603171414358.015b0755.png" alt="img"></p><h3 id="2-3-STW弊端和优化">2.3 STW弊端和优化</h3><ul><li>STW弊端<ul><li>golang 的垃圾回收算法属于 <strong>标记-清除</strong>，是需要 STW 的</li><li>STW 就是 <strong>Stop The World</strong> 的意思，在 golang 中就是要停掉所有的 goroutine，专心进行垃圾回收，待垃圾回收结束后再恢复 goroutine</li><li>而 STW 时间的长短直接影响了应用的执行，如果时间过长，那将是灾难性的。</li><li>为了缩短 STW 时间，golang 不对优化垃圾回收算法</li><li>其中**写屏障（Write Barrier）<strong>和</strong>辅助 GC（Mutator Assist）**就是两种优化垃圾回收的方法</li></ul></li><li><strong><code>1）写屏障（Write Barrier）</code></strong><ul><li>而写屏障就是让 goroutine 与 GC 同时运行的手段，虽然不能完全消除 STW，但是可以大大减少 STW 的时间。</li><li>写屏障在 GC 的特定时间开启，开启后指针传递时会把指针标记，即本轮不回收，下次 GC 时再确定。</li></ul></li><li><strong><code>2）辅助 GC（Mutator Assist）</code></strong><ul><li>为了防止内存分配过快，在 GC 执行过程中</li><li>GC 过程中 mutator 线程会并发运行，而 mutator assist 机制会协助 GC 做一部分的工作</li></ul></li></ul><h3 id="2-4-写屏障">2.4 写屏障</h3><h4 id="1、STW解决的问题">1、STW解决的问题</h4><ul><li><code>标记过程需的要STW</code>，因为对象引用关系如果在标记阶段做了修改，<code>会影响标记结果的正确性</code>。</li><li>例如下图（假设没有STW）<ul><li>1）灰色对象B引用白色对象C（此时C尚未被扫描）</li><li>2）当遍历完A对象后，A变成黑色<ul><li>如果有其他程序断开了B对C的引用</li><li>同时添加了A对C的引用（由于A是黑色，所以C会一直是白色，被回收）</li></ul></li></ul></li></ul><p><img src="/img/image-20220401211153112.d1d09a94.png" alt="img"></p><h4 id="2、屏障技术">2、屏障技术</h4><ul><li><code>1）强三色不变式</code>：强三色不变式很好理解，强制性的不允许黑色对象引用白色对象即可<ul><li><code>插入屏障</code>：插入屏障拦截将白色指针插入黑色对象的操作，标记其对应对象为灰色状态</li></ul></li><li><code>2）弱三色不变式</code>：所有被黑色对象引用的白色对象都处于灰色保护状态<ul><li><code>删除屏障</code>：也是拦截写操作的，但是是通过保护灰色对象到白色对象的路径不会断来实现的</li><li>被灰色引用的对象，被删除了最后一个指向它的指针，也依旧可以活过这一轮，在下一轮GC中被清理掉</li></ul></li></ul><h4 id="3、混合写屏障">3、混合写屏障</h4><ul><li><p><code>插入屏障 优缺点</code></p><ul><li>插入写屏障在标记开始时无需STW，可直接开始，并发进行</li><li>但结束时需要STW来重新扫描栈，标记栈上引用的白色对象的存活</li></ul></li><li><p><code>删除屏障 优缺点</code></p><ul><li>删除写屏障则需要在GC开始时STW扫描堆栈来记录初始快照</li><li>这个过程会保护开始时刻的所有存活对象，但结束时无需STW</li></ul></li><li><p><code>Go1.8版本引入的混合写屏障</code></p><ul><li>同样允许黑色对象引用白色对象，白色对象处于灰色保护状态，但是<code>只由堆上的灰色对象保护</code>。</li><li>只需要在开始时并发扫描各个goroutine的栈，使其变黑并一直保持，这个过程不需要STW</li><li>而标记结束后，因为栈在扫描后始终是黑色的，也无需再进行re-scan操作了，减少了STW的时间。</li></ul></li><li><p><code>混合写屏障两种情况</code></p><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">灰色对象B在堆上<pre class="line-numbers language-none"><code class="language-none">  - 一个堆上的灰色对象B，引用白色对象C，在GC并发运行的过程中  - 如果栈已扫描置黑，而赋值器&#96;将指向C的唯一指针从B中删除&#96;，&#96;并让栈上其他对象引用它&#96;  - 这时，写屏障会在删除指向白色对象C的指针的时候&#96;就将C对象置灰&#96;，就可以保护下来了- &#96;&#96;&#96;  灰色对象B在栈上<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>- 灰色对象B在栈上，引用堆上的白色对象C，将其引用关系删除，且新增一个黑色对象到对象C的引用- 那么就需要通过shade(ptr)来保护了，在指针插入黑色对象时会触发对对象C的置灰操作。- 如果栈已经被扫描过了，那么栈上引用的对象都是灰色或受灰色保护的白色对象了，所以就没有必要再进行这步操作。</code></pre></li></ul></li></ul><h3 id="2-5-垃圾回收触发机制">2.5 垃圾回收触发机制</h3><ul><li>1、内存分配量达到阈值<ul><li>每次内存分配都会检查当前内存分配量是否达到阈值，如果达到阈值则触发 GC。</li><li><code>阈值 = 上次 GC 内存分配量 * 内存增长率</code></li><li>内存增长率由环境变量 <code>GOGC</code> 控制，默认为 100，即每当内存扩大一倍时启动 GC。</li></ul></li><li>2、定时触发 GC<ul><li>默认情况下，2 分钟触发一次 GC，该间隔由 <code>src/runtime/proc.go</code> 中的 <code>forcegcperiod</code> 声明。</li></ul></li><li>3、手动触发 GC<ul><li>在代码中，可通过使用 <code>runtime.GC()</code> 手动触发 GC。</li></ul></li></ul><h3 id="2-6-GC-优化建议">2.6 GC 优化建议</h3><ul><li>由上文可知，GC 性能是与对象数量有关的，对象越多 GC 性能越差，对程序的影响也越大。</li><li>所以在开发中要尽量减少对象分配个数，采用对象复用、将小对象组合成大对象或采用小数据类型（如使用 <code>int8</code> 代替 <code>int</code>）等。</li></ul><h3 id="2-7-结语">2.7 结语</h3><ul><li>一门编程语言的垃圾回收机制会直接影响使用其开发应用的性能。</li><li>在日常开发工作中也因注意到其作用，有助于开发出高性能的应用，这也是 GC 常常在面试中被问到的原因。</li><li>同时，了解 GC 对了解内存管理也很有帮助。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内存泄露</title>
    <link href="/2021/02/10/Go%E8%BF%9B%E9%98%B6%20-%20%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/"/>
    <url>/2021/02/10/Go%E8%BF%9B%E9%98%B6%20-%20%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/</url>
    
    <content type="html"><![CDATA[<h1 id="1-内存泄漏">1.内存泄漏</h1><h2 id="01-内存泄漏概念">01.内存泄漏概念</h2><h3 id="1-1-内存泄漏定义">1.1 内存泄漏定义</h3><ul><li>定义：由于疏忽或错误造成程序未能释放已经不再使用的内存。</li></ul><h3 id="1-2-go内存泄漏两种情况">1.2 go内存泄漏两种情况</h3><ul><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">情况1：僵尸进程<pre class="line-numbers language-none"><code class="language-none">  - 有goroutine泄漏，goroutine“飞”了，zombie goroutine没有结束  - 这个时候在这个goroutine上分配的内存对象将一直被这个僵尸goroutine引用着  - 进而导致gc无法回收这类对象，内存泄漏- &#96;&#96;&#96;  情况2：全局数据结构挂住了本该释放的对象<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>- 有一些全局（或者生命周期和程序本身运行周期一样长的）的数据结构意外的挂住了本该释放的对象- 虽然goroutine已经退出了，但是这些对象并没有从这类数据结构中删除，导致对象一直被引用，无法被回收。</code></pre></li></ul><h2 id="02-内存泄漏排查">02.内存泄漏排查</h2><h3 id="2-1-排除掉goroutine泄漏">2.1 排除掉goroutine泄漏</h3><ul><li>首先，我利用压测工具对server进行100个websocket连接，模拟用户浏览行为，然后关闭连接。</li><li>打开浏览器查看goroutine数量，发现新起的goroutine全部已经销毁，没有观察到有泄漏的goroutine，因此排除此情况。</li></ul><h3 id="2-2-确定是全局变量无回收">2.2 确定是全局变量无回收</h3><ul><li>再次用压测工具进行压测然后关闭，使用观察内存情况。</li><li>使用<code>go tool pprof -inuse_space http://127.0.0.1:9999/debug/pprof/heap</code></li><li>输入<code>png</code>导出（在这种情况下，需要等程序gc完再导出，建议等10分钟左右）</li><li><strong>发现问题所在</strong><ul><li>每次都会遗留这么大概0.5M的内存空间出来</li><li>就奇怪，明明整个goroutine退出为什么还有会内存占用?相应的全局变量也会删除该地方的引用。</li><li>等一下，全局变量，难道是删除的时候没做好配对导致没有真正删除该引用吗？</li><li>去查了下代码，果然是没有<strong>删除引用导致</strong>的，至此问题解决。</li></ul></li></ul><p><img src="/img/image-20210604100636742.9939c323.png" alt="img"></p><ul><li>这里面有个项目的坑，上报日志的key不是根据这个<code>len(map)</code>计算出，导致上报日志的时候以为删除了该key。</li></ul><h2 id="03-goroutine-泄露的场景">03.goroutine 泄露的场景</h2><ul><li>goroutine泄露一般是因为channel操作阻塞而导致整个routine一直阻塞等待或者 goroutine 里有死循环的时候</li><li>可以细分为下面五种情况</li></ul><h3 id="3-1-情况1：从channel里读但没有写">3.1 情况1：从channel里读但没有写</h3><ul><li>leak 是一个有 bug 程序。它启动了一个 goroutine 阻塞接收 channel。</li><li>当 Goroutine 正在等待时，leak 函数会结束返回。</li><li>此时，程序的其他任何部分都不能通过 channel 发送数据，那个 channel 永远不会关闭</li><li>fmt.Println 调用永远不会发生， 那个 goroutine 会被永远锁死</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">leak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>     ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>     <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        val <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"We received a value:"</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-情况2：向已满的-buffered-channel-写，但是没有读">3.2 情况2：向已满的 buffered channel 写，但是没有读</h3><h3 id="3-3-情况3：-select操作在所有case上阻塞">3.3 情况3： select操作在所有case上阻塞</h3><ul><li>实现一个 fibonacci 数列生成器，并在独立的 goroutine 中运行</li><li>在读取完需要长度的数列后，如果 用于 退出生成器的 quit 忘了被 close (或写入数据)</li><li>select 将一直被阻塞造成 该 goroutine 泄露。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> quit <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>x<span class="token punctuation">,</span> y <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token keyword">for</span><span class="token punctuation">&#123;</span><span class="token keyword">select</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> c <span class="token operator">&lt;-</span> x<span class="token punctuation">:</span>x<span class="token punctuation">,</span> y <span class="token operator">=</span> y<span class="token punctuation">,</span> x<span class="token operator">+</span>y<span class="token keyword">case</span> <span class="token operator">&lt;-</span>quit<span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"quit"</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token keyword">go</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> quit<span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span> c<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// close(quit)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-4-goroutine进入死循环">3.4 goroutine进入死循环</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 粗暴的示例</span><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">for</span><span class="token punctuation">&#123;</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"fooo"</span><span class="token punctuation">)</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>内存逃逸</title>
    <link href="/2021/02/09/Go%E8%BF%9B%E9%98%B6%20-%20%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/"/>
    <url>/2021/02/09/Go%E8%BF%9B%E9%98%B6%20-%20%E5%86%85%E5%AD%98%E9%80%83%E9%80%B8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-内存逃逸">1.内存逃逸</h1><h2 id="01-内存逃逸">01.内存逃逸</h2><h3 id="1-1-其他语言内存回收机制">1.1 其他语言内存回收机制</h3><ul><li>在C/C++开发中，动态分配内存(new/malloc)需要我们手动释放资源。</li><li>这样做的好处是，需要申请多少内存空间可以很好的掌握怎么分配。</li><li>但是这有个缺点，如果忘记释放内存，则会导致内存泄漏。</li><li>在很多高级语言中(python/Go/java)都加上了垃圾回收机制。</li></ul><h3 id="1-2-什么是内存逃逸">1.2 什么是内存逃逸</h3><ul><li>函数内部申请的临时变量，正常会分配到栈里，栈中的内存分配非常快，自动回收，无需垃圾回收</li><li>但是若果申请的临时变量作为了函数返回值，编译器会认为在退出函数之后还有其他地方在引用</li><li>在编译的时候就会将变量存储到堆中，堆中的数据不会自动回收，必须使用垃圾回收机制清楚</li><li><code>我们将这种 由于某些原因，数据没有分配到栈中而是分配到堆中的现象叫做 内存逃逸</code></li></ul><h3 id="1-2-golang的内存分配之堆和栈">1.2 golang的内存分配之堆和栈</h3><h4 id="1-2-1-内存分片概述">1.2.1 内存分片概述</h4><ul><li>Go的垃圾回收，让堆和栈堆程序员保持透明。</li><li>真正解放了程序员的双手，让他们可以专注于业务，“高效”地完成代码编写。</li><li>把那些内存管理的复杂机制交给编译器。</li><li>栈 可以简单得理解成一次函数调用内部申请到的内存，它们会随着函数的返回把内存还给系统。</li></ul><h4 id="1-2-2-分配到栈里">1.2.2 分配到栈里</h4><ul><li>下面的例子，函数内部申请的临时变量，即使你是用make申请到的内存</li><li>如果发现在退出函数后没有用了，那么就把丢到栈上，毕竟栈上的内存分配比堆上快很多</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>temp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h4 id="1-2-3-分配到堆里">1.2.3 分配到堆里</h4><ul><li>申请的代码和上面的一模一样，但是申请后作为返回值返回了</li><li>编译器会认为在退出函数之后还有其他地方在引用，当函数返回之后并不会将其内存归还</li><li>那么就申请到堆里。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">F</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>temp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token operator">...</span><span class="token keyword">return</span> temp<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-分配到栈里和堆里区别">1.3 分配到栈里和堆里区别</h3><ul><li>分片到堆的坏处<ul><li>如果变量都分配到堆上，堆不像栈可以自动清理。</li><li>它会引起Go频繁地进行垃圾回收，而垃圾回收会占用比较大的系统开销。</li></ul></li><li>放到堆还是栈的情况<ul><li>堆适合不可预知的大小的内存分配。</li><li>但是为此付出的代价是分配速度较慢，而且会形成内存碎片。</li><li>栈内存分配则会非常快，栈分配内存只需要两个CPU指令：“PUSH”和“RELEASE”分配和释放；</li><li>而堆分配内存首先需要去找到一块大小合适的内存块。之后要通过垃圾回收才能释放。</li></ul></li></ul><h2 id="02-逃逸的几种情况">02.逃逸的几种情况</h2><h3 id="2-0-逃逸分析">2.0 逃逸分析</h3><ul><li>逃逸分析是分析在程序的哪些地方可以访问到该指针。</li><li>简单来说，<code>编译器会根据变量是否被外部引用来决定是否逃逸</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token number">1</span>、如果函数外部没有引用，则优先放到栈中；<span class="token number">2</span>、如果函数外部存在引用，则必定放到堆中；<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><ul><li>对此你可以理解为，逃逸分析是编译器用于决定变量分配到堆上还是栈上的一种行为。</li><li>注意：go 在编译阶段确立逃逸，并不是在运行时。</li></ul><h3 id="2-1-指针逃逸">2.1 指针逃逸</h3><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">方法内把局部变量指针返回<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>提问：函数传递指针真的比传值效率高吗？</li><li>我们知道传递指针可以减少底层值的拷贝，可以提高效率</li><li>但是如果拷贝的数据量小，由于指针传递会产生逃逸，逃逸可能存储到堆中</li><li>存储到堆可能会增加GC的负担，所以传递指针不一定是高效的。</li></ul><p><img src="/img/image-20210603140737458.e54d323b.png" alt="img"></p><h3 id="2-2-栈空间不足逃逸">2.2 栈空间不足逃逸</h3><ul><li>当我们创建一个切片长度为10000时就会逃逸。</li><li>实际上当栈空间不足以存放当前对象时或无法判断当前切片长度时会将对象分配到堆中。</li><li><strong>slice 的背后数组被重新分配了，因为 append 时可能会超出其容量( cap )。</strong></li><li>slice 初始化的地方在编译时是可以知道的，它最开始会在栈上分配。</li><li>如果切片背后的存储要基于运行时的数据进行扩充，就会在堆上分配。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> build <span class="token operator">-</span>gcflags<span class="token operator">=</span><span class="token operator">-</span>m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210603134806118.f6be98fa.png" alt="img"></p><h3 id="2-3-动态类型逃逸">2.3 动态类型逃逸</h3><ul><li>很多函数参数为interface类型，比如 Println函数</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-c" data-language="c"><code class="language-c">func <span class="token function">Println</span><span class="token punctuation">(</span>a <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>interface<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token keyword">int</span><span class="token punctuation">,</span> err error<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>编译期间很难确定其参数的具体类型，也能产生逃逸。</li></ul><p><img src="/img/image-20210603135441980.8b7142a9.png" alt="img"></p><h2 id="03-如何避免">03.如何避免</h2><ul><li>1、不要盲目使用变量指针作为参数，虽然减少了复制，但变量逃逸的开销更大。</li><li>2、预先设定好slice长度，避免频繁超出容量，重新分配。</li><li>3、如果对于性能要求比较高且访问频次比较高的函数调用，应该尽量避免使用接口类型<ul><li>在 interface 类型上调用方法都是动态调度的 —— 方法的真正实现只能在运行时知道</li></ul></li></ul><h2 id="04-逃逸分析作用">04.逃逸分析作用</h2><h3 id="4-1-逃逸分析作用">4.1 逃逸分析作用</h3><ul><li>1、逃逸分析的好处是为了减少gc的压力，不逃逸的对象分配在栈上，当函数返回时就回收了资源，不需要gc标记清除。</li><li>2、逃逸分析完后可以确定哪些变量可以分配在栈上，栈的分配比堆快，性能好</li><li>3、同步消除，如果你定义的对象的方法上有同步锁，但在运行时，却只有一个线程在访问，此时逃逸分析后的机器码，会去掉同步锁运行。</li></ul><h3 id="4-2-总结">4.2 总结</h3><ul><li>1、堆上动态分配内存比栈上静态分配内存，开销大很多。</li><li>2、变量分配在栈上需要能在编译期确定它的作用域，否则会分配到堆上。</li><li>3、Go编译器会在编译期对考察变量的作用域，并作一系列检查<ul><li>如果它的作用域在运行期间对编译器一直是可知的，那么就会分配到栈上。</li><li>简单来说，编译器会根据变量是否被外部引用来决定是否逃逸。</li></ul></li><li>4、不要盲目使用变量的指针作为函数参数，虽然它会减少复制操作。<ul><li>但其实当参数为变量自身的时候，复制是在栈上完成的操作</li><li>开销远比变量逃逸后动态地在堆上分配内存少的多。</li></ul></li><li>5、逃逸分析在编译阶段完成的。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>make和new</title>
    <link href="/2021/02/08/Go%E8%BF%9B%E9%98%B6%20-%20make%E5%92%8Cnew/"/>
    <url>/2021/02/08/Go%E8%BF%9B%E9%98%B6%20-%20make%E5%92%8Cnew/</url>
    
    <content type="html"><![CDATA[<h1 id="1-make和new">1.make和new</h1><h2 id="01-make和new">01.make和new</h2><h3 id="1-1-make和new比较">1.1 make和new比较</h3><ul><li>new 和 make 是两个内置函数，主要用来创建并分配类型的内存。</li><li>make和new区别<ul><li><code>make</code> 关键字的作用是创建于 slice、map 和 channel 等内置的数据结构</li><li><code>new</code> 的作用是为类型申请一片内存空间，并返回指向这片内存的指针</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>       <span class="token comment">// 切片长度为 1，预留空间长度为 10</span>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v--%T \n"</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>a<span class="token punctuation">)</span>   <span class="token comment">// [0 0 0]--[]int   值----切片本身</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token comment">//b = b.append(b,2)          // 返回的是内存指针，所以不能直接 append</span><span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>        <span class="token comment">// 必须通过 * 指针取值，才能进行 append 添加</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v--%T"</span><span class="token punctuation">,</span>b<span class="token punctuation">,</span>b<span class="token punctuation">)</span>    <span class="token comment">// &amp;[]--*[]string  内存的指针---内存指针</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-new函数">1.2 new函数</h3><ul><li><code>一：系统默认的数据类型，分配空间</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 1.new实例化int</span>age <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token operator">*</span>age <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">// 2.new实例化切片</span>li <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token operator">*</span>li <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>li<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">// 3.实例化map</span>userinfo <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">*</span>userinfo <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"张三"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">)</span>    <span class="token comment">// &amp;map[username:张三]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>二：自定义类型使用 new 函数来分配空间</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s <span class="token operator">*</span>Students <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span>      <span class="token comment">//分配空间</span>s<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">"zhangsan"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        <span class="token comment">// &amp;&#123;zhangsan 0&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-make函数">1.3 make函数</h3><ul><li>make 也是用于内存分配的，但是和 new 不同，它只用于 chan、map 以及 slice 的内存创建</li><li>而且它返回的类型就是这三个类型本身，而不是他们的指针类型</li><li>因为这三种类型就是引用类型，所以就没有必要返回他们的指针了</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>       <span class="token comment">// 切片长度为 1，预留空间长度为 10</span>b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>          <span class="token comment">// [0 0 0]  map[]  0xc0000180e0</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>当我们为slice分配内存的时候，应当尽量预估到slice可能的最大长度</li><li>通过给make传第三个参数的方式来给slice预留好内存空间</li><li>这样可以避免二次分配内存带来的开销，大大提高程序的性能。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pointer</title>
    <link href="/2021/02/07/Go%E8%BF%9B%E9%98%B6%20-%20pointer/"/>
    <url>/2021/02/07/Go%E8%BF%9B%E9%98%B6%20-%20pointer/</url>
    
    <content type="html"><![CDATA[<h1 id="01-pointer">01.pointer</h1><h2 id="01-pointer-2">01.pointer</h2><h3 id="1-1-什么是pointer">1.1 什么是pointer</h3><ul><li>在Go里面pointer就是1种可以<code>把内存地址存储起来的数据类型</code>。</li><li>我们使用pointer数据类型的变量可以记录下另1个变量的内存地址，方便我们修改这变量的值。</li><li>只需要记住以下几点：<ul><li><code>&amp;变量名</code>： 获取变量的内存地址</li><li><code>*pointor</code>：通过指针类型的变量，获取该指针指向的值</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>name <span class="token operator">:=</span> <span class="token string">"张三"</span>p1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>name        <span class="token comment">// &amp;变量名： 获取变量的内存地址</span>p2 <span class="token operator">:=</span> <span class="token operator">*</span><span class="token operator">&amp;</span>name        <span class="token comment">// *pointor：通过指针类型的变量，获取该指针指向的值</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">)</span><span class="token comment">// 张三 0xc000088230 张三</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210602162823100.be0346a7.png" alt="img"></p><h3 id="1-2-为什么Go中使用了指针？">1.2 为什么Go中使用了指针？</h3><ul><li><p>因为指针可以帮助我们节省内存，我们知道在程序运行时值类型的变量被赋值之后会对值进行重新拷贝</p></li><li><p>如果我们每次拷贝的是1个指针类型的变量呢？</p></li><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">值类型变量:在函数中传递无法修改变量的值</code></pre></div></figure><ul><li>还有Go函数里面传递的参数都是副本也就是重新copy一份，我们如何在函数中修该1个外部变量。</li><li>我们可以通过记录下值类型变量的内存地址，来达到修改值类型变量的目的。</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>interface</title>
    <link href="/2021/02/05/Go%E8%BF%9B%E9%98%B6%20-%20interface/"/>
    <url>/2021/02/05/Go%E8%BF%9B%E9%98%B6%20-%20interface/</url>
    
    <content type="html"><![CDATA[<h1 id="1-interface">1.interface</h1><h2 id="01-interface">01.interface</h2><h3 id="1-1-interface作用">1.1 interface作用</h3><ul><li><p>接口是 Go 语言的重要组成部分，它在 Go 语言中通过一组方法指定了一个对象的行为</p></li><li><p>接口 interface 的引入能够让我们在 Go 语言更好地组织并写出易于测试的代码</p></li><li><p>golang中的接口分为</p><figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">带方法的接口和空接口<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>iface：表示带方法的接口</li><li>eface：表示空接口</li></ul></li></ul><h3 id="1-2-eface空接口">1.2 eface空接口</h3><ul><li>空接口eface结构比较简单，由两个属性构成</li><li>一个是<code>类型信息_type</code>，一个是<code>数据信息</code></li><li>其数据结构声明如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> eface <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  _type <span class="token operator">*</span>_type  data  unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210602153422706.ccbddf01.png" alt="img"></p><ul><li>其中_type是GO语言中所有类型的公共描述，Go语言几乎所有的数据结构都可以抽象成 _type，是所有类型的公共描述</li><li><strong>type负责决定data应该如何解释和操作</strong></li><li>type的结构代码如下:</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> _type <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  size       <span class="token builtin">uintptr</span>   ptrdata    <span class="token builtin">uintptr</span>    <span class="token comment">// size of memory prefix holding all pointers</span>  hash       <span class="token builtin">uint32</span>     <span class="token comment">// 类型哈希</span>  tflag      tflag  align      <span class="token builtin">uint8</span>      <span class="token comment">// _type作为整体变量存放时的对齐字节数</span>  fieldalign <span class="token builtin">uint8</span>  kind       <span class="token builtin">uint8</span>  alg        <span class="token operator">*</span>typeAlg  <span class="token comment">// gcdata stores the GC type data for the garbage collector.</span>  <span class="token comment">// If the KindGCProg bit is set in kind, gcdata is a GC program.</span>  <span class="token comment">// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.</span>  gcdata    <span class="token operator">*</span><span class="token builtin">byte</span>  str       nameOff  ptrToThis typeOff  <span class="token comment">// type for pointer to this type, may be zero</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>data表示指向具体的实例数据，由于Go的参数传递规则为值传递</li><li>如果希望可以通过interface对实例数据修改，则需要传入指针</li><li>此时data指向的是指针的副本，但指针指向的实例地址不变，仍然可以对实例数据产生修改。</li></ul><h3 id="1-3-iface带方法的接口">1.3 iface带方法的接口</h3><ul><li>iface 表示带方法的数据结构，非空接口初始化的过程就是初始化一个iface类型的结构</li><li>其中data的作用同eface的相同，这里不再多加描述。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> iface <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  tab  <span class="token operator">*</span>itab  data unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210602155153963.8ea13138.png" alt="img"></p><ul><li>iface结构中最重要的是itab结构（结构如下），每一个 <code>itab</code> 都占 32 字节的空间</li><li>itab可以理解为pair&lt;interface type, concrete type&gt;</li><li>itab里面包含了interface的一些关键信息，比如method的具体实现</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> itab <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  inter  <span class="token operator">*</span>interfacetype      <span class="token comment">// 接口自身的元信息</span>  _type  <span class="token operator">*</span>_type           <span class="token comment">// 具体类型的元信息</span>  link   <span class="token operator">*</span>itab  bad    <span class="token builtin">int32</span>  hash   <span class="token builtin">int32</span>           <span class="token comment">// _type里也有一个同样的hash，此处多放一个是为了方便运行接口断言</span>  fun    <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span>        <span class="token comment">// 函数指针，指向具体类型所实现的方法</span><span class="token punctuation">&#125;</span><span class="token comment">// interface type包含了一些关于interface本身的信息，比如package path，包含的method</span><span class="token keyword">type</span> interfacetype <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  typ     _type  pkgpath name  mhdr    <span class="token punctuation">[</span><span class="token punctuation">]</span>imethod<span class="token punctuation">&#125;</span><span class="token keyword">type</span> imethod <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>      <span class="token comment">//这里的 method 只是一种函数声明的抽象，比如  func Print() error</span>  name nameOff  ityp typeOff<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-4-interface设计的优缺点">1.4 interface设计的优缺点</h3><ul><li>优点，非侵入式设计，写起来更自由，无需显式实现，只要实现了与 interface 所包含的所有函数签名相同的方法即可。</li><li>缺点，duck-typing风格并不关注接口的规则和含义，也没法检查，不确定某个struct具体实现了哪些interface。</li><li>只能通过goru工具查看。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Channel</title>
    <link href="/2021/01/30/Go%E8%BF%9B%E9%98%B6%20-%20Channel/"/>
    <url>/2021/01/30/Go%E8%BF%9B%E9%98%B6%20-%20Channel/</url>
    
    <content type="html"><![CDATA[<h1 id="1-channel">1.channel</h1><h2 id="01-channel的整体结构图">01.channel的整体结构图</h2><h3 id="1-1-channel结构图">1.1 channel结构图</h3><ul><li>channel本质是一个<code>hchan</code>这个结构体</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// points to an array of dataqsiz elements</span>    sendx    <span class="token builtin">uint</span>   <span class="token comment">// send index</span>    recvx    <span class="token builtin">uint</span>   <span class="token comment">// receive index</span>    recvq    waitq  <span class="token comment">// list of recv waiters</span>    sendq    waitq  <span class="token comment">// list of send waiters</span>    lock mutex<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><p>简单说明：</p><ul><li><p><code>buf</code>是有缓冲的channel所特有的结构，用来存储缓存数据，<code>是个循环链表</code></p></li><li><figure><div class="code-wrapper"><pre class="language-none"><code class="language-none">sendx<pre class="line-numbers language-none"><code class="language-none">和<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>recvx<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">用于记录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure>buf<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">  这个循环链表中的~发送或者接收的~index  - &#96;recvx&#96;和&#96;sendx&#96;是根据循环链表&#96;buf&#96;的变动而改变的- &#96;lock&#96;是个互斥锁，发送或接收前都需要加锁- &#96;&#96;&#96;  recvq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>和<figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">sendq<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure> —&gt; <figure><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">是个双向链表<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>- 分别是接收或者发送的goroutine抽象出来的结构体(sudog)的队列</code></pre></li></ul></li></ul><p><img src="/img/image-20210602090848795.72979bb7.png" alt="img"></p><h3 id="1-2-创建channel">1.2 创建channel</h3><ul><li>创建channel实际上就是在内存中实例化了一个<code>hchan</code>的结构体，并返回一个ch指针</li><li>我们使用过程中channel在函数之间的传递都是用的这个指针</li><li>这就是为什么函数传递中无需使用channel的指针，而直接用channel就行了，因为channel本身就是一个指针</li></ul><h3 id="1-3-channel中队列如何实现">1.3 channel中队列如何实现</h3><ul><li>channel中有个缓存buf，是用来缓存数据的(假如实例化了带缓存的channel的话)队列。</li><li>当使用<code>send (ch &lt;- xx)</code>或者<code>recv ( &lt;-ch)</code>的时候，首先要锁住<code>hchan</code>这个结构体</li><li>然后开始<code>send (ch &lt;- xx)</code>数据，这时候满了，队列塞不进去了</li><li>然后是取<code>recv ( &lt;-ch)</code>的过程，是个逆向的操作，也是需要加锁</li></ul><p><img src="/img/mebkj3h2za.b21725dd.gif" alt="img"></p><h3 id="1-4-channel缓存满发生什么">1.4 channel缓存满发生什么</h3><ul><li>使用的时候，我们都知道，当channel缓存满了，或者没有缓存的时候</li><li>我们继续send(ch &lt;- xxx)或者recv(&lt;- ch)会阻塞当前goroutine，但是，是如何实现的呢？</li><li>Go的goroutine是用户态的线程(<code>user-space threads</code>)，用户态的线程是需要自己去调度的</li><li>Go有运行时的scheduler去帮我们完成调度这件事情</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数组与切片</title>
    <link href="/2021/01/25/Go%E8%BF%9B%E9%98%B6%20-%20%E6%95%B0%E7%BB%84%E4%B8%8E%E5%88%87%E7%89%87/"/>
    <url>/2021/01/25/Go%E8%BF%9B%E9%98%B6%20-%20%E6%95%B0%E7%BB%84%E4%B8%8E%E5%88%87%E7%89%87/</url>
    
    <content type="html"><![CDATA[<h1 id="1-数组与切片">1.数组与切片</h1><h2 id="01-数组">01.数组</h2><h3 id="1-1-数组">1.1 数组</h3><ul><li>数组是一种非常有用的数据结构，因为其占用的内存是连续分配的。</li><li>由于内存连续，CPU能把正在使用的数据缓存更久的时间。</li><li>而且内存连续很容易计算索引，可以快速迭代数组里的所有元素。</li><li>golang中声明数组需要告诉数组长度，以及存放数据类型</li><li>一旦初始化成功，那么存储的数据类型和数组长度就都不能改变了</li><li>xxxxxxxxxx package mainimport &quot;fmt&quot;​func main() {    SliceShallowCopy()    SliceDeepCopy()}​func SliceShallowCopy() {    src := []byte {1,2,3,4,5,6}    dst := src    fmt.Println(“浅拷贝原始数据”,src)   // [1 2 3 4 5 6]    dst[0]=10    // 修改拷贝数据，原始数据会以前跟着改变    fmt.Println(“after modify[src]:”,src)  // [10 2 3 4 5 6]}​func SliceDeepCopy() {    src := []byte {1,2,3,4,5,6}    var dst = make([]byte, len(src))    copy(dst[:], src)    fmt.Println(“深拷贝前:”,src)   // [1 2 3 4 5 6]    dst[0]=10    fmt.Println(“深拷贝修改拷贝数据值后:”,src)   // [1 2 3 4 5 6]}go</li></ul><h3 id="1-2-引用类型">1.2 引用类型</h3><ul><li>golang 的引用类型包括 slice、map、channel、function、pointer 等.</li><li>它们在进行赋值时拷贝的是指针值，但拷贝后指针指向的地址是相同的.</li></ul><h2 id="02-切片的内部实现">02.切片的内部实现</h2><ul><li>切片是一种数据结构，这种数据结构便于使用和管理数据集合。</li><li>切片是围绕动态数组的概念构建的，可以按需自动增长和缩小。</li><li>切片的动态增长是通过内置函数 append 来实现的，这个函数可以快速且高效地增长切片。</li><li>还可以通过对切片再次切片来缩小一个切片的大小。</li><li>因为切片的底层内存也是在连续块中分配的，所以切片还能获得索引、迭代以及为垃圾回收优化的好处。</li></ul><p><img src="/img/image-20210601155555698.78a455d2.png" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Map</title>
    <link href="/2021/01/23/Go%E8%BF%9B%E9%98%B6%20-%20Map/"/>
    <url>/2021/01/23/Go%E8%BF%9B%E9%98%B6%20-%20Map/</url>
    
    <content type="html"><![CDATA[<h1 id="01-Map">01.Map</h1><h2 id="01-map底层">01.map底层</h2><ul><li>[参考(opens new window)](<a href="https://www.bookstack.cn/read/qcrao-Go-Questions/map-map">https://www.bookstack.cn/read/qcrao-Go-Questions/map-map</a> <a href="http://xn--icts4hw6bpzfl2cqt6afa433ez06c.md">的扩容过程是怎样的.md</a>)</li></ul><h3 id="1-1-map底层浅析">1.1 map底层浅析</h3><ul><li>笼统的来说，go的map底层是一个hash表，通过键值对进行映射</li><li>键通过哈希函数生成哈希值，然后go底层的map数据结构就存储相应的hash值，进行索引，最终是在底层使用的数组存储key,和value</li><li>稍微详细的说，就设计到go map 的结构：<code>hmap 和bmap</code></li></ul><h3 id="1-2-Hash函数">1.2 Hash函数</h3><ul><li><p>哈希函数会将传入的key值进行哈希运算，得到一个唯一的值。</p></li><li><p>go语言把生成的哈希值一分为二，比如一个key经过哈希函数，生成的哈希值为：<code>8423452987653321</code>，go语言会这它拆分为<code>84234529</code>，和<code>87653321</code>。</p></li><li><p>那么，前半部分就叫做</p><p>高位哈希值</p><p>，后半部分就叫做</p><p>低位哈希值</p><p>。</p><ul><li>**高位哈希值：**是用来确定当前的bucket（桶）有没有所存储的数据的。</li><li>**低位哈希值：**是用来确定，当前的数据存在了哪个bucket（桶）</li></ul></li></ul><h2 id="02-map源码">02.map源码</h2><h3 id="2-1-hmap-a-header-of-map">2.1 hmap(a header of map)</h3><ul><li>hmap是map的最外层的一个数据结构，包括了map的各种基础信息、如大小、bucket。</li><li>首先说一下，buckets这个参数，它存储的是指向buckets数组的一个指针，当bucket(桶为0时)为nil。</li><li><strong>我们可以理解为，hmap指向了一个空bucket数组</strong>，并且当bucket数组需要扩容时，它会开辟一倍的内存空间</li><li>并且会渐进式的把原数组拷贝，即用到旧数组的时候就拷贝到新数组。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Go map的一个header结构</span><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    count     <span class="token builtin">int</span>    <span class="token comment">// map的大小.  len()函数就取的这个值</span>    flags     <span class="token builtin">uint8</span>    <span class="token comment">//map状态标识</span>    B         <span class="token builtin">uint8</span>    <span class="token comment">// 可以最多容纳 6.5 * 2 ^ B 个元素，6.5为装载因子即:map长度=6.5*2^B</span>                    <span class="token comment">//B可以理解为buckets已扩容的次数</span>    noverflow <span class="token builtin">uint16</span>     <span class="token comment">// 溢出buckets的数量</span>    hash0     <span class="token builtin">uint32</span>     <span class="token comment">// hash 种子</span>    buckets    unsafe<span class="token punctuation">.</span>Pointer   <span class="token comment">//指向最大2^B个Buckets数组的指针. count==0时为nil.</span>    oldbuckets unsafe<span class="token punctuation">.</span>Pointer    <span class="token comment">//指向扩容之前的buckets数组，并且容量是现在一半.不增长就为nil</span>    nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">// 搬迁进度，小于nevacuate的已经搬迁</span>    extra <span class="token operator">*</span>mapextra           <span class="token comment">// 可选字段，额外信息</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-bmap-a-bucket-of-map">2.2 bmap(a bucket of map)</h3><ul><li>bucket（桶），每一个bucket最多放8个key和value，最后由一个overflow字段指向下一个bmap</li><li>注意key、value、overflow字段都不显示定义，而是通过maptype计算偏移获取的。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Go map 的 buckets结构</span><span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>    <span class="token comment">// 每个元素hash值的高8位，如果tophash[0] &lt; minTopHash，表示这个桶的搬迁状态</span>    tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>  <span class="token comment">// 第二个是8个key、8个value，但是我们不能直接看到；为了优化对齐，go采用了key放在一起，value放在一起的存储方式，</span>   <span class="token comment">// 第三个是溢出时，下一个溢出桶的地址</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><strong>bucket这三部分内容决定了它是怎么工作的</strong></li><li><code>第一部分：tophash</code><ul><li>它的tophash 存储的是哈希函数算出的哈希值的高八位是用来加快索引的。</li><li><strong>因为把高八位存储起来，这样不用完整比较key就能过滤掉不符合的key，加快查询速度</strong></li><li>当一个哈希值的高8位和存储的高8位相符合，再去比较完整的key值，进而取出value。</li></ul></li><li><code>第二部分：存储的是key 和value</code><ul><li>就是我们传入的key和value，注意，它的底层排列方式是，key全部放在一起，value全部放在一起。</li><li><strong>当key大于128字节时，bucket的key字段存储的会是指针，指向key的实际内容；value也是一样。</strong></li><li>这样排列好处是在key和value的长度不同的时候，可以消除padding带来的空间浪费。</li><li>并且每个bucket<strong>最多存放8个键值对</strong></li></ul></li><li><code>第三部分：存储的是当bucket溢出时，指向的下一个bucket的指针</code></li><li><strong>bucket的设计细节：</strong><ul><li>在golang map中出现冲突时，不是每一个key都申请一个结构通过链表串起来</li><li>**而是以bmap为最小粒度挂载，一个bmap可以放8个key和value。</li><li><strong>这样减少对象数量，减轻管理内存的负担，利于gc。</strong></li><li>如果插入时，bmap中key超过8，那么就会申请一个新的bmap（overflow bucket）挂在这个bmap的后面形成链表</li><li><strong>优先用预分配的overflow bucket，如果预分配的用完了，那么就malloc一个挂上去。</strong></li><li><strong>注意golang的map不会shrink，内存只会越用越多，overflow bucket中的key全删了也不会释放</strong></li></ul></li></ul><h3 id="2-3-map图解">2.3 map图解</h3><ul><li>hmap存储了一个指向底层bucket数组的指针。</li><li>我们存入的key和value是存储在bucket里面中，如果key和value大于128字节，那么bucket里面存储的是指向我们key和value的指针，如果不是则存储的是值。</li><li>每个bucket 存储8个key和value，如果超过就重新创建一个bucket挂在在元bucket上，持续挂接形成链表。</li><li>高位哈希值：是用来确定当前的bucket（桶）有没有所存储的数据的。</li><li>低位哈希值：是用来确定，当前的数据存在了哪个bucket（桶）</li></ul><p><img src="/img/image-20210601203653081.99c2168b.png" alt="img"></p><h3 id="2-4-查找流程">2.4 查找流程</h3><ul><li>查找或者操作map时，首先key经过hash函数生成hash值，<code>通过哈希值的低8位来判断当前数据属于哪个桶(bucket)</code></li><li>找到bucket以后，通过哈希值的高八位与bucket存储的高位哈希值循环比对</li><li>如果相同就比较刚才找到的底层数组的key值，如果key相同，取出value。</li><li>如果高八位hash值在此bucket没有，或者有，但是key不相同，就去链表中下一个溢出bucket中查找，直到查找到链表的末尾</li><li>碰撞冲突：<ul><li>如果不同的key定位到了统一bucket或者生成了同一hash,就产生冲突。</li><li>go是通过链表法来解决冲突的。</li><li>比如一个高八位的hash值和已经存入的hash值相同，并且此bucket存的8个键值对已经满了，或者后面已经挂了好几个bucket了。</li><li>那么这时候要存这个值就先比对key,key肯定不相同啊，那就从此位置一直沿着链表往后找，找到一个空位置，存入它。</li><li>所以这种情况，两个相同的hash值高8位是存在不同bucket中的。</li></ul></li></ul><p><img src="/img/image-20210601205847317.fc59c72d.png" alt="img"></p><h2 id="03-map增删改查原理">03.map增删改查原理</h2><h3 id="3-1-创建">3.1 创建</h3><ul><li>map的创建比较简单，在参数校验之后，需要找到合适的B来申请桶的内存空间</li><li>接着便是穿件hmap这个结构，以及对它的初始化。</li></ul><p><img src="/img/image-20210601210239851.ab5f6cb7.png" alt="img"></p><h3 id="3-2-访问-mapaccess">3.2 访问 - mapaccess</h3><p><img src="/img/image-20210601210400192.061fa1a3.png" alt="img"></p><h3 id="3-3-分配-mapassign">3.3 分配 - mapassign</h3><ul><li>为一个key分配空间的逻辑，大致与查找类似，但增加了写保护和扩容的操作；</li><li>注意，分配过程和删除过程都没有在oldbuckets中查找，这是因为首先要进行扩容判断和操作；</li></ul><h3 id="3-4-删除-mapdelete">3.4 删除 - mapdelete</h3><ul><li>删除某个key的操作与分配类似，由于hashmap的存储结构是数组+链表，</li><li>所以真正删除key仅仅是将对应的slot设置为empty，并没有减少内存；</li></ul><h2 id="04-map扩容策略是什么">04.map扩容策略是什么</h2><h3 id="4-1-map简述">4.1 map简述</h3><ul><li><p>使用哈希表的目的就是要快速查找到目标 key，然而，随着向 map 中添加的 key 越来越多，key 发生碰撞的概率也越来越大。</p></li><li><p>bucket 中的 8 个 cell 会被逐渐塞满，查找、插入、删除 key 的效率也会越来越低。</p></li><li><p>最理想的情况是一个 bucket 只装一个 key，这样，就能达到 <code>O(1)</code> 的效率，但这样空间消耗太大，用空间换时间的代价太高。</p></li><li><p>Go 语言采用一个 bucket 里装载 8 个 key，定位到某个 bucket 后，还需要再定位到具体的 key，这实际上又用了时间换空间。</p></li><li><p>当然，这样做，要有一个度，不然所有的 key 都落在了同一个 bucket 里，直接退化成了链表，各种操作的效率直接降为 O(n)，是不行的。</p></li><li><p><code>装载因子</code></p><ul><li><p>需要有一个指标来衡量前面描述的情况，这就是<code>装载因子</code></p></li><li><figure><div class="code-wrapper"><pre><code class="language-go">   loadFactor := count /(2^B)<pre class="line-numbers language-none"><code class="language-none">    1  - count 就是 map 的元素个数，2^B 表示 bucket 数量### 4.2 触发 map 扩容的时机- 在向 map 插入新 key 的时候，会进行条件检测，符合下面这 2 个条件，就会触发扩容- 1）装载因子超过阈值，源码里定义的阈值是 6.5。- 2）overflow 的 bucket 数量过多：  - 当 B 小于 15，也就是 bucket 总数 2^B 小于 2^15 时，如果 overflow 的 bucket 数量超过 2^B；  - 当 B &gt;&#x3D; 15，也就是 bucket 总数 2^B 大于等于 2^15，如果 overflow 的 bucket 数量超过 2^15。#### 4.2.1 第 1 点扩容- 我们知道，每个 bucket 有 8 个空位，在没有溢出，且所有的桶都装满了的情况下，装载因子算出来的结果是 8。- 因此当装载因子超过 6.5 时，表明很多 bucket 都快要装满了，查找效率和插入效率都变低了。在这个时候进行扩容是有必要的。- &#96;&#96;&#96;  对于条件 1，扩容方案<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure></code></pre></li><li><p>元素太多，而 bucket 数量太少，很简单：将 B 加 1，bucket 最大数量（2^B）直接变成原来 bucket 数量的 2 倍。</p></li><li><p>于是，就有新老 bucket 了</p></li><li><p>注意，这时候元素都在老 bucket 里，还没迁移到新的 bucket 来。</p></li><li><p>而且，新 bucket 只是最大数量变为原来最大数量（2^B）的 2 倍（2^B * 2）。</p></li></ul></li></ul><h4 id="4-2-2-第2点扩容是对第1点的补充">4.2.2 第2点扩容是对第1点的补充</h4><ul><li>就是说在装载因子比较小的情况下，这时候 map 的查找和插入效率也很低，而第 1 点识别不出来这种情况。</li><li>表面现象就是计算装载因子的分子比较小，即 map 里元素总数少，但是 bucket 数量多（真实分配的 bucket 数量多，包括大量的 overflow bucket）。</li><li>不难想像造成这种情况的原因：不停地插入、删除元素。</li><li>先插入很多元素，导致创建了很多 bucket，但是装载因子达不到第 1 点的临界值，未触发扩容来缓解这种情况。</li><li>之后，删除元素降低元素总数量，再插入很多元素，导致创建很多的 overflow bucket，但就是不会触犯第 1 点的规定</li><li>overflow bucket 数量太多，导致 key 会很分散，查找插入效率低得吓人，因此出台第 2 点规定。</li><li>这就像是一座空城，房子很多，但是住户很少，都分散了，找起人来很困难。</li><li><code>对于条件 2，扩容方案</code><ul><li>其实元素没那么多，但是 overflow bucket 数特别多，说明很多 bucket 都没装满。</li><li>解决办法就是开辟一个新 bucket 空间，将老 bucket 中的元素移动到新 bucket，使得同一个 bucket 中的 key 排列地更紧密。</li><li>这样，原来，在 overflow bucket 中的 key 可以移动到 bucket 中来。</li><li>结果是节省空间，提高 bucket 利用率，map 的查找和插入效率自然就会提升。</li></ul></li></ul><h2 id="05-map值无法地址取值">05.map值无法地址取值</h2><h3 id="5-1-map指针取地址报错问题">5.1 map指针取地址报错问题</h3><ul><li>当通过key获取到value时，这个value是不可寻址的，因为map 会进行动静扩容</li><li>当进行扩大后，map的value就会进行内存迁徙，其地址发生变化，所以无奈对这个value进行寻址</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">type</span> UserInfo <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>UserName <span class="token builtin">string</span> <span class="token string">`json:"user_name"`</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>user <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>UserInfo<span class="token punctuation">)</span>user<span class="token punctuation">[</span><span class="token string">"0001"</span><span class="token punctuation">]</span> <span class="token operator">=</span> UserInfo<span class="token punctuation">&#123;</span>UserName<span class="token punctuation">:</span> <span class="token string">"jack"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 因为map会进行动静扩容，当进行扩大后，map的value就会进行内存迁徙，其地址发生变化</span><span class="token comment">// 所以 user["0001"] 返回值不是固定的地址，所以无法获取地址</span>p1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>user<span class="token punctuation">[</span><span class="token string">"0001"</span><span class="token punctuation">]</span>  <span class="token comment">// Cannot take the address of 'user["0001"]'</span><span class="token comment">// 如果非要获取地址可以先赋值给一个变量</span>u <span class="token operator">:=</span> user<span class="token punctuation">[</span><span class="token string">"0001"</span><span class="token punctuation">]</span>p2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>u<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="5-2-map使用指针value">5.2 map使用指针value</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> UserInfo <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>UserName <span class="token builtin">string</span> <span class="token string">`json:"user_name"`</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>user <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>UserInfo<span class="token punctuation">)</span>user<span class="token punctuation">[</span><span class="token string">"0001"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>UserInfo<span class="token punctuation">&#123;</span>UserName<span class="token punctuation">:</span> <span class="token string">"jack"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// 上面是指针 *UserInfo 才能这样操作，否则报错</span>user<span class="token punctuation">[</span><span class="token string">"0001"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>UserName <span class="token operator">=</span> <span class="token string">"tom"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>user<span class="token punctuation">[</span><span class="token string">"0001"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>字符串</title>
    <link href="/2021/01/20/Go%E8%BF%9B%E9%98%B6%20-%20%E5%AD%97%E7%AC%A6%E4%B8%B2/"/>
    <url>/2021/01/20/Go%E8%BF%9B%E9%98%B6%20-%20%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="1-字符串">1.字符串</h1><h2 id="01-字符串底层">01.字符串底层</h2><h3 id="1-1-字符串底层结构">1.1 字符串底层结构</h3><ul><li>一个字符串是一个不可改变的字节序列，字符串通常是用来包含人类可读的文本数据。</li><li>和数组不同的是，字符串的元素不可修改，<code>是一个只读的字节数组</code>。</li><li>每个字符串的长度虽然也是固定的，但是字符串的长度并不是字符串类型的一部分。</li><li>Go语言字符串的底层结构在 reflect.StringHeader 中定义</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> StringHeader <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Data <span class="token builtin">uintptr</span>Len <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>字符串结构由两个信息组成<ul><li>第一个是字符串指向的底层字节数组</li><li>第二个是字符串的字节的长度</li></ul></li><li>而slice 包含一个数据指针、一个长度和一个容量，当容量不够时会重新申请新的内存，Data 指针将指向新的地址，原来的地址空间将被释放</li><li>字符串其实是一个结构体，因此字符串的赋值操作也就是 reflect.StringHeader 结构体的复制过程，并不会涉及底层字节数组的复制。</li><li>我们可以看看字符串“Hello, world”本身对应的内存结构：</li></ul><p><img src="/img/image-20210601140428459.2bc7c2a5.png" alt="img"></p><ul><li>字符串虽然不是切片，但是支持切片操作，不同位置的切片底层也访问的同一块内存数据</li><li>因为字符串是只读的，相同的字符串通常是对应同一个字符串常量</li></ul><h3 id="1-2-reflect-StringHeader">1.2 reflect.StringHeader</h3><ul><li>字符串和数组类似，内置的 len 函数返回字符串的长度。</li><li>也可以通过 reflect.StringHeader 结构访问字符串的长度</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"reflect"</span><span class="token string">"unsafe"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span><span class="token string">"aaa"</span><span class="token comment">// 1.unsafe.Pointer(&amp;a)方法可以得到变量a的地址</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 0xc000054240</span><span class="token comment">// 2.(*reflect.StringHeader)(unsafe.Pointer(&amp;a)) 可以把字符串a转成底层结构的形式。</span>b <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Lenfmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>  <span class="token comment">// 3</span><span class="token comment">// 3.(*[]byte)(unsafe.Pointer(&amp;ssh)) 可以把ssh底层结构体转成byte的切片的指针</span><span class="token comment">// 4.再通过 *转为指针指向的实际内容</span>ssh <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>c <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ssh<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v"</span><span class="token punctuation">,</span>c<span class="token punctuation">)</span>  <span class="token comment">// [97 97 97]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-修改字符串">1.3 修改字符串</h3><ul><li>要修改字符串，需要先将其转换成[]rune 或[]byte，完成后再转换为 string。</li><li>无论哪种转换，都会重新分配内存，并复制字节数组。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s1 <span class="token operator">:=</span> <span class="token string">"big"</span><span class="token comment">// 强制类型转换</span>byteS1 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>byteS1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'p'</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>byteS1<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// pig</span>s2 <span class="token operator">:=</span> <span class="token string">"白萝卜"</span>runeS2 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>runeS2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'红'</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>runeS2<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 红萝卜</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-4-字符串反转">1.4 字符串反转</h3><ul><li><code>rune</code>关键字，从golang源码中看出，它是int32的别名（-2^31 ~ 2^31-1），比起byte（-128～127），<strong>可表示更多的字符</strong>。</li><li>由于rune可表示的范围更大，所以能处理一切字符，当然也包括<strong>中文字符</strong>。在平时计算中文字符，可用rune。</li><li>因此将<code>字符串</code>转为<code>rune的切片</code>，再进行翻转，完美解决。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span><span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>src <span class="token operator">:=</span> <span class="token string">"2012年的第一场雪！"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// [50 48 49 50 24180 30340 31532 19968 22330 38634 65281]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// []rune(src)</span>dst <span class="token operator">:=</span> <span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v\n"</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// ！雪场一第的年2102</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">reverse</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">rune</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">rune</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> s<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go进阶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go进阶</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go mod包管理工具</title>
    <link href="/2021/01/13/9.go%20mod%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"/>
    <url>/2021/01/13/9.go%20mod%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h1 id="1-go-mod包管理工具">1.go mod包管理工具</h1><h2 id="01-Golang-中包的介绍和定义">01.Golang 中包的介绍和定义</h2><ul><li>包（package）是多个 Go 源码的集合，是一种高级的代码复用方案</li><li>Go 语言为我们提供了很多内置包，如 fmt、strconv、strings、sort、errors、time、encoding/json、os、io 等。</li><li><strong>Golang</strong> 中的包可以分为三种：1、系统内置包 2、自定义包 3、第三方包<ul><li>1、系统内置包<ul><li>fmt、strconv、strings、sort、errors、time、encoding/json、os、io 等</li></ul></li><li>2、自定义包<ul><li>开发者自己写的包</li></ul></li><li>3、第三方包<ul><li>属于自定义包的一种，需要下载安装到本地后才可以使用</li><li>如前面给大家介绍的&quot;<a href="http://github.com/shopspring/decimal">github.com/shopspring/decimal</a>&quot;包解决 float 精度丢失问题</li></ul></li></ul></li></ul><h2 id="02-Golang包管理工具go-mod">02.Golang包管理工具go mod</h2><ul><li>在 Golang1.11 版本之前如果我们要自定义包的话必须把项目放在 GOPATH 目录。</li><li>Go1.11 版本之后无需手动配置环境变量，使用 go mod 管理项目</li><li>也不需要非得把项目放到 GOPATH指定目录下，你可以在你磁盘的任何位置新建一个项目</li><li>Go1.13 以后可以彻底不要 GOPATH了。</li></ul><h3 id="2-1-go-mod-init-初始化项目">2.1 go mod init 初始化项目</h3><ul><li>实际项目开发中我们首先要在我们项目目录中用 go mod 命令生成一个 go.mod 文件管理我们项目的依赖。</li><li>比如我们的 golang 项目文件要放在了 itying 这个文件夹，这个时候我们需要在 itying 文件夹</li><li>里面使用 go mod 命令生成一个 go.mod 文件</li><li>go.mod文件一旦创建后，它的内容将会被go toolchain全面掌控。</li><li>go toolchain会在各类命令执行时，比如go get、go build、go mod等修改和维护go.mod文件。</li><li>go.mod 提供了module, require、replace和exclude 四个命令<ul><li><code>module</code> 语句指定包的名字（路径）</li><li><code>require</code> 语句指定的依赖项模块</li><li><code>replace</code> 语句可以替换依赖项模块</li><li><code>exclude</code> 语句可以忽略依赖项模块</li></ul></li></ul><p><img src="/img/image-20210519185031831.9054b000.png" alt="img"></p><h3 id="2-2-go-mod常用命令">2.2 go mod常用命令</h3><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>download</td><td>download modules to local cache(下载依赖包)</td></tr><tr><td>edit</td><td>edit go.mod from tools or scripts（编辑go.mod)</td></tr><tr><td>graph</td><td>print module requirement graph (打印模块依赖图)</td></tr><tr><td>verify</td><td>initialize new module in current directory（在当前目录初始化mod）</td></tr><tr><td>tidy</td><td>add missing and remove unused modules(拉取缺少的模块，移除不用的模块)</td></tr><tr><td>vendor</td><td>make vendored copy of dependencies(将依赖复制到vendor下)</td></tr><tr><td>verify</td><td>verify dependencies have expected content (验证依赖是否正确）</td></tr><tr><td>why</td><td>explain why packages or modules are needed(解释为什么需要依赖)</td></tr></tbody></table><h2 id="03-Golang-中自定义包">03.Golang 中自定义包</h2><ul><li>包（package）是多个 Go 源码的集合，一个包可以简单理解为一个存放多个.go 文件的文件夹。</li><li>该文件夹下面的所有 go 文件都要在代码的第一行添加如下代码，声明该文件归属的包。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">package 包名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="3-1-初始化项目">3.1 初始化项目</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">mkdir Democd Demo<span class="token keyword">go</span> mod init Demo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210519192851251.59ed18f1.png" alt="img"></p><h3 id="3-2-Demo-calc-calc-go">3.2 Demo/calc/calc.go</h3><ul><li>如果想在一个包中引用另外一个包里的标识符（如变量、常量、类型、函数等）时，该标识符必须是对外可见的（public）。</li><li>在 Go 语言中只需要将标识符的首字母大写就可以让标识符对外可见了。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> calc<span class="token keyword">var</span> aaa <span class="token operator">=</span> <span class="token string">"私有变量"</span>   <span class="token comment">//首字母小写表示私有</span><span class="token keyword">var</span> Age <span class="token operator">=</span> <span class="token number">20</span><span class="token keyword">func</span> <span class="token function">Add</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//首字母大写表示 公有方法</span><span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">Sub</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//公有方法</span><span class="token keyword">return</span> x <span class="token operator">-</span> y<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3-Demo-main-go">3.3 Demo/main.go</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>c <span class="token string">"Demo/calc"</span>    <span class="token comment">// c是取的别名</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>sum <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span>                  <span class="token comment">//12</span>sub <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>                  <span class="token comment">// 8</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//main包中init函数 优先于 main函数</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main init..."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*main init...128 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-init-初始化函数">04.init()初始化函数</h2><h3 id="4-1-init-函数介绍">4.1 init()函数介绍</h3><ul><li>在Go语言程序执行时导入包语句会自动触发包内部 init()函数的调用。</li><li>需要注意的是：init()函数没有参数也没有返回值。</li><li>init()函数在程序运行时自动被调用执行，不能在代码中主动调用它。</li></ul><p><img src="/img/image-20210519193802393.65f0f073.png" alt="img"></p><h3 id="4-2-init-函数执行顺序">4.2 init()函数执行顺序</h3><ul><li>Go 语言包会从 main 包开始检查其导入的所有包，每个包中又可能导入了其他的包。</li><li>Go 编译器由此构建出一个树状的包引用关系，再根据引用顺序决定编译顺序，依次编译这些包的代码。</li><li>在运行时，被最后导入的包会最先初始化并调用其 init()函数， 如下图示</li></ul><p><img src="/img/image-20210519194004817.397cc155.png" alt="img"></p><h2 id="05-Golang中使用第三方包">05.Golang中使用第三方包</h2><h3 id="5-1-查找golang的第三方包">5.1 查找golang的第三方包</h3><ul><li>我们可以在 <a href="https://pkg.go.dev/">https://pkg.go.dev/</a><a href="https://pkg.go.dev/"> (opens new window)</a>查找看常见的 golang 第三方包</li></ul><p><img src="/img/image-20210519194958548.6c6eed46.png" alt="img"></p><h3 id="5-2-安装这个包">5.2 安装这个包</h3><ul><li>第一种方法：go get 包名称 （全局）</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span>shopspring<span class="token operator">/</span>decimal<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>第二种方法：go mod download （全局）<ul><li>依赖包会自动下载到$GOPATH/pkg/mod，多个项目可以共享缓存的 mod</li><li>注意使用 <code>go mod download</code> 的时候首先需要在你的项目里面引入第三方包</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">go mod download<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>第三种方法：go mod vendor 将依赖复制到当前项目的 vendor 下 （本项目）<ul><li>将依赖复制到当前项目的 vendor 下</li><li>注意：使用 go mod vendor 的时候首先需要在你的项目里面引入第三方包</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> mod vendor<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>流程控制</title>
    <link href="/2021/01/12/8.%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/"/>
    <url>/2021/01/12/8.%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="1-流程控制">1.流程控制</h1><h2 id="01-if-else-分支结构">01.if else(分支结构)</h2><h3 id="1-1-if-条件判断基本写法">1.1 if 条件判断基本写法</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>score <span class="token operator">:=</span> <span class="token number">65</span><span class="token keyword">if</span> score <span class="token operator">>=</span> <span class="token number">90</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> score <span class="token operator">></span> <span class="token number">75</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-if-条件判断特殊写法">1.2 if 条件判断特殊写法</h3><ul><li>if 条件判断还有一种特殊的写法，可以在 if 表达式之前添加一个执行语句，再根据变量值进行判断</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//这里的 score 是局部作用域</span><span class="token keyword">if</span> score <span class="token operator">:=</span> <span class="token number">56</span><span class="token punctuation">;</span> score <span class="token operator">>=</span> <span class="token number">90</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> score <span class="token operator">></span> <span class="token number">75</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token comment">// 只能在函数内部打印 score</span><span class="token punctuation">&#125;</span><span class="token comment">// fmt.Println(score) //undefined: score</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-for-循环结构">02.for(循环结构)</h2><h3 id="2-1-for循环">2.1 for循环</h3><ul><li><code>1）普通for循环</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 打印： 0 ~ 9 的数字</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>2）外部定义 i</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>i <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>i<span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>3）省略初始语句</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>i <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-打印-0-10-所有的偶数">2.2 打印 0-10 所有的偶数</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 0 2 4 6 8</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-嵌套循环">2.3 嵌套循环</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%vx%v=%v \t"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> i<span class="token operator">*</span>j<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*1x1=12x1=2 2x2=43x1=3 3x2=6 3x3=94x1=4 4x2=8 4x3=12 4x4=165x1=5 5x2=10 5x3=15 5x4=20 5x5=256x1=6 6x2=12 6x3=18 6x4=24 6x5=30 6x6=367x1=7 7x2=14 7x3=21 7x4=28 7x5=35 7x6=42 7x7=498x1=8 8x2=16 8x3=24 8x4=32 8x5=40 8x6=48 8x7=56 8x8=649x1=9 9x2=18 9x3=27 9x4=36 9x5=45 9x6=54 9x7=63 9x8=72 9x9=81*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-模拟while循环">2.4 模拟while循环</h3><ul><li><strong>Go</strong> 语言中是没有 <strong>while</strong> 语句的，我们可以通过 <strong>for</strong> 代替</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>k <span class="token operator">:=</span> <span class="token number">1</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 这里也等价 for ; ; &#123;</span><span class="token keyword">if</span> k <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ok~~"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span>   <span class="token comment">//break 就是跳出这个 for 循环</span><span class="token punctuation">&#125;</span>k<span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-5-for-range-键值循环">2.5 for range(键值循环)</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">:=</span> <span class="token string">"abc上海"</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> str <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"索引=%d, 值=%c \n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*索引=0, 值=a索引=1, 值=b索引=2, 值=c索引=3, 值=上索引=6, 值=海*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-switch-case">03.switch case</h2><ul><li>使用 switch 语句可方便地对大量的值进行条件判断</li></ul><h3 id="3-1-case一般用法">3.1 case一般用法</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>score <span class="token operator">:=</span> <span class="token string">"B"</span><span class="token keyword">switch</span> score <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token string">"A"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"非常棒"</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"B"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"优秀"</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token string">"C"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"及格"</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"不及格"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-case语句多个值">3.2 case语句多个值</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>n <span class="token operator">:=</span> <span class="token number">2</span><span class="token keyword">switch</span> n <span class="token punctuation">&#123;</span><span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"奇数"</span><span class="token punctuation">)</span><span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"偶数"</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-3-fallthrough-语法">3.3 fallthrough 语法</h3><ul><li>fallthrough 语法可以执行满足条件的 case 的下一个 case，是为了兼容 C 语言中的 case 设计</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token string">"a"</span><span class="token keyword">switch</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> s <span class="token operator">==</span> <span class="token string">"a"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token keyword">fallthrough</span><span class="token keyword">case</span> s <span class="token operator">==</span> <span class="token string">"b"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token keyword">case</span> s <span class="token operator">==</span> <span class="token string">"c"</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"c"</span><span class="token punctuation">)</span><span class="token keyword">default</span><span class="token punctuation">:</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*ab */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-break、continue、goto">04.break、continue、goto</h2><h3 id="4-1-break跳出单循环">4.1 break跳出单循环</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>k <span class="token operator">:=</span> <span class="token number">1</span><span class="token keyword">for</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 这里也等价 for ; ; &#123;</span><span class="token keyword">if</span> k <span class="token operator">&lt;=</span> <span class="token number">10</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ok~~"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span>   <span class="token comment">//break 就是跳出这个 for 循环</span><span class="token punctuation">&#125;</span>k<span class="token operator">++</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-跳出多重循环">4.2 跳出多重循环</h3><ul><li>在多重循环中，可以用标号 <strong>label</strong> 标出想 <strong>break</strong> 的循环</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>lable2<span class="token punctuation">:</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> j <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span><span class="token keyword">break</span> lable2<span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"i j 的值:"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*i j 的值: 0 - 0i j 的值: 0 - 1 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-3-continue-继续下次循环">4.3 continue(继续下次循环)</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> j <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span><span class="token keyword">continue</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"i j 的值"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*i j 的值 0 - 0i j 的值 0 - 1i j 的值 0 - 3i j 的值 1 - 0i j 的值 1 - 1i j 的值 1 - 3 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-4-goto-跳转到指定标签">4.4 goto(跳转到指定标签)</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> j <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">&#123;</span><span class="token keyword">goto</span> breakTag  <span class="token comment">// // 设置退出标签</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v-%v\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span>breakTag<span class="token punctuation">:</span><span class="token comment">// 标签</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"结束 for 循环"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*0-00-1结束 for 循环 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>interface接口</title>
    <link href="/2021/01/11/7.interface%E6%8E%A5%E5%8F%A3/"/>
    <url>/2021/01/11/7.interface%E6%8E%A5%E5%8F%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="1-interface接口">1.interface接口</h1><h2 id="01-Golang接口的定义">01.Golang接口的定义</h2><h3 id="1-1-Golang-中的接口">1.1 Golang 中的接口</h3><ul><li>在Go语言中接口（interface）是一种类型，一种抽象的类型。</li><li>接口（interface）定义了一个对象的行为规范，只定义规范不实现，由具体的对象来实现规范的细节。</li><li>实现接口的条件<ul><li>一个对象只要全部实现了接口中的方法，那么就实现了这个接口。</li><li>换句话说，接口就是一个需要实现的方法列表。</li></ul></li></ul><h3 id="1-2-定义一个Usber接口">1.2 定义一个Usber接口</h3><ul><li>定义一个 <strong>Usber</strong> 接口让 <strong>Phone</strong> 和 <strong>Camera</strong> 结构体实现这个接口</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">//1.接口是一个规范</span><span class="token keyword">type</span> Usber <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">//2.如果接口里面有方法的话，必要要通过结构体或者通过自定义类型实现这个接口</span><span class="token keyword">type</span> Phone <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token comment">//3.手机要实现usb接口的话必须得实现usb接口中的所有方法</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p Phone<span class="token punctuation">)</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"启动"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p Phone<span class="token punctuation">)</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"关机"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p <span class="token operator">:=</span> Phone<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"华为手机"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> p1 Usber   <span class="token comment">//golang中接口就是一个数据类型</span>p1 <span class="token operator">=</span> p       <span class="token comment">//表示手机实现Usb接口</span>p1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>p1<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*华为手机 启动华为手机 关机 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-空接口">02.空接口</h2><h3 id="2-1-空接口说明">2.1 空接口说明</h3><ul><li><code>golang中空接口也可以直接当做类型来使用，可以表示任意类型</code></li><li>Golang 中的接口可以不定义任何方法，没有定义任何方法的接口就是空接口。</li><li>空接口表示没有任何约束，因此任何类型变量都可以实现空接口。</li><li>空接口在实际项目中用的是非常多的，用空接口可以表示任意数据类型。</li></ul><h3 id="2-2-空接口作为函数的参数">2.2 空接口作为函数的参数</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token comment">//空接口作为函数的参数</span><span class="token keyword">func</span> <span class="token function">show</span><span class="token punctuation">(</span>a <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值:%v 类型:%T\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>                      <span class="token comment">// 值:20 类型:int</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">"你好golang"</span><span class="token punctuation">)</span>            <span class="token comment">// 值:你好golang 类型:string</span>slice <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">&#125;</span><span class="token function">show</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span>                     <span class="token comment">// 值:[1 2 34 4] 类型:[]int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-切片实现空接口">2.3 切片实现空接口</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> slice <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#123;</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">32.2</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span>  <span class="token comment">// [张三 20 true 32.2]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-map-的值实现空接口">2.4 map 的值实现空接口</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 空接口作为 map 值</span><span class="token keyword">var</span> studentInfo <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>studentInfo<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"张三"</span>studentInfo<span class="token punctuation">[</span><span class="token string">"age"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">18</span>studentInfo<span class="token punctuation">[</span><span class="token string">"married"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>studentInfo<span class="token punctuation">)</span><span class="token comment">// [age:18 married:false name:张三]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-类型断言">03.类型断言</h2><ul><li>一个接口的值（简称接口值）是由一个具体类型和具体类型的值两部分组成的。</li><li>这两部分分别称为接口的动态类型和动态值。</li><li>如果我们想要判断空接口中值的类型，那么这个时候就可以使用类型断言</li><li>其语法格式：<code>x.(T)</code><ul><li>x : 表示类型为 interface{}的变量</li><li>T : 表示断言 x 可能是的类型</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> x <span class="token keyword">interface</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>x <span class="token operator">=</span> <span class="token string">"Hello golnag"</span>v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token keyword">if</span> ok <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"非字符串类型"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-值接收者和指针接收者">04.值接收者和指针接收者</h2><h3 id="4-1-值接收者">4.1 值接收者</h3><ul><li>如果结构体中的方法是值接收者，那么实例化后的结构体值类型和结构体指针类型都可以赋值给接口变量</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Usb <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Phone <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p Phone<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"开始工作"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p Phone<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"phone 停止"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>phone1 <span class="token operator">:=</span> Phone<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"小米手机"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> p1 Usb <span class="token operator">=</span> phone1      <span class="token comment">//phone1 实现了 Usb 接口 phone1 是 Phone 类型</span>p1<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>phone2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Phone<span class="token punctuation">&#123;</span>     <span class="token comment">//小米手机 开始工作</span>Name<span class="token punctuation">:</span> <span class="token string">"苹果手机"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> p2 Usb <span class="token operator">=</span> phone2      <span class="token comment">//phone2 实现了 Usb 接口 phone2 是 *Phone 类型</span>p2<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">//苹果手机 开始工作</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-指针接收者">4.2 指针接收者</h3><ul><li>如果结构体中的方法是指针接收者，那么实例化后结构体指针类型都可以赋值给接口变量，<code>结构体值类型没法赋值给接口变量</code>。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Usb <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Phone <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Phone<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">"开始工作"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Phone<span class="token punctuation">)</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"phone 停止"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">/*错误写法phone1 := Phone&#123;Name: "小米手机",&#125;var p1 Usb = phone1p1.Start()*/</span><span class="token comment">//正确写法</span>phone2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Phone<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"苹果手机"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">var</span> p2 Usb <span class="token operator">=</span> phone2 <span class="token comment">//phone2 实现了 Usb 接口 phone2 是 *Phone 类型</span>p2<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//苹果手机 开始工作</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-一个结构体实现多个接口">05.一个结构体实现多个接口</h2><ul><li>Golang 中一个结构体也可以实现多个接口</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> AInterface <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> BInterface <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">SetInfo</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> People <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>Name <span class="token builtin">string</span>Age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p People<span class="token punctuation">)</span> <span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"姓名:%v 年龄:%d"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>Age<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>People<span class="token punctuation">)</span> <span class="token function">SetInfo</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> age <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span>Name <span class="token operator">=</span> namep<span class="token punctuation">.</span>Age <span class="token operator">=</span> age<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> people <span class="token operator">=</span> <span class="token operator">&amp;</span>People<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>Age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// people 实现了 AInterface 和 BInterface</span><span class="token keyword">var</span> p1 AInterface <span class="token operator">=</span> people<span class="token keyword">var</span> p2 BInterface <span class="token operator">=</span> peoplefmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p2<span class="token punctuation">.</span><span class="token function">SetInfo</span><span class="token punctuation">(</span><span class="token string">"李四"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span>         <span class="token comment">// 姓名:张三 年龄:20</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">GetInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 姓名:李四 年龄:30</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="06-接口嵌套">06.接口嵌套</h2><ul><li>接口与接口间可以通过嵌套创造出新的接口。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> SayInterface <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> MoveInterface <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 接口嵌套</span><span class="token keyword">type</span> Animal <span class="token keyword">interface</span> <span class="token punctuation">&#123;</span>SayInterfaceMoveInterface<span class="token punctuation">&#125;</span><span class="token keyword">type</span> Cat <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c Cat<span class="token punctuation">)</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"喵喵喵"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c Cat<span class="token punctuation">)</span> <span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"猫会动"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> x Animalx <span class="token operator">=</span> Cat<span class="token punctuation">&#123;</span>name<span class="token punctuation">:</span> <span class="token string">"花花"</span><span class="token punctuation">&#125;</span>x<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 猫会动</span>x<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 喵喵喵</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>结构体</title>
    <link href="/2021/01/10/6.%E7%BB%93%E6%9E%84%E4%BD%93/"/>
    <url>/2021/01/10/6.%E7%BB%93%E6%9E%84%E4%BD%93/</url>
    
    <content type="html"><![CDATA[<h1 id="1-结构体">1.结构体</h1><h2 id="01-结构体基础">01.结构体基础</h2><h3 id="1-1-什么是结构体">1.1 什么是结构体</h3><ul><li>Go语言中没有“类”的概念，也不支持“类”的继承等面向对象的概念。</li><li>Go语言中通过结构体的内嵌再配合接口比面向对象具有更高的扩展性和灵活性。</li></ul><h3 id="1-2-自定义类型">1.2 自定义类型</h3><ul><li>在 Go 语言中有一些基本的数据类型，如 string、整型、浮点型、布尔等数据类型</li><li>Go 语言中可以使用 type 关键字来定义自定义类型。</li><li>将 myInt 定义为 int 类型，通过 type 关键字的定义，myInt 就是一种新的类型，它具有 int 的特性</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> myInt <span class="token builtin">int</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="1-3-类型别名">1.3 类型别名</h3><ul><li>Golang1.9 版本以后添加的新功能。</li><li><strong>类型别名规定</strong>：TypeAlias 只是 Type 的别名，本质上 TypeAlias 与 Type 是同一个类型</li><li>就像 一个孩子小时候有大名、小名、英文名，但这些名字都指的是他本人。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> TypeAlias <span class="token operator">=</span> Type<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><h3 id="1-4-自定义类型和类型别名的区别">1.4 自定义类型和类型别名的区别</h3><ul><li>类型别名与自定义类型表面上看只有一个等号的差异</li><li>结果显示 a 的类型是 main.newInt，表 示 main 包下定义的 newInt 类型。</li><li>b 的类型是 int 类型。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> newInt <span class="token builtin">int</span>      <span class="token comment">//类型定义</span><span class="token keyword">type</span> myInt <span class="token operator">=</span> <span class="token builtin">int</span>      <span class="token comment">//类型别名</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a newInt<span class="token keyword">var</span> b myIntfmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of a:%T\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>   <span class="token comment">//type of a:main.newInt</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of b:%T\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>   <span class="token comment">//type of b:int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-结构体定义">02.结构体定义</h2><h3 id="2-1-基本实例化（法1）">2.1 基本实例化（法1）</h3><ul><li>只有当结构体实例化时，才会真正地分配内存，也就是必须实例化后才能使用结构体的字段。</li><li>结构体本身也是一种类型，我们可以像声明内置类型一样使用 var 关键字声明结构体类型</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>city <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> p1 personp1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"张三"</span>p1<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token string">"北京"</span>p1<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">18</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p1=%v\n"</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>   <span class="token comment">// p1=&#123;张三 北京 18&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p1=%#v\n"</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>   <span class="token comment">// p1=main.person&#123;name:"张三", city:"北京", age:18&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-new实例化（法2）">2.2 new实例化（法2）</h3><ul><li>我们还可以通过使用 new 关键字对结构体进行实例化，得到的是结构体的地址</li><li>从打印的结果中我们可以看出 p2 是一个结构体指针。</li><li>注意：在 Golang 中支持对结构体指针直接使用.来访问结构体的成员。</li><li><code>p2.name = &quot;张三&quot;</code> 其实在底层是 <code>(*p2).name = &quot;张三&quot;</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>city <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span>p2<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"张三"</span>p2<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span>p2<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token string">"北京"</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T\n"</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>    <span class="token comment">//*main.person</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p2=%#v\n"</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>  <span class="token comment">//p2=&amp;main.person&#123;name:"张三", city:"北京", age:20&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="xxxxxxxxxx-package-mainimport-“fmt”-“sort”-func-main-第一：生成字典，scoreMap-var-scoreMap-make-map-string-int-200-for-i-0-i-10-i-key-fmt-Sprintf-“stu-02d”-i-生成-stu-开头的字符串-scoreMap-key-i-第二：取出-map-中的所有-key-存入切片-keys-var-keys-make-string-0-200-for-key-range-scoreMap-keys-append-keys-key-​-第三：对切片进行排序-sort-Strings-keys-​-第四：按照排序后的-key-遍历-map-for-key-range-keys-fmt-Println-key-scoreMap-key-stu00-0stu01-1stu02-2stu03-3stu04-4stu05-5stu06-6stu07-7stu08-8stu09-9-go">xxxxxxxxxx package mainimport (    “fmt”    “sort”)func main() {    // 第一：生成字典，scoreMap    var scoreMap = make(map[string]int, 200)    for i := 0; i &lt; 10; i++ {        key := fmt.Sprintf(“stu%02d”, i) //生成 stu 开头的字符串        scoreMap[key] = i    }        // 第二：取出 map 中的所有 key 存入切片 keys    var keys = make([]string, 0, 200)    for key := range scoreMap {        keys = append(keys, key)    }​    // 第三：对切片进行排序    sort.Strings(keys)​    // 第四：按照排序后的 key 遍历 map    for _, key := range keys {        fmt.Println(key, scoreMap[key])    }}/*stu00 0stu01 1stu02 2stu03 3stu04 4stu05 5stu06 6stu07 7stu08 8stu09 9 */go</h3><ul><li>使用&amp;对结构体进行取地址操作相当于对该结构体类型进行了一次 new 实例化操作</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>city <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p3 <span class="token operator">:=</span> <span class="token operator">&amp;</span>person<span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T\n"</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span>    <span class="token comment">//*main.person</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p3=%#v\n"</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span>  <span class="token comment">//p3=&amp;main.person&#123;name:"", city:"", age:0&#125;</span>p3<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"zhangsan"</span>p3<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">30</span>p3<span class="token punctuation">.</span>city <span class="token operator">=</span> <span class="token string">"深圳"</span><span class="token punctuation">(</span><span class="token operator">*</span>p3<span class="token punctuation">)</span><span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">40</span>   <span class="token comment">//这样也是可以的</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p3=%#v\n"</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span> <span class="token comment">//p3=&amp;main.person&#123;name:"zhangsan", city:"深圳", age:30&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-4-键值对初始化（法4）">2.4 键值对初始化（法4）</h3><ul><li>注意：最后一个属性的,要加上</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>city <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p4 <span class="token operator">:=</span> person<span class="token punctuation">&#123;</span>name<span class="token punctuation">:</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span>city<span class="token punctuation">:</span> <span class="token string">"北京"</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// p4=main.person&#123;name:"zhangsan", city:"北京", age:18&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p4=%#v\n"</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-5-值列表初始化（法5）">2.5 值列表初始化（法5）</h3><ul><li>初始化结构体的时候可以简写，也就是初始化的时候不写键，直接写值</li><li>必须初始化结构体的所有字段。</li><li>初始值的填充顺序必须与字段在结构体中的声明顺序一致。</li><li>该方式不能和键值初始化方式混用</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>city <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 初始化结构体的时候可以简写，也就是初始化的时候不写键，直接写值</span>p7 <span class="token operator">:=</span> <span class="token operator">&amp;</span>person<span class="token punctuation">&#123;</span><span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"北京"</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token comment">// p7=&amp;main.person&#123;name:"zhangsan", city:"北京", age:28&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"p7=%#v\n"</span><span class="token punctuation">,</span> p7<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-6-结构体的匿名字段">2.6 结构体的匿名字段</h3><ul><li>结构体允许其成员字段在声明时没有字段名而只有类型，这种没有名字的字段就称为匿名字段。</li><li>匿名字段默认采用类型名作为字段名，结构体要求字段名称必须唯一，因此一个结构体中同种类型的匿名字段只能有一个。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//Person 结构体 Person 类型</span><span class="token builtin">string</span><span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p1 <span class="token operator">:=</span> Person<span class="token punctuation">&#123;</span><span class="token string">"小王子"</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v\n"</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>   <span class="token comment">//main.Person&#123;string:"北京", int:18&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token builtin">string</span><span class="token punctuation">,</span> p1<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span>    <span class="token comment">//北京 18</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-嵌套结构体">03.嵌套结构体</h2><h3 id="3-1-普通嵌套结构体">3.1 普通嵌套结构体</h3><ul><li>一个结构体中可以嵌套包含另一个结构体或结构体指针。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Address 地址结构体</span>Province <span class="token builtin">string</span>City <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//User 用户结构体</span>Name <span class="token builtin">string</span>Gender <span class="token builtin">string</span>Address Address<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>user1 <span class="token operator">:=</span> User<span class="token punctuation">&#123;</span>Name<span class="token punctuation">:</span> <span class="token string">"张三"</span><span class="token punctuation">,</span>Gender<span class="token punctuation">:</span> <span class="token string">"男"</span><span class="token punctuation">,</span>Address<span class="token punctuation">:</span> Address<span class="token punctuation">&#123;</span>Province<span class="token punctuation">:</span> <span class="token string">"广东"</span><span class="token punctuation">,</span>City<span class="token punctuation">:</span> <span class="token string">"深圳"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"user1=%#v\n"</span><span class="token punctuation">,</span> user1<span class="token punctuation">)</span> <span class="token comment">//user1=main.User&#123;Name:" 张 三 ", Gender:" 男 ", Address:main.Address&#123;Province:"广东", City:"深圳"&#125;&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-嵌套匿名结构体">3.2 嵌套匿名结构体</h3><ul><li>注意：当访问结构体成员时会先在结构体中查找该字段，找不到再去匿名结构体中查找。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>  <span class="token comment">//Address 地址结构体</span>Province <span class="token builtin">string</span>City <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> User <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//User 用户结构体</span>Name <span class="token builtin">string</span>Gender <span class="token builtin">string</span>Address<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> user2 Useruser2<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">"张三"</span>user2<span class="token punctuation">.</span>Gender <span class="token operator">=</span> <span class="token string">"男"</span>user2<span class="token punctuation">.</span>Address<span class="token punctuation">.</span>Province <span class="token operator">=</span> <span class="token string">"广东"</span>   <span class="token comment">//通过匿名结构体.字段名访问</span>user2<span class="token punctuation">.</span>City <span class="token operator">=</span> <span class="token string">"深圳"</span>   <span class="token comment">//直接访问匿名结构体的字段名</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"user2=%#v\n"</span><span class="token punctuation">,</span> user2<span class="token punctuation">)</span><span class="token comment">//user2=main.User&#123;Name:"张三", Gender:"男", Address:main.Address&#123;Province:"广东", City:"深圳"&#125;&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-结构体方法和接收者">04.结构体方法和接收者</h2><h3 id="4-1-结构体说明">4.1 结构体说明</h3><ul><li>在 go 语言中，没有类的概念但是可以给类型（结构体，自定义类型）定义方法。</li><li>所谓方法就是定义了接收者的函数。<ul><li>Go语言中的方法（Method）是一种作用于特定类型变量的函数。</li><li>这种特定类型变量叫做接收者（Receiver）。</li><li>接收者的概念就类似于其他语言中的this或者 self。</li></ul></li><li>方法的定义格式如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>接收者变量 接收者类型<span class="token punctuation">)</span> 方法名<span class="token punctuation">(</span>参数列表<span class="token punctuation">)</span> <span class="token punctuation">(</span>返回参数<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>函数体<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>给结构体 Person 定义一个方法打印 Person 的信息</li></ul><h3 id="4-2-结构体方法和接收者">4.2 结构体方法和接收者</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>age <span class="token builtin">int8</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p Person<span class="token punctuation">)</span> <span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"姓名:%v 年龄:%v"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span>  <span class="token comment">// 姓名:小王子 年龄:25</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p1 <span class="token operator">:=</span> Person<span class="token punctuation">&#123;</span>name<span class="token punctuation">:</span> <span class="token string">"小王子"</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span>  <span class="token number">25</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>p1<span class="token punctuation">.</span><span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 姓名:小王子 年龄:25</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-3-值类型和指针类型接收者">4.3 值类型和指针类型接收者</h3><ul><li>实例1：给结构体 Person 定义一个方法打印 Person 的信息</li><li>1、值类型的接收者<ul><li>当方法作用于值类型接收者时，Go 语言会在代码运行时将接收者的值复制一份。</li><li>在值类型接收者的方法中可以获取接收者的成员值，但修改操作只是针对副本，无法修改接收者变量本身。</li></ul></li><li>2、指针类型的接收者<ul><li>指针类型的接收者由一个结构体的指针组成</li><li>由于指针的特性，调用方法时修改接收者指针的任意成员变量，在方法结束后，修改都是有效的。</li><li>这种方式就十分接近于其他语言中面向对象中的 this 或者 self。</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span class="token comment">//值类型接受者</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p Person<span class="token punctuation">)</span> <span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"姓名:%v 年龄:%v\n"</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>age<span class="token punctuation">)</span>  <span class="token comment">// 姓名:小王子 年龄:25</span><span class="token punctuation">&#125;</span><span class="token comment">//指针类型接收者</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Person<span class="token punctuation">)</span> <span class="token function">setInfo</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> age <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p<span class="token punctuation">.</span>name <span class="token operator">=</span> namep<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>p1 <span class="token operator">:=</span> Person<span class="token punctuation">&#123;</span>name<span class="token punctuation">:</span> <span class="token string">"小王子"</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span> <span class="token number">25</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>p1<span class="token punctuation">.</span><span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 姓名:小王子 年龄:25</span>p1<span class="token punctuation">.</span><span class="token function">setInfo</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>p1<span class="token punctuation">.</span><span class="token function">printInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token comment">// 姓名:张三 年龄:20</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-结构体继承">05.结构体继承</h2><ul><li>Go 语言中使用结构体也可以实现其他编程语言中的继承</li></ul><h3 id="5-1-普通传值">5.1 普通传值</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Animal <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Animal 动物</span>name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Animal<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s 会运动！\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Dog <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Dog狗</span>Age <span class="token builtin">int8</span>Animal    <span class="token comment">// 通过嵌套匿名结构体实现继承</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>d Dog<span class="token punctuation">)</span> <span class="token function">wang</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s 会汪汪汪~\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>d1 <span class="token operator">:=</span> Dog<span class="token punctuation">&#123;</span>Age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>Animal<span class="token punctuation">:</span> Animal<span class="token punctuation">&#123;</span>    <span class="token comment">//注意嵌套的是结构体指针</span>name<span class="token punctuation">:</span> <span class="token string">"阿奇"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>d1<span class="token punctuation">.</span><span class="token function">wang</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//乐乐会汪汪汪~</span>d1<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//乐乐会动！</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="5-2-指针传值">5.2 指针传值</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> Animal <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Animal 动物</span>name <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>Animal<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s 会运动！\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Dog <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>   <span class="token comment">//Dog狗</span>Age <span class="token builtin">int8</span><span class="token operator">*</span>Animal  <span class="token comment">//通过嵌套匿名结构体实现继承</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>Dog<span class="token punctuation">)</span> <span class="token function">wang</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s 会汪汪汪~\n"</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>d1 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Dog<span class="token punctuation">&#123;</span>Age<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>Animal<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Animal<span class="token punctuation">&#123;</span>    <span class="token comment">//注意嵌套的是结构体指针</span>name<span class="token punctuation">:</span> <span class="token string">"阿奇"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>d1<span class="token punctuation">.</span><span class="token function">wang</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//乐乐会汪汪汪~</span>d1<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//乐乐会动！</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="06-给任意类型添加方法">06.给任意类型添加方法</h2><ul><li>在 Go 语言中，接收者的类型可以是任何类型，不仅仅是结构体，任何类型都可以拥有方法。</li><li>举个例子，我们基于内置的 int 类型使用 type 关键字可以定义新的自定义类型，然后为我们的自定义类型添加方法。</li><li>注意事项： 非本地类型不能定义方法，也就是说我们不能给别的包的类型定义方法。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> myInt <span class="token builtin">int</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m myInt<span class="token punctuation">)</span> <span class="token function">SayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"Hello, 我是一个 int。"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> m1 myIntm1<span class="token punctuation">.</span><span class="token function">SayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">//Hello, 我是一个 int。</span>m1 <span class="token operator">=</span> <span class="token number">100</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%#v %T\n"</span><span class="token punctuation">,</span> m1<span class="token punctuation">,</span> m1<span class="token punctuation">)</span>   <span class="token comment">//100 main.MyInt</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>指针</title>
    <link href="/2021/01/09/5.%E6%8C%87%E9%92%88/"/>
    <url>/2021/01/09/5.%E6%8C%87%E9%92%88/</url>
    
    <content type="html"><![CDATA[<h1 id="1-指针">1.指针</h1><h2 id="01-关于指针">01.关于指针</h2><p>要搞明白 <strong>Go</strong> 语言中的指针需要先知道 <strong>3</strong> 个概念：<code>指针地址、指针类型、指针取值</code></p><ul><li><code>指针地址（&amp;a）</code></li><li><code>指针取值（*&amp;a）</code></li><li><code>指针类型（&amp;a）</code> —&gt; <code>*int</code> 改变数据传指针</li><li>变量的本质是给存储数据的内存地址起了一个好记的别名。</li><li>比如我们定义了一个变量 a := 10 ,这个时候可以直接通过 a 这个变量来读取内存中保存的 10 这个值。</li><li>在计算机底层 a 这个变量其实对应了一个内存地址。</li><li>指针也是一个变量，但它是一种特殊的变量，它存储的数据不是一个普通的值，而是另一个变量的内存地址。</li><li><strong>Go</strong> 语言中的指针操作非常简单，我们只需要记住两个符号：&amp;（取地址）和 *（根据地址取值）</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d \n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>        <span class="token comment">// &amp;a 指针地址 (824633761976)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%d \n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>       <span class="token comment">// *&amp;a 指针取值 (10)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T \n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>        <span class="token comment">// %T 指针类型 (*int )</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><p><img src="/img/image-20210519103732255.5c4eeb04.png" alt="img"></p><h2 id="02-取变量地址">02.<code>&amp;取变量地址</code></h2><h3 id="2-1-符号取地址操作">2.1 &amp;符号取地址操作</h3><ul><li>每个变量在运行时都拥有一个地址，这个地址代表变量在内存中的位置。</li><li>Go 语言中使用&amp;字符放在变量前面对变量进行取地址操作。</li><li>Go 语言中的值类型（int、float、bool、string、array、struct）都有对应的指针类型</li><li>取变量指针的语法如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">ptr <span class="token operator">:=</span> <span class="token operator">&amp;</span>v      <span class="token comment">// 比如 v 的类型为 T</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><p>1</p><ul><li><strong>v</strong> : 代表被取地址的变量，类型为 T</li><li><strong>ptr</strong> : 用于接收地址的变量，<strong>ptr</strong> 的类型就为*T，称做 T 的指针类型。*代表指针。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token operator">&amp;</span>afmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"a:%d ptr:%p\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a<span class="token punctuation">)</span>    <span class="token comment">// a:10 ptr:0xc0000100a8</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"b:%v type:%T\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> b<span class="token punctuation">)</span>    <span class="token comment">// b:0xc0000100a8 type:*int</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"取 b 的地址："</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span>    <span class="token comment">// 取 b 的地址： 0xc000006028</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-b-a-的图示">2.2 b := &amp;a 的图示</h3><p><img src="/img/image-20210519104530628.569190a8.png" alt="img"></p><h2 id="03-指针修改数据">03.指针修改数据</h2><h3 id="3-1-指针取值">3.1 <code>*指针取值</code></h3><ul><li>在对普通变量使用&amp;操作符取地址后会获得这个变量的指针，然后可以对指针使用操作，也就是指针取值</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token number">10</span>b <span class="token operator">:=</span> <span class="token operator">&amp;</span>a   <span class="token comment">// 取变量 a 的地址，将地址保存到指针 b 中</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of b:%T\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>     <span class="token comment">// type of b:*int</span>c <span class="token operator">:=</span> <span class="token operator">*</span>b    <span class="token comment">// 指针取值（根据指针的值去内存取值）</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of c:%T\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>    <span class="token comment">// type of c:int</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"value of c:%v\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>   <span class="token comment">// value of c:10</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>变量、指针地址、指针变量、取地址、取值的相互关系和特性如下：<ul><li>xxxxxxxxxx package mainimport (    “fmt”    “sort”)func main() {    // 第一：生成字典，scoreMap    var scoreMap = make(map[string]int, 200)    for i := 0; i &lt; 10; i++ {        key := fmt.Sprintf(“stu%02d”, i) //生成 stu 开头的字符串        scoreMap[key] = i    }        // 第二：取出 map 中的所有 key 存入切片 keys    var keys = make([]string, 0, 200)    for key := range scoreMap {        keys = append(keys, key)    }​    // 第三：对切片进行排序    sort.Strings(keys)​    // 第四：按照排序后的 key 遍历 map    for _, key := range keys {        fmt.Println(key, scoreMap[key])    }}/*stu00 0stu01 1stu02 2stu03 3stu04 4stu05 5stu06 6stu07 7stu08 8stu09 9 */go</li><li>指针变量的值是指针地址。</li><li>对指针变量进行取值（*）操作，可以获得指针变量指向的原变量的值。</li></ul></li></ul><h3 id="3-2-指针传值示例">3.2 指针传值示例</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">modify1</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">modify2</span><span class="token punctuation">(</span>x <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token operator">*</span>x <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token number">10</span><span class="token function">modify1</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token comment">// 10</span><span class="token function">modify2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token comment">// 100</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-new-和-make">04.new 和 make</h2><h3 id="4-0-执行报错">4.0 执行报错</h3><ul><li>执行下面的代码会引发 panic，为什么呢？</li><li>在 Go 语言中对于引用类型的变量，我们在使用的时候不仅要声明它，还要为它分配内存空间，否则我们的值就没办法存储。</li><li>而对于值类型的声明不需要分配内存空间，是因为它们在声明的时候已经默认分配好了内存空间。</li><li>要分配内存，就引出来今天的 new 和 make。</li><li>Go 语言中 new 和 make 是内建的两个函数，主要用来分配内存。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> userinfo <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>userinfo<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"张三"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">/*panic: assignment to entry in nil map */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-1-make和new比较">4.1 make和new比较</h3><ul><li>new 和 make 是两个内置函数，主要用来创建并分配类型的内存。</li><li>make和new区别<ul><li><code>make</code> 关键字的作用是创建于 slice、map 和 channel 等内置的数据结构</li><li><code>new</code> 的作用是为类型申请一片内存空间，并返回指向这片内存的指针</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>       <span class="token comment">// 切片长度为 1，预留空间长度为 10</span>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v--%T \n"</span><span class="token punctuation">,</span>a<span class="token punctuation">,</span>a<span class="token punctuation">)</span>   <span class="token comment">// [0 0 0]--[]int   值----切片本身</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token comment">//b = b.append(b,2)          // 返回的是内存指针，所以不能直接 append</span><span class="token operator">*</span>b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>b<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>        <span class="token comment">// 必须通过 * 指针取值，才能进行 append 添加</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v--%T"</span><span class="token punctuation">,</span>b<span class="token punctuation">,</span>b<span class="token punctuation">)</span>    <span class="token comment">// &amp;[]--*[]string  内存的指针---内存指针</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-new函数">4.2 new函数</h3><ul><li><code>一：系统默认的数据类型，分配空间</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 1.new实例化int</span>age <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token operator">*</span>age <span class="token operator">=</span> <span class="token number">1</span><span class="token comment">// 2.new实例化切片</span>li <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token operator">*</span>li <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>li<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">// 3.实例化map</span>userinfo <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">*</span>userinfo <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token operator">*</span>userinfo<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"张三"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>userinfo<span class="token punctuation">)</span>    <span class="token comment">// &amp;map[username:张三]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li><code>二：自定义类型使用 new 函数来分配空间</code></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s <span class="token operator">*</span>Students <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span>      <span class="token comment">//分配空间</span>s<span class="token punctuation">.</span>name <span class="token operator">=</span><span class="token string">"zhangsan"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        <span class="token comment">// &amp;&#123;zhangsan 0&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>name <span class="token builtin">string</span>age <span class="token builtin">int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-3-make函数">4.3 make函数</h3><ul><li>make 也是用于内存分配的，但是和 new 不同，它只用于 chan、map 以及 slice 的内存创建</li><li>而且它返回的类型就是这三个类型本身，而不是他们的指针类型</li><li>因为这三种类型就是引用类型，所以就没有必要返回他们的指针了</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>       <span class="token comment">// 切片长度为 1，预留空间长度为 10</span>b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span>c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">)</span>          <span class="token comment">// [0 0 0]  map[]  0xc0000180e0</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>当我们为slice分配内存的时候，应当尽量预估到slice可能的最大长度</li><li>通过给make传第三个参数的方式来给slice预留好内存空间</li><li>这样可以避免二次分配内存带来的开销，大大提高程序的性能。</li></ul>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Map</title>
    <link href="/2021/01/08/4.Map/"/>
    <url>/2021/01/08/4.Map/</url>
    
    <content type="html"><![CDATA[<h1 id="1-map">1.map</h1><h2 id="01-map介绍">01.map介绍</h2><h3 id="1-1-map说明">1.1 map说明</h3><ul><li>map 是一种无序的基于 key-value 的数据结构，Go 语言中的 map 是引用类型，必须初始化才能使用。</li><li>Go 语言中 map 的定义语法如下：<code>map[KeyType]ValueType</code></li><li>其中:<ul><li>KeyType:表示键的类型。</li><li>ValueType:表示键对应的值的类型。</li><li>map 类型的变量默认初始值为 nil，需要使用 make()函数来分配内存。</li></ul></li><li>其中 cap 表示 map 的容量，该参数虽然不是必须的。</li><li>注意：获取 map 的容量不能使用 cap, cap 返回的是数组切片分配的空间大小, 根本不能用于map。</li><li>要获取 map 的容量，可以用 len 函数。</li></ul><h2 id="02-定义map">02.定义map</h2><h3 id="2-1-map定义：法1">2.1 map定义：法1</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>scoreMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>scoreMap<span class="token punctuation">[</span><span class="token string">"张三"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span>scoreMap<span class="token punctuation">[</span><span class="token string">"小明"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>scoreMap<span class="token punctuation">)</span>             <span class="token comment">// map[小明:100 张三:90]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>scoreMap<span class="token punctuation">[</span><span class="token string">"小明"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment">// 100</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of a:%T\n"</span><span class="token punctuation">,</span> scoreMap<span class="token punctuation">)</span>    <span class="token comment">// type of a:map[string]int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-map定义：法2">2.2 map定义：法2</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>userInfo <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"IT 营小王子"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span>   <span class="token comment">// map[password:123456 username:IT 营小王子]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-map嵌套map">2.3 map嵌套map</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> mapSlice <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> mapSlice <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"index:%d value:%v\n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"#################### after init ################"</span><span class="token punctuation">)</span><span class="token comment">// 对切片中的 map 元素进行初始化</span>mapSlice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>mapSlice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"小王子"</span>mapSlice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"123456"</span>mapSlice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"address"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"海淀区"</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> mapSlice <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"index:%d value:%v\n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*index:0 value:map[]index:1 value:map[]index:2 value:map[]#################### after init ################index:0 value:map[address:海淀区 name:小王子 password:123456]index:1 value:map[]index:2 value:map[] */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-map基本使用">03.map基本使用</h2><h3 id="3-1-判断某个键是否存在">3.1 判断某个键是否存在</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>userInfo <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span><span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> userInfo<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token keyword">if</span> ok <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>    <span class="token comment">// zhangsan</span><span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"map中没有此元素"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-delete-函数">3.2 delete()函数</h3><ul><li>使用 delete()内建函数从 map 中删除一组键值对，delete()函数的格式如下：delete(map 对象, key)</li><li>其中，<ul><li>map 对象:表示要删除键值对的 map 对象</li><li>key:表示要删除的键值对的键</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>scoreMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>scoreMap<span class="token punctuation">[</span><span class="token string">"张三"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span>scoreMap<span class="token punctuation">[</span><span class="token string">"小明"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>scoreMap<span class="token punctuation">[</span><span class="token string">"娜扎"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token function">delete</span><span class="token punctuation">(</span>scoreMap<span class="token punctuation">,</span> <span class="token string">"小明"</span><span class="token punctuation">)</span>   <span class="token comment">//将小明:100 从 map 中删除</span><span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token operator">:=</span> <span class="token keyword">range</span> scoreMap<span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*娜扎 60张三 90 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-map遍历">04.map遍历</h2><h3 id="4-1-遍历key和value">4.1 遍历key和value</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>scoreMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>scoreMap<span class="token punctuation">[</span><span class="token string">"张三"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span>scoreMap<span class="token punctuation">[</span><span class="token string">"小明"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>scoreMap<span class="token punctuation">[</span><span class="token string">"娜扎"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">60</span><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> scoreMap <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*张三 90小明 100娜扎 60 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-只遍历Key">4.2 只遍历Key</h3><ul><li>注意： 遍历 map 时的元素顺序与添加键值对的顺序无关</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>   <span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>   scoreMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>   scoreMap<span class="token punctuation">[</span><span class="token string">"张三"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">90</span>   scoreMap<span class="token punctuation">[</span><span class="token string">"小明"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>   scoreMap<span class="token punctuation">[</span><span class="token string">"娜扎"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">60</span>   <span class="token keyword">for</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> scoreMap <span class="token punctuation">&#123;</span>      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span>   <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*张三小明娜扎 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-3-顺序遍历map">4.3 顺序遍历map</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sort"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 第一：生成字典，scoreMap</span><span class="token keyword">var</span> scoreMap <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>key <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"stu%02d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token comment">//生成 stu 开头的字符串</span>scoreMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">&#125;</span><span class="token comment">// 第二：取出 map 中的所有 key 存入切片 keys</span><span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> scoreMap <span class="token punctuation">&#123;</span>keys <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token comment">// 第三：对切片进行排序</span>sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span><span class="token comment">// 第四：按照排序后的 key 遍历 map</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> keys <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> scoreMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*stu00 0stu01 1stu02 2stu03 3stu04 4stu05 5stu06 6stu07 7stu08 8stu09 9 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>切片</title>
    <link href="/2021/01/07/3.%E5%88%87%E7%89%87/"/>
    <url>/2021/01/07/3.%E5%88%87%E7%89%87/</url>
    
    <content type="html"><![CDATA[<h1 id="1-切片">1.切片</h1><h2 id="01-切片基础">01.切片基础</h2><h3 id="1-1-切片的定义">1.1 切片的定义</h3><ul><li>切片（Slice）是一个拥有相同类型元素的可变长度的序列。</li><li>它是基于数组类型做的一层封装。</li><li>它非常灵活，支持自动扩容。</li><li>切片是一个引用类型，它的内部结构包含地址、长度和容量。</li><li>声明切片类型的基本语法如下：</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// var name []T</span><span class="token comment">// 1、name:表示变量名</span><span class="token comment">// 2、T:表示切片中的元素类型</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 切片是引用类型，不支持直接比较，只能和 nil 比较</span><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>       <span class="token comment">//声明一个字符串切片</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>       <span class="token comment">//[]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>      <span class="token comment">//true</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>       <span class="token comment">//声明一个整型切片并初始化</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>        <span class="token comment">//[]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>      <span class="token comment">//false</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">bool</span><span class="token punctuation">&#123;</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">&#125;</span>     <span class="token comment">//声明一个布尔切片并初始化</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>              <span class="token comment">//[false true]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>         <span class="token comment">//false</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>切片之间是不能比较的，我们不能使用==操作符来判断两个切片是否含有全部相等元素。</li><li>切片唯一合法的比较操作是和 nil 比较。 一个 nil 值的切片并没有底层数组，一个 nil 值的切片的长度和容量都是 0。</li><li>但是我们不能说一个长度和容量都是 0 的切片一定是 nil</li><li>例如下面的</li></ul><h3 id="1-2-关于-nil-的认识">1.2 关于 nil 的认识</h3><ul><li>当你声明了一个变量 , 但却还并没有赋值时 , golang 中会自动给你的变量赋值一个默认零值。</li><li>这是每种类型对应的零值</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token builtin">bool</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">false</span>numbers <span class="token operator">-</span><span class="token operator">></span> <span class="token number">0</span><span class="token builtin">string</span><span class="token operator">-</span><span class="token operator">></span> <span class="token string">""</span>pointers <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">nil</span>slices <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">nil</span>maps <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">nil</span>channels <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">nil</span>functions <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">nil</span>interfaces <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">nil</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-切片的本质">1.3 切片的本质</h3><ul><li>切片的本质就是对底层数组的封装，它包含了三个信息：底层数组的指针、切片的长度（len）和切片的容量（cap）。</li><li>举个例子，现在有一个数组 a := [8]int{0, 1, 2, 3, 4, 5, 6, 7}，切片 s1 := a[:5]，相应示意图如下。</li></ul><p><img src="/img/image-20210518145248496.5673a487.png" alt="img"></p><ul><li>切片 s2 := a[3:6]，相应示意图如下</li></ul><p><img src="/img/image-20210518145427694.bad1dc70.png" alt="img"></p><h3 id="1-4-切片的扩容策略">1.4 切片的扩容策略</h3><ul><li>1、首先判断，如果新申请容量（cap）大于 2 倍的旧容量（old.cap），最终容量（newcap）就是新申请的容量（cap）。</li><li>2、否则判断，如果旧切片的长度小于 1024，则最终容量(newcap)就是旧容量(old.cap)的两倍，即（newcap=doublecap）</li><li>3、否则判断，如果旧切片长度大于等于 1024，则最终容量（newcap）从旧容量（old.cap）开始循环增加原来的 1/4，即（newcap=old.cap,for{newcap+= newcap/4}）直到最终容量newcap）大于等于新申请的容量(cap)，即（newcap &gt;= cap）</li><li>4、如果最终容量（cap）计算值溢出，则最终容量（cap）就是新申请容量（cap）。</li></ul><h3 id="1-5-切片的长度和容量">1.5 切片的长度和容量</h3><ul><li>切片拥有自己的长度和容量，我们可以通过使用内置的 **len()**函数求长度，使用内置的 **cap()**函数求切片的容量。</li><li>切片的长度就是它所包含的元素个数。</li><li>切片的容量是从它的第一个元素开始数，到其底层数组元素末尾的个数。</li><li>切片 s 的长度和容量可通过表达式 len(s) 和 cap(s) 来获取。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"长度:%v 容量 %v\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 长度:6 容量 6</span>c <span class="token operator">:=</span> s<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>          <span class="token comment">// [2 3]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"长度:%v 容量 %v\n"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">// 长度:2 容量 6</span>d <span class="token operator">:=</span> s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>         <span class="token comment">// [3 5]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"长度:%v 容量 %v"</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">// 长度:2 容量 5</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-切片循环">02.切片循环</h2><ul><li>切片的循环遍历和数组的循环遍历是一样的</li></ul><h3 id="2-1-基本遍历">2.1 基本遍历</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*北京上海深圳 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-k，v遍历">2.2 k，v遍历</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*0 北京1 上海2 深圳 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-定义切片">03.定义切片</h2><h3 id="3-1-数组定义切片">3.1 数组定义切片</h3><ul><li>由于切片的底层就是一个数组，所以我们可以基于数组定义切片。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">55</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">&#125;</span> <span class="token comment">// 基于数组定义切片</span>b <span class="token operator">:=</span> a<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>     <span class="token comment">// [56 57 58]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of b:%T\n"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>   <span class="token comment">// type of b:[]int</span>c <span class="token operator">:=</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment">// [56 57]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-make-构造切片">3.2 make()构造切片</h3><ul><li>我们上面都是基于数组来创建的切片，如果需要动态的创建一个切片，我们就需要使用内置的 make()函数</li><li>格式如下：<code>make([]T, size, cap)</code><ul><li>T:切片的元素类型</li><li>size:切片中元素的数量</li><li>cap:切片的容量</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>         <span class="token comment">//[0 0]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//2</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">cap</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token comment">//10</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>上面代码中 a 的内部存储空间已经分配了 10 个，但实际上只用了 2 个。</li><li>容量并不会影响当前元素的个数，所以 len(a)返回 2，cap(a)则返回该切片的容量。</li></ul><h2 id="04-append">04.append()</h2><ul><li>Go 语言的内建函数 append()可以为切片动态添加元素，每个切片会指向一个底层数组</li><li>这个数组的容量够用就添加新增元素。</li><li>当底层数组不能容纳新增的元素时，切片就会自动按照一定的策略进行“扩容”，此时该切片指向的底层数组就会更换。</li><li>“扩容”操作往往发生在append()函数调用时，所以我们通常都需要用原变量接收 append 函数的返回值。</li></ul><h3 id="4-1-append添加">4.1 append添加</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// append()添加元素和切片扩容</span><span class="token keyword">var</span> numSlice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>numSlice <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>numSlice<span class="token punctuation">,</span> i<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v len:%d cap:%d ptr:%p\n"</span><span class="token punctuation">,</span> numSlice<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>numSlice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>numSlice<span class="token punctuation">)</span><span class="token punctuation">,</span> numSlice<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-append追加多个">4.2 append追加多个</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> citySlice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>citySlice <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>citySlice<span class="token punctuation">,</span> <span class="token string">"北京"</span><span class="token punctuation">)</span><span class="token comment">// 追加一个元素</span>citySlice <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>citySlice<span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"广州"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">)</span><span class="token comment">// 追加多个元素</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"成都"</span><span class="token punctuation">,</span> <span class="token string">"重庆"</span><span class="token punctuation">&#125;</span>citySlice <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>citySlice<span class="token punctuation">,</span> a<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token comment">// 追加切片</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>citySlice<span class="token punctuation">)</span> <span class="token comment">//[北京 上海 广州 深圳 成都 重庆]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-3-切片中删除元素">4.3 切片中删除元素</h3><ul><li>Go 语言中并没有删除切片元素的专用方法，我们可以使用切片本身的特性来删除元素</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">&#125;</span>a <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">...</span><span class="token punctuation">)</span>      <span class="token comment">// 要删除索引为 2 的元素</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                <span class="token comment">//[30 31 33 34 35 36 37]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-4-切片合并">4.4 切片合并</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>arr1 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">&#125;</span>arr2 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr2<span class="token punctuation">,</span>arr1<span class="token punctuation">)</span>arr1 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>arr1<span class="token punctuation">,</span> arr2<span class="token operator">...</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span>  <span class="token comment">// [2 7 1 5 9 3]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-copy">05.copy()</h2><h3 id="5-1-引用问题">5.1 引用问题</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span>b <span class="token operator">:=</span> afmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">//[1 2 3 4 5]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>   <span class="token comment">//[1 2 3 4 5]</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1000</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">//[1000 2 3 4 5]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>   <span class="token comment">//[1000 2 3 4 5]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="5-2-copy-函数">5.2 copy()函数</h3><ul><li>Go 语言内建的 copy()函数可以迅速地将一个切片的数据复制到另外一个切片空间中</li><li>copy()函数的使用格式如下： copy(destSlice, srcSlice []T)</li><li>其中：<ul><li>srcSlice: 数据来源切片</li><li>destSlice: 目标切片</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">&#125;</span>c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>    <span class="token comment">// [0 0 0 0 0]</span><span class="token function">copy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> a<span class="token punctuation">)</span>         <span class="token comment">//使用 copy()函数将切片 a 中的元素复制到切片 c</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>     <span class="token comment">//[1 2 3 4 5]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>     <span class="token comment">//[1 2 3 4 5]</span>c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1000</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">//[1 2 3 4 5]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>   <span class="token comment">//[1000 2 3 4 5]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="06-sort">06.sort()</h2><h3 id="6-1-正序排序">6.1 正序排序</h3><ul><li>对于 int 、 float64 和 string 数组或是切片的排序</li><li>go 分别提供了 sort.Ints() 、sort.Float64s() 和 sort.Strings() 函数， 默认都是从小到大排序</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sort"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>intList <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>sort<span class="token punctuation">.</span><span class="token function">Ints</span><span class="token punctuation">(</span>intList<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>intList<span class="token punctuation">)</span>   <span class="token comment">// [0 1 2 3 4 5 6 7 8 9]</span>stringList <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">&#125;</span>sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>stringList<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>stringList<span class="token punctuation">)</span>   <span class="token comment">// [a b c d f i w x y z]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="6-2-sort-降序排序">6.2 sort 降序排序</h3><ul><li>Golang的sort 包 可 以 使 用 sort.Reverse(slice) 来 调 换slice.Interface.Less</li><li>也就是比较函数，所以， int 、 float64 和 string的逆序排序函数可以这么写</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"sort"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>intList <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">&#125;</span>sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span><span class="token function">IntSlice</span><span class="token punctuation">(</span>intList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>intList<span class="token punctuation">)</span>   <span class="token comment">// [9 8 7 6 5 4 3 2 1 0]</span>stringList <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"a"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"z"</span><span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">&#125;</span>sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>sort<span class="token punctuation">.</span><span class="token function">StringSlice</span><span class="token punctuation">(</span>stringList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>stringList<span class="token punctuation">)</span>   <span class="token comment">// [z y x w i f d c b a]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数组</title>
    <link href="/2021/01/07/2.%E6%95%B0%E7%BB%84/"/>
    <url>/2021/01/07/2.%E6%95%B0%E7%BB%84/</url>
    
    <content type="html"><![CDATA[<h1 id="1-数组">1.数组</h1><h2 id="01-切片基础">01.切片基础</h2><h3 id="1-1-Array介绍">1.1 Array介绍</h3><ul><li>数组是指一系列<code>同一类型数据的集合</code>。</li><li>数组中包含的每个数据被称为数组元素(element)，这种类型可以是任意的原始类型，比如 int、string 等</li><li>一个数组包含的元素个数被称为数组的长度。</li><li>在 Golang 中数组是一个长度固定的数据类型，数组的长度是类型的一部分，也就是说 <code>[5]int 和 [10]int 是两个不同的类型</code>。</li><li>Golang中数组的另一个特点是占用内存的连续性，也就是说数组中的元素是被分配到连续的内存地址中的，因而索引数组元素的速度非常快。</li><li>和数组对应的类型是 Slice（切片），Slice 是可以增长和收缩的动态序列，功能也更灵活</li><li>但是想要理解 slice 工作原理的话需要先理解数组，所以本节主要为大家讲解数组的使用。</li></ul><p><img src="/img/image-20210518110223971.b3f1bc7a.png" alt="img"></p><h3 id="1-2-数组定义">1.2 数组定义</h3><figure><div class="code-wrapper"><pre class="line-numbers language-text" data-language="text"><code class="language-text">var 数组变量名 [元素数量]T<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div></figure><ul><li>比如：var a [5]int， 数组的长度必须是常量，并且长度是数组类型的一部分</li><li>一旦定义，长度不能变。 [5]int 和[4]int 是不同的类型。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 定义一个长度为 3 元素类型为 int 的数组 a</span><span class="token keyword">var</span> a <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token comment">// 定义一个长度为 3 元素类型为 int 的数组 b 并赋值</span><span class="token keyword">var</span> b <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span>b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">80</span>b<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>b<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">96</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>     <span class="token comment">// [0 0 0 0 0]</span>fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>     <span class="token comment">// [80 100 96]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-3-数组是值类型">1.3 数组是值类型</h3><ul><li>数组是值类型，赋值和传参会复制整个数组。</li><li>因此改变副本的值，不会改变本身的值。</li><li>注意：<ul><li>数组支持 “==“、”!=” 操作符，因为内存总是被初始化过的。</li><li><code>[n]*T</code>表示指针数组，<code>*[n]T</code> 表示数组指针</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">&#125;</span><span class="token function">modifyArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token comment">//在 modify 中修改的是 a 的副本 x</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>     <span class="token comment">//[10 20 30]</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">modifyArray</span><span class="token punctuation">(</span>x <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-创建数组">02.创建数组</h2><h3 id="2-1-自定义数组长度">2.1 自定义数组长度</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 1) 数组会初始化为 int 类型的零值</span><span class="token keyword">var</span> testArray <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>testArray<span class="token punctuation">)</span>    <span class="token comment">//[0 0 0]</span><span class="token comment">// 2) 使用指定的初始值完成初始化</span><span class="token keyword">var</span> numArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>numArray<span class="token punctuation">)</span>     <span class="token comment">//[1 2 0]</span><span class="token keyword">var</span> cityArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>cityArray<span class="token punctuation">)</span>    <span class="token comment">//[北京 上海 深圳]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-2-让编译器识别">2.2 让编译器识别</h3><ul><li>按照上面的方法每次都要确保提供的初始值和数组长度一致</li><li>一般情况下我们可以让编译器根据初始值的个数自行推断数组的长度</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> numArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>numArray<span class="token punctuation">)</span>   <span class="token comment">//[1 2]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of numArray:%T\n"</span><span class="token punctuation">,</span> numArray<span class="token punctuation">)</span>  <span class="token comment">//type of numArray:[2]int</span><span class="token keyword">var</span> cityArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>cityArray<span class="token punctuation">)</span>   <span class="token comment">//[北京 上海 深圳]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of cityArray:%T\n"</span><span class="token punctuation">,</span> cityArray<span class="token punctuation">)</span>  <span class="token comment">//type of cityArray:[3]string</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="2-3-指定索引值">2.3 指定索引值</h3><ul><li>我们还可以使用指定索引值的方式来初始化数组</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 初始化一个整数数组，在下标1号和3号位置写入： 1   5</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token comment">// [0 1 0 5]</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"type of a:%T\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>    <span class="token comment">//type of a:[4]int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-数组的遍历">03.数组的遍历</h2><h3 id="3-1-普通遍历数组">3.1 普通遍历数组</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*北京上海深圳 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="3-2-k-v遍历数组">3.2 k,v遍历数组</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*0 北京1 上海2 深圳 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="04-多维数组">04.多维数组</h2><h3 id="4-1-定义多维数组">4.1 定义多维数组</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"广州"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"成都"</span><span class="token punctuation">,</span> <span class="token string">"重庆"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>         <span class="token comment">//[[北京 上海] [广州 深圳] [成都 重庆]]</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment">//支持索引取值:重庆</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-2-遍历多维数组">4.2 遍历多维数组</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span><span class="token string">"北京"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"广州"</span><span class="token punctuation">,</span> <span class="token string">"深圳"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token string">"成都"</span><span class="token punctuation">,</span> <span class="token string">"重庆"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v1 <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">&#123;</span>   <span class="token comment">// v1 = [北京 上海]</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v2 <span class="token operator">:=</span> <span class="token keyword">range</span> v1 <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">/*北京上海广州深圳成都重庆*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-数组练习">05.数组练习</h2><h3 id="5-1-数组求和">5.1 数组求和</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> intArr2 <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">&#125;</span>sum <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> intArr2 <span class="token punctuation">&#123;</span><span class="token comment">//累计求和</span>sum <span class="token operator">+=</span> val<span class="token punctuation">&#125;</span>    <span class="token comment">//如何让平均值保留到小数.</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"sum=%v 平均值=%v \n\n"</span><span class="token punctuation">,</span> sum<span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>intArr2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// sum=111 平均值=22.2 </span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="5-2-数组最大值">5.2 数组最大值</h3><ul><li>1、声明一个数组 var intArr[5] = […]int {1, -1, 12, 65, 11}</li><li>2、假定第一个元素就是最大值，下标就 0</li><li>3、然后从第二个元素开始循环比较，如果发现有更大，则交换</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> intArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">&#123;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">&#125;</span>maxValue <span class="token operator">:=</span> intArr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>maxIndex <span class="token operator">:=</span> <span class="token number">0</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>intArr<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> maxValue <span class="token operator">&lt;</span> intArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">&#123;</span>maxValue <span class="token operator">=</span> intArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>maxIndex <span class="token operator">=</span> i<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"最大值"</span><span class="token punctuation">,</span> maxValue<span class="token punctuation">,</span> <span class="token string">"最大值索引值"</span><span class="token punctuation">,</span> maxIndex<span class="token punctuation">)</span><span class="token comment">// 最大值 112 最大值索引值 2</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基本数据类型</title>
    <link href="/2021/01/07/1.%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
    <url>/2021/01/07/1.%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="1-基本数据类型">1.基本数据类型</h1><h2 id="01-内置类型">01.内置类型</h2><h3 id="1-1-值类型：">1.1 值类型：</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token builtin">bool</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token number">32</span> or <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int8</span><span class="token punctuation">,</span> <span class="token builtin">int16</span><span class="token punctuation">,</span> <span class="token builtin">int32</span><span class="token punctuation">,</span> <span class="token builtin">int64</span><span class="token function">uint</span><span class="token punctuation">(</span><span class="token number">32</span> or <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint8</span><span class="token punctuation">(</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">uint16</span><span class="token punctuation">,</span> <span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token builtin">uint64</span><span class="token builtin">float32</span><span class="token punctuation">,</span> <span class="token builtin">float64</span><span class="token builtin">string</span><span class="token builtin">complex64</span><span class="token punctuation">,</span> <span class="token builtin">complex128</span>array    <span class="token comment">// 固定长度的数组</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="1-2-引用类型：-指针类型"><strong>1.2 引用类型：(指针类型)</strong></h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">slice    <span class="token comment">// 序列数组(最常用)</span><span class="token keyword">map</span>     <span class="token comment">// 映射</span><span class="token keyword">chan</span>     <span class="token comment">// 管道</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="02-内置函数">02.内置函数</h2><ul><li>Go 语言拥有一些不需要进行导入操作就可以使用的内置函数。</li><li>它们有时可以针对不同的类型进行操作，例如：len、cap 和 append，或必须用于系统级的操作，例如：panic。</li><li>因此，它们需要直接获得编译器的支持。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token builtin">append</span>          <span class="token comment">// 用来追加元素到数组、slice中,返回修改后的数组、slice</span><span class="token builtin">close</span>           <span class="token comment">// 主要用来关闭channel</span><span class="token builtin">delete</span>          <span class="token comment">// 从map中删除key对应的value</span><span class="token builtin">panic</span>           <span class="token comment">// 停止常规的goroutine  （panic和recover：用来做错误处理）</span><span class="token builtin">recover</span>         <span class="token comment">// 允许程序定义goroutine的panic动作</span><span class="token builtin">real</span>           <span class="token comment">// 返回complex的实部   （complex、real imag：用于创建和操作复数）</span><span class="token builtin">imag</span>           <span class="token comment">// 返回complex的虚部</span><span class="token builtin">make</span>           <span class="token comment">// 用来分配内存，返回Type本身(只能应用于slice, map, channel)</span><span class="token builtin">new</span>            <span class="token comment">// 用来分配内存，主要用来分配值类型，比如int、struct。返回指向Type的指针</span><span class="token builtin">cap</span>            <span class="token comment">// capacity是容量的意思，用于返回某个类型的最大容量（只能用于切片和 map）</span><span class="token builtin">copy</span>            <span class="token comment">// 用于复制和连接slice，返回复制的数目</span><span class="token builtin">len</span>            <span class="token comment">// 来求长度，比如string、array、slice、map、channel ，返回长度</span><span class="token builtin">print</span>、<span class="token builtin">println</span>     <span class="token comment">// 底层打印函数，在部署环境中建议使用 fmt 包</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="03-基本类型介绍">03.基本类型介绍</h2><table><thead><tr><th>类型</th><th>长度(字节)</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>bool</td><td>1</td><td>false</td><td></td></tr><tr><td>byte</td><td>1</td><td>0</td><td>uint8</td></tr><tr><td>rune</td><td>4</td><td>0</td><td>Unicode Code Point, int32</td></tr><tr><td>int, uint</td><td>4或8</td><td>0</td><td>32 或 64 位</td></tr><tr><td>int8, uint8</td><td>1</td><td>0</td><td>-128 ~ 127, 0 ~ 255，byte是uint8 的别名</td></tr><tr><td>int16, uint16</td><td>2</td><td>0</td><td>-32768 ~ 32767, 0 ~ 65535</td></tr><tr><td>int32, uint32</td><td>4</td><td>0</td><td>-21亿~ 21亿, 0 ~ 42亿，rune是int32 的别名</td></tr><tr><td>int64, uint64</td><td>8</td><td>0</td><td></td></tr><tr><td>float32</td><td>4</td><td>0.0</td><td></td></tr><tr><td>float64</td><td>8</td><td>0.0</td><td></td></tr><tr><td>complex64</td><td>8</td><td></td><td>xxxxxxxxxx package mainimport &quot;fmt&quot;func main() {    var intArr = […]int{1, -1, 112, 65, 11}    maxValue := intArr[0]    maxIndex := 0    for i := 0; i &lt; len(intArr); i++ {        if maxValue &lt; intArr[i] {            maxValue = intArr[i]            maxIndex = i        }    }    fmt.Println(“最大值”, maxValue, “最大值索引值”, maxIndex)    // 最大值 112 最大值索引值 2}go</td></tr><tr><td>complex128</td><td>16</td><td></td><td></td></tr><tr><td>uintptr</td><td>4或8</td><td></td><td>以存储指针的 uint32 或 uint64 整数</td></tr><tr><td>array</td><td></td><td></td><td>值类型</td></tr><tr><td>struct</td><td></td><td></td><td>值类型</td></tr><tr><td>string</td><td></td><td>“”</td><td>UTF-8 字符串</td></tr><tr><td>slice</td><td></td><td>nil</td><td>引用类型</td></tr><tr><td>map</td><td></td><td>nil</td><td>引用类型</td></tr><tr><td>channel</td><td></td><td>nil</td><td>引用类型</td></tr><tr><td>interface</td><td></td><td>nil</td><td>接口</td></tr><tr><td>function</td><td></td><td>nil</td><td>函数</td></tr></tbody></table><h2 id="04-数字类型">04.数字类型</h2><h3 id="4-1-Golang数据类型介绍">4.1 Golang数据类型介绍</h3><ul><li><strong>Go</strong> <strong>语言中数据类型分为</strong>：基本数据类型和复合数据类型</li><li><strong>基本数据类型有：</strong><ul><li>整型、浮点型、布尔型、字符串</li></ul></li><li><strong>复合数据类型有：</strong><ul><li>数组、切片、结构体、函数、map、通道（channel）、接口</li></ul></li></ul><h3 id="4-2-整型分为两大类">4.2 整型分为两大类</h3><ul><li>有符号整形按长度分为：int8、int16、int32、int64</li><li>对应的无符号整型：uint8、uint16、uint32、uint64</li></ul><p><img src="/img/image-20210514092328042.51463d9d.png" alt="img"></p><ul><li><strong>关于字节：</strong><ul><li>字节也叫 Byte，是计算机数据的基本存储单位。8bit(位)=1Byte(字节) 1024Byte(字节)=1KB</li><li>1024KB=1MB 1024MB=1GB</li><li>1024GB=1TB 。在电脑里一个中文字是占两个字节的。</li></ul></li></ul><h3 id="4-3-unsafe-Sizeof">4.3 unsafe.Sizeof</h3><ul><li>unsafe.Sizeof(n1) 是 unsafe 包的一个函数，可以返回 n1 变量占用的字节数</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"unsafe"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token builtin">int8</span> <span class="token operator">=</span> <span class="token number">124</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T\n"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>       <span class="token comment">// int8</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token comment">// 1 (表示占用1个字节，也就是8 byte)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-4-int不同长度直接的转换">4.4 int不同长度直接的转换</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> num1 <span class="token builtin">int8</span>num1 <span class="token operator">=</span> <span class="token number">127</span>num2 <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span>   <span class="token comment">// 将num1类型转换成 int32 并赋值给num1</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值:%v 类型%T"</span><span class="token punctuation">,</span> num2<span class="token punctuation">,</span> num2<span class="token punctuation">)</span> <span class="token comment">//值:127 类型 int32</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-5-浮点型">4.5 浮点型</h3><ul><li>Go 语言支持两种浮点型数：float32 和 float64</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%f\n"</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>Pi<span class="token punctuation">)</span>    <span class="token comment">// 3.141593 (默认保留 6 位小数)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%.2f\n"</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>Pi<span class="token punctuation">)</span>   <span class="token comment">// 3.14 (保留 2 位小数)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-6-reflect-TypeOf查看数据类型">4.6 reflect.TypeOf查看数据类型</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"reflect"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>c <span class="token operator">:=</span> <span class="token number">10</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">)</span>   <span class="token comment">// int</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-7-int常用转换">4.7 int常用转换</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span><span class="token comment">// string到int</span>intV<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token comment">// string到int64</span>int64V<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token comment">// int到string</span>strS <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token comment">// int64到string</span><span class="token keyword">var</span> tmp <span class="token builtin">int64</span> <span class="token operator">=</span>  <span class="token number">123</span>str64S<span class="token operator">:=</span>strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%T--%T--%T--%T"</span><span class="token punctuation">,</span> intV<span class="token punctuation">,</span> int64V<span class="token punctuation">,</span> strS<span class="token punctuation">,</span> str64S<span class="token punctuation">)</span><span class="token comment">// int--int64--string--string</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-8-int8转int16">4.8 int8转int16</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token builtin">int8</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token keyword">var</span> b <span class="token builtin">int16</span> <span class="token operator">=</span> <span class="token number">40</span><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">int16</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> b    <span class="token comment">//要转换成相同类型才能运行</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v--类型%T"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment">//值：60--类型 int16</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-9-int16转float32">4.9 int16转float32</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a <span class="token builtin">float32</span> <span class="token operator">=</span> <span class="token number">3.2</span><span class="token keyword">var</span> b <span class="token builtin">int16</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token keyword">var</span> c <span class="token operator">=</span> a <span class="token operator">+</span> <span class="token function">float32</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v--类型%T"</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">)</span>  <span class="token comment">//值：9.2--类型 float32</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-10-math-Sqrt强转">4.10 math.Sqrt强转</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token keyword">var</span> c <span class="token builtin">int</span><span class="token comment">// math.Sqrt()接收的参数是 float64 类型，需要强制转换</span>c <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>a<span class="token operator">*</span>a <span class="token operator">+</span> b<span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment">// 5</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-11-int与str转换">4.11 int与str转换</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//2.1 int64转str</span><span class="token keyword">var</span> num2 <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">123456</span>str2 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>num2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T \n"</span><span class="token punctuation">,</span>str2<span class="token punctuation">,</span>str2<span class="token punctuation">)</span>  <span class="token comment">// 123456---string</span><span class="token comment">//2.2 str转int64</span>v1<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str2<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T\n"</span><span class="token punctuation">,</span>v1<span class="token punctuation">,</span>v1<span class="token punctuation">)</span>      <span class="token comment">// 123456---float64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="4-12-str与int64转换">4.12 str与int64转换</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//1.1 int转sting</span>num1 <span class="token operator">:=</span> <span class="token number">123456</span>str1 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T \n"</span><span class="token punctuation">,</span>str1<span class="token punctuation">,</span>str1<span class="token punctuation">)</span>  <span class="token comment">// 123456---string</span><span class="token comment">// 1.2 sting转int</span>_int<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>_int<span class="token punctuation">,</span>err<span class="token punctuation">)</span>  <span class="token comment">// 123456 &lt;nil></span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T\n"</span><span class="token punctuation">,</span>_int<span class="token punctuation">,</span>_int<span class="token punctuation">)</span>   <span class="token comment">// 123456---int</span><span class="token comment">//2.1 int64转str</span><span class="token keyword">var</span> num2 <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">123456</span>str2 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>num2<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T \n"</span><span class="token punctuation">,</span>str2<span class="token punctuation">,</span>str2<span class="token punctuation">)</span>  <span class="token comment">// 123456---string</span><span class="token comment">//2.2 str转int64</span>v1<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str2<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v---%T\n"</span><span class="token punctuation">,</span>v1<span class="token punctuation">,</span>v1<span class="token punctuation">)</span>      <span class="token comment">// 123456---float64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="05-布尔值">05.布尔值</h2><ul><li>Go 语言中以 bool 类型进行声明布尔型数据，布尔型数据只有 true（真）和 false（假）两个值。</li><li>注意：<ul><li>1.布尔类型变量的默认值为 false。</li><li>2.Go 语言中不允许将整型强制转换为布尔型.</li><li>3.布尔型无法参与数值运算，也无法与其他类型进行转换。</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"unsafe"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token boolean">true</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token string">"占用字节："</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// true 占用字节： 1</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="06-字符串">06.字符串</h2><h3 id="6-1-字符串">6.1 字符串</h3><ul><li>Go 语言里的字符串的内部实现使用 UTF-8 编码。</li><li>字符串的值为双引号(&quot;)中的内容，可以在 Go 语言的源码中直接添加非 ASCII 码字符</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go">s1 <span class="token operator">:=</span> <span class="token string">"hello"</span>s2 <span class="token operator">:=</span> <span class="token string">"你好"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><h3 id="6-2-字符串转义符">6.2 字符串转义符</h3><ul><li>Go 语言的字符串常见转义符包含回车、换行、单双引号、制表符等</li></ul><p><img src="/img/image-20210514100809925.a65546c6.png" alt="img"></p><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"str := \"c:\\Code\\demo\\go.exe\""</span><span class="token punctuation">)</span>  <span class="token comment">// str := "c:\Code\demo\go.exe"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="6-3-多行字符串">6.3 多行字符串</h3><ul><li>反引号间换行将被作为字符串中的换行，但是所有的转义字符均无效，文本将会原样输出。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s1 <span class="token operator">:=</span> <span class="token string">`第一行第二行第三行`</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="6-4-byte和rune">6.4 byte和rune</h3><ul><li>Go 语言的字符有以下两种</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token builtin">uint8</span>类型，或者叫 <span class="token builtin">byte</span> 型：代表了ASCII码的一个字符。<span class="token builtin">rune</span>类型：代表一个 UTF<span class="token operator">-</span><span class="token number">8</span>字符<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div></figure><ul><li>字符串底层是一个byte数组，所以可以和[]byte类型相互转换。</li><li>字符串是不能修改的 字符串是由byte字节组成，所以字符串的长度是byte字节的长度。</li><li>rune类型用来表示utf8字符，一个rune字符由一个或多个byte组成。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// “美国第一”</span>s <span class="token operator">:=</span> <span class="token string">"美国第一"</span>s_rune <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span> <span class="token string">"中国"</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>s_rune<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 中国第一</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="07-字符串的常用操作">07.字符串的常用操作</h2><table><thead><tr><th>方法</th><th>介绍</th></tr></thead><tbody><tr><td>len(str)</td><td>求长度</td></tr><tr><td>+或fmt.Sprintf</td><td>拼接字符串</td></tr><tr><td>strings.Split</td><td>分割</td></tr><tr><td>strings.Contains</td><td>判断是否包含</td></tr><tr><td>strings.HasPrefix,strings.HasSuffix</td><td>前缀/后缀判断</td></tr><tr><td>strings.Index(),strings.LastIndex()</td><td>子串出现的位置</td></tr><tr><td>strings.Join(a[]string, sep string)</td><td>join操作</td></tr></tbody></table><h3 id="7-1-len-str">7.1 len(str)</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"this is str"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 11</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="7-2-拼接">7.2 +(拼接)</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> str1 <span class="token operator">=</span> <span class="token string">"你好"</span><span class="token keyword">var</span> str2 <span class="token operator">=</span> <span class="token string">"golang"</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str1 <span class="token operator">+</span> str2<span class="token punctuation">)</span>  <span class="token comment">// 你好golang</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="7-3-strings-Split">7.3 strings.Split()</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">"123-456-789"</span><span class="token keyword">var</span> arr <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>  <span class="token comment">// [123 456 789]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="7-4-strings-HasPrefix">7.4 strings.HasPrefix()</h3><ul><li>首字符尾字母包含指定字符</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// 1.判断字符串 以 this 开头</span><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"this is golang"</span><span class="token keyword">var</span> flag <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"this"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>   <span class="token comment">// true</span><span class="token comment">// 2.判断字符串以 go 结尾</span><span class="token keyword">var</span> flag2 <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"go"</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>flag2<span class="token punctuation">)</span>   <span class="token comment">// false</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="7-5-strings-Index">7.5 strings.Index()</h3><ul><li>判断字符串出现的位置</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"this is golang"</span><span class="token keyword">var</span> index <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"go"</span><span class="token punctuation">)</span> <span class="token comment">//从前往后</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>   <span class="token comment">// 8 （判断字符串 go 出现的位置）</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="7-6-strings-Join">7.6 strings.Join()</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strings"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">"123-456-789"</span><span class="token keyword">var</span> arr <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">"-"</span><span class="token punctuation">)</span>    <span class="token comment">// [123 456 789]</span><span class="token keyword">var</span> str2 <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>    <span class="token comment">// 123*456*789</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="7-7-单引号">7.7 单引号</h3><ul><li>组成每个字符串的元素叫做“字符”，可以通过遍历字符串元素获得字符，字符用单引号（’）</li><li>uint8 类型，或者叫 byte 型，代表了 ASCII 码的一个字符</li><li>rune 类型，代表一个 UTF-8 字符</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token char">'a'</span>name <span class="token operator">:=</span> <span class="token string">"zhangsan"</span><span class="token comment">//当我们直接输出 byte（字符）的时候输出的是这个字符对应的码值</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>       <span class="token comment">// 97 这里输出的是 a 字符串的 ASCII值</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>    <span class="token comment">// zhangsan</span><span class="token comment">//如果我们要输出这个字符，需要格式化输出</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"的值是%c"</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>  <span class="token comment">// a的值是a</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="08-字符串遍历">08.字符串遍历</h2><h3 id="8-1-遍历字符串">8.1 遍历字符串</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token string">"hello 张三"</span><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">&#123;</span> <span class="token comment">//byte</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v(%c) "</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">// 104(h) 101(e) 108(l) 108(l) 111(o) 32( ) 229(å) 188(¼) 160() 228(ä) 184(¸) 137()</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 打印一个换行</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">&#123;</span> <span class="token comment">//rune</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v=>%c "</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token comment">// 104=>h 101=>e 108=>l 108=>l 111=>o 32=>  24352=>张 19977=>三</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="8-2-修改字符串">8.2 修改字符串</h3><ul><li>要修改字符串，需要先将其转换成[]rune 或[]byte，完成后再转换为 string。</li><li>无论哪种转换，都会重新分配内存，并复制字节数组。</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s1 <span class="token operator">:=</span> <span class="token string">"big"</span><span class="token comment">// 强制类型转换</span>byteS1 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span>byteS1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'p'</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>byteS1<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// pig</span>s2 <span class="token operator">:=</span> <span class="token string">"白萝卜"</span>runeS2 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span>runeS2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'红'</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>runeS2<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// 红萝卜</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><ul><li>将“美国第一”改成“中国第一”</li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// “美国第一”</span>s <span class="token operator">:=</span> <span class="token string">"美国第一"</span>s_rune <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span> <span class="token string">"中国"</span> <span class="token operator">+</span> <span class="token function">string</span><span class="token punctuation">(</span>s_rune<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 中国第一</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="09-转String">09.转String</h2><h3 id="9-1-sprintf转string">9.1 sprintf转string</h3><ul><li>注意：sprintf 使用中需要注意转换的格式<ul><li>int 为%d</li><li>float 为%f</li><li>bool 为%t</li><li>byte 为%c</li></ul></li></ul><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> i <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token keyword">var</span> f <span class="token builtin">float64</span> <span class="token operator">=</span> <span class="token number">12.456</span><span class="token keyword">var</span> t <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token keyword">var</span> b <span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token char">'a'</span><span class="token keyword">var</span> strs <span class="token builtin">string</span>strs <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>  <span class="token comment">// 把 int 转换成 string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> strs<span class="token punctuation">,</span> strs<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=20</span>strs <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%f"</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>  <span class="token comment">// 把 float 转换成 string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> strs<span class="token punctuation">,</span> strs<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=12.456000</span>strs <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%t"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>  <span class="token comment">// 把 bool 转换成 string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> strs<span class="token punctuation">,</span> strs<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=true</span>strs <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment">// 把 byte  转换成 string</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> strs<span class="token punctuation">,</span> strs<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=a</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="9-2-strconv">9.2 strconv</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//1、int 转换成 string</span><span class="token keyword">var</span> num1 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span>s1 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>num1<span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> s1<span class="token punctuation">,</span> s1<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=20</span><span class="token comment">// 2、float 转 string</span><span class="token keyword">var</span> num2 <span class="token builtin">float64</span> <span class="token operator">=</span> <span class="token number">20.113123</span><span class="token comment">/* 参数 1：要转换的值参数 2：格式化类型参数 3: 保留的小数点 -1（不对小数点格式化）参数 4：格式化的类型*/</span>s2 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatFloat</span><span class="token punctuation">(</span>num2<span class="token punctuation">,</span> <span class="token char">'f'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> s2<span class="token punctuation">,</span> s2<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=20.11</span><span class="token comment">// 3、bool 转 string</span>s3 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatBool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型： %T ,值=%v \n"</span><span class="token punctuation">,</span> s3<span class="token punctuation">,</span> s3<span class="token punctuation">)</span>  <span class="token comment">// 类型： string ,值=20.11</span><span class="token comment">//4、int64 转 string</span><span class="token keyword">var</span> num3 <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">20</span>s4 <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">FormatInt</span><span class="token punctuation">(</span>num3<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment">/* 第二个参数10为 进制 */</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"类型 %T ,值=%v \n"</span><span class="token punctuation">,</span> s4<span class="token punctuation">,</span> s4<span class="token punctuation">)</span>  <span class="token comment">// 类型 string ,值=20</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h2 id="10-String转其他">10.String转其他</h2><h3 id="10-1-string转int">10.1 string转int</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">"1234"</span>i64<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T"</span><span class="token punctuation">,</span> i64<span class="token punctuation">,</span> i64<span class="token punctuation">)</span>  <span class="token comment">// 值：1234 类型：int64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="10-2-string转float">10.2 string转float</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>str <span class="token operator">:=</span> <span class="token string">"3.1415926535"</span>v1<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>v2<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T\n"</span><span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span>  <span class="token comment">// 值：3.1415927410125732 类型：float64</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T"</span><span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v2<span class="token punctuation">)</span>  <span class="token comment">// 值：3.1415926535 类型：float64</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="10-3-string转bool">10.3 string转bool</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"strconv"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseBool</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">)</span>   <span class="token comment">// string 转 bool</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"值：%v 类型：%T"</span><span class="token punctuation">,</span> b<span class="token punctuation">,</span> b<span class="token punctuation">)</span>  <span class="token comment">// 值：true 类型：bool</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="10-4-string转字符">10.4 string转字符</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>s <span class="token operator">:=</span> <span class="token string">"hello 张三"</span><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">&#123;</span> <span class="token comment">//rune</span><span class="token comment">// 104(h) 101(e) 108(l) 108(l) 111(o) 32( ) 24352(张) 19977(三) </span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v(%c) "</span><span class="token punctuation">,</span> r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure><h3 id="10-5-字符串反转">10.5 字符串反转</h3><figure><div class="code-wrapper"><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">func</span> <span class="token function">Reverse</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">&#123;</span>r <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">&#123;</span>r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>a <span class="token operator">:=</span> <span class="token string">"Hello, Wrold"</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">Reverse</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// dlorW ,olleH</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></figure>]]></content>
    
    
    <categories>
      
      <category>Go基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Go基础</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
